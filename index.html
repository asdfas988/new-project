<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸ªäººç©ºé—´ - å…¨èƒ½ç‰ˆ</title>
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <!-- Supabase -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Markdown æ¸²æŸ“å™¨ -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- å­—ä½“ -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* ========== å…¨å±€æ ·å¼ (ä¿æŒåŸæœ‰çš„æš–è‰²æ‰‹è´¦é£) ========== */
        :root {
            --bg-color: #fef9f3;
            --text-color: #5a4a42;
            --accent-pink: #ff9a8b;
            --accent-green: #a3de83;
            --accent-blue: #8fd3f4;
            --card-border: 2.5px solid #5a4a42;
            --card-shadow: 6px 6px 0px #d4b8a7;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Noto Sans SC', sans-serif; background: var(--bg-color); min-height: 100vh; color: var(--text-color); padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }

        /* å¤´éƒ¨ */
        .header { text-align: center; margin-bottom: 30px; padding: 30px; background: #fffaf0; border-radius: 24px; box-shadow: 8px 8px 0px #e0c9b8; border: 3px solid #5a4a42; display: flex; flex-direction: column; align-items: center; }
        .header h1 { font-size: 2.2em; font-weight: 700; text-shadow: 3px 3px 0px #ffd6cc; }

        .grid { display: grid; grid-template-columns: 1fr; gap: 30px; margin-bottom: 40px; }
        
        /* é€šç”¨å¡ç‰‡ */
        .card { background: #fffefc; border-radius: 20px; padding: 30px; box-shadow: var(--card-shadow); border: var(--card-border); transition: transform 0.3s; position: relative; }
        .card h2 { margin-bottom: 20px; padding-bottom: 15px; border-bottom: 3px dotted #ff9a8b; font-size: 1.4em; font-weight: 700; display: flex; justify-content: space-between; align-items: center; }

        /* æŒ‰é’®ä¸è¾“å…¥ */
        .btn { background: linear-gradient(90deg, #ff9a8b, #ff6b6b); border: none; padding: 12px 30px; border-radius: 50px; color: white; cursor: pointer; font-size: 16px; font-weight: 700; box-shadow: 4px 4px 0px #d45d5d; transition: all 0.2s; width: 100%; }
        .btn-sm { padding: 6px 15px; font-size: 0.9em; border-radius: 20px; background: linear-gradient(90deg, #4ecdc4, #a3de83); box-shadow: 3px 3px 0px #2ba69b; border: none; color: white; font-weight: bold; cursor: pointer; }
        .btn-danger { background: #ff6b6b; box-shadow: 3px 3px 0px #c0392b; }
        .collapse-btn { background: #fffaf5; border: 2px solid #ff9a8b; color: #ff6b6b; padding: 4px 12px; border-radius: 12px; font-size: 0.8em; font-weight: bold; cursor: pointer; }
        .note-input, .note-textarea { width: 100%; padding: 12px; border: 2px solid #e0c9b8; border-radius: 12px; font-size: 15px; margin-bottom: 15px; background: #fffaf9; font-family: inherit; }
        .search-box { width: 100%; padding: 8px 12px; border: 2px solid #e0c9b8; border-radius: 10px; margin-bottom: 10px; font-size: 0.85em; }

        /* è¿›åº¦æ¡ä¸çŠ¶æ€ */
        .level-display { font-size: 4em; font-weight: 800; text-align: center; color: #ff6b6b; text-shadow: 3px 3px 0px #ffd6cc; }
        .xp-progress { height: 18px; background: #ffe8d6; border-radius: 10px; overflow: hidden; border: 2px solid #5a4a42; margin: 10px 0; }
        .xp-fill { height: 100%; background: linear-gradient(90deg, #4ecdc4, #a3de83); transition: width 0.5s; }
        .p-done { background: linear-gradient(90deg, #4ecdc4, #556270); }

        /* åˆ—è¡¨å¸ƒå±€ (KB & è¯»ä¹¦ç¬”è®°é€šç”¨) */
        .split-layout { display: flex; gap: 20px; height: 550px; border: 1px solid #e0c9b8; border-radius: 15px; overflow: hidden; background: #fff; }
        .side-nav { width: 250px; border-right: 2px dashed #e0c9b8; background: #fffaf5; overflow-y: auto; padding: 15px; }
        .nav-item { padding: 10px 12px; border-radius: 8px; cursor: pointer; margin-bottom: 5px; font-size: 0.9em; display: flex; justify-content: space-between; align-items: center; transition: 0.2s; border: 1px solid transparent; }
        .nav-item:hover { background: #ffe8d6; }
        .nav-item.active { background: #ff9a8b; color: white; font-weight: bold; }
        .main-content { flex: 1; padding: 25px; overflow-y: auto; display: flex; flex-direction: column; }

        /* æ˜Ÿæ˜Ÿè¯„åˆ† */
        .stars { color: #ffcc00; font-size: 1.2em; cursor: pointer; }
        .star-inactive { color: #ccc; }

        /* Markdown å†…å®¹æ ·å¼ */
        .markdown-content { line-height: 1.6; color: #5a4a42; }
        .markdown-content h1, .markdown-content h2 { border-bottom: 1px solid #eee; margin-bottom: 10px; padding-bottom: 5px; }

        /* æˆå°±å¡ç‰‡ */
        .ach-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; }
        .ach-card { background: #fffefc; border-radius: 15px; padding: 20px; text-align: center; border: 2px solid #5a4a42; position: relative; box-shadow: 4px 4px 0px #d4b8a7; }

        /* èµ„äº§å›¾è¡¨ */
        .chart-container { width: 100%; height: 300px; background: #fff; border: 2px solid #e0c9b8; border-radius: 15px; padding: 15px; margin-bottom: 20px; }

        [v-cloak] { display: none; }
    </style>
</head>
<body>
    <div id="app" v-cloak>
        <!-- ç™»å½• -->
        <div v-if="!isLoggedIn" class="header" style="max-width: 400px; margin: 100px auto;">
            <h1>â˜¯ï¸ ä¸ªäººç©ºé—´</h1>
            <input type="email" v-model="email" placeholder="é‚®ç®±" class="note-input" style="margin-top:20px">
            <input type="password" v-model="password" placeholder="å¯†ç " class="note-input">
            <button class="btn" @click="login">è¿›å…¥</button>
        </div>

        <!-- ä¸»ç•Œé¢ -->
        <div v-else class="container">
            <div class="header">
                <h1>ğŸ‘‹ {{ userEmail.split('@')[0] }} çš„ç¬¬äºŒå¤§è„‘</h1>
                <div style="margin-top: 15px;">
                    <button class="btn-sm" @click="syncData" :disabled="syncing">{{ syncing ? 'â˜ï¸ åŒæ­¥ä¸­...' : 'ğŸ”„ åŒæ­¥æ•°æ®' }}</button>
                    <button class="btn-sm btn-danger" @click="logout" style="margin-left: 10px;">é€€å‡º</button>
                </div>
            </div>

            <div class="grid">
                <!-- 1. çŠ¶æ€ -->
                <div class="card">
                    <h2>ğŸ“Š è§’è‰²çŠ¶æ€ <button class="collapse-btn" @click="collapsed.stats = !collapsed.stats">{{ collapsed.stats ? 'å±•å¼€' : 'æ”¶èµ·' }}</button></h2>
                    <div v-show="!collapsed.stats">
                        <div class="level-display">Lv.{{ playerData.level }}</div>
                        <div class="xp-progress"><div class="xp-fill" :style="{width: xpPercentage + '%'}"></div></div>
                        <div style="text-align: center; font-weight: bold;">{{ playerData.xp }} / {{ playerData.nextLevelXp }} XP</div>
                    </div>
                </div>

                <!-- 2. æ¯æ—¥å§”æ‰˜ -->
                <div class="card">
                    <h2>âš”ï¸ æ¯æ—¥ä»»åŠ¡ <button class="collapse-btn" @click="collapsed.quests = !collapsed.quests">{{ collapsed.quests ? 'å±•å¼€' : 'æ”¶èµ·' }}</button></h2>
                    <div v-show="!collapsed.quests">
                        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                            <input v-model="newQuestTitle" placeholder="æ·»åŠ æ–°ä»»åŠ¡..." class="note-input" style="margin-bottom: 0;">
                            <button class="btn-sm" @click="addDailyQuest">â•</button>
                        </div>
                        <div v-for="quest in playerData.dailyTasks || []" :key="quest.id" style="margin-bottom: 10px; display: flex; align-items: center; cursor: pointer;" @click="toggleQuest(quest)">
                            <div style="width: 20px; height: 20px; border: 2px solid #5a4a42; margin-right: 10px; border-radius: 4px;" :style="{background: quest.completed ? '#a3de83' : 'white'}"></div>
                            <span :style="{textDecoration: quest.completed ? 'line-through' : 'none'}">{{ quest.title }}</span>
                            <button @click.stop="deleteDailyQuest(quest.id)" style="margin-left: auto; border: none; background: none; color: #ff6b6b; cursor: pointer;">âœ•</button>
                        </div>
                    </div>
                </div>

                <!-- 3. OKR ç›®æ ‡ -->
                <div class="card">
                    <h2>ğŸ¯ é˜¶æ®µç›®æ ‡ <button class="collapse-btn" @click="collapsed.goals = !collapsed.goals">{{ collapsed.goals ? 'å±•å¼€' : 'æ”¶èµ·' }}</button></h2>
                    <div v-show="!collapsed.goals">
                        <div style="background: #fffaf5; padding: 15px; border: 2px dashed #e0c9b8; border-radius: 12px; margin-bottom: 20px;">
                            <input v-model="newGoal.title" placeholder="ç›®æ ‡å†…å®¹..." class="note-input">
                            <button class="btn" @click="addGoal">æ·»åŠ ç›®æ ‡</button>
                        </div>
                        <div v-for="(goal, index) in playerData.goals" :key="index" style="margin-bottom: 20px;">
                            <div style="display: flex; justify-content: space-between; font-weight: bold;">
                                <span>{{ goal.title }}</span>
                                <span>{{ calculateProgress(goal) }}%</span>
                            </div>
                            <div class="xp-progress" style="height: 12px;"><div class="xp-fill p-done" :style="{width: calculateProgress(goal) + '%'}"></div></div>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="number" v-model.number="goal.current" style="width: 80px;" class="note-input" @change="saveAll">
                                <button class="btn-sm btn-danger" @click="deleteGoal(index)">âœ•</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 4. çŸ¥è¯†åº“ (å¸¦æœç´¢) -->
                <div class="card">
                    <h2>ğŸ“š çŸ¥è¯†å®åº“ <button class="collapse-btn" @click="collapsed.kb = !collapsed.kb">{{ collapsed.kb ? 'å±•å¼€' : 'æ”¶èµ·' }}</button></h2>
                    <div v-show="!collapsed.kb">
                        <div class="split-layout">
                            <div class="side-nav">
                                <input v-model="kbSearchQuery" placeholder="ğŸ” æœç´¢æ–‡æ¡£..." class="search-box">
                                <div v-for="doc in filteredKbDocs" :key="doc.id" class="nav-item" :class="{active: currentKbDoc?.id === doc.id}" @click="selectKbDoc(doc)">
                                    <span style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">ğŸ“„ {{ doc.title }}</span>
                                </div>
                                <button class="btn-sm" style="width: 100%; margin-top: 10px;" @click="createNewKbDoc">+ æ–°æ–‡æ¡£</button>
                            </div>
                            <div class="main-content">
                                <div v-if="isEditingKb">
                                    <input v-model="kbEditForm.title" placeholder="æ–‡æ¡£æ ‡é¢˜" class="note-input">
                                    <textarea v-model="kbEditForm.content" placeholder="Markdown å†…å®¹..." class="note-textarea" style="height: 350px;"></textarea>
                                    <div style="display: flex; gap: 10px;">
                                        <button class="btn-sm" @click="saveKbDoc">ä¿å­˜æ–‡æ¡£</button>
                                        <button class="btn-sm btn-danger" @click="deleteKbDoc(kbEditForm.id)" v-if="kbEditForm.id">åˆ é™¤æ–‡æ¡£</button>
                                        <button class="btn-sm btn-ghost" @click="isEditingKb = false" style="background: #ccc;">å–æ¶ˆ</button>
                                    </div>
                                </div>
                                <div v-else-if="currentKbDoc">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                        <h3>{{ currentKbDoc.title }}</h3>
                                        <button class="btn-sm" @click="editKbDoc">ç¼–è¾‘</button>
                                    </div>
                                    <div class="markdown-content" v-html="renderMarkdown(currentKbDoc.content)"></div>
                                </div>
                                <div v-else style="text-align: center; margin-top: 100px; color: #999;">è¯·é€‰æ‹©æ–‡æ¡£æˆ–ç‚¹å‡»æ–°å»º</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 5. è¯»ä¹¦ç¬”è®° (æ–°æ·»åŠ  & å¸¦æœç´¢) -->
                <div class="card">
                    <h2>ğŸ“– è¯»ä¹¦ç¬”è®° <button class="collapse-btn" @click="collapsed.books = !collapsed.books">{{ collapsed.books ? 'å±•å¼€' : 'æ”¶èµ·' }}</button></h2>
                    <div v-show="!collapsed.books">
                        <div class="split-layout">
                            <div class="side-nav">
                                <input v-model="bookSearchQuery" placeholder="ğŸ” æœç´¢ä¹¦ç±/ä½œè€…/æ ‡ç­¾..." class="search-box">
                                <div v-for="book in filteredBooks" :key="book.id" class="nav-item" :class="{active: currentBook?.id === book.id}" @click="selectBook(book)">
                                    <div style="overflow: hidden;">
                                        <div style="font-weight: bold; white-space: nowrap; text-overflow: ellipsis;">{{ book.title }}</div>
                                        <div style="font-size: 0.75em; opacity: 0.8;">{{ book.author }}</div>
                                    </div>
                                </div>
                                <button class="btn-sm" style="width: 100%; margin-top: 10px;" @click="createNewBook">+ è®°ç¬”è®°</button>
                            </div>
                            <div class="main-content">
                                <div v-if="isEditingBook">
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                        <input v-model="bookEditForm.title" placeholder="ä¹¦å" class="note-input">
                                        <input v-model="bookEditForm.author" placeholder="ä½œè€…" class="note-input">
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                                        <span>è¯„åˆ†:</span>
                                        <span class="stars">
                                            <span v-for="i in 5" :key="i" @click="bookEditForm.rating = i" :class="{'star-inactive': i > bookEditForm.rating}">â˜…</span>
                                        </span>
                                        <input v-model="bookEditForm.tags" placeholder="æ ‡ç­¾ (ç”¨é€—å·éš”å¼€)" class="note-input" style="margin:0; flex:1">
                                    </div>
                                    <textarea v-model="bookEditForm.content" placeholder="ç²¾å½©ç¬”è®°..." class="note-textarea" style="height: 150px;"></textarea>
                                    <textarea v-model="bookEditForm.reflection" placeholder="ä¸ªäººæ„Ÿæƒ³..." class="note-textarea" style="height: 100px;"></textarea>
                                    <div style="display: flex; gap: 10px;">
                                        <button class="btn-sm" @click="saveBook">ä¿å­˜ç¬”è®°</button>
                                        <button class="btn-sm btn-danger" @click="deleteBook(bookEditForm.id)" v-if="bookEditForm.id">åˆ é™¤</button>
                                        <button class="btn-sm" @click="isEditingBook = false" style="background: #ccc;">å–æ¶ˆ</button>
                                    </div>
                                </div>
                                <div v-else-if="currentBook">
                                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                        <div>
                                            <h3 style="font-size: 1.5em; margin-bottom: 5px;">{{ currentBook.title }}</h3>
                                            <div style="color: #7a6a62;">ä½œè€…: {{ currentBook.author }} | æ ‡ç­¾: {{ currentBook.tags }}</div>
                                            <div class="stars">è¯„åˆ†: <span v-for="i in 5" :key="i" :class="{'star-inactive': i > currentBook.rating}">â˜…</span></div>
                                        </div>
                                        <button class="btn-sm" @click="editBook">ç¼–è¾‘</button>
                                    </div>
                                    <hr style="margin: 20px 0; border: none; border-top: 1px dashed #e0c9b8;">
                                    <div class="markdown-content">
                                        <h4>ğŸ“ ç²¾å½©ç¬”è®°</h4>
                                        <div v-html="renderMarkdown(currentBook.content)"></div>
                                        <h4 style="margin-top:20px">ğŸ’¡ ä¸ªäººæ„Ÿæƒ³</h4>
                                        <div v-html="renderMarkdown(currentBook.reflection)"></div>
                                    </div>
                                </div>
                                <div v-else style="text-align: center; margin-top: 100px; color: #999;">å¼€å§‹ä½ çš„é˜…è¯»ä¹‹æ—…å§</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 6. æˆå°±ç³»ç»Ÿ -->
                <div class="card">
                    <h2>ğŸ† æˆå°±è£è€€ <button class="collapse-btn" @click="collapsed.ach = !collapsed.ach">{{ collapsed.ach ? 'å±•å¼€' : 'æ”¶èµ·' }}</button></h2>
                    <div v-show="!collapsed.ach">
                        <div style="background: #fffaf5; padding: 15px; border: 2px dashed #e0c9b8; border-radius: 12px; margin-bottom: 20px; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                            <input v-model="newAch.name" placeholder="æˆå°±åç§°" class="note-input" style="margin:0">
                            <input v-model="newAch.icon" placeholder="å›¾æ ‡" class="note-input" style="margin:0">
                            <input v-model.number="newAch.requirement" type="number" placeholder="ç›®æ ‡å€¼" class="note-input" style="margin:0">
                            <button class="btn-sm" @click="addAchievement" style="grid-column: span 3;">æ·»åŠ æˆå°±</button>
                        </div>
                        <div class="ach-grid">
                            <div v-for="ach in achievements" :key="ach.id" class="ach-card">
                                <span @click="deleteAchievement(ach.id)" style="position:absolute; top:5px; right:10px; cursor:pointer; color:#ccc;">âœ•</span>
                                <div style="font-size: 2.5em; margin-bottom: 10px;">{{ ach.icon }}</div>
                                <h3>{{ ach.name }}</h3>
                                <div style="font-weight: bold; color: #ff6b6b; margin: 5px 0;">{{ ach.current }} / {{ ach.requirement }}</div>
                                <button class="btn-sm" @click="updateAch(ach, 1)">+1</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 7. å¤ç›˜ & èµ„äº§ -->
                <div class="card">
                    <h2>ğŸ”„ å¤ç›˜èµ„äº§ <button class="collapse-btn" @click="collapsed.reviews = !collapsed.reviews">{{ collapsed.reviews ? 'å±•å¼€' : 'æ”¶èµ·' }}</button></h2>
                    <div v-show="!collapsed.reviews">
                        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                            <button class="btn-sm" @click="activeReviewTab = 'stock'">ğŸ“ˆ èµ„äº§æ›²çº¿</button>
                            <button class="btn-sm" @click="activeReviewTab = 'daily'">ğŸ“ æ—¥å¸¸å¤ç›˜</button>
                            <button class="btn-sm btn-danger" @click="showReviewForm = !showReviewForm">æ–°å¢è®°å½•</button>
                        </div>
                        <div v-show="activeReviewTab === 'stock'" class="chart-container">
                            <canvas id="assetChart"></canvas>
                        </div>
                        <div v-if="showReviewForm" style="background: #fffaf5; padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 2px dashed #ff9a8b;">
                            <input v-if="activeReviewTab === 'stock'" v-model="newStockData.totalAsset" type="number" placeholder="ä»Šæ—¥èµ„äº§æ€»å‡€å€¼" class="note-input">
                            <input v-model="newNote.title" placeholder="æ ‡é¢˜" class="note-input">
                            <textarea v-model="newNote.content" placeholder="å†…å®¹..." class="note-textarea"></textarea>
                            <button class="btn" @click="saveNote">ğŸ’¾ ä¿å­˜</button>
                        </div>
                        <div v-for="note in filteredNotes" :key="note.id" class="card" style="margin-bottom:15px; padding:15px; box-shadow:none;">
                            <div style="font-size: 0.8em; color: #999;">{{ formatDate(note.createdAt) }}</div>
                            <h3 style="margin: 5px 0;">{{ note.title }}</h3>
                            <p style="white-space: pre-wrap;">{{ note.content }}</p>
                            <button class="btn-sm btn-danger" @click="deleteNote(note.id)" style="margin-top: 10px; float: right;">åˆ é™¤</button>
                            <div style="clear: both;"></div>
                        </div>
                    </div>
                </div>

                <!-- æŠ€èƒ½ã€å•†åº—ã€æ˜“å­¦å†…å®¹... (ä¿æŒåŸæœ‰) -->
                <div class="card">
                    <h2>âš¡ æŠ€èƒ½ & å•†åº— <button class="collapse-btn" @click="collapsed.skills = !collapsed.skills">{{ collapsed.skills ? 'å±•å¼€' : 'æ”¶èµ·' }}</button></h2>
                    <div v-show="!collapsed.skills">
                        <!-- æŠ€èƒ½ -->
                        <div v-for="skill in skills" :key="skill.id" style="margin-bottom: 15px; padding: 10px; background: #fffaf5; border-radius: 10px; border: 1px solid #e0c9b8; display: flex; justify-content: space-between; align-items: center;">
                            <div style="flex:1">
                                <strong>{{ skill.name }} (Lv.{{ skill.level }})</strong>
                                <div class="xp-progress" style="height: 6px;"><div class="xp-fill" :style="{width: (skill.xp/skill.maxXp*100)+'%'}"></div></div>
                            </div>
                            <button class="btn-sm" @click="practiceSkill(skill.id)" style="margin-left: 10px;">ç»ƒä¹ </button>
                        </div>
                        <hr style="margin: 15px 0; border: none; border-top: 1px dashed #ccc;">
                        <!-- å•†åº— -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px;">
                            <div v-for="item in playerData.shopItems" :key="item.id" style="text-align: center; padding: 10px; border: 1px solid #e0c9b8; border-radius: 10px;">
                                <div style="font-size: 2em;">{{ item.icon }}</div>
                                <div>{{ item.name }}</div>
                                <div style="color: #ff9a8b; font-weight: bold;">{{ item.cost }} XP</div>
                                <button class="btn-sm" @click="buyItem(item)" :disabled="playerData.xp < item.cost" style="width: 100%; margin-top: 5px;">å…‘æ¢</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2>â˜¯ï¸ æ˜“å­¦å‘½ä¾‹ <button class="collapse-btn" @click="collapsed.cases = !collapsed.cases">{{ collapsed.cases ? 'å±•å¼€' : 'æ”¶èµ·' }}</button></h2>
                    <div v-show="!collapsed.cases">
                        <input v-model="newCase.title" placeholder="å‘½ä¸»ç§°å‘¼" class="note-input" style="width: auto; margin-right: 10px;">
                        <button class="btn-sm" @click="saveCase">ä¿å­˜å‘½ä¾‹</button>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
                            <div v-for="c in cases" :key="c.id" @click="viewCase(c)" style="padding: 15px; background: #fff; border: 2px solid #e0c9b8; border-radius: 15px; cursor: pointer;">
                                <strong>{{ c.title }}</strong>
                                <div style="font-size: 0.8em; color: #999;">{{ formatDate(c.createdAt) }}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- å‘½ä¾‹è¯¦æƒ…å¼¹çª— -->
        <div v-if="viewingItem" class="kb-overlay" @click.self="viewingItem = null">
            <div class="card" style="width: 90%; max-width: 500px;">
                <h2>{{ viewingItem.title }}</h2>
                <textarea v-model="viewingItem.content" class="note-textarea" style="height: 300px;" @change="saveAll"></textarea>
                <button class="btn" @click="viewingItem = null">å…³é—­</button>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://zqmgigcnruvvdcholbuj.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpxbWdpZ2NucnV2dmRjaG9sYnVqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4NjgzNjEsImV4cCI6MjA4MTQ0NDM2MX0.IHzDp7o5M9QM8IBWy2ri5gS9h9nm0zk3AaPTNveDqXI';
        const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    isLoggedIn: false, userId: null, userEmail: '', email: '', password: '', syncing: false,
                    collapsed: { stats: false, quests: false, goals: false, kb: false, books: false, ach: false, reviews: false, skills: true, cases: true },
                    
                    playerData: { level: 1, xp: 0, nextLevelXp: 100, goals: [], dailyTasks: [], shopItems: [
                        {id: 1, name: 'å–å¥¶èŒ¶', icon: 'ğŸ¥¤', cost: 50}, {id: 2, name: 'ç©æ¸¸æˆ', icon: 'ğŸ®', cost: 100}
                    ], assetHistory: [] },

                    // çŸ¥è¯†åº“
                    kbDocs: [], currentKbDoc: null, isEditingKb: false, kbSearchQuery: '',
                    kbEditForm: { id: null, title: '', content: '' },

                    // è¯»ä¹¦ç¬”è®°
                    books: [], currentBook: null, isEditingBook: false, bookSearchQuery: '',
                    bookEditForm: { id: null, title: '', author: '', rating: 5, tags: '', content: '', reflection: '' },

                    // å…¶ä»–æ¨¡å—
                    achievements: [], newAch: { name: '', icon: 'ğŸ†', requirement: 10, current: 0 },
                    skills: [], notes: [], cases: [],
                    newGoal: { title: '', current: 0, target: 100 },
                    newQuestTitle: '',
                    activeReviewTab: 'stock', showReviewForm: false,
                    newNote: { title: '', content: '' },
                    newStockData: { totalAsset: null },
                    newCase: { title: '', content: '' },
                    viewingItem: null, chartInstance: null
                }
            },
            computed: {
                xpPercentage() { return Math.min(100, (this.playerData.xp / this.playerData.nextLevelXp) * 100); },
                filteredKbDocs() {
                    const q = this.kbSearchQuery.toLowerCase();
                    return this.kbDocs.filter(d => d.title.toLowerCase().includes(q) || d.content.toLowerCase().includes(q));
                },
                filteredBooks() {
                    const q = this.bookSearchQuery.toLowerCase();
                    return this.books.filter(b => b.title.toLowerCase().includes(q) || b.author.toLowerCase().includes(q) || b.tags.toLowerCase().includes(q));
                },
                filteredNotes() {
                    return this.notes.filter(n => n.type === this.activeReviewTab).sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));
                }
            },
            methods: {
                formatDate(s) { return new Date(s).toLocaleString(); },
                renderMarkdown(t) { return marked.parse(t || ''); },
                
                async login() {
                    const { data, error } = await sb.auth.signInWithPassword({ email: this.email, password: this.password });
                    if (error) return alert(error.message);
                    this.isLoggedIn = true; this.userId = data.user.id; this.userEmail = data.user.email;
                    this.loadData();
                },
                async logout() { await sb.auth.signOut(); location.reload(); },

                async loadData() {
                    const [p, s, a, n, k, c, b] = await Promise.all([
                        sb.from('players').select('*').eq('user_id', this.userId).single(),
                        sb.from('skills').select('*').eq('user_id', this.userId),
                        sb.from('achievements').select('*').eq('user_id', this.userId),
                        sb.from('notes').select('*').eq('user_id', this.userId),
                        sb.from('kb_notes').select('*').eq('user_id', this.userId),
                        sb.from('cases').select('*').eq('user_id', this.userId),
                        sb.from('books').select('*').eq('user_id', this.userId)
                    ]);
                    if(p.data) this.playerData = { ...this.playerData, ...p.data.data };
                    if(s.data) this.skills = s.data.map(i => i.data);
                    if(a.data) this.achievements = a.data.map(i => i.data);
                    if(n.data) this.notes = n.data.map(i => i.data);
                    if(k.data) this.kbDocs = k.data.map(i => i.data);
                    if(c.data) this.cases = c.data.map(i => i.data);
                    if(b.data) this.books = b.data.map(i => i.data);
                    this.loadChart();
                },

                async saveAll() {
                    const save = async (t, d) => {
                        await sb.from(t).delete().eq('user_id', this.userId);
                        if(d && d.length) await sb.from(t).insert(d.map(x => ({ user_id: this.userId, data: x })));
                    };
                    await sb.from('players').upsert({ user_id: this.userId, data: this.playerData });
                    await Promise.all([save('skills', this.skills), save('achievements', this.achievements), save('notes', this.notes), save('kb_notes', this.kbDocs), save('cases', this.cases), save('books', this.books)]);
                },
                async syncData() { this.syncing = true; await this.saveAll(); this.syncing = false; alert('æ•°æ®å·²åŒæ­¥'); },

                // çŸ¥è¯†åº“é€»è¾‘
                createNewKbDoc() { this.kbEditForm = { id: null, title: '', content: '' }; this.isEditingKb = true; },
                selectKbDoc(doc) { this.currentKbDoc = doc; this.isEditingKb = false; },
                editKbDoc() { this.kbEditForm = { ...this.currentKbDoc }; this.isEditingKb = true; },
                saveKbDoc() {
                    const now = new Date().toISOString();
                    if(this.kbEditForm.id) {
                        const idx = this.kbDocs.findIndex(d => d.id === this.kbEditForm.id);
                        this.kbDocs[idx] = { ...this.kbEditForm, updatedAt: now };
                    } else {
                        const newDoc = { ...this.kbEditForm, id: Date.now(), createdAt: now };
                        this.kbDocs.unshift(newDoc);
                        this.kbEditForm.id = newDoc.id;
                    }
                    this.currentKbDoc = { ...this.kbDocs.find(d => d.id === this.kbEditForm.id) };
                    this.isEditingKb = false; this.saveAll();
                },
                deleteKbDoc(id) { if(confirm('åˆ é™¤æ–‡æ¡£ï¼Ÿ')) { this.kbDocs = this.kbDocs.filter(d=>d.id!==id); this.currentKbDoc = null; this.isEditingKb = false; this.saveAll(); } },

                // è¯»ä¹¦ç¬”è®°é€»è¾‘
                createNewBook() { this.bookEditForm = { id: null, title: '', author: '', rating: 5, tags: '', content: '', reflection: '' }; this.isEditingBook = true; },
                selectBook(book) { this.currentBook = book; this.isEditingBook = false; },
                editBook() { this.bookEditForm = { ...this.currentBook }; this.isEditingBook = true; },
                saveBook() {
                    const now = new Date().toISOString();
                    if(this.bookEditForm.id) {
                        const idx = this.books.findIndex(b => b.id === this.bookEditForm.id);
                        this.books[idx] = { ...this.bookEditForm, updatedAt: now };
                    } else {
                        const newBook = { ...this.bookEditForm, id: Date.now(), createdAt: now };
                        this.books.unshift(newBook);
                        this.bookEditForm.id = newBook.id;
                    }
                    this.currentBook = { ...this.books.find(b => b.id === this.bookEditForm.id) };
                    this.isEditingBook = false; this.addXp(20); this.saveAll();
                },
                deleteBook(id) { if(confirm('ç¡®è®¤åˆ é™¤è¿™æœ¬è¯»ä¹¦ç¬”è®°ï¼Ÿ')) { this.books = this.books.filter(b=>b.id!==id); this.currentBook = null; this.isEditingBook = false; this.saveAll(); } },

                // èµ„äº§å›¾è¡¨
                loadChart() {
                    setTimeout(() => {
                        const ctx = document.getElementById('assetChart'); if(!ctx) return;
                        if(this.chartInstance) this.chartInstance.destroy();
                        const history = (this.playerData.assetHistory || []).sort((a,b)=>new Date(a.date)-new Date(b.date));
                        this.chartInstance = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: history.map(h => new Date(h.date).toLocaleDateString()),
                                datasets: [{ label: 'å‡€å€¼', data: history.map(h=>h.value), borderColor: '#ff9a8b', tension: 0.3, fill: true, backgroundColor: 'rgba(255,154,139,0.1)' }]
                            },
                            options: { responsive: true, maintainAspectRatio: false }
                        });
                    }, 400);
                },

                // é€šç”¨é€»è¾‘
                addGoal() { this.playerData.goals.push({...this.newGoal}); this.newGoal = {title:'', current:0, target:100}; this.saveAll(); },
                deleteGoal(i) { this.playerData.goals.splice(i,1); this.saveAll(); },
                calculateProgress(g) { return Math.round((g.current/g.target)*100); },
                addDailyQuest() { if(this.newQuestTitle) { this.playerData.dailyTasks.push({id:Date.now(), title:this.newQuestTitle, completed:false}); this.newQuestTitle=''; this.saveAll(); } },
                toggleQuest(q) { q.completed = !q.completed; if(q.completed) this.addXp(5); this.saveAll(); },
                deleteDailyQuest(id) { this.playerData.dailyTasks = this.playerData.dailyTasks.filter(t=>t.id!==id); this.saveAll(); },
                addAchievement() { this.achievements.push({...this.newAch, id:Date.now()}); this.newAch = {name:'', icon:'ğŸ†', requirement:10, current:0}; this.saveAll(); },
                updateAch(ach, v) { ach.current += v; this.saveAll(); },
                deleteAchievement(id) { this.achievements = this.achievements.filter(a=>a.id!==id); this.saveAll(); },
                saveNote() {
                    const note = { id: Date.now(), type: this.activeReviewTab, createdAt: new Date().toISOString(), ...this.newNote };
                    this.notes.unshift(note);
                    if(this.activeReviewTab === 'stock' && this.newStockData.totalAsset) {
                        this.playerData.assetHistory.push({ date: new Date().toISOString(), value: this.newStockData.totalAsset });
                        this.loadChart();
                    }
                    this.newNote = { title:'', content:'' }; this.showReviewForm = false; this.addXp(10); this.saveAll();
                },
                practiceSkill(id) { const s = this.skills.find(x=>x.id===id); if(s) { s.xp+=20; if(s.xp>=s.maxXp) { s.xp=0; s.level++; s.maxXp*=1.5; } this.saveAll(); } },
                addXp(v) { this.playerData.xp += v; if(this.playerData.xp >= this.playerData.nextLevelXp) { this.playerData.xp -= this.playerData.nextLevelXp; this.playerData.level++; } },
                buyItem(item) { this.playerData.xp -= item.cost; alert('å…‘æ¢æˆåŠŸ!'); this.saveAll(); },
                saveCase() { this.cases.unshift({id:Date.now(), title:this.newCase.title, content:'', createdAt:new Date().toISOString()}); this.newCase.title=''; this.saveAll(); },
                viewCase(c) { this.viewingItem = c; },
                deleteNote(id) { this.notes = this.notes.filter(n=>n.id!==id); this.saveAll(); }
            },
            mounted() {
                sb.auth.getSession().then(({ data: { session } }) => {
                    if(session) { this.isLoggedIn = true; this.userId = session.user.id; this.userEmail = session.user.email; this.loadData(); }
                });
            }
        }).mount('#app');
    </script>
</body>
</html>

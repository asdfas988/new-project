<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÊàêÈïøÊâãË¥¶</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Noto Sans SC', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #fef9f3;
            min-height: 100vh;
            color: #5a4a42;
            padding: 20px;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px;
            background: #fffaf0;
            border-radius: 24px;
            box-shadow: 8px 8px 0px #e0c9b8;
            border: 3px solid #5a4a42;
            position: relative;
        }
        .header h1 {
            font-size: 2.5em;
            font-weight: 700;
            text-shadow: 3px 3px 0px #ffd6cc;
        }
        .grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }
        .card {
            background: #fffefc;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 6px 6px 0px #d4b8a7;
            border: 2.5px solid #5a4a42;
            transition: all 0.3s;
        }
        .card:hover { transform: translateY(-5px); }
        .card h2 {
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 3px dotted #ff9a8b;
            font-size: 1.4em;
            font-weight: 700;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .btn {
            background: linear-gradient(90deg, #ff9a8b, #ff6b6b);
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            color: white;
            cursor: pointer;
            font-size: 16px;
            font-weight: 700;
            font-family: inherit;
            transition: all 0.3s;
            width: 100%;
            margin-top: 15px;
            box-shadow: 4px 4px 0px #d45d5d;
        }
        .btn:hover:not(:disabled) { transform: translateY(-2px); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-sm {
            padding: 8px 20px;
            font-size: 0.9em;
            width: auto;
            border-radius: 25px;
            background: linear-gradient(90deg, #4ecdc4, #a3de83);
            box-shadow: 3px 3px 0px #2ba69b;
            border: none;
            color: white;
            font-weight: bold;
            cursor: pointer;
            margin: 0;
            font-family: inherit;
        }
        .collapse-btn {
            background: #fffaf5;
            border: 2px solid #ff9a8b;
            cursor: pointer;
            font-size: 0.85em;
            color: #ff6b6b;
            padding: 5px 12px;
            border-radius: 15px;
            font-family: inherit;
            font-weight: bold;
        }
        .note-input, .note-textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0c9b8;
            border-radius: 12px;
            font-size: 16px;
            font-family: inherit;
            margin-bottom: 15px;
            background: #fffaf9;
        }
        .note-textarea { min-height: 180px; resize: vertical; }
        .note-input:focus, .note-textarea:focus {
            outline: none;
            border-color: #ff9a8b;
            box-shadow: 2px 2px 0px #ffd6cc;
        }
        .status-message {
            padding: 15px 25px;
            border-radius: 12px;
            margin: 20px 0;
            font-weight: 700;
            border: 2px solid;
        }
        .status-success {
            background: rgba(163, 222, 131, 0.9);
            color: #2d5a27;
            border-color: #2ba69b;
        }
        .status-error {
            background: rgba(255, 154, 139, 0.9);
            color: #7a2c28;
            border-color: #d45d5d;
        }
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 154, 139, 0.3);
            border-radius: 50%;
            border-top-color: #ff6b6b;
            animation: spin 1s infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .level-display {
            font-size: 4.5em;
            font-weight: 800;
            text-align: center;
            margin: 25px 0;
            color: #ff6b6b;
            text-shadow: 3px 3px 0px #ffd6cc;
        }
        .xp-progress {
            height: 24px;
            background: #ffe8d6;
            border-radius: 12px;
            margin: 15px 0;
            overflow: hidden;
            border: 2px solid #5a4a42;
        }
        .xp-fill {
            height: 100%;
            background: linear-gradient(90deg, #4ecdc4, #a3de83);
            transition: width 0.5s ease;
        }
        .skill-item {
            padding: 18px;
            background: #fffaf5;
            border-radius: 15px;
            margin: 15px 0;
            border: 2px solid #e0c9b8;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .achievement-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
            gap: 20px;
            margin-top: 25px;
        }
        .achievement-card {
            background: #fffefc;
            border-radius: 18px;
            padding: 20px;
            box-shadow: 4px 4px 0px #d4b8a7;
            border: 2px solid #5a4a42;
        }
        .achievement-card.locked { opacity: 0.6; filter: grayscale(0.4); }
        .achievement-icon {
            font-size: 2.5em;
            text-align: center;
            margin-bottom: 15px;
        }
        .achievement-progress {
            height: 10px;
            background: #ffe8d6;
            border-radius: 6px;
            margin: 15px 0;
            overflow: hidden;
        }
        .achievement-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff9a8b, #ff6b6b);
            transition: width 0.6s ease;
        }
        .note-tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0c9b8;
            padding-bottom: 10px;
        }
        .note-tab {
            padding: 10px 20px;
            border: 2px solid #e0c9b8;
            background: #fffaf5;
            border-radius: 15px 15px 0 0;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        .note-tab.active {
            background: linear-gradient(90deg, #ff9a8b, #ff6b6b);
            color: white;
            border-color: #ff6b6b;
            transform: translateY(2px);
        }
        .note-list { margin-top: 20px; }
        .note-card {
            background: #fffaf5;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 15px;
            border: 2px solid #e0c9b8;
        }
        .note-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }
        .note-tag {
            background: linear-gradient(90deg, #4ecdc4, #a3de83);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
        }
        .achievement-form-container {
            background: #fffaf5;
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
            border: 2px solid #e0c9b8;
        }
        .achievement-icon-picker {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 10px;
            margin: 15px 0;
        }
        .achievement-icon-option {
            font-size: 2em;
            padding: 10px;
            border: 2px solid #e0c9b8;
            border-radius: 10px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
            background: white;
        }
        .achievement-icon-option:hover {
            transform: scale(1.1);
            border-color: #ff9a8b;
        }
        .achievement-icon-option.selected {
            border-color: #ff6b6b;
            background: #ffebe8;
            box-shadow: 3px 3px 0px #d4b8a7;
        }
        .collapsible-content {
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        .achievement-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            margin-top: 10px;
        }
        .achievement-actions button {
            padding: 6px 12px;
            border: 2px solid #e0c9b8;
            background: #fffaf5;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.9em;
            font-family: inherit;
            font-weight: 600;
            transition: all 0.2s;
        }
        .achievement-actions button:hover {
            background: #ff9a8b;
            color: white;
            border-color: #ff6b6b;
        }
        .filter-container {
            background: #fffaf5;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 2px solid #e0c9b8;
        }
        .filter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }
        .filter-header h3 {
            font-weight: 700;
            color: #5a4a42;
        }
        .filter-toggle {
            background: #fffaf5;
            border: 2px solid #ff9a8b;
            color: #ff6b6b;
            padding: 5px 12px;
            border-radius: 15px;
            font-weight: bold;
            font-size: 0.9em;
        }
        .filter-options {
            margin-top: 20px;
        }
        .filter-section {
            margin-bottom: 20px;
        }
        .filter-section h4 {
            color: #5a4a42;
            margin-bottom: 10px;
            font-family: inherit;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .filter-active-indicator {
            width: 8px;
            height: 8px;
            background: #ff6b6b;
            border-radius: 50%;
            display: inline-block;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .tags-filter {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .tag-filter-btn {
            padding: 8px 16px;
            border: 2px solid #e0c9b8;
            background: white;
            border-radius: 20px;
            cursor: pointer;
            font-family: inherit;
            font-weight: 600;
            transition: all 0.3s;
        }
        .tag-filter-btn:hover {
            border-color: #ff9a8b;
            background: #fff5e6;
        }
        .tag-filter-btn.active {
            background: linear-gradient(90deg, #4ecdc4, #a3de83);
            color: white;
            border-color: #2ba69b;
        }
        .sort-options {
            display: flex;
            gap: 10px;
        }
        .sort-btn {
            padding: 10px 20px;
            border: 2px solid #e0c9b8;
            background: white;
            border-radius: 15px;
            cursor: pointer;
            font-family: inherit;
            font-weight: 600;
            transition: all 0.3s;
        }
        .sort-btn:hover {
            border-color: #ff9a8b;
            background: #fff5e6;
        }
        .sort-btn.active {
            background: linear-gradient(90deg, #ff9a8b, #ff6b6b);
            color: white;
            border-color: #ff6b6b;
        }
        .filter-results {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 15px;
            border-top: 2px dotted #e0c9b8;
            font-weight: 600;
            color: #7a6a62;
        }
        .clear-filters-btn {
            padding: 8px 16px;
            border: 2px solid #ff9a8b;
            background: white;
            border-radius: 20px;
            cursor: pointer;
            font-family: inherit;
            font-weight: 600;
            color: #ff6b6b;
            transition: all 0.3s;
        }
        .clear-filters-btn:hover {
            background: #ff9a8b;
            color: white;
        }
        .no-notes-message {
            text-align: center;
            padding: 40px 20px;
            color: #c9b8a7;
            font-size: 1.1em;
        }
        .no-notes-message div:first-child {
            font-size: 3em;
            margin-bottom: 10px;
        }

        /* ========== ËØª‰π¶Á¨îËÆ∞Ê†∑Âºè ========== */
        .book-tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0c9b8;
            padding-bottom: 10px;
        }
        .book-tab {
            padding: 10px 20px;
            border: 2px solid #e0c9b8;
            background: #fffaf5;
            border-radius: 15px 15px 0 0;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        .book-tab.active {
            background: linear-gradient(90deg, #667eea, #764ba2);
            color: white;
            border-color: #5a4a42;
            transform: translateY(2px);
        }
        .book-form-group {
            margin-bottom: 20px;
        }
        .book-form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 700;
            color: #5a4a42;
            font-family: inherit;
        }
        .book-rating {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            justify-content: center;
        }
        .star-rating {
            font-size: 2em;
            cursor: pointer;
            transition: all 0.2s;
            color: #e0c9b8;
        }
        .star-rating:hover {
            transform: scale(1.2);
        }
        .star-rating.filled {
            color: #ffd700;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }
        .book-tag-picker {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
        }
        .book-tag-option {
            padding: 8px 16px;
            border: 2px solid #e0c9b8;
            background: white;
            border-radius: 20px;
            cursor: pointer;
            font-family: inherit;
            font-weight: 600;
            transition: all 0.3s;
        }
        .book-tag-option:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }
        .book-tag-option.selected {
            background: linear-gradient(90deg, #667eea, #764ba2);
            color: white;
            border-color: #5a4a42;
        }
        .book-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .book-card {
            background: #fffefc;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 4px 4px 0px #d4b8a7;
            border: 2px solid #e0c9b8;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .book-card:hover {
            transform: translateY(-5px);
            box-shadow: 6px 6px 0px #d4b8a7;
            border-color: #667eea;
        }
        .book-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 10px;
        }
        .book-header h3 {
            font-weight: 700;
            font-size: 1.2em;
            color: #5a4a42;
            margin: 0;
            flex: 1;
        }
        .book-author {
            color: #7a6a62;
            font-size: 0.95em;
            font-style: italic;
        }
        .book-rating-display {
            font-size: 1.2em;
            color: #ffd700;
            margin: 5px 0;
        }
        .book-content {
            color: #5a4a42;
            font-size: 0.95em;
            line-height: 1.6;
            flex: 1;
        }
        .book-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 10px;
            border-top: 1px dotted #e0c9b8;
        }
        .book-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        .book-tag {
            background: linear-gradient(90deg, #667eea, #764ba2);
            color: white;
            padding: 3px 10px;
            border-radius: 10px;
            font-size: 0.8em;
            font-weight: 600;
        }
        .book-actions {
            display: flex;
            gap: 8px;
        }
        .book-action-btn {
            background: #fffaf5;
            border: 1px solid #e0c9b8;
            border-radius: 8px;
            padding: 6px 10px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.2s;
        }
        .book-action-btn:hover {
            background: #ff9a8b;
            transform: scale(1.1);
        }
        .book-status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
            margin-left: 10px;
        }
        .book-status.reading {
            background: #ff9a8b;
            color: white;
        }
        .book-status.finished {
            background: linear-gradient(90deg, #4ecdc4, #a3de83);
            color: white;
        }
        .book-status.planning {
            background: #e0c9b8;
            color: #5a4a42;
        }

        /* ========== Áü•ËØÜÂ∫ìÊ†∑Âºè ========== */
        .kb-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }
        .kb-modal {
            background: #fef9f3;
            border-radius: 24px;
            width: 95%;
            max-width: 1400px;
            height: 90vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            border: 3px solid #5a4a42;
            overflow: hidden;
        }
        .kb-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 3px solid #5a4a42;
        }
        .kb-header h1 {
            font-weight: 700;
            font-size: 1.8em;
            margin: 0;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }
        .kb-close-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid white;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .kb-close-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }
        .kb-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        .kb-sidebar {
            width: 280px;
            background: #fffaf0;
            border-right: 3px solid #e0c9b8;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }
        .kb-sidebar-header {
            padding: 20px;
            border-bottom: 2px dotted #ff9a8b;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .kb-sidebar-header h3 {
            font-weight: 700;
            color: #5a4a42;
            margin: 0;
        }
        .kb-category-list {
            padding: 10px;
        }
        .kb-category-item {
            padding: 12px 15px;
            margin: 5px 0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            background: #fffefc;
            border: 2px solid transparent;
            position: relative;
        }
        .kb-category-item:hover {
            background: #fff5e6;
            border-color: #ff9a8b;
            transform: translateX(5px);
        }
        .kb-category-item.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #5a4a42;
            box-shadow: 4px 4px 0px #d4b8a7;
        }
        .kb-category-icon {
            font-size: 1.3em;
        }
        .kb-category-name {
            flex: 1;
            font-weight: 600;
        }
        .kb-category-count {
            font-size: 0.85em;
            opacity: 0.7;
        }
        .kb-category-actions {
            display: none;
            gap: 5px;
        }
        .kb-category-item:hover .kb-category-actions {
            display: flex;
        }
        .kb-category-actions button {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #e0c9b8;
            border-radius: 6px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.2s;
        }
        .kb-category-actions button:hover {
            background: #ff9a8b;
            transform: scale(1.1);
        }
        .kb-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .kb-toolbar {
            padding: 20px;
            background: #fffaf0;
            border-bottom: 2px dotted #ff9a8b;
            display: flex;
            gap: 15px;
            align-items: center;
        }
        .kb-search-input {
            flex: 1;
            padding: 12px 20px;
            border: 2px solid #e0c9b8;
            border-radius: 25px;
            font-size: 16px;
            font-family: inherit;
            background: #fffefc;
            transition: all 0.3s;
        }
        .kb-search-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .btn-primary {
            background: linear-gradient(90deg, #667eea, #764ba2);
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            color: white;
            cursor: pointer;
            font-size: 16px;
            font-weight: 700;
            font-family: inherit;
            transition: all 0.3s;
            box-shadow: 4px 4px 0px #5a4a42;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 6px 6px 0px #5a4a42;
        }
        .btn-secondary {
            background: #e0c9b8;
            border: 2px solid #5a4a42;
            padding: 12px 24px;
            border-radius: 25px;
            color: #5a4a42;
            cursor: pointer;
            font-size: 16px;
            font-weight: 700;
            font-family: inherit;
            transition: all 0.3s;
        }
        .btn-secondary:hover {
            background: #d4b8a7;
            transform: translateY(-2px);
        }
        .kb-notes-list {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            align-content: start;
        }
        .kb-empty {
            grid-column: 1 / -1;
            text-align: center;
            padding: 60px 20px;
            color: #a0a0a0;
        }
        .kb-empty-icon {
            font-size: 4em;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        .kb-empty p {
            font-size: 1.1em;
            font-family: inherit;
        }
        .kb-note-card {
            background: #fffefc;
            border-radius: 16px;
            padding: 20px;
            border: 2px solid #e0c9b8;
            box-shadow: 4px 4px 0px #d4b8a7;
            cursor: pointer;
            transition: all 0.3s;
            height: fit-content;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .kb-note-card:hover {
            transform: translateY(-5px);
            box-shadow: 6px 6px 0px #d4b8a7;
            border-color: #667eea;
        }
        .kb-note-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            gap: 10px;
        }
        .kb-note-header h3 {
            font-weight: 700;
            font-size: 1.2em;
            color: #5a4a42;
            margin: 0;
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        .kb-note-date {
            font-size: 0.85em;
            color: #a0a0a0;
            white-space: nowrap;
        }
        .kb-note-preview {
            color: #7a6a62;
            font-size: 0.95em;
            line-height: 1.6;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
        }
        .kb-note-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 10px;
            border-top: 1px dotted #e0c9b8;
        }
        .kb-note-category {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
        }
        .kb-note-actions {
            display: flex;
            gap: 8px;
        }
        .kb-action-btn {
            background: #fffaf5;
            border: 1px solid #e0c9b8;
            border-radius: 8px;
            padding: 6px 10px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.2s;
        }
        .kb-action-btn:hover {
            background: #ff9a8b;
            transform: scale(1.1);
        }
        .kb-form-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            backdrop-filter: blur(5px);
        }
        .kb-form-modal {
            background: #fef9f3;
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
            border: 3px solid #5a4a42;
            overflow: hidden;
        }
        .kb-editor-modal {
            max-width: 800px;
        }
        .kb-detail-modal {
            max-width: 900px;
        }
        .kb-form-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 3px solid #5a4a42;
        }
        .kb-form-header h2 {
            font-weight: 700;
            margin: 0;
            font-size: 1.4em;
        }
        .kb-form-body {
            flex: 1;
            padding: 25px;
            overflow-y: auto;
        }
        .kb-form-group {
            margin-bottom: 20px;
        }
        .kb-form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 700;
            color: #5a4a42;
            font-family: inherit;
        }
        .kb-form-input,
        .kb-form-select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0c9b8;
            border-radius: 12px;
            font-size: 16px;
            font-family: inherit;
            background: #fffaf9;
            transition: all 0.3s;
        }
        .kb-form-input:focus,
        .kb-form-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .kb-form-textarea {
            width: 100%;
            min-height: 300px;
            padding: 15px;
            border: 2px solid #e0c9b8;
            border-radius: 12px;
            font-size: 16px;
            font-family: inherit;
            background: #fffaf9;
            resize: vertical;
            line-height: 1.6;
            transition: all 0.3s;
        }
        .kb-form-textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .kb-form-footer {
            padding: 20px 25px;
            background: #fffaf0;
            border-top: 2px dotted #ff9a8b;
            display: flex;
            gap: 15px;
            justify-content: flex-end;
        }
        .kb-icon-picker {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
            gap: 10px;
        }
        .kb-icon-btn {
            width: 50px;
            height: 50px;
            border: 2px solid #e0c9b8;
            border-radius: 12px;
            background: #fffaf9;
            font-size: 1.5em;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .kb-icon-btn:hover {
            background: #fff5e6;
            border-color: #ff9a8b;
            transform: scale(1.1);
        }
        .kb-icon-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #5a4a42;
            box-shadow: 3px 3px 0px #d4b8a7;
        }
        .kb-detail-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            padding: 15px 0;
            border-bottom: 2px dotted #ff9a8b;
            margin-bottom: 20px;
        }
        .kb-detail-category {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 6px 15px;
            border-radius: 15px;
            font-size: 0.9em;
            font-weight: 600;
        }
        .kb-detail-date {
            color: #a0a0a0;
            font-size: 0.9em;
        }
        .kb-detail-content {
            font-size: 1.05em;
            line-height: 1.8;
            color: #5a4a42;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .kb-sidebar::-webkit-scrollbar,
        .kb-notes-list::-webkit-scrollbar,
        .kb-form-body::-webkit-scrollbar {
            width: 8px;
        }
        .kb-sidebar::-webkit-scrollbar-track,
        .kb-notes-list::-webkit-scrollbar-track,
        .kb-form-body::-webkit-scrollbar-track {
            background: #fffaf0;
        }
        .kb-sidebar::-webkit-scrollbar-thumb,
        .kb-notes-list::-webkit-scrollbar-thumb,
        .kb-form-body::-webkit-scrollbar-thumb {
            background: #e0c9b8;
            border-radius: 4px;
        }
        .kb-sidebar::-webkit-scrollbar-thumb:hover,
        .kb-notes-list::-webkit-scrollbar-thumb:hover,
        .kb-form-body::-webkit-scrollbar-thumb:hover {
            background: #d4b8a7;
        }
        @media (max-width: 768px) {
            .grid {
                gap: 20px;
            }
            .kb-modal {
                width: 100%;
                height: 100vh;
                border-radius: 0;
            }
            .kb-content {
                flex-direction: column;
            }
            .kb-sidebar {
                width: 100%;
                max-height: 200px;
                border-right: none;
                border-bottom: 3px solid #e0c9b8;
            }
            .kb-notes-list {
                grid-template-columns: 1fr;
            }
            .kb-form-modal {
                width: 100%;
                height: 100vh;
                max-height: 100vh;
                border-radius: 0;
            }
            .book-grid {
                grid-template-columns: 1fr;
            }
        }
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .kb-note-card {
            animation: slideIn 0.3s ease-out;
        }
        .kb-category-item {
            animation: slideIn 0.3s ease-out;
        }
        .book-card {
            animation: slideIn 0.3s ease-out;
        }
    </style>
</head>
<body>
    <div id="app" class="container">
        <!-- ÁôªÂΩïÁïåÈù¢ -->
        <div v-if="!isLoggedIn">
            <div class="header">
                <h1>üåü ÊàêÈïøÊâãË¥¶ üåü</h1>
                <p style="margin-top: 10px; font-size: 1.2em; color: #7a6a62;">ËÆ∞ÂΩïÊØè‰∏ÄÊ≠•ÊàêÈïøÁöÑË∂≥Ëøπ</p>
            </div>
            
            <div class="grid">
                <div class="card">
                    <h2>üîê ÁôªÂΩï/Ê≥®ÂÜå</h2>
                    <input 
                        type="email" 
                        v-model="email" 
                        placeholder="ÈÇÆÁÆ±"
                        class="note-input"
                        @keyup.enter="login"
                    >
                    <input 
                        type="password" 
                        v-model="password" 
                        placeholder="ÂØÜÁ†ÅÔºàËá≥Â∞ë6‰ΩçÔºâ"
                        class="note-input"
                        @keyup.enter="login"
                    >
                    <button class="btn" @click="login" :disabled="loading">
                        <span v-if="!loading">ÁôªÂΩï</span>
                        <span v-else class="loading-spinner"></span>
                    </button>
                    <button class="btn" @click="register" :disabled="loading" style="background: linear-gradient(90deg, #4ecdc4, #a3de83); box-shadow: 4px 4px 0px #2ba69b;">
                        <span v-if="!loading">Ê≥®ÂÜå</span>
                        <span v-else class="loading-spinner"></span>
                    </button>
                </div>
            </div>
            
            <div v-if="message" :class="['status-message', messageType === 'success' ? 'status-success' : 'status-error']">
                {{ message }}
            </div>
        </div>
        
        <!-- ‰∏ªÁïåÈù¢ -->
        <div v-else>
            <div class="header">
                <h1>üåü ÊàëÁöÑÊàêÈïøÊâãË¥¶ üåü</h1>
                <p style="margin-top: 10px; font-size: 1.1em; color: #7a6a62;">
                    Ê¨¢ËøéÂõûÊù•Ôºå{{ userEmail }}ÔºÅ
                    <button class="btn-sm" @click="syncData" :disabled="syncing" style="margin-left: 15px;">
                        <span v-if="!syncing">üîÑ ÂêåÊ≠•</span>
                        <span v-else class="loading-spinner"></span>
                    </button>
                    <button class="btn-sm" @click="logout" style="margin-left: 10px; background: linear-gradient(90deg, #ff9a8b, #ff6b6b); box-shadow: 3px 3px 0px #d45d5d;">
                        ÈÄÄÂá∫
                    </button>
                </p>
            </div>
            
            <div v-if="message" :class="['status-message', messageType === 'success' ? 'status-success' : 'status-error']">
                {{ message }}
            </div>
            
            <div class="grid">
                <!-- Á≠âÁ∫ßÁä∂ÊÄÅ -->
                <div class="card">
                    <h2>
                        üìä Á≠âÁ∫ßÁä∂ÊÄÅ
                        <button class="collapse-btn" @click="collapsed.status = !collapsed.status">
                            {{ collapsed.status ? 'Â±ïÂºÄ' : 'Êî∂Ëµ∑' }}
                        </button>
                    </h2>
                    <div v-show="!collapsed.status">
                        <div class="level-display">Lv.{{ playerData.level }}</div>
                        <div class="xp-progress">
                            <div class="xp-fill" :style="{width: xpPercentage + '%'}"></div>
                        </div>
                        <div style="text-align: center; margin-top: 15px; font-size: 1.1em;">
                            <strong>{{ playerData.xp }}</strong> / {{ playerData.nextLevelXp }} XP
                        </div>
                        <div style="text-align: center; margin-top: 12px; color: #7a6a62; font-size: 0.95em;">
                            üèÜ Â∑≤ÂÆåÊàêÊàêÂ∞±: {{ completedAchievementsCount }} / {{ achievements.length }}
                        </div>
                    </div>
                </div>
                
                <!-- ÊäÄËÉΩËøΩË∏™ -->
                <div class="card">
                    <h2>
                        ‚ö° ÊäÄËÉΩËøΩË∏™
                        <button class="collapse-btn" @click="collapsed.skills = !collapsed.skills">
                            {{ collapsed.skills ? 'Â±ïÂºÄ' : 'Êî∂Ëµ∑' }}
                        </button>
                    </h2>
                    <div v-show="!collapsed.skills">
                        <div v-if="skills.length === 0" style="color: #c9b8a7; text-align: center; padding: 20px;">
                            ËøòÊ≤°ÊúâÊ∑ªÂä†ÊäÄËÉΩÔºåÁÇπÂáª‰∏ãÊñπÊåâÈíÆÂºÄÂßãÔºÅ
                        </div>
                        <div v-for="skill in skills" :key="skill.id" class="skill-item">
                            <div>
                                <div style="font-weight: 700; font-size: 1.1em; margin-bottom: 8px;">
                                    {{ skill.icon }} {{ skill.name }}
                                    <span style="color: #a0a0a0; font-size: 0.85em; margin-left: 8px;">Lv.{{ skill.level }}</span>
                                </div>
                                <div style="font-size: 0.9em; color: #7a6a62;">{{ skill.category }}</div>
                                <div class="xp-progress" style="height: 8px; margin: 10px 0;">
                                    <div class="xp-fill" :style="{width: (skill.xp / skill.maxXp * 100) + '%'}"></div>
                                </div>
                                <div style="font-size: 0.85em; color: #a0a0a0;">{{ skill.xp }} / {{ skill.maxXp }} XP</div>
                            </div>
                            <div>
                                <button class="btn-sm" @click="practiceSkill(skill.id)">ÁªÉ‰π†</button>
                                <button class="btn-sm" @click="deleteSkill(skill.id)" style="background: linear-gradient(90deg, #ff9a8b, #ff6b6b); box-shadow: 3px 3px 0px #d45d5d; margin-top: 8px;">Âà†Èô§</button>
                            </div>
                        </div>
                        <button class="btn" @click="addNewSkill">‚ûï Ê∑ªÂä†Êñ∞ÊäÄËÉΩ</button>
                    </div>
                </div>
                <!-- ÊàêÂ∞±Á≥ªÁªü -->
                <div class="card">
                    <h2>
                        üèÜ ÊàêÂ∞±Á≥ªÁªü
                        <button class="collapse-btn" @click="collapsed.achievements = !collapsed.achievements">
                            {{ collapsed.achievements ? 'Â±ïÂºÄ' : 'Êî∂Ëµ∑' }}
                        </button>
                    </h2>
                    <div v-show="!collapsed.achievements">
                        <button class="btn-sm" @click="showAchievementForm = !showAchievementForm" style="margin-bottom: 15px;">
                            {{ showAchievementForm ? 'ÂèñÊ∂àÂàõÂª∫' : '‚ûï ÂàõÂª∫ÊàêÂ∞±' }}
                        </button>
                        
                        <!-- ÊàêÂ∞±ÂàõÂª∫/ÁºñËæëË°®Âçï -->
                        <div v-if="showAchievementForm" class="achievement-form-container">
                            <h3 style="margin-bottom: 15px; font-weight: 700;">
                                {{ editingAchievementId ? 'ÁºñËæëÊàêÂ∞±' : 'ÂàõÂª∫Êñ∞ÊàêÂ∞±' }}
                            </h3>
                            <input 
                                type="text" 
                                v-model="newAchievement.name" 
                                placeholder="ÊàêÂ∞±ÂêçÁß∞"
                                class="note-input"
                            >
                            <textarea 
                                v-model="newAchievement.description" 
                                placeholder="ÊàêÂ∞±ÊèèËø∞"
                                class="note-textarea"
                                style="min-height: 80px;"
                            ></textarea>
                            <div style="margin: 15px 0;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 700;">ÈÄâÊã©ÂõæÊ†á:</label>
                                <div class="achievement-icon-picker">
                                    <div 
                                        v-for="icon in achievementIcons" 
                                        :key="icon"
                                        class="achievement-icon-option"
                                        :class="{selected: newAchievement.icon === icon}"
                                        @click="newAchievement.icon = icon"
                                    >
                                        {{ icon }}
                                    </div>
                                </div>
                            </div>
                            <input 
                                type="number" 
                                v-model.number="newAchievement.requirement" 
                                placeholder="ÂÆåÊàêË¶ÅÊ±ÇÔºàÊï∞ÈáèÔºâ"
                                class="note-input"
                                min="1"
                            >
                            <input 
                                type="number" 
                                v-model.number="newAchievement.reward" 
                                placeholder="Â•ñÂä±ÁªèÈ™å"
                                class="note-input"
                                min="1"
                            >
                            <button class="btn" @click="saveAchievement">
                                {{ editingAchievementId ? 'Êõ¥Êñ∞ÊàêÂ∞±' : 'ÂàõÂª∫ÊàêÂ∞±' }}
                            </button>
                            <button class="btn" @click="cancelNewAchievement" style="background: #e0c9b8; box-shadow: 4px 4px 0px #d4b8a7;">
                                ÂèñÊ∂à
                            </button>
                        </div>
                        
                        <!-- ÊàêÂ∞±ÂàóË°® -->
                        <div class="achievement-grid">
                            <div 
                                v-for="ach in achievements" 
                                :key="ach.id"
                                class="achievement-card"
                                :class="{locked: !ach.unlocked}"
                            >
                                <div class="achievement-icon">{{ ach.icon }}</div>
                                <h3 style="margin-bottom: 8px; text-align: center; font-weight: 700;">
                                    {{ ach.name }}
                                </h3>
                                <p style="font-size: 0.9em; color: #7a6a62; text-align: center; margin-bottom: 12px;">
                                    {{ ach.description }}
                                </p>
                                <div class="achievement-progress">
                                    <div 
                                        class="achievement-progress-fill" 
                                        :style="{width: Math.min(100, (ach.current / ach.requirement * 100)) + '%'}"
                                    ></div>
                                </div>
                                <div style="text-align: center; font-size: 0.9em; color: #7a6a62;">
                                    {{ ach.current }} / {{ ach.requirement }}
                                </div>
                                <div style="text-align: center; margin-top: 10px; font-weight: 700; color: #4ecdc4;">
                                    üíé +{{ ach.reward }} XP
                                </div>
                                <div v-if="ach.unlocked" style="text-align: center; margin-top: 10px; color: #a3de83; font-weight: 700;">
                                    ‚úÖ Â∑≤Ëß£ÈîÅ
                                </div>
                                
                                <!-- Ëá™ÂÆö‰πâÊàêÂ∞±ÁöÑÁºñËæë/Âà†Èô§ÊåâÈíÆ -->
                                <div v-if="ach.isCustom" class="achievement-actions">
                                    <button @click="editAchievement(ach.id)">‚úèÔ∏è ÁºñËæë</button>
                                    <button @click="deleteAchievement(ach.id)">üóëÔ∏è Âà†Èô§</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Á¨îËÆ∞Êú¨ -->
                <div class="card">
                    <h2>
                        üìù Á¨îËÆ∞Êú¨
                        <button class="collapse-btn" @click="collapsed.notes = !collapsed.notes">
                            {{ collapsed.notes ? 'Â±ïÂºÄ' : 'Êî∂Ëµ∑' }}
                        </button>
                    </h2>
                    <div v-show="!collapsed.notes">
                        <!-- Á¨îËÆ∞Ê†áÁ≠æÈ°µ -->
                        <div class="note-tabs">
                            <div 
                                class="note-tab"
                                :class="{active: activeNoteTab === 'all'}"
                                @click="activeNoteTab = 'all'"
                            >
                                ÂÖ®ÈÉ®Á¨îËÆ∞ ({{ notes.length }})
                            </div>
                            <div 
                                class="note-tab"
                                :class="{active: activeNoteTab === 'new'}"
                                @click="activeNoteTab = 'new'"
                            >
                                ‚ú® Êñ∞Âª∫Á¨îËÆ∞
                            </div>
                        </div>
                        
                        <!-- Êñ∞Âª∫Á¨îËÆ∞ -->
                        <div v-if="activeNoteTab === 'new'">
                            <input 
                                type="text" 
                                v-model="newNote.title" 
                                placeholder="Á¨îËÆ∞Ê†áÈ¢ò..."
                                class="note-input"
                            >
                            <textarea 
                                v-model="newNote.content" 
                                placeholder="ËÆ∞ÂΩï‰Ω†ÁöÑÊÉ≥Ê≥ï..."
                                class="note-textarea"
                            ></textarea>
                            <input 
                                type="text" 
                                v-model="newNote.tags" 
                                placeholder="Ê†áÁ≠æÔºàÁî®ÈÄóÂè∑ÂàÜÈöîÔºåÂ¶Ç: Â≠¶‰π†,ÁºñÁ®ã,ÊÄùËÄÉÔºâ"
                                class="note-input"
                            >
                            <button class="btn" @click="saveNote">üíæ ‰øùÂ≠òÁ¨îËÆ∞</button>
                        </div>
                        
                        <!-- Á¨îËÆ∞Á≠õÈÄâÂô® -->
                        <div v-if="activeNoteTab === 'all'">
                            <div class="filter-container">
                                <div class="filter-header" @click="collapsed.filterExpanded = !collapsed.filterExpanded">
                                    <h3>üîç Á≠õÈÄâÂíåÊêúÁ¥¢</h3>
                                    <button class="filter-toggle">
                                        {{ collapsed.filterExpanded ? 'Â±ïÂºÄ' : 'Êî∂Ëµ∑' }}
                                    </button>
                                </div>
                                
                                <div v-show="!collapsed.filterExpanded" class="collapsible-content">
                                    <!-- ÊêúÁ¥¢Ê°Ü -->
                                    <div style="margin-top: 15px;">
                                        <input 
                                            type="text" 
                                            v-model="noteFilters.search" 
                                            placeholder="ÊêúÁ¥¢Ê†áÈ¢òÊàñÂÜÖÂÆπ..."
                                            class="note-input"
                                            @input="applyFilters"
                                        >
                                    </div>
                                    
                                    <div class="filter-options">
                                        <!-- Ê†áÁ≠æÁ≠õÈÄâ -->
                                        <div class="filter-section">
                                            <h4>
                                                Ê†áÁ≠æÁ≠õÈÄâ 
                                                <span v-if="noteFilters.selectedTags.length > 0" class="filter-active-indicator"></span>
                                            </h4>
                                            <div v-if="allTags.length > 0" class="tags-filter">
                                                <button 
                                                    v-for="tag in allTags" 
                                                    :key="tag"
                                                    class="tag-filter-btn"
                                                    :class="{active: noteFilters.selectedTags.includes(tag)}"
                                                    @click="toggleTagFilter(tag)"
                                                >
                                                    {{ tag }}
                                                </button>
                                            </div>
                                            <div v-else style="color: #c9b8a7; font-size: 0.9em;">
                                                ÊöÇÊó†Ê†áÁ≠æÔºåÊ∑ªÂä†Á¨îËÆ∞Êó∂Ê∑ªÂä†Ê†áÁ≠æÂç≥ÂèØÁ≠õÈÄâ
                                            </div>
                                        </div>
                                        
                                        <!-- ÊéíÂ∫èÈÄâÈ°π -->
                                        <div class="filter-section">
                                            <h4>
                                                ÊéíÂ∫èÊñπÂºè 
                                                <span v-if="noteFilters.sortBy !== 'newest'" class="filter-active-indicator"></span>
                                            </h4>
                                            <div class="sort-options">
                                                <button 
                                                    class="sort-btn" 
                                                    :class="{active: noteFilters.sortBy === 'newest'}"
                                                    @click="noteFilters.sortBy = 'newest'; applyFilters()"
                                                >
                                                    ÊúÄÊñ∞‰ºòÂÖà
                                                </button>
                                                <button 
                                                    class="sort-btn" 
                                                    :class="{active: noteFilters.sortBy === 'oldest'}"
                                                    @click="noteFilters.sortBy = 'oldest'; applyFilters()"
                                                >
                                                    ÊúÄÊó©‰ºòÂÖà
                                                </button>
                                                <button 
                                                    class="sort-btn" 
                                                    :class="{active: noteFilters.sortBy === 'title'}"
                                                    @click="noteFilters.sortBy = 'title'; applyFilters()"
                                                >
                                                    Ê†áÈ¢òÊéíÂ∫è
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Á≠õÈÄâÁªìÊûúÂíåÊ∏ÖÈô§ÊåâÈíÆ -->
                                    <div class="filter-results">
                                        <span v-if="filteredNotes.length !== notes.length">
                                            ÊâæÂà∞ {{ filteredNotes.length }} Êù°Á¨îËÆ∞ÔºàÂÖ± {{ notes.length }} Êù°Ôºâ
                                        </span>
                                        <span v-else>
                                            ÂÖ± {{ notes.length }} Êù°Á¨îËÆ∞
                                        </span>
                                        <button 
                                            class="clear-filters-btn" 
                                            @click="clearFilters"
                                            v-if="isFilterActive"
                                        >
                                            Ê∏ÖÈô§Á≠õÈÄâ
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Á¨îËÆ∞ÂàóË°® -->
                            <div class="note-list">
                                <div v-if="filteredNotes.length === 0" class="no-notes-message">
                                    <div>üì≠</div>
                                    <div v-if="notes.length === 0">ËøòÊ≤°ÊúâÁ¨îËÆ∞ÔºåÂéªÊñ∞Âª∫‰∏ÄÊù°ÂêßÔºÅ</div>
                                    <div v-else>Ê≤°ÊúâÊâæÂà∞Á¨¶ÂêàÊù°‰ª∂ÁöÑÁ¨îËÆ∞</div>
                                </div>
                                <div 
                                    v-for="note in filteredNotes" 
                                    :key="note.id"
                                    class="note-card"
                                >
                                    <h3 style="margin-bottom: 12px; font-weight: 700;">{{ note.title }}</h3>
                                    <div class="note-tags" v-if="note.tags && note.tags.length">
                                        <span 
                                            class="note-tag" 
                                            v-for="tag in note.tags" 
                                            :key="tag"
                                            @click="setTagFilter(tag)"
                                            :style="{cursor: 'pointer'}"
                                        >
                                            {{ tag }}
                                        </span>
                                    </div>
                                    <p style="margin: 12px 0; line-height: 1.6;">{{ note.content }}</p>
                                    <div style="font-size: 0.85em; color: #a0a0a0; margin-top: 10px;">
                                        {{ formatDate(note.createdAt) }}
                                    </div>
                                    <button class="btn-sm" @click="deleteNote(note.id)" style="margin-top: 12px; background: linear-gradient(90deg, #ff9a8b, #ff6b6b); box-shadow: 3px 3px 0px #d45d5d;">
                                        Âà†Èô§
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ËØª‰π¶Á¨îËÆ∞ÊùøÂùó -->
                <div class="card">
                    <h2>
                        üìö ËØª‰π¶Á¨îËÆ∞
                        <button class="collapse-btn" @click="collapsed.books = !collapsed.books">
                            {{ collapsed.books ? 'Â±ïÂºÄ' : 'Êî∂Ëµ∑' }}
                        </button>
                    </h2>
                    <div v-show="!collapsed.books">
                        <!-- ËØª‰π¶Á¨îËÆ∞Ê†áÁ≠æÈ°µ -->
                        <div class="book-tabs">
                            <div 
                                class="book-tab"
                                :class="{active: activeBookTab === 'all'}"
                                @click="activeBookTab = 'all'"
                            >
                                ÊâÄÊúâ‰π¶Á±ç ({{ books.length }})
                            </div>
                            <div 
                                class="book-tab"
                                :class="{active: activeBookTab === 'new'}"
                                @click="activeBookTab = 'new'"
                            >
                                ‚ú® Ê∑ªÂä†Êñ∞‰π¶
                            </div>
                        </div>
                        
                        <!-- Êñ∞Â¢û‰π¶Á±çË°®Âçï -->
                        <div v-if="activeBookTab === 'new'">
                            <div class="book-form-group">
                                <label>‰π¶Âêç</label>
                                <input 
                                    type="text" 
                                    v-model="newBook.title" 
                                    placeholder="ËØ∑ËæìÂÖ•‰π¶Âêç"
                                    class="note-input"
                                >
                            </div>
                            
                            <div class="book-form-group">
                                <label>‰ΩúËÄÖ</label>
                                <input 
                                    type="text" 
                                    v-model="newBook.author" 
                                    placeholder="ËØ∑ËæìÂÖ•‰ΩúËÄÖ"
                                    class="note-input"
                                >
                            </div>
                            
                            <div class="book-form-group">
                                <label>ÈòÖËØªÁä∂ÊÄÅ</label>
                                <select v-model="newBook.status" class="note-input">
                                    <option value="planning">ËÆ°ÂàíÈòÖËØª</option>
                                    <option value="reading">Ê≠£Âú®ÈòÖËØª</option>
                                    <option value="finished">Â∑≤ËØªÂÆå</option>
                                </select>
                            </div>
                            
                            <div class="book-form-group">
                                <label>ËØÑÂàÜ</label>
                                <div class="book-rating">
                                    <span 
                                        v-for="star in 5" 
                                        :key="star"
                                        class="star-rating"
                                        :class="{filled: star <= newBook.rating}"
                                        @click="newBook.rating = star"
                                    >
                                        ‚òÖ
                                    </span>
                                </div>
                            </div>
                            
                            <div class="book-form-group">
                                <label>ËØª‰π¶Á¨îËÆ∞</label>
                                <textarea 
                                    v-model="newBook.notes" 
                                    placeholder="ËÆ∞ÂΩï‰Ω†ÁöÑËØª‰π¶Á¨îËÆ∞..."
                                    class="note-textarea"
                                    style="min-height: 120px;"
                                ></textarea>
                            </div>
                            
                            <div class="book-form-group">
                                <label>ÊÑüÊÇü‰∏éÊî∂Ëé∑</label>
                                <textarea 
                                    v-model="newBook.insights" 
                                    placeholder="ÂÜô‰∏ã‰Ω†ÁöÑÊÑüÊÇü‰∏éÊî∂Ëé∑..."
                                    class="note-textarea"
                                    style="min-height: 120px;"
                                ></textarea>
                            </div>
                            
                            <div class="book-form-group">
                                <label>ÈÄâÊã©Ê†áÁ≠æ</label>
                                <div class="book-tag-picker">
                                    <span 
                                        v-for="tag in bookTags" 
                                        :key="tag"
                                        class="book-tag-option"
                                        :class="{selected: newBook.tags.includes(tag)}"
                                        @click="toggleBookTag(tag)"
                                    >
                                        {{ tag }}
                                    </span>
                                </div>
                                <input 
                                    type="text" 
                                    v-model="newBook.customTag" 
                                    placeholder="ÊàñËæìÂÖ•Ëá™ÂÆö‰πâÊ†áÁ≠æ"
                                    class="note-input"
                                    style="margin-top: 10px;"
                                    @keyup.enter="addCustomBookTag"
                                >
                            </div>
                            
                            <div class="book-form-group">
                                <label>ÂºÄÂßãÊó•Êúü</label>
                                <input 
                                    type="date" 
                                    v-model="newBook.startDate" 
                                    class="note-input"
                                >
                            </div>
                            
                            <div class="book-form-group" v-if="newBook.status === 'finished'">
                                <label>ÂÆåÊàêÊó•Êúü</label>
                                <input 
                                    type="date" 
                                    v-model="newBook.finishDate" 
                                    class="note-input"
                                >
                            </div>
                            
                            <button class="btn" @click="saveBook" style="background: linear-gradient(90deg, #667eea, #764ba2); box-shadow: 4px 4px 0px #5a4a42;">
                                üíæ ‰øùÂ≠òËØª‰π¶Á¨îËÆ∞
                            </button>
                            <button class="btn" @click="resetBookForm" style="background: #e0c9b8; box-shadow: 4px 4px 0px #d4b8a7;">
                                ÈáçÁΩÆ
                            </button>
                        </div>
                        
                        <!-- ‰π¶Á±çÂàóË°® -->
                        <div v-if="activeBookTab === 'all'">
                            <!-- ÊêúÁ¥¢ÂíåÁ≠õÈÄâ -->
                            <div class="filter-container">
                                <div class="filter-header" @click="collapsed.bookFilterExpanded = !collapsed.bookFilterExpanded">
                                    <h3>üîç ÊêúÁ¥¢ÂíåÁ≠õÈÄâ‰π¶Á±ç</h3>
                                    <button class="filter-toggle">
                                        {{ collapsed.bookFilterExpanded ? 'Â±ïÂºÄ' : 'Êî∂Ëµ∑' }}
                                    </button>
                                </div>
                                
                                <div v-show="!collapsed.bookFilterExpanded" class="collapsible-content">
                                    <!-- ÊêúÁ¥¢Ê°Ü -->
                                    <div style="margin-top: 15px;">
                                        <input 
                                            type="text" 
                                            v-model="bookFilters.search" 
                                            placeholder="ÊêúÁ¥¢‰π¶ÂêçÊàñ‰ΩúËÄÖ..."
                                            class="note-input"
                                        >
                                    </div>
                                    
                                    <div class="filter-options">
                                        <!-- Ê†áÁ≠æÁ≠õÈÄâ -->
                                        <div class="filter-section">
                                            <h4>
                                                Ê†áÁ≠æÁ≠õÈÄâ 
                                                <span v-if="bookFilters.selectedTags.length > 0" class="filter-active-indicator"></span>
                                            </h4>
                                            <div v-if="allBookTags.length > 0" class="tags-filter">
                                                <button 
                                                    v-for="tag in allBookTags" 
                                                    :key="tag"
                                                    class="tag-filter-btn"
                                                    :class="{active: bookFilters.selectedTags.includes(tag)}"
                                                    @click="toggleBookFilterTag(tag)"
                                                >
                                                    {{ tag }}
                                                </button>
                                            </div>
                                            <div v-else style="color: #c9b8a7; font-size: 0.9em;">
                                                ÊöÇÊó†Ê†áÁ≠æÔºåÊ∑ªÂä†‰π¶Á±çÊó∂Ê∑ªÂä†Ê†áÁ≠æÂç≥ÂèØÁ≠õÈÄâ
                                            </div>
                                        </div>
                                        
                                        <!-- Áä∂ÊÄÅÁ≠õÈÄâ -->
                                        <div class="filter-section">
                                            <h4>ÈòÖËØªÁä∂ÊÄÅ</h4>
                                            <div class="sort-options">
                                                <button 
                                                    class="sort-btn" 
                                                    :class="{active: bookFilters.status === 'all'}"
                                                    @click="bookFilters.status = 'all'"
                                                >
                                                    ÂÖ®ÈÉ®
                                                </button>
                                                <button 
                                                    class="sort-btn" 
                                                    :class="{active: bookFilters.status === 'planning'}"
                                                    @click="bookFilters.status = 'planning'"
                                                >
                                                    ËÆ°Âàí‰∏≠
                                                </button>
                                                <button 
                                                    class="sort-btn" 
                                                    :class="{active: bookFilters.status === 'reading'}"
                                                    @click="bookFilters.status = 'reading'"
                                                >
                                                    ÈòÖËØª‰∏≠
                                                </button>
                                                <button 
                                                    class="sort-btn" 
                                                    :class="{active: bookFilters.status === 'finished'}"
                                                    @click="bookFilters.status = 'finished'"
                                                >
                                                    Â∑≤ËØªÂÆå
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <!-- ÊéíÂ∫èÈÄâÈ°π -->
                                        <div class="filter-section">
                                            <h4>ÊéíÂ∫èÊñπÂºè</h4>
                                            <div class="sort-options">
                                                <button 
                                                    class="sort-btn" 
                                                    :class="{active: bookFilters.sortBy === 'newest'}"
                                                    @click="bookFilters.sortBy = 'newest'"
                                                >
                                                    ÊúÄÊñ∞Ê∑ªÂä†
                                                </button>
                                                <button 
                                                    class="sort-btn" 
                                                    :class="{active: bookFilters.sortBy === 'title'}"
                                                    @click="bookFilters.sortBy = 'title'"
                                                >
                                                    ‰π¶ÂêçÊéíÂ∫è
                                                </button>
                                                <button 
                                                    class="sort-btn" 
                                                    :class="{active: bookFilters.sortBy === 'rating'}"
                                                    @click="bookFilters.sortBy = 'rating'"
                                                >
                                                    ËØÑÂàÜÊúÄÈ´ò
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Á≠õÈÄâÁªìÊûúÂíåÊ∏ÖÈô§ÊåâÈíÆ -->
                                    <div class="filter-results">
                                        <span v-if="filteredBooks.length !== books.length">
                                            ÊâæÂà∞ {{ filteredBooks.length }} Êú¨‰π¶ÔºàÂÖ± {{ books.length }} Êú¨Ôºâ
                                        </span>
                                        <span v-else>
                                            ÂÖ± {{ books.length }} Êú¨‰π¶
                                        </span>
                                        <button 
                                            class="clear-filters-btn" 
                                            @click="clearBookFilters"
                                            v-if="isBookFilterActive"
                                        >
                                            Ê∏ÖÈô§Á≠õÈÄâ
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- ‰π¶Á±çÂç°ÁâáÂàóË°® -->
                            <div class="book-grid">
                                <div v-if="filteredBooks.length === 0" class="no-notes-message">
                                    <div>üìö</div>
                                    <div v-if="books.length === 0">ËøòÊ≤°ÊúâËØª‰π¶Á¨îËÆ∞ÔºåÊ∑ªÂä†‰∏ÄÊú¨ÂêßÔºÅ</div>
                                    <div v-else>Ê≤°ÊúâÊâæÂà∞Á¨¶ÂêàÊù°‰ª∂ÁöÑ‰π¶Á±ç</div>
                                </div>
                                
                                <div 
                                    v-for="book in filteredBooks" 
                                    :key="book.id"
                                    class="book-card"
                                >
                                    <div class="book-header">
                                        <div>
                                            <h3>{{ book.title }}</h3>
                                            <div class="book-author">‰ΩúËÄÖÔºö{{ book.author }}</div>
                                        </div>
                                        <span class="book-status" :class="book.status">
                                            {{ book.status === 'planning' ? 'ËÆ°Âàí‰∏≠' : book.status === 'reading' ? 'ÈòÖËØª‰∏≠' : 'Â∑≤ËØªÂÆå' }}
                                        </span>
                                    </div>
                                    
                                    <div class="book-rating-display">
                                        <span v-for="star in 5" :key="star">
                                            {{ star <= book.rating ? '‚òÖ' : '‚òÜ' }}
                                        </span>
                                        <span style="font-size: 0.8em; color: #7a6a62; margin-left: 5px;">
                                            {{ book.rating }}/5
                                        </span>
                                    </div>
                                    
                                    <div class="book-content" v-if="book.notes">
                                        <strong>Á¨îËÆ∞Ôºö</strong>{{ book.notes.length > 100 ? book.notes.substring(0, 100) + '...' : book.notes }}
                                    </div>
                                    
                                    <div class="book-content" v-if="book.insights">
                                        <strong>ÊÑüÊÇüÔºö</strong>{{ book.insights.length > 100 ? book.insights.substring(0, 100) + '...' : book.insights }}
                                    </div>
                                    
                                    <div class="book-footer">
                                        <div class="book-tags">
                                            <span 
                                                v-for="tag in book.tags" 
                                                :key="tag"
                                                class="book-tag"
                                                @click="setBookTagFilter(tag)"
                                                :style="{cursor: 'pointer'}"
                                            >
                                                {{ tag }}
                                            </span>
                                        </div>
                                        <div class="book-actions">
                                            <button class="book-action-btn" @click="editBook(book.id)">‚úèÔ∏è</button>
                                            <button class="book-action-btn" @click="deleteBook(book.id)">üóëÔ∏è</button>
                                        </div>
                                    </div>
                                    
                                    <div style="font-size: 0.8em; color: #a0a0a0; margin-top: 5px;">
                                        <span v-if="book.startDate">ÂºÄÂßãÔºö{{ formatDateShort(book.startDate) }}</span>
                                        <span v-if="book.finishDate" style="margin-left: 10px;">ÂÆåÊàêÔºö{{ formatDateShort(book.finishDate) }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Áü•ËØÜÂ∫ìÂÖ•Âè£ -->
                <div class="card">
                    <h2>üìö Áü•ËØÜÂ∫ì</h2>
                    <p style="margin: 15px 0; color: #7a6a62;">
                        ÂàõÂª∫ÂàÜÁ±ª„ÄÅÊï¥ÁêÜÁ¨îËÆ∞ÔºåÊûÑÂª∫‰Ω†ÁöÑÁü•ËØÜ‰ΩìÁ≥ª
                    </p>
                    <button class="btn" @click="openKnowledgeBase" style="background: linear-gradient(90deg, #667eea, #764ba2); box-shadow: 4px 4px 0px #5a4a42;">
                        üìö ÊâìÂºÄÁü•ËØÜÂ∫ì
                    </button>
                </div>
            </div>
        </div>

        <!-- Áü•ËØÜÂ∫ìÂºπÁ™ó -->
        <div v-if="isLoggedIn && showKnowledgeBase" class="kb-modal-overlay" @click.self="closeKnowledgeBase">
            <div class="kb-modal">
                <!-- È°∂ÈÉ®Ê†áÈ¢òÊ†è -->
                <div class="kb-header">
                    <h1>üìö ÊàëÁöÑÁü•ËØÜÂ∫ì</h1>
                    <button class="kb-close-btn" @click="closeKnowledgeBase">‚úï</button>
                </div>
                
                <!-- ‰∏ª‰ΩìÂÜÖÂÆπ -->
                <div class="kb-content">
                    <!-- Â∑¶‰æßËæπÊ†è - ÂàÜÁ±ªÂàóË°® -->
                    <div class="kb-sidebar">
                        <div class="kb-sidebar-header">
                            <h3>ÂàÜÁ±ªÁõÆÂΩï</h3>
                            <button class="btn-sm" @click="showCategoryForm = true">+ Êñ∞Âª∫</button>
                        </div>
                        
                        <!-- ÂàÜÁ±ªÂàóË°® -->
                        <div class="kb-category-list">
                            <!-- ÂÖ®ÈÉ®Á¨îËÆ∞ -->
                            <div 
                                class="kb-category-item"
                                :class="{ active: selectedCategory === 'all' }"
                                @click="selectCategory('all')"
                            >
                                <span class="kb-category-icon">üìñ</span>
                                <span class="kb-category-name">ÂÖ®ÈÉ®Á¨îËÆ∞</span>
                                <span class="kb-category-count">({{ kbNotes.length }})</span>
                            </div>
                            
                            <div 
                                v-for="category in kbCategories" 
                                :key="category.id"
                                class="kb-category-item"
                                :class="{ active: selectedCategory && selectedCategory.id === category.id }"
                                @click="selectCategory(category)"
                            >
                                <span class="kb-category-icon">{{ category.icon }}</span>
                                <span class="kb-category-name">{{ category.name }}</span>
                                <span class="kb-category-count">({{ getCategoryNotesCount(category.id) }})</span>
                                <div class="kb-category-actions">
                                    <button @click.stop="editCategory(category)" title="ÁºñËæë">‚úèÔ∏è</button>
                                    <button @click.stop="deleteCategory(category.id)" title="Âà†Èô§">üóëÔ∏è</button>
                                </div>
                            </div>
                            
                            <!-- Êú™ÂàÜÁ±ª -->
                            <div 
                                class="kb-category-item"
                                :class="{ active: selectedCategory === 'uncategorized' }"
                                @click="selectCategory('uncategorized')"
                            >
                                <span class="kb-category-icon">üìã</span>
                                <span class="kb-category-name">Êú™ÂàÜÁ±ª</span>
                                <span class="kb-category-count">({{ getUncategorizedCount() }})</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Âè≥‰æßÂÜÖÂÆπÂå∫ -->
                    <div class="kb-main">
                        <!-- Â∑•ÂÖ∑Ê†è -->
                        <div class="kb-toolbar">
                            <input 
                                type="text" 
                                v-model="kbSearchQuery" 
                                placeholder="üîç ÊêúÁ¥¢Á¨îËÆ∞..."
                                class="kb-search-input"
                            >
                            <button class="btn-primary" @click="showNoteEditor = true">
                                ‚ú® Êñ∞Âª∫Á¨îËÆ∞
                            </button>
                        </div>
                        
                        <!-- Á¨îËÆ∞ÂàóË°® -->
                        <div class="kb-notes-list">
                            <div v-if="filteredKbNotes.length === 0" class="kb-empty">
                                <div class="kb-empty-icon">üìù</div>
                                <p>ÊöÇÊó†Á¨îËÆ∞ÔºåÁÇπÂáª"Êñ∞Âª∫Á¨îËÆ∞"ÂºÄÂßãËÆ∞ÂΩïÂêßÔºÅ</p>
                            </div>
                            
                            <div 
                                v-for="note in filteredKbNotes" 
                                :key="note.id"
                                class="kb-note-card"
                                @click="openNoteDetail(note)"
                            >
                                <div class="kb-note-header">
                                    <h3>{{ note.title }}</h3>
                                    <span class="kb-note-date">{{ formatDateShort(note.updatedAt || note.createdAt) }}</span>
                                </div>
                                <div class="kb-note-preview">{{ getPreviewText(note.content) }}</div>
                                <div class="kb-note-footer">
                                    <span v-if="note.categoryId" class="kb-note-category">
                                        {{ getCategoryIcon(note.categoryId) }} {{ getCategoryName(note.categoryId) }}
                                    </span>
                                    <span v-else class="kb-note-category" style="background: #a0a0a0;">
                                        üìã Êú™ÂàÜÁ±ª
                                    </span>
                                    <div class="kb-note-actions">
                                        <button @click.stop="editKbNote(note)" class="kb-action-btn">‚úèÔ∏è</button>
                                        <button @click.stop="deleteKbNote(note.id)" class="kb-action-btn">üóëÔ∏è</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Êñ∞Âª∫/ÁºñËæëÂàÜÁ±ªÂºπÁ™ó -->
        <div v-if="showCategoryForm" class="kb-form-overlay" @click.self="closeCategoryForm">
            <div class="kb-form-modal">
                <div class="kb-form-header">
                    <h2>{{ editingCategoryId ? 'ÁºñËæëÂàÜÁ±ª' : 'Êñ∞Âª∫ÂàÜÁ±ª' }}</h2>
                    <button class="kb-close-btn" @click="closeCategoryForm">‚úï</button>
                </div>
                <div class="kb-form-body">
                    <div class="kb-form-group">
                        <label>ÂàÜÁ±ªÂêçÁß∞</label>
                        <input 
                            type="text" 
                            v-model="categoryForm.name" 
                            placeholder="ËæìÂÖ•ÂàÜÁ±ªÂêçÁß∞..."
                            class="kb-form-input"
                        >
                    </div>
                    <div class="kb-form-group">
                        <label>ÈÄâÊã©ÂõæÊ†á</label>
                        <div class="kb-icon-picker">
                            <button 
                                v-for="icon in categoryIcons" 
                                :key="icon"
                                class="kb-icon-btn"
                                :class="{ active: categoryForm.icon === icon }"
                                @click="categoryForm.icon = icon"
                            >
                                {{ icon }}
                            </button>
                        </div>
                    </div>
                </div>
                <div class="kb-form-footer">
                    <button class="btn-secondary" @click="closeCategoryForm">ÂèñÊ∂à</button>
                    <button class="btn-primary" @click="saveCategoryForm">‰øùÂ≠ò</button>
                </div>
            </div>
        </div>

        <!-- Êñ∞Âª∫/ÁºñËæëÁ¨îËÆ∞ÂºπÁ™ó -->
        <div v-if="showNoteEditor" class="kb-form-overlay" @click.self="closeNoteEditor">
            <div class="kb-form-modal kb-editor-modal">
                <div class="kb-form-header">
                    <h2>{{ editingNoteId ? 'ÁºñËæëÁ¨îËÆ∞' : 'Êñ∞Âª∫Á¨îËÆ∞' }}</h2>
                    <button class="kb-close-btn" @click="closeNoteEditor">‚úï</button>
                </div>
                <div class="kb-form-body">
                    <div class="kb-form-group">
                        <label>Á¨îËÆ∞Ê†áÈ¢ò</label>
                        <input 
                            type="text" 
                            v-model="noteForm.title" 
                            placeholder="ËæìÂÖ•Á¨îËÆ∞Ê†áÈ¢ò..."
                            class="kb-form-input"
                        >
                    </div>
                    <div class="kb-form-group">
                        <label>ÈÄâÊã©ÂàÜÁ±ª</label>
                        <select v-model="noteForm.categoryId" class="kb-form-select">
                            <option :value="null">Êú™ÂàÜÁ±ª</option>
                            <option 
                                v-for="category in kbCategories" 
                                :key="category.id" 
                                :value="category.id"
                            >
                                {{ category.icon }} {{ category.name }}
                            </option>
                        </select>
                    </div>
                    <div class="kb-form-group">
                        <label>Á¨îËÆ∞ÂÜÖÂÆπ</label>
                        <textarea 
                            v-model="noteForm.content" 
                            placeholder="ÂºÄÂßãËÆ∞ÂΩï..."
                            class="kb-form-textarea"
                        ></textarea>
                    </div>
                </div>
                <div class="kb-form-footer">
                    <button class="btn-secondary" @click="closeNoteEditor">ÂèñÊ∂à</button>
                    <button class="btn-primary" @click="saveNoteForm">‰øùÂ≠ò</button>
                </div>
            </div>
        </div>

        <!-- Á¨îËÆ∞ËØ¶ÊÉÖÂºπÁ™ó -->
        <div v-if="viewingNote" class="kb-form-overlay" @click.self="closeNoteDetail">
            <div class="kb-form-modal kb-detail-modal">
                <div class="kb-form-header">
                    <h2>{{ viewingNote.title }}</h2>
                    <button class="kb-close-btn" @click="closeNoteDetail">‚úï</button>
                </div>
                <div class="kb-form-body">
                    <div class="kb-detail-meta">
                        <span v-if="viewingNote.categoryId" class="kb-detail-category">
                            {{ getCategoryIcon(viewingNote.categoryId) }} {{ getCategoryName(viewingNote.categoryId) }}
                        </span>
                        <span v-else class="kb-detail-category" style="background: #a0a0a0;">
                            üìã Êú™ÂàÜÁ±ª
                        </span>
                        <span class="kb-detail-date">
                            ÂàõÂª∫‰∫é: {{ formatDate(viewingNote.createdAt) }}
                        </span>
                        <span v-if="viewingNote.updatedAt" class="kb-detail-date">
                            Êõ¥Êñ∞‰∫é: {{ formatDate(viewingNote.updatedAt) }}
                        </span>
                    </div>
                    <div class="kb-detail-content">
                        {{ viewingNote.content }}
                    </div>
                </div>
                <div class="kb-form-footer">
                    <button class="btn-secondary" @click="closeNoteDetail">ÂÖ≥Èó≠</button>
                    <button class="btn-primary" @click="editKbNote(viewingNote); closeNoteDetail()">ÁºñËæë</button>
                </div>
            </div>
        </div>
    </div>
    <script>
        const SUPABASE_URL = 'https://zqmgigcnruvvdcholbuj.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpxbWdpZ2NucnV2dmRjaG9sYnVqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4NjgzNjEsImV4cCI6MjA4MTQ0NDM2MX0.IHzDp7o5M9QM8IBWy2ri5gS9h9nm0zk3AaPTNveDqXI';
        const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        const { createApp } = Vue;
        
        createApp({
            data() {
                return {
                    isLoggedIn: false,
                    userId: null,
                    userEmail: '',
                    email: '',
                    password: '',
                    loading: false,
                    syncing: false,
                    saving: false,
                    message: '',
                    messageType: 'success',
                    collapsed: { 
                        status: false, 
                        skills: false, 
                        achievements: false, 
                        notes: false, 
                        books: false,
                        filterExpanded: false,
                        bookFilterExpanded: false 
                    },
                    playerData: { level: 1, xp: 0, nextLevelXp: 100 },
                    skills: [],
                    achievements: [
                        { id: 1, name: 'ÂàùÂ≠¶ËÄÖ', icon: 'üå±', description: 'ÂàõÂª∫Á¨¨‰∏Ä‰∏™ÊäÄËÉΩ', requirement: 1, current: 0, unlocked: false, reward: 50, isCustom: false },
                        { id: 2, name: 'Â§öÈù¢Êâã', icon: 'üîß', description: 'Êã•Êúâ5‰∏™ÊäÄËÉΩ', requirement: 5, current: 0, unlocked: false, reward: 150, isCustom: false },
                        { id: 3, name: 'Á¨îËÆ∞Ëææ‰∫∫', icon: 'üìù', description: 'ÂàõÂª∫10Êù°Á¨îËÆ∞', requirement: 10, current: 0, unlocked: false, reward: 100, isCustom: false },
                        { id: 4, name: 'ÊàêÈïø‰πãË∑Ø', icon: 'üöÄ', description: 'ËææÂà∞10Á∫ß', requirement: 10, current: 0, unlocked: false, reward: 500, isCustom: false },
                    ],
                    notes: [],
                    activeNoteTab: 'all',
                    newNote: { title: '', content: '', tags: '' },
                    showAchievementForm: false,
                    newAchievement: {
                        name: '',
                        description: '',
                        icon: 'üèÜ',
                        requirement: 1,
                        reward: 50,
                        isCustom: true
                    },
                    achievementIcons: ['üèÜ', '‚≠ê', 'üéØ', 'üöÄ', 'üí°', 'üî•', '‚ú®', 'üéñÔ∏è', 'üèÖ', 'üëë', 'üíé', 'üìö', 'üé®', 'üéµ', 'üèÉ', 'üß†', 'üí™', '‚ù§Ô∏è', 'üåü', 'üåà'],
                    editingAchievementId: null,
                    noteFilters: {
                        search: '',
                        selectedTags: [],
                        sortBy: 'newest'
                    },
                    
                    // ËØª‰π¶Á¨îËÆ∞Êï∞ÊçÆ
                    books: [],
                    activeBookTab: 'all',
                    newBook: {
                        title: '',
                        author: '',
                        status: 'planning',
                        rating: 0,
                        notes: '',
                        insights: '',
                        tags: [],
                        customTag: '',
                        startDate: new Date().toISOString().split('T')[0],
                        finishDate: ''
                    },
                    editingBookId: null,
                    bookTags: ['ÂøÉÁêÜÂ≠¶', 'ÁÆ°ÁêÜÂ≠¶', 'ÊñáÂ≠¶', 'Â∞èËØ¥', 'Âì≤Â≠¶', 'ÂéÜÂè≤', 'ÁßëÂ≠¶', 'ÊäÄÊúØ', 'ÁªèÊµé', 'ÊïôËÇ≤', 'Ëá™ÊàëÊàêÈïø', '‰º†ËÆ∞', 'Ëâ∫ÊúØ', 'ÂÅ•Â∫∑', '‰∫∫ÈôÖÂÖ≥Á≥ª', 'ËÅåÂú∫'],
                    bookFilters: {
                        search: '',
                        selectedTags: [],
                        status: 'all',
                        sortBy: 'newest'
                    },
                    
                    showKnowledgeBase: false,
                    kbCategories: [],
                    kbNotes: [],
                    selectedCategory: 'all',
                    kbSearchQuery: '',
                    showCategoryForm: false,
                    editingCategoryId: null,
                    categoryForm: { name: '', icon: 'üìÅ' },
                    categoryIcons: ['üìÅ', 'üìÇ', 'üìö', 'üìñ', 'üìù', '‚úèÔ∏è', 'üí°', 'üéØ', 'üé®', 'üíª', 'üî¨', 'üìä', 'üéµ', 'üé¨', 'üèãÔ∏è', 'üç≥', '‚úàÔ∏è', 'üåü', '‚ù§Ô∏è', 'üéì', 'üíº', 'üè†', 'üå±', '‚ö°'],
                    showNoteEditor: false,
                    editingNoteId: null,
                    noteForm: { title: '', content: '', categoryId: null },
                    viewingNote: null
                };
            },
            
            computed: {
                xpPercentage() {
                    return Math.min(100, (this.playerData.xp / this.playerData.nextLevelXp) * 100);
                },
                completedAchievementsCount() {
                    return this.achievements.filter(a => a.unlocked).length;
                },
                allTags() {
                    const allTags = [];
                    this.notes.forEach(note => {
                        if (note.tags && Array.isArray(note.tags)) {
                            note.tags.forEach(tag => {
                                if (!allTags.includes(tag)) allTags.push(tag);
                            });
                        }
                    });
                    return allTags.sort();
                },
                filteredNotes() {
                    let filtered = [...this.notes];
                    if (this.noteFilters.search.trim()) {
                        const searchTerm = this.noteFilters.search.toLowerCase().trim();
                        filtered = filtered.filter(note => note.title.toLowerCase().includes(searchTerm) || note.content.toLowerCase().includes(searchTerm));
                    }
                    if (this.noteFilters.selectedTags.length > 0) {
                        filtered = filtered.filter(note => {
                            if (!note.tags || !Array.isArray(note.tags)) return false;
                            return this.noteFilters.selectedTags.some(tag => note.tags.includes(tag));
                        });
                    }
                    filtered.sort((a, b) => {
                        const dateA = new Date(a.createdAt);
                        const dateB = new Date(b.createdAt);
                        switch (this.noteFilters.sortBy) {
                            case 'newest': return dateB - dateA;
                            case 'oldest': return dateA - dateB;
                            case 'title': return a.title.localeCompare(b.title);
                            default: return dateB - dateA;
                        }
                    });
                    return filtered;
                },
                isFilterActive() {
                    return this.noteFilters.search.trim() !== '' || this.noteFilters.selectedTags.length > 0 || this.noteFilters.sortBy !== 'newest';
                },
                allBookTags() {
                    const allTags = new Set();
                    this.books.forEach(book => {
                        if (book.tags && Array.isArray(book.tags)) {
                            book.tags.forEach(tag => allTags.add(tag));
                        }
                    });
                    return Array.from(allTags).sort();
                },
                filteredBooks() {
                    let filtered = [...this.books];
                    
                    // ÊêúÁ¥¢ËøáÊª§
                    if (this.bookFilters.search.trim()) {
                        const searchTerm = this.bookFilters.search.toLowerCase().trim();
                        filtered = filtered.filter(book => 
                            book.title.toLowerCase().includes(searchTerm) || 
                            book.author.toLowerCase().includes(searchTerm)
                        );
                    }
                    
                    // Ê†áÁ≠æËøáÊª§
                    if (this.bookFilters.selectedTags.length > 0) {
                        filtered = filtered.filter(book => {
                            if (!book.tags || !Array.isArray(book.tags)) return false;
                            return this.bookFilters.selectedTags.some(tag => book.tags.includes(tag));
                        });
                    }
                    
                    // Áä∂ÊÄÅËøáÊª§
                    if (this.bookFilters.status !== 'all') {
                        filtered = filtered.filter(book => book.status === this.bookFilters.status);
                    }
                    
                    // ÊéíÂ∫è
                    filtered.sort((a, b) => {
                        switch (this.bookFilters.sortBy) {
                            case 'newest':
                                return new Date(b.createdAt || 0) - new Date(a.createdAt || 0);
                            case 'title':
                                return a.title.localeCompare(b.title);
                            case 'rating':
                                return b.rating - a.rating;
                            default:
                                return new Date(b.createdAt || 0) - new Date(a.createdAt || 0);
                        }
                    });
                    
                    return filtered;
                },
                isBookFilterActive() {
                    return this.bookFilters.search.trim() !== '' || 
                           this.bookFilters.selectedTags.length > 0 || 
                           this.bookFilters.status !== 'all' || 
                           this.bookFilters.sortBy !== 'newest';
                },
                filteredKbNotes() {
                    let filtered = [...this.kbNotes];
                    if (this.selectedCategory === 'all') {
                        // ÊòæÁ§∫ÂÖ®ÈÉ®
                    } else if (this.selectedCategory === 'uncategorized') {
                        filtered = filtered.filter(note => !note.categoryId);
                    } else if (this.selectedCategory && this.selectedCategory.id) {
                        filtered = filtered.filter(note => note.categoryId === this.selectedCategory.id);
                    }
                    if (this.kbSearchQuery.trim()) {
                        const query = this.kbSearchQuery.toLowerCase();
                        filtered = filtered.filter(note => note.title.toLowerCase().includes(query) || note.content.toLowerCase().includes(query));
                    }
                    return filtered.sort((a, b) => new Date(b.updatedAt || b.createdAt) - new Date(a.updatedAt || a.createdAt));
                }
            },
            
            methods: {
                showMessage(text, type = 'success') {
                    this.message = text;
                    this.messageType = type;
                    setTimeout(() => this.message = '', 4000);
                },
                
                async register() {
                    if (!this.email || !this.password) { this.showMessage('ËØ∑ËæìÂÖ•ÈÇÆÁÆ±ÂíåÂØÜÁ†Å', 'error'); return; }
                    if (this.password.length < 6) { this.showMessage('ÂØÜÁ†ÅËá≥Â∞ë6‰Ωç', 'error'); return; }
                    this.loading = true;
                    try {
                        const { data, error } = await sb.auth.signUp({ email: this.email, password: this.password });
                        if (error) throw error;
                        if (data.user && data.user.identities && data.user.identities.length === 0) {
                            this.showMessage('ÈÇÆÁÆ±Â∑≤Ê≥®ÂÜå', 'error');
                        } else {
                            this.showMessage('Ê≥®ÂÜåÊàêÂäüÔºÅËØ∑ÁôªÂΩï', 'success');
                        }
                        this.password = '';
                    } catch (error) {
                        this.showMessage(error.message || 'Ê≥®ÂÜåÂ§±Ë¥•', 'error');
                    } finally {
                        this.loading = false;
                    }
                },
                
                async login() {
                    if (!this.email || !this.password) { this.showMessage('ËØ∑ËæìÂÖ•ÈÇÆÁÆ±ÂíåÂØÜÁ†Å', 'error'); return; }
                    this.loading = true;
                    try {
                        const { data, error } = await sb.auth.signInWithPassword({ email: this.email.trim(), password: this.password });
                        if (error) throw error;
                        this.isLoggedIn = true;
                        this.userId = data.user.id;
                        this.userEmail = data.user.email;
                        this.showMessage('ÁôªÂΩïÊàêÂäüÔºÅ', 'success');
                        await this.loadAllData();
                    } catch (error) {
                        this.showMessage(error.message || 'ÁôªÂΩïÂ§±Ë¥•', 'error');
                    } finally {
                        this.loading = false;
                    }
                },
                
                async logout() {
                    await sb.auth.signOut();
                    this.isLoggedIn = false;
                    this.userId = null;
                    this.showKnowledgeBase = false;
                    this.resetData();
                    this.showMessage('Â∑≤ÈÄÄÂá∫', 'success');
                },
                
                async loadAllData() {
                    this.syncing = true;
                    try {
                        const { data: pData } = await sb.from('players').select('*').eq('user_id', this.userId).single();
                        if (pData && pData.data) this.playerData = pData.data;
                        
                        const { data: sData } = await sb.from('skills').select('*').eq('user_id', this.userId);
                        if (sData) this.skills = sData.map(s => s.data);
                        
                        const { data: aData } = await sb.from('achievements').select('*').eq('user_id', this.userId);
                        if (aData && aData.length > 0) {
                            const loadedAchievements = aData.map(a => a.data);
                            const defaultAchievements = [
                                { id: 1, name: 'ÂàùÂ≠¶ËÄÖ', icon: 'üå±', description: 'ÂàõÂª∫Á¨¨‰∏Ä‰∏™ÊäÄËÉΩ', requirement: 1, current: 0, unlocked: false, reward: 50, isCustom: false },
                                { id: 2, name: 'Â§öÈù¢Êâã', icon: 'üîß', description: 'Êã•Êúâ5‰∏™ÊäÄËÉΩ', requirement: 5, current: 0, unlocked: false, reward: 150, isCustom: false },
                                { id: 3, name: 'Á¨îËÆ∞Ëææ‰∫∫', icon: 'üìù', description: 'ÂàõÂª∫10Êù°Á¨îËÆ∞', requirement: 10, current: 0, unlocked: false, reward: 100, isCustom: false },
                                { id: 4, name: 'ÊàêÈïø‰πãË∑Ø', icon: 'üöÄ', description: 'ËææÂà∞10Á∫ß', requirement: 10, current: 0, unlocked: false, reward: 500, isCustom: false },
                            ];
                            const customAchievements = loadedAchievements.filter(a => a.isCustom);
                            const defaultWithData = defaultAchievements.map(defaultAch => {
                                const loadedAch = loadedAchievements.find(a => a.id === defaultAch.id && !a.isCustom);
                                return loadedAch ? loadedAch : defaultAch;
                            });
                            this.achievements = [...defaultWithData, ...customAchievements];
                        }
                        
                        const { data: nData } = await sb.from('notes').select('*').eq('user_id', this.userId);
                        if (nData) {
                            this.notes = nData.map(n => n.data);
                            this.notes.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                        }
                        
                        // Âä†ËΩΩËØª‰π¶Á¨îËÆ∞Êï∞ÊçÆ
                        const { data: bData } = await sb.from('books').select('*').eq('user_id', this.userId);
                        if (bData) {
                            this.books = bData.map(b => b.data);
                            this.books.sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0));
                        }
                        
                        const { data: kbCatData } = await sb.from('kb_categories').select('*').eq('user_id', this.userId);
                        if (kbCatData) this.kbCategories = kbCatData.map(c => c.data);
                        
                        const { data: kbNotesData } = await sb.from('kb_notes').select('*').eq('user_id', this.userId);
                        if (kbNotesData) this.kbNotes = kbNotesData.map(n => n.data);
                        
                        this.updateAchievements();
                        this.showMessage('Êï∞ÊçÆÂ∑≤Âä†ËΩΩ', 'success');
                    } catch (error) {
                        console.error('Âä†ËΩΩÂ§±Ë¥•:', error);
                    } finally {
                        this.syncing = false;
                    }
                },
                
                resetData() {
                    this.playerData = { level: 1, xp: 0, nextLevelXp: 100 };
                    this.skills = [];
                    this.achievements = [
                        { id: 1, name: 'ÂàùÂ≠¶ËÄÖ', icon: 'üå±', description: 'ÂàõÂª∫Á¨¨‰∏Ä‰∏™ÊäÄËÉΩ', requirement: 1, current: 0, unlocked: false, reward: 50, isCustom: false },
                        { id: 2, name: 'Â§öÈù¢Êâã', icon: 'üîß', description: 'Êã•Êúâ5‰∏™ÊäÄËÉΩ', requirement: 5, current: 0, unlocked: false, reward: 150, isCustom: false },
                        { id: 3, name: 'Á¨îËÆ∞Ëææ‰∫∫', icon: 'üìù', description: 'ÂàõÂª∫10Êù°Á¨îËÆ∞', requirement: 10, current: 0, unlocked: false, reward: 100, isCustom: false },
                        { id: 4, name: 'ÊàêÈïø‰πãË∑Ø', icon: 'üöÄ', description: 'ËææÂà∞10Á∫ß', requirement: 10, current: 0, unlocked: false, reward: 500, isCustom: false },
                    ];
                    this.notes = [];
                    this.books = [];
                    this.kbCategories = [];
                    this.kbNotes = [];
                },
                
                async syncData() { await this.loadAllData(); },
                
                async saveAllData() {
                    if (!this.userId) return;
                    this.saving = true;
                    try {
                        await sb.from('players').upsert({ user_id: this.userId, data: this.playerData });
                        
                        await sb.from('skills').delete().eq('user_id', this.userId);
                        if (this.skills.length > 0) await sb.from('skills').insert(this.skills.map(skill => ({ user_id: this.userId, data: skill })));
                        
                        await sb.from('achievements').delete().eq('user_id', this.userId);
                        if (this.achievements.length > 0) await sb.from('achievements').insert(this.achievements.map(ach => ({ user_id: this.userId, data: ach })));
                        
                        await sb.from('notes').delete().eq('user_id', this.userId);
                        if (this.notes.length > 0) await sb.from('notes').insert(this.notes.map(note => ({ user_id: this.userId, data: note })));
                        
                        // ‰øùÂ≠òËØª‰π¶Á¨îËÆ∞Êï∞ÊçÆ
                        await sb.from('books').delete().eq('user_id', this.userId);
                        if (this.books.length > 0) await sb.from('books').insert(this.books.map(book => ({ user_id: this.userId, data: book })));
                        
                        await sb.from('kb_categories').delete().eq('user_id', this.userId);
                        if (this.kbCategories.length > 0) await sb.from('kb_categories').insert(this.kbCategories.map(cat => ({ user_id: this.userId, data: cat })));
                        
                        await sb.from('kb_notes').delete().eq('user_id', this.userId);
                        if (this.kbNotes.length > 0) await sb.from('kb_notes').insert(this.kbNotes.map(note => ({ user_id: this.userId, data: note })));
                        
                    } catch (error) {
                        console.error('‰øùÂ≠òÂ§±Ë¥•:', error);
                    } finally {
                        this.saving = false;
                    }
                },
                
                addXp(amount) {
                    this.playerData.xp += amount;
                    while (this.playerData.xp >= this.playerData.nextLevelXp) {
                        this.playerData.xp -= this.playerData.nextLevelXp;
                        this.playerData.level++;
                        this.playerData.nextLevelXp = Math.floor(this.playerData.nextLevelXp * 1.5);
                        this.showMessage('ÂçáÁ∫ß‰∫ÜÔºÅÁé∞Âú®ÊòØ Lv.' + this.playerData.level, 'success');
                    }
                    this.updateAchievements();
                    this.saveAllData();
                },
                
                addNewSkill() {
                    const name = prompt('ËØ∑ËæìÂÖ•ÊäÄËÉΩÂêçÁß∞:');
                    if (!name || !name.trim()) return;
                    const category = prompt('ËØ∑ËæìÂÖ•ÊäÄËÉΩÂàÜÁ±ª (Â¶Ç: ÁºñÁ®ã„ÄÅËØ≠Ë®Ä„ÄÅËøêÂä®):') || 'ÈÄöÁî®';
                    const icons = ['üíª', 'üìö', 'üé®', 'üéµ', 'üèÉ', 'üç≥', 'üì∑', '‚úçÔ∏è', 'üéØ', 'üß†'];
                    const newSkill = {
                        id: Date.now(),
                        name: name.trim(),
                        category: category.trim(),
                        icon: icons[Math.floor(Math.random() * icons.length)],
                        level: 1,
                        xp: 0,
                        maxXp: 50
                    };
                    this.skills.push(newSkill);
                    this.addXp(10);
                    this.showMessage('ÊäÄËÉΩÂ∑≤Ê∑ªÂä†ÔºÅ+10 XP', 'success');
                },
                
                practiceSkill(skillId) {
                    const skill = this.skills.find(s => s.id === skillId);
                    if (!skill) return;
                    const xpGain = 10 + Math.floor(Math.random() * 10);
                    skill.xp += xpGain;
                    if (skill.xp >= skill.maxXp) {
                        skill.xp -= skill.maxXp;
                        skill.level++;
                        skill.maxXp = Math.floor(skill.maxXp * 1.3);
                        this.showMessage(skill.name + ' ÂçáÁ∫ß‰∫ÜÔºÅLv.' + skill.level, 'success');
                    }
                    this.addXp(xpGain);
                    this.showMessage('ÁªÉ‰π†ÂÆåÊàêÔºÅ+' + xpGain + ' XP', 'success');
                },
                
                deleteSkill(skillId) {
                    if (!confirm('Á°ÆÂÆöÂà†Èô§Ëøô‰∏™ÊäÄËÉΩÂêóÔºü')) return;
                    const index = this.skills.findIndex(s => s.id === skillId);
                    if (index !== -1) {
                        this.skills.splice(index, 1);
                        this.updateAchievements();
                        this.saveAllData();
                        this.showMessage('ÊäÄËÉΩÂ∑≤Âà†Èô§', 'success');
                    }
                },
                
                updateAchievements() {
                    this.achievements.forEach(ach => {
                        if (ach.unlocked) return;
                        switch (ach.id) {
                            case 1: ach.current = this.skills.length; break;
                            case 2: ach.current = this.skills.length; break;
                            case 3: ach.current = this.notes.length; break;
                            case 4: ach.current = this.playerData.level; break;
                        }
                        if (ach.current >= ach.requirement && !ach.unlocked) {
                            ach.unlocked = true;
                            this.addXp(ach.reward);
                            this.showMessage('ÊàêÂ∞±Ëß£ÈîÅ: ' + ach.name + '! +' + ach.reward + ' XP', 'success');
                        }
                    });
                },
                
                saveAchievement() {
                    if (!this.newAchievement.name.trim()) { this.showMessage('ËØ∑ËæìÂÖ•ÊàêÂ∞±ÂêçÁß∞', 'error'); return; }
                    if (this.editingAchievementId) {
                        const ach = this.achievements.find(a => a.id === this.editingAchievementId);
                        if (ach) {
                            ach.name = this.newAchievement.name.trim();
                            ach.description = this.newAchievement.description.trim();
                            ach.icon = this.newAchievement.icon;
                            ach.requirement = this.newAchievement.requirement || 1;
                            ach.reward = this.newAchievement.reward || 50;
                            this.showMessage('ÊàêÂ∞±Â∑≤Êõ¥Êñ∞', 'success');
                        }
                    } else {
                        const newAch = {
                            id: Date.now(),
                            name: this.newAchievement.name.trim(),
                            description: this.newAchievement.description.trim(),
                            icon: this.newAchievement.icon,
                            requirement: this.newAchievement.requirement || 1,
                            current: 0,
                            unlocked: false,
                            reward: this.newAchievement.reward || 50,
                            isCustom: true
                        };
                        this.achievements.push(newAch);
                        this.showMessage('ÊàêÂ∞±Â∑≤ÂàõÂª∫', 'success');
                    }
                    this.cancelNewAchievement();
                    this.saveAllData();
                },
                
                editAchievement(achId) {
                    const ach = this.achievements.find(a => a.id === achId);
                    if (ach) {
                        this.newAchievement = { name: ach.name, description: ach.description, icon: ach.icon, requirement: ach.requirement, reward: ach.reward, isCustom: true };
                        this.editingAchievementId = achId;
                        this.showAchievementForm = true;
                    }
                },
                
                deleteAchievement(achId) {
                    if (!confirm('Á°ÆÂÆöÂà†Èô§Ëøô‰∏™ÊàêÂ∞±ÂêóÔºü')) return;
                    const index = this.achievements.findIndex(a => a.id === achId);
                    if (index !== -1) {
                        this.achievements.splice(index, 1);
                        this.saveAllData();
                        this.showMessage('ÊàêÂ∞±Â∑≤Âà†Èô§', 'success');
                    }
                },
                
                cancelNewAchievement() {
                    this.newAchievement = { name: '', description: '', icon: 'üèÜ', requirement: 1, reward: 50, isCustom: true };
                    this.editingAchievementId = null;
                    this.showAchievementForm = false;
                },
                
                async saveNote() {
                    if (!this.newNote.title.trim()) { this.showMessage('ËØ∑ËæìÂÖ•Á¨îËÆ∞Ê†áÈ¢ò', 'error'); return; }
                    if (!this.newNote.content.trim()) { this.showMessage('ËØ∑ËæìÂÖ•Á¨îËÆ∞ÂÜÖÂÆπ', 'error'); return; }
                    const tags = this.newNote.tags ? this.newNote.tags.split(',').map(t => t.trim()).filter(t => t) : [];
                    const note = {
                        id: Date.now(),
                        title: this.newNote.title.trim(),
                        content: this.newNote.content.trim(),
                        tags: tags,
                        createdAt: new Date().toISOString()
                    };
                    this.notes.unshift(note);
                    this.newNote = { title: '', content: '', tags: '' };
                    this.activeNoteTab = 'all';
                    this.addXp(15);
                    this.showMessage('Á¨îËÆ∞Â∑≤‰øùÂ≠òÔºÅ+15 XP', 'success');
                },
                
                deleteNote(noteId) {
                    if (!confirm('Á°ÆÂÆöÂà†Èô§ËøôÊù°Á¨îËÆ∞ÂêóÔºü')) return;
                    const index = this.notes.findIndex(n => n.id === noteId);
                    if (index !== -1) {
                        this.notes.splice(index, 1);
                        this.updateAchievements();
                        this.saveAllData();
                        this.showMessage('Á¨îËÆ∞Â∑≤Âà†Èô§', 'success');
                    }
                },
                
                formatDate(dateStr) {
                    if (!dateStr) return '';
                    const date = new Date(dateStr);
                    return date.toLocaleString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
                },
                
                formatDateShort(dateStr) {
                    if (!dateStr) return '';
                    const date = new Date(dateStr);
                    return date.toLocaleDateString('zh-CN', { month: '2-digit', day: '2-digit' });
                },
                
                toggleTagFilter(tag) {
                    const index = this.noteFilters.selectedTags.indexOf(tag);
                    if (index === -1) {
                        this.noteFilters.selectedTags.push(tag);
                    } else {
                        this.noteFilters.selectedTags.splice(index, 1);
                    }
                },
                
                setTagFilter(tag) {
                    this.noteFilters.selectedTags = [tag];
                    this.collapsed.filterExpanded = false;
                },
                
                clearFilters() {
                    this.noteFilters = { search: '', selectedTags: [], sortBy: 'newest' };
                },
                
                applyFilters() {},
                
                // ËØª‰π¶Á¨îËÆ∞ÊñπÊ≥ï
                toggleBookTag(tag) {
                    const index = this.newBook.tags.indexOf(tag);
                    if (index === -1) {
                        this.newBook.tags.push(tag);
                    } else {
                        this.newBook.tags.splice(index, 1);
                    }
                },
                
                addCustomBookTag() {
                    if (this.newBook.customTag.trim() && !this.newBook.tags.includes(this.newBook.customTag.trim())) {
                        this.newBook.tags.push(this.newBook.customTag.trim());
                        this.newBook.customTag = '';
                    }
                },
                
                async saveBook() {
                    if (!this.newBook.title.trim()) { this.showMessage('ËØ∑ËæìÂÖ•‰π¶Âêç', 'error'); return; }
                    if (!this.newBook.author.trim()) { this.showMessage('ËØ∑ËæìÂÖ•‰ΩúËÄÖ', 'error'); return; }
                    
                    const bookData = {
                        id: this.editingBookId || Date.now(),
                        title: this.newBook.title.trim(),
                        author: this.newBook.author.trim(),
                        status: this.newBook.status,
                        rating: this.newBook.rating,
                        notes: this.newBook.notes.trim(),
                        insights: this.newBook.insights.trim(),
                        tags: [...this.newBook.tags],
                        startDate: this.newBook.startDate || null,
                        finishDate: this.newBook.finishDate || null,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    };
                    
                    if (this.editingBookId) {
                        const index = this.books.findIndex(b => b.id === this.editingBookId);
                        if (index !== -1) {
                            this.books[index] = bookData;
                            this.showMessage('ËØª‰π¶Á¨îËÆ∞Â∑≤Êõ¥Êñ∞', 'success');
                        }
                    } else {
                        this.books.unshift(bookData);
                        this.showMessage('ËØª‰π¶Á¨îËÆ∞Â∑≤Ê∑ªÂä†', 'success');
                        this.addXp(20); // Ê∑ªÂä†ËØª‰π¶Á¨îËÆ∞Â•ñÂä±ÁªèÈ™å
                    }
                    
                    await this.saveAllData();
                    this.resetBookForm();
                    this.activeBookTab = 'all';
                },
                
                editBook(bookId) {
                    const book = this.books.find(b => b.id === bookId);
                    if (book) {
                        this.newBook = {
                            title: book.title,
                            author: book.author,
                            status: book.status,
                            rating: book.rating,
                            notes: book.notes || '',
                            insights: book.insights || '',
                            tags: [...book.tags],
                            customTag: '',
                            startDate: book.startDate || new Date().toISOString().split('T')[0],
                            finishDate: book.finishDate || ''
                        };
                        this.editingBookId = bookId;
                        this.activeBookTab = 'new';
                    }
                },
                
                async deleteBook(bookId) {
                    if (!confirm('Á°ÆÂÆöÂà†Èô§ËøôÊú¨ËØª‰π¶Á¨îËÆ∞ÂêóÔºü')) return;
                    const index = this.books.findIndex(b => b.id === bookId);
                    if (index !== -1) {
                        this.books.splice(index, 1);
                        await this.saveAllData();
                        this.showMessage('ËØª‰π¶Á¨îËÆ∞Â∑≤Âà†Èô§', 'success');
                    }
                },
                
                resetBookForm() {
                    this.newBook = {
                        title: '',
                        author: '',
                        status: 'planning',
                        rating: 0,
                        notes: '',
                        insights: '',
                        tags: [],
                        customTag: '',
                        startDate: new Date().toISOString().split('T')[0],
                        finishDate: ''
                    };
                    this.editingBookId = null;
                },
                
                toggleBookFilterTag(tag) {
                    const index = this.bookFilters.selectedTags.indexOf(tag);
                    if (index === -1) {
                        this.bookFilters.selectedTags.push(tag);
                    } else {
                        this.bookFilters.selectedTags.splice(index, 1);
                    }
                },
                
                setBookTagFilter(tag) {
                    this.bookFilters.selectedTags = [tag];
                    this.collapsed.bookFilterExpanded = false;
                },
                
                clearBookFilters() {
                    this.bookFilters = {
                        search: '',
                        selectedTags: [],
                        status: 'all',
                        sortBy: 'newest'
                    };
                },
                
                // Áü•ËØÜÂ∫ìÊñπÊ≥ï
                openKnowledgeBase() {
                    this.showKnowledgeBase = true;
                    this.selectedCategory = 'all';
                    this.kbSearchQuery = '';
                },
                
                closeKnowledgeBase() {
                    this.showKnowledgeBase = false;
                    this.selectedCategory = 'all';
                    this.kbSearchQuery = '';
                },
                
                selectCategory(category) {
                    this.selectedCategory = category;
                },
                
                getCategoryNotesCount(categoryId) {
                    return this.kbNotes.filter(note => note.categoryId === categoryId).length;
                },
                
                getUncategorizedCount() {
                    return this.kbNotes.filter(note => !note.categoryId).length;
                },
                
                getCategoryName(categoryId) {
                    const category = this.kbCategories.find(c => c.id === categoryId);
                    return category ? category.name : 'Êú™ÂàÜÁ±ª';
                },
                
                getCategoryIcon(categoryId) {
                    const category = this.kbCategories.find(c => c.id === categoryId);
                    return category ? category.icon : 'üìã';
                },
                
                editCategory(category) {
                    this.categoryForm = { name: category.name, icon: category.icon };
                    this.editingCategoryId = category.id;
                    this.showCategoryForm = true;
                },
                
                async saveCategoryForm() {
                    if (!this.categoryForm.name.trim()) { this.showMessage('ËØ∑ËæìÂÖ•ÂàÜÁ±ªÂêçÁß∞', 'error'); return; }
                    if (this.editingCategoryId) {
                        const category = this.kbCategories.find(c => c.id === this.editingCategoryId);
                        if (category) {
                            category.name = this.categoryForm.name.trim();
                            category.icon = this.categoryForm.icon;
                            this.showMessage('ÂàÜÁ±ªÂ∑≤Êõ¥Êñ∞', 'success');
                        }
                    } else {
                        const newCategory = {
                            id: Date.now(),
                            name: this.categoryForm.name.trim(),
                            icon: this.categoryForm.icon,
                            createdAt: new Date().toISOString()
                        };
                        this.kbCategories.push(newCategory);
                        this.showMessage('ÂàÜÁ±ªÂ∑≤ÂàõÂª∫', 'success');
                    }
                    await this.saveAllData();
                    this.closeCategoryForm();
                },
                
                closeCategoryForm() {
                    this.showCategoryForm = false;
                    this.editingCategoryId = null;
                    this.categoryForm = { name: '', icon: 'üìÅ' };
                },
                
                async deleteCategory(categoryId) {
                    if (!confirm('Á°ÆÂÆöÂà†Èô§Ê≠§ÂàÜÁ±ªÔºüËØ•ÂàÜÁ±ª‰∏ãÁöÑÁ¨îËÆ∞Â∞ÜÂèò‰∏∫Êú™ÂàÜÁ±ª„ÄÇ')) return;
                    const index = this.kbCategories.findIndex(c => c.id === categoryId);
                    if (index !== -1) {
                        this.kbCategories.splice(index, 1);
                        this.kbNotes.forEach(note => {
                            if (note.categoryId === categoryId) note.categoryId = null;
                        });
                        if (this.selectedCategory && this.selectedCategory.id === categoryId) {
                            this.selectedCategory = 'all';
                        }
                        await this.saveAllData();
                        this.showMessage('ÂàÜÁ±ªÂ∑≤Âà†Èô§', 'success');
                    }
                },
                
                editKbNote(note) {
                    this.noteForm = { title: note.title, content: note.content, categoryId: note.categoryId };
                    this.editingNoteId = note.id;
                    this.showNoteEditor = true;
                },
                
                async saveNoteForm() {
                    if (!this.noteForm.title.trim()) { this.showMessage('ËØ∑ËæìÂÖ•Á¨îËÆ∞Ê†áÈ¢ò', 'error'); return; }
                    if (!this.noteForm.content.trim()) { this.showMessage('ËØ∑ËæìÂÖ•Á¨îËÆ∞ÂÜÖÂÆπ', 'error'); return; }
                    if (this.editingNoteId) {
                        const note = this.kbNotes.find(n => n.id === this.editingNoteId);
                        if (note) {
                            note.title = this.noteForm.title.trim();
                            note.content = this.noteForm.content.trim();
                            note.categoryId = this.noteForm.categoryId;
                            note.updatedAt = new Date().toISOString();
                            this.showMessage('Á¨îËÆ∞Â∑≤Êõ¥Êñ∞', 'success');
                        }
                    } else {
                        const newNote = {
                            id: Date.now(),
                            title: this.noteForm.title.trim(),
                            content: this.noteForm.content.trim(),
                            categoryId: this.noteForm.categoryId,
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        };
                        this.kbNotes.unshift(newNote);
                        this.showMessage('Á¨îËÆ∞Â∑≤ÂàõÂª∫', 'success');
                    }
                    await this.saveAllData();
                    this.closeNoteEditor();
                },
                
                closeNoteEditor() {
                    this.showNoteEditor = false;
                    this.editingNoteId = null;
                    this.noteForm = { title: '', content: '', categoryId: null };
                },
                
                async deleteKbNote(noteId) {
                    if (!confirm('Á°ÆÂÆöÂà†Èô§ËøôÁØáÁ¨îËÆ∞Ôºü')) return;
                    const index = this.kbNotes.findIndex(n => n.id === noteId);
                    if (index !== -1) {
                        this.kbNotes.splice(index, 1);
                        await this.saveAllData();
                        this.showMessage('Á¨îËÆ∞Â∑≤Âà†Èô§', 'success');
                    }
                },
                
                openNoteDetail(note) {
                    this.viewingNote = note;
                },
                
                closeNoteDetail() {
                    this.viewingNote = null;
                },
                
                getPreviewText(content) {
                    return content.length > 100 ? content.substring(0, 100) + '...' : content;
                }
            },
            
            async mounted() {
                try {
                    const { data: { session } } = await sb.auth.getSession();
                    if (session) {
                        this.isLoggedIn = true;
                        this.userId = session.user.id;
                        this.userEmail = session.user.email;
                        await this.loadAllData();
                    }
                    
                    sb.auth.onAuthStateChange((event, session) => {
                        if (event === 'SIGNED_IN' && session) {
                            this.isLoggedIn = true;
                            this.userId = session.user.id;
                            this.userEmail = session.user.email;
                            this.loadAllData();
                        } else if (event === 'SIGNED_OUT') {
                            this.isLoggedIn = false;
                            this.userId = null;
                            this.showKnowledgeBase = false;
                            this.resetData();
                        }
                    });
                } catch (error) {
                    console.error('ÂàùÂßãÂåñÂ§±Ë¥•:', error);
                }
            }
        }).mount('#app');
    </script>
</body>
</html>

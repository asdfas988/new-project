<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆé•¿æ‰‹è´¦ - ä½ çš„ä¸ªäººæˆé•¿ç³»ç»Ÿ</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* ========== å…¨å±€åŸºç¡€æ ·å¼ ========== */
        :root {
            --primary-gradient: linear-gradient(135deg, #ff9a8b 0%, #ff6a88 55%, #ff99ac 100%);
            --secondary-gradient: linear-gradient(120deg, #84fab0 0%, #8fd3f4 100%);
            --accent-color: #5a4a42;
            --bg-color: #fef9f3;
            --card-bg: #fffefc;
            --border-color: #e0c9b8;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Noto Sans SC', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-color);
            min-height: 100vh;
            color: var(--accent-color);
            padding: 20px;
        }
        
        /* æ»šåŠ¨æ¡ç¾åŒ– */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #dccdc3; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #c0b0a3; }

        .container { max-width: 1400px; margin: 0 auto; }
        
        /* å¤´éƒ¨æ ·å¼ */
        .header {
            text-align: center; margin-bottom: 30px; padding: 30px;
            background: #fffaf0; border-radius: 24px;
            box-shadow: 8px 8px 0px var(--border-color);
            border: 3px solid var(--accent-color);
            position: relative;
        }
        .header h1 { font-size: 2.5em; font-weight: 700; text-shadow: 3px 3px 0px #ffd6cc; }

        .grid { display: grid; grid-template-columns: 1fr; gap: 30px; margin-bottom: 40px; }
        
        /* å¡ç‰‡é€šç”¨æ ·å¼ */
        .card {
            background: var(--card-bg); border-radius: 20px; padding: 30px;
            box-shadow: 6px 6px 0px #d4b8a7; border: 2.5px solid var(--accent-color);
            transition: transform 0.3s;
        }
        .card h2 {
            margin-bottom: 20px; padding-bottom: 15px;
            border-bottom: 3px dotted #ff9a8b;
            font-size: 1.4em; font-weight: 700;
            display: flex; justify-content: space-between; align-items: center;
        }

        /* æŒ‰é’®ä½“ç³» */
        .btn {
            background: var(--primary-gradient); border: none; padding: 12px 30px;
            border-radius: 50px; color: white; cursor: pointer;
            font-size: 16px; font-weight: 700; transition: all 0.3s;
            box-shadow: 4px 4px 0px #d45d5d; width: 100%;
        }
        .btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 6px 6px 0px #d45d5d; }
        .btn:disabled { opacity: 0.7; cursor: not-allowed; }
        
        .btn-sm {
            padding: 6px 16px; font-size: 0.9em; border-radius: 20px;
            background: var(--secondary-gradient); color: #2d5a27;
            box-shadow: 2px 2px 0px #2ba69b; border: none; font-weight: bold; cursor: pointer;
        }
        .btn-danger { background: #ff6b6b; color: white; box-shadow: 2px 2px 0px #c0392b; }
        
        .collapse-btn {
            background: #fffaf5; border: 2px solid #ff9a8b; color: #ff6b6b;
            padding: 4px 12px; border-radius: 12px; font-size: 0.8em; font-weight: bold; cursor: pointer;
        }

        /* è¾“å…¥æ¡†ä½“ç³» */
        .note-input, .note-textarea, .filter-input {
            width: 100%; padding: 12px; border: 2px solid var(--border-color);
            border-radius: 12px; font-size: 15px; font-family: inherit;
            background: #fffaf9; transition: all 0.3s; margin-bottom: 15px;
        }
        .note-textarea { min-height: 120px; resize: vertical; line-height: 1.6; }
        .note-input:focus, .note-textarea:focus { outline: none; border-color: #ff9a8b; box-shadow: 0 0 0 3px rgba(255, 154, 139, 0.2); }

        /* çŠ¶æ€ä¸åŠ è½½ */
        .status-message { padding: 12px 20px; border-radius: 12px; margin: 15px 0; font-weight: bold; text-align: center; }
        .status-success { background: #d4edda; color: #155724; border: 2px solid #c3e6cb; }
        .status-error { background: #f8d7da; color: #721c24; border: 2px solid #f5c6cb; }
        .loading-spinner { display: inline-block; width: 16px; height: 16px; border: 3px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 1s infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* ========== ç‰¹è‰²æ¨¡å—ï¼šçƒ­åŠ›å›¾ & æ¸¸æˆåŒ– ========== */
        .heatmap-container { display: flex; gap: 4px; justify-content: center; margin: 15px 0; flex-wrap: wrap; }
        .heatmap-day { width: 18px; height: 18px; border-radius: 4px; background: #eee; border: 1px solid #ddd; position: relative; }
        .heatmap-day.level-1 { background: #d6e685; border-color: #bedb39; }
        .heatmap-day.level-2 { background: #8cc665; border-color: #7bc96f; }
        .heatmap-day.level-3 { background: #44a340; border-color: #30923c; }
        .heatmap-day.level-4 { background: #1e6823; border-color: #196127; }
        .heatmap-legend { display: flex; gap: 5px; font-size: 0.8em; color: #888; align-items: center; justify-content: center; margin-top: 5px; }

        .level-display { font-size: 3.5em; font-weight: 800; text-align: center; color: #ff6b6b; margin: 10px 0; }
        .xp-progress { height: 20px; background: #ffe8d6; border-radius: 10px; overflow: hidden; border: 2px solid var(--accent-color); }
        .xp-fill { height: 100%; background: var(--secondary-gradient); transition: width 0.5s ease; }

        /* ========== å¤ç›˜ç³»ç»Ÿ (åŸç¬”è®°æœ¬) ========== */
        .review-tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid var(--border-color); padding-bottom: 10px; overflow-x: auto; }
        .review-tab {
            padding: 8px 18px; border: 2px solid transparent; border-radius: 20px;
            cursor: pointer; font-weight: 600; font-size: 0.95em; white-space: nowrap;
            background: #fff; border-color: var(--border-color);
        }
        .review-tab.active { background: var(--accent-color); color: white; border-color: var(--accent-color); }
        .review-tab.active-special { background: var(--primary-gradient); color: white; border: none; }

        .template-btn { font-size: 0.85em; padding: 4px 10px; background: #fffaf5; border: 1px dashed #ff9a8b; color: #ff6b6b; border-radius: 6px; cursor: pointer; margin-bottom: 8px; display: inline-block; }
        .template-btn:hover { background: #fff0eb; }

        /* ç­›é€‰å®¹å™¨é€šç”¨ */
        .filter-panel { background: #fffaf5; border: 1px solid var(--border-color); padding: 15px; border-radius: 12px; margin-bottom: 20px; }
        .filter-row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; margin-bottom: 10px; }
        .filter-tag { padding: 4px 12px; background: #fff; border: 1px solid var(--border-color); border-radius: 15px; cursor: pointer; font-size: 0.9em; }
        .filter-tag.active { background: #ff9a8b; color: white; border-color: #ff9a8b; }
        
        /* ç¬”è®°å¡ç‰‡ */
        .note-card { background: #fffaf5; padding: 20px; border-radius: 15px; margin-bottom: 15px; border: 2px solid var(--border-color); position: relative; }
        .note-date { font-size: 0.85em; color: #999; margin-bottom: 8px; display: block; }
        .note-tags { display: flex; gap: 5px; flex-wrap: wrap; margin-top: 10px; }
        .note-tag-pill { background: #e0f2f1; color: #00695c; padding: 2px 8px; border-radius: 4px; font-size: 0.8em; font-weight: 600; }
        .note-type-pill { position: absolute; top: 20px; right: 20px; font-size: 0.8em; padding: 2px 8px; border-radius: 4px; background: #fff3e0; color: #e65100; border: 1px solid #ffb74d; }

        /* ========== è¯»ä¹¦ç¬”è®° ========== */
        .book-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .book-card {
            background: #fff; border: 2px solid var(--border-color); border-radius: 16px;
            padding: 20px; cursor: pointer; transition: all 0.3s;
            display: flex; flex-direction: column; height: 100%;
        }
        .book-card:hover { transform: translateY(-5px); border-color: #667eea; box-shadow: 0 10px 20px rgba(102,126,234,0.1); }
        .book-status-badge { display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 0.8em; font-weight: bold; margin-bottom: 10px; width: fit-content; }
        .status-planning { background: #eee; color: #666; }
        .status-reading { background: #fff3cd; color: #856404; }
        .status-finished { background: #d4edda; color: #155724; }

        /* ========== çŸ¥è¯†åº“ï¼ˆè¯­é›€é£æ ¼ï¼‰ ========== */
        .kb-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; backdrop-filter: blur(5px); display: flex; justify-content: center; align-items: center; }
        .kb-window { width: 95%; max-width: 1400px; height: 92vh; background: #fff; border-radius: 12px; display: flex; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); }
        
        .kb-sidebar { width: 260px; background: #fafafa; border-right: 1px solid #eee; display: flex; flex-direction: column; flex-shrink: 0; }
        .kb-sidebar-head { padding: 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .kb-nav-item { padding: 10px 20px; cursor: pointer; display: flex; align-items: center; gap: 10px; color: #444; font-size: 14px; }
        .kb-nav-item:hover { background: #eee; }
        .kb-nav-item.active { background: #e6f7ff; color: #1890ff; border-right: 3px solid #1890ff; }
        
        .kb-main { flex: 1; display: flex; flex-direction: column; background: #fff; }
        .kb-toolbar { padding: 15px 30px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .kb-breadcrumbs { color: #888; font-size: 14px; }
        
        .kb-content { flex: 1; overflow-y: auto; padding: 40px; }
        .kb-doc-list-item { padding: 15px 0; border-bottom: 1px solid #f5f5f5; cursor: pointer; display: flex; justify-content: space-between; }
        .kb-doc-list-item:hover { background: #fafafa; padding-left: 10px; padding-right: 10px; border-radius: 6px; }
        
        /* è¯¦æƒ…å¼¹çª—é€šç”¨ */
        .modal-body { padding: 20px; overflow-y: auto; max-height: 70vh; line-height: 1.8; white-space: pre-wrap; }
        .modal-footer { padding: 20px; border-top: 1px solid #eee; text-align: right; }

        @media (max-width: 768px) {
            .kb-window { width: 100%; height: 100%; border-radius: 0; }
            .kb-sidebar { width: 60px; }
            .kb-nav-item span:not(.icon) { display: none; }
            .grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div id="app" class="container">
        <!-- ç™»å½•ç•Œé¢ (ä¿æŒä¸å˜) -->
        <div v-if="!isLoggedIn" style="max-width: 500px; margin: 100px auto;">
            <div class="header">
                <h1>ğŸŒ± æˆé•¿æ‰‹è´¦</h1>
                <p>è®°å½• Â· å¤ç›˜ Â· è¿›åŒ–</p>
            </div>
            <div class="card">
                <input type="email" v-model="email" placeholder="é‚®ç®±" class="note-input">
                <input type="password" v-model="password" placeholder="å¯†ç  (è‡³å°‘6ä½)" class="note-input">
                <button class="btn" @click="login" :disabled="loading">{{ loading ? 'å¤„ç†ä¸­...' : 'ç™»å½• / æ³¨å†Œ' }}</button>
                <div style="text-align:center; margin-top:15px; font-size:0.9em; color:#888;">
                    æ–°ç”¨æˆ·è¾“å…¥é‚®ç®±å¯†ç åç‚¹å‡»æŒ‰é’®è‡ªåŠ¨æ³¨å†Œ
                </div>
            </div>
            <div v-if="message" :class="['status-message', messageType === 'success' ? 'status-success' : 'status-error']">{{ message }}</div>
        </div>

        <!-- ä¸»ç•Œé¢ -->
        <div v-else>
            <div class="header" style="display:flex; justify-content:space-between; align-items:center; padding: 20px 40px;">
                <div style="text-align:left;">
                    <h1 style="font-size:1.8em; margin:0;">ğŸš€ {{ userEmail.split('@')[0] }}çš„æˆé•¿ç©ºé—´</h1>
                    <div style="margin-top:5px; font-size:0.9em; opacity:0.8;">ä¿æŒçƒ­çˆ±ï¼Œå¥”èµ´å±±æµ·</div>
                </div>
                <div>
                    <button class="btn-sm" @click="syncData" :disabled="syncing">
                        <span v-if="syncing" class="loading-spinner"></span> {{ syncing ? 'åŒæ­¥ä¸­' : 'ğŸ”„ åŒæ­¥æ•°æ®' }}
                    </button>
                    <button class="btn-sm btn-danger" @click="logout" style="margin-left:10px;">é€€å‡º</button>
                </div>
            </div>

            <div v-if="message" :class="['status-message', messageType === 'success' ? 'status-success' : 'status-error']">{{ message }}</div>

            <!-- ä»ªè¡¨ç›˜ï¼šçƒ­åŠ›å›¾ä¸ç­‰çº§ -->
            <div class="card" style="margin-bottom:30px;">
                <h2>ğŸ“Š æˆé•¿æ¦‚è§ˆ <button class="collapse-btn" @click="collapsed.stats = !collapsed.stats">{{ collapsed.stats ? 'å±•å¼€' : 'æ”¶èµ·' }}</button></h2>
                <div v-show="!collapsed.stats">
                    <div style="display:flex; align-items:center; gap:30px; flex-wrap:wrap;">
                        <div style="flex:1; min-width:200px; text-align:center;">
                            <div class="level-display">Lv.{{ playerData.level }}</div>
                            <div class="xp-progress"><div class="xp-fill" :style="{width: xpPercentage + '%'}"></div></div>
                            <div style="margin-top:5px; font-size:0.9em; color:#888;">{{ playerData.xp }} / {{ playerData.nextLevelXp }} XP</div>
                        </div>
                        <div style="flex:2; min-width:300px;">
                            <h3 style="font-size:1em; margin-bottom:10px; color:#888;">ğŸ“ è¿‘14å¤©æ´»è·ƒåº¦ (è¿ç»­è®°å½•æŒ‘æˆ˜)</h3>
                            <div class="heatmap-container">
                                <div v-for="(day, index) in activityHeatmap" :key="index" 
                                     class="heatmap-day" 
                                     :class="'level-' + day.level" 
                                     :title="day.date + ': ' + day.count + 'æ¬¡æ´»åŠ¨'">
                                </div>
                            </div>
                            <div class="heatmap-legend">
                                <span>å°‘</span>
                                <div class="heatmap-day level-1" style="width:12px;height:12px;"></div>
                                <div class="heatmap-day level-2" style="width:12px;height:12px;"></div>
                                <div class="heatmap-day level-3" style="width:12px;height:12px;"></div>
                                <div class="heatmap-day level-4" style="width:12px;height:12px;"></div>
                                <span>å¤š</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid">
                <!-- æ¨¡å—ä¸€ï¼šå¤ç›˜ç³»ç»Ÿ (åŸç¬”è®°æœ¬å‡çº§ç‰ˆ) -->
                <div class="card">
                    <h2>ğŸ”„ å¤ç›˜ç³»ç»Ÿ <button class="collapse-btn" @click="collapsed.reviews = !collapsed.reviews">{{ collapsed.reviews ? 'å±•å¼€' : 'æ”¶èµ·' }}</button></h2>
                    <div v-show="!collapsed.reviews">
                        <div class="review-tabs">
                            <div class="review-tab" :class="{active: activeReviewTab === 'daily'}" @click="activeReviewTab = 'daily'">ğŸ“ æ—¥å¸¸è®°å½•</div>
                            <div class="review-tab" :class="{active: activeReviewTab === 'weekly'}" @click="activeReviewTab = 'weekly'">ğŸ“… å‘¨å¤ç›˜</div>
                            <div class="review-tab" :class="{active: activeReviewTab === 'yearly'}" @click="activeReviewTab = 'yearly'">ğŸ† å¹´ç»ˆæ€»ç»“</div>
                            <div class="review-tab active-special" @click="showReviewForm = !showReviewForm">{{ showReviewForm ? 'âœ–ï¸ å–æ¶ˆ' : 'â• æ–°å»ºè®°å½•' }}</div>
                        </div>

                        <!-- æ–°å»ºå¤ç›˜è¡¨å• -->
                        <div v-if="showReviewForm" style="background:#fffaf9; padding:20px; border-radius:15px; border:2px dashed #ff9a8b; margin-bottom:20px;">
                            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                                <h3 style="font-size:1.1em;">æ–°å»º {{ getReviewTypeName(activeReviewTab) }}</h3>
                                <div>
                                    <span v-if="activeReviewTab === 'weekly'" class="template-btn" @click="applyTemplate('weekly')">ğŸ“„ æ’å…¥å‘¨å¤ç›˜æ¨¡æ¿ (KPT)</span>
                                    <span v-if="activeReviewTab === 'yearly'" class="template-btn" @click="applyTemplate('yearly')">ğŸ“„ æ’å…¥å¹´ç»ˆå¤ç›˜æ¨¡æ¿</span>
                                </div>
                            </div>
                            <input type="text" v-model="newNote.title" placeholder="æ ‡é¢˜ (ä¾‹å¦‚: 2023å¹´ç¬¬4å‘¨å¤ç›˜)" class="note-input">
                            <textarea v-model="newNote.content" placeholder="è®°å½•å†…å®¹..." class="note-textarea" style="height:200px;"></textarea>
                            <input type="text" v-model="newNote.tags" placeholder="æ ‡ç­¾ (ç”¨é€—å·åˆ†éš”ï¼Œå¦‚: å¤ç›˜, å­¦ä¹ , è®¡åˆ’)" class="note-input">
                            <button class="btn" @click="saveNote">ğŸ’¾ ä¿å­˜è®°å½• (+15 XP)</button>
                        </div>

                        <!-- ç­›é€‰å·¥å…·æ  (ä¿®å¤ç‰ˆ) -->
                        <div class="filter-panel">
                            <div class="filter-row">
                                <input type="text" v-model="noteFilters.search" placeholder="ğŸ” æœç´¢æ ‡é¢˜æˆ–å†…å®¹..." class="filter-input" style="width:200px; margin-bottom:0;">
                                <select v-model="noteFilters.sortBy" class="filter-input" style="width:150px; margin-bottom:0;">
                                    <option value="newest">ğŸ“… æœ€æ–°ä¼˜å…ˆ</option>
                                    <option value="oldest">ğŸ“… æœ€æ—©ä¼˜å…ˆ</option>
                                </select>
                                <button v-if="activeReviewTab !== 'daily'" @click="noteFilters = {search:'', sortBy:'newest', selectedTags:[]}" style="background:none; border:none; color:#ff6b6b; cursor:pointer;">æ¸…é™¤ç­›é€‰</button>
                            </div>
                            <div class="filter-row" v-if="allNoteTags.length > 0">
                                <span style="font-size:0.9em; font-weight:bold;">æ ‡ç­¾ç­›é€‰:</span>
                                <span v-for="tag in allNoteTags" :key="tag" 
                                      class="filter-tag" 
                                      :class="{active: noteFilters.selectedTags.includes(tag)}"
                                      @click="toggleNoteTagFilter(tag)">
                                    {{ tag }}
                                </span>
                            </div>
                        </div>

                        <!-- åˆ—è¡¨å±•ç¤º -->
                        <div v-if="filteredNotes.length === 0" style="text-align:center; padding:30px; color:#aaa;">
                            æ²¡æœ‰æ‰¾åˆ°ç›¸å…³è®°å½•ï¼Œå¼€å§‹å†™ç¬¬ä¸€ç¯‡å§ï¼
                        </div>
                        <div v-for="note in filteredNotes" :key="note.id" class="note-card">
                            <div class="note-type-pill">{{ getReviewTypeName(note.type || 'daily') }}</div>
                            <span class="note-date">ğŸ“… {{ formatDate(note.createdAt) }}</span>
                            <h3 style="margin-bottom:10px;">{{ note.title }}</h3>
                            <div style="white-space: pre-wrap; color:#555; line-height:1.6; max-height:150px; overflow:hidden; mask-image: linear-gradient(180deg, #000 60%, transparent);">{{ note.content }}</div>
                            
                            <div class="note-tags">
                                <span v-for="tag in note.tags" :key="tag" class="note-tag-pill">#{{ tag }}</span>
                            </div>
                            
                            <div style="margin-top:15px; display:flex; gap:10px;">
                                <button class="btn-sm" style="background:#eee; color:#333; box-shadow:none; border:1px solid #ccc;" @click="viewNoteDetail(note)">æŸ¥çœ‹å…¨æ–‡</button>
                                <button class="btn-sm btn-danger" @click="deleteNote(note.id)">åˆ é™¤</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æ¨¡å—äºŒï¼šè¯»ä¹¦ç¬”è®° (ä¿®å¤ç­›é€‰ä¸äº¤äº’) -->
                <div class="card">
                    <h2>ğŸ“š è¯»ä¹¦ç¬”è®° <button class="collapse-btn" @click="collapsed.books = !collapsed.books">{{ collapsed.books ? 'å±•å¼€' : 'æ”¶èµ·' }}</button></h2>
                    <div v-show="!collapsed.books">
                        <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                            <div class="review-tabs" style="margin-bottom:0; border-bottom:none;">
                                <div class="review-tab active-special" @click="showBookForm = !showBookForm">{{ showBookForm ? 'âœ–ï¸ å–æ¶ˆ' : 'â• æ·»åŠ æ–°ä¹¦' }}</div>
                            </div>
                        </div>

                        <!-- æ·»åŠ ä¹¦ç±è¡¨å• -->
                        <div v-if="showBookForm" style="background:#fffaf9; padding:20px; border-radius:15px; border:2px dashed #667eea; margin-bottom:20px;">
                            <div class="grid" style="grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:15px;">
                                <input v-model="newBook.title" placeholder="ä¹¦å" class="note-input" style="margin:0;">
                                <input v-model="newBook.author" placeholder="ä½œè€…" class="note-input" style="margin:0;">
                            </div>
                            <div style="display:flex; gap:15px; margin-bottom:15px;">
                                <select v-model="newBook.status" class="note-input" style="margin:0;">
                                    <option value="planning">ğŸ“… è®¡åˆ’é˜…è¯»</option>
                                    <option value="reading">ğŸ“– æ­£åœ¨é˜…è¯»</option>
                                    <option value="finished">âœ… å·²è¯»å®Œ</option>
                                </select>
                                <div style="display:flex; align-items:center; gap:5px;">
                                    <span>è¯„åˆ†:</span>
                                    <span v-for="s in 5" :key="s" style="cursor:pointer; font-size:1.5em; color:#ffd700;" @click="newBook.rating = s">
                                        {{ s <= newBook.rating ? 'â˜…' : 'â˜†' }}
                                    </span>
                                </div>
                            </div>
                            <textarea v-model="newBook.notes" placeholder="æ ¸å¿ƒç¬”è®°..." class="note-textarea" style="height:100px;"></textarea>
                            <textarea v-model="newBook.insights" placeholder="ä¸ªäººæ„Ÿæ‚Ÿ..." class="note-textarea" style="height:80px;"></textarea>
                            <input v-model="newBook.tags" placeholder="æ ‡ç­¾ (å¦‚: å¿ƒç†å­¦, ä¼ è®°)..." class="note-input">
                            <button class="btn" style="background: linear-gradient(90deg, #667eea, #764ba2);" @click="saveBook">ğŸ’¾ ä¿å­˜è¯»ä¹¦ç¬”è®° (+20 XP)</button>
                        </div>

                        <!-- ä¹¦ç±ç­›é€‰ (ä¿®å¤ç‰ˆ) -->
                        <div class="filter-panel">
                            <div class="filter-row">
                                <input type="text" v-model="bookFilters.search" placeholder="ğŸ” æœä¹¦åæˆ–ä½œè€…..." class="filter-input" style="width:200px; margin:0;">
                                <select v-model="bookFilters.status" class="filter-input" style="width:120px; margin:0;">
                                    <option value="all">å…¨éƒ¨çŠ¶æ€</option>
                                    <option value="planning">ğŸ“… è®¡åˆ’ä¸­</option>
                                    <option value="reading">ğŸ“– é˜…è¯»ä¸­</option>
                                    <option value="finished">âœ… å·²è¯»å®Œ</option>
                                </select>
                                <button v-if="bookFilters.status !== 'all' || bookFilters.search" @click="bookFilters={search:'', status:'all', selectedTags:[]}" style="background:none; border:none; color:#667eea; cursor:pointer;">é‡ç½®</button>
                            </div>
                            <div class="filter-row" v-if="allBookTags.length > 0">
                                <span style="font-size:0.9em; font-weight:bold;">ç±»å‹:</span>
                                <span v-for="tag in allBookTags" :key="tag" 
                                      class="filter-tag" 
                                      :class="{active: bookFilters.selectedTags.includes(tag)}"
                                      @click="toggleBookTagFilter(tag)">
                                    {{ tag }}
                                </span>
                            </div>
                        </div>

                        <!-- ä¹¦ç±åˆ—è¡¨ -->
                        <div class="book-grid">
                            <div v-for="book in filteredBooks" :key="book.id" class="book-card" @click="viewBookDetail(book)">
                                <div :class="['book-status-badge', 'status-' + book.status]">
                                    {{ book.status === 'planning' ? 'è®¡åˆ’ä¸­' : book.status === 'reading' ? 'é˜…è¯»ä¸­' : 'å·²å®Œæˆ' }}
                                </div>
                                <h3 style="font-size:1.1em; margin-bottom:5px;">{{ book.title }}</h3>
                                <div style="font-size:0.9em; color:#888; font-style:italic; margin-bottom:10px;">{{ book.author }}</div>
                                <div style="color:#ffd700; margin-bottom:10px;">
                                    <span v-for="s in 5" :key="s">{{ s <= book.rating ? 'â˜…' : 'â˜†' }}</span>
                                </div>
                                <div v-if="book.notes" style="font-size:0.9em; color:#555; overflow:hidden; display:-webkit-box; -webkit-line-clamp:3; -webkit-box-orient:vertical; margin-bottom:auto;">
                                    {{ book.notes }}
                                </div>
                                <div style="margin-top:15px; border-top:1px solid #eee; padding-top:10px; display:flex; justify-content:space-between; align-items:center;">
                                    <div style="font-size:0.8em; color:#999;">{{ book.tags ? book.tags.join(', ') : '' }}</div>
                                    <button class="btn-sm btn-danger" @click.stop="deleteBook(book.id)" style="padding:4px 10px; font-size:0.8em;">ğŸ—‘ï¸</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æ¨¡å—ä¸‰ï¼šçŸ¥è¯†åº“ (è¯­é›€é£æ ¼) -->
                <div class="card">
                    <h2>ğŸ§  çŸ¥è¯†åº“ <button class="collapse-btn" @click="collapsed.kb = !collapsed.kb">{{ collapsed.kb ? 'å±•å¼€' : 'æ”¶èµ·' }}</button></h2>
                    <div v-show="!collapsed.kb">
                        <p style="color:#666; margin-bottom:15px;">æ„å»ºä½ çš„ç¬¬äºŒå¤§è„‘ï¼Œæ”¯æŒMarkdowné£æ ¼çš„æ²‰æµ¸å¼å†™ä½œã€‚</p>
                        <button class="btn" style="background: linear-gradient(120deg, #2681ff, #00b9ff); box-shadow: 4px 4px 0px #005a9e;" @click="openKnowledgeBase">
                            ğŸ“‚ æ‰“å¼€çŸ¥è¯†åº“å·¥ä½œå°
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- çŸ¥è¯†åº“å…¨å±å¼¹çª— (è¯­é›€é£æ ¼) -->
        <div v-if="showKnowledgeBase" class="kb-overlay" @click.self="closeKnowledgeBase">
            <div class="kb-window">
                <!-- ä¾§è¾¹æ  -->
                <div class="kb-sidebar">
                    <div class="kb-sidebar-head">
                        <h3 style="font-weight:700;">æˆ‘çš„çŸ¥è¯†åº“</h3>
                        <button @click="createKbCategory" style="background:none; border:none; font-size:1.2em; cursor:pointer; color:#666;">+</button>
                    </div>
                    <div style="flex:1; overflow-y:auto; padding:10px 0;">
                        <div class="kb-nav-item" :class="{active: kbCurrentCategory === 'all'}" @click="kbCurrentCategory = 'all'">
                            <span class="icon">ğŸ“‘</span> <span>å…¨éƒ¨æ–‡æ¡£</span>
                        </div>
                        <div v-for="cat in kbCategories" :key="cat.id" 
                             class="kb-nav-item" 
                             :class="{active: kbCurrentCategory && kbCurrentCategory.id === cat.id}"
                             @click="kbCurrentCategory = cat">
                            <span class="icon">{{ cat.icon }}</span> 
                            <span>{{ cat.name }}</span>
                            <span style="margin-left:auto; font-size:0.8em; color:#999;">{{ getKbCount(cat.id) }}</span>
                        </div>
                    </div>
                </div>

                <!-- ä¸»åŒºåŸŸ -->
                <div class="kb-main">
                    <!-- é¡¶éƒ¨å·¥å…·æ  -->
                    <div class="kb-toolbar">
                        <div class="kb-breadcrumbs">
                            é¦–é¡µ / {{ kbCurrentCategory === 'all' ? 'å…¨éƒ¨æ–‡æ¡£' : kbCurrentCategory.name }}
                        </div>
                        <div style="display:flex; gap:10px;">
                            <input v-model="kbSearch" placeholder="ğŸ” æœç´¢æ–‡æ¡£..." style="padding:6px 12px; border:1px solid #ddd; border-radius:4px;">
                            <button class="btn-sm" style="background:#2681ff; color:white; box-shadow:none;" @click="openKbEditor()">+ æ–°å»ºæ–‡æ¡£</button>
                            <button @click="closeKnowledgeBase" style="background:none; border:none; font-size:1.2em; cursor:pointer;">âœ•</button>
                        </div>
                    </div>

                    <!-- å†…å®¹åˆ—è¡¨ -->
                    <div class="kb-content">
                        <div v-if="kbEditorMode">
                            <input v-model="kbEditorData.title" placeholder="æ— æ ‡é¢˜æ–‡æ¡£" style="width:100%; font-size:2em; font-weight:700; border:none; outline:none; margin-bottom:20px;">
                            <select v-model="kbEditorData.categoryId" style="margin-bottom:20px; padding:5px;">
                                <option :value="null">æ— åˆ†ç±»</option>
                                <option v-for="cat in kbCategories" :key="cat.id" :value="cat.id">{{ cat.name }}</option>
                            </select>
                            <textarea v-model="kbEditorData.content" placeholder="å¼€å§‹å†™ä½œ..." style="width:100%; height:60vh; border:none; outline:none; font-size:1.1em; line-height:1.8; resize:none;"></textarea>
                            <div style="text-align:right; margin-top:20px;">
                                <button class="btn-sm" style="background:#eee; color:#333; box-shadow:none; margin-right:10px;" @click="kbEditorMode = false">å–æ¶ˆ</button>
                                <button class="btn-sm" style="background:#2681ff; color:white; box-shadow:none;" @click="saveKbDoc">å‘å¸ƒæ–‡æ¡£</button>
                            </div>
                        </div>

                        <div v-else>
                            <div v-if="filteredKbDocs.length === 0" style="text-align:center; margin-top:100px; color:#999;">
                                æ­¤åˆ†ç±»ä¸‹æš‚æ— æ–‡æ¡£
                            </div>
                            <div v-for="doc in filteredKbDocs" :key="doc.id" class="kb-doc-list-item" @click="viewKbDoc(doc)">
                                <div style="display:flex; align-items:center; gap:10px;">
                                    <span style="font-size:1.2em;">ğŸ“„</span>
                                    <div>
                                        <div style="font-weight:600; font-size:1.1em;">{{ doc.title }}</div>
                                        <div style="font-size:0.85em; color:#999; margin-top:4px;">
                                            {{ formatDateShort(doc.updatedAt) }} Â· {{ (doc.content || '').substring(0, 30) }}...
                                        </div>
                                    </div>
                                </div>
                                <div style="display:flex; align-items:center; gap:10px;">
                                    <button class="btn-sm" style="background:none; color:#2681ff; box-shadow:none; padding:0;" @click.stop="editKbDoc(doc)">ç¼–è¾‘</button>
                                    <button class="btn-sm" style="background:none; color:#ff6b6b; box-shadow:none; padding:0;" @click.stop="deleteKbDoc(doc.id)">åˆ é™¤</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- è¯¦æƒ…å¼¹çª— (é€šç”¨) -->
        <div v-if="viewingItem" class="kb-overlay" @click.self="viewingItem = null">
            <div class="card" style="width:90%; max-width:800px; padding:0; overflow:hidden;">
                <div style="padding:20px; background:#fffaf0; border-bottom:1px solid #eee; display:flex; justify-content:space-between;">
                    <h2 style="margin:0; font-size:1.5em;">{{ viewingItem.title }}</h2>
                    <button @click="viewingItem = null" style="background:none; border:none; font-size:1.5em; cursor:pointer;">âœ•</button>
                </div>
                <div class="modal-body">
                    <div v-if="viewingItem.type === 'book'" style="margin-bottom:20px; padding:15px; background:#f9f9f9; border-radius:8px;">
                        <div><strong>ä½œè€…:</strong> {{ viewingItem.author }}</div>
                        <div><strong>çŠ¶æ€:</strong> {{ viewingItem.status }}</div>
                        <div><strong>è¯„åˆ†:</strong> {{ viewingItem.rating }}æ˜Ÿ</div>
                    </div>
                    <div style="font-size:1.1em;">
                        {{ viewingItem.content || viewingItem.notes }}
                    </div>
                    <div v-if="viewingItem.insights" style="margin-top:20px; padding-top:20px; border-top:1px dashed #ccc;">
                        <strong>ğŸ’¡ æ„Ÿæ‚Ÿ:</strong>
                        <p>{{ viewingItem.insights }}</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-sm" @click="viewingItem = null">å…³é—­</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        const SUPABASE_URL = 'https://zqmgigcnruvvdcholbuj.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpxbWdpZ2NucnV2dmRjaG9sYnVqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4NjgzNjEsImV4cCI6MjA4MTQ0NDM2MX0.IHzDp7o5M9QM8IBWy2ri5gS9h9nm0zk3AaPTNveDqXI'; // ä½ çš„ Key
        const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    // ç”¨æˆ·ä¸çŠ¶æ€
                    isLoggedIn: false, userId: null, userEmail: '', email: '', password: '',
                    loading: false, syncing: false, message: '', messageType: 'success',
                    
                    // UIçŠ¶æ€
                    collapsed: { stats: false, reviews: false, books: false, kb: true },
                    showReviewForm: false, showBookForm: false, viewingItem: null,
                    
                    // æ•°æ®æ¨¡å‹
                    playerData: { level: 1, xp: 0, nextLevelXp: 100 },
                    
                    // å¤ç›˜ç³»ç»Ÿ (Reviews/Notes)
                    notes: [], 
                    activeReviewTab: 'daily', // daily, weekly, yearly
                    newNote: { title: '', content: '', tags: '' },
                    noteFilters: { search: '', sortBy: 'newest', selectedTags: [] },
                    
                    // è¯»ä¹¦ç¬”è®°
                    books: [],
                    newBook: { title: '', author: '', status: 'reading', rating: 0, notes: '', insights: '', tags: '' },
                    bookFilters: { search: '', status: 'all', selectedTags: [] },
                    
                    // çŸ¥è¯†åº“ (Knowledge Base)
                    showKnowledgeBase: false, kbEditorMode: false,
                    kbCategories: [], kbDocs: [],
                    kbCurrentCategory: 'all', kbSearch: '',
                    kbEditorData: { id: null, title: '', content: '', categoryId: null }
                };
            },
            computed: {
                xpPercentage() { return Math.min(100, (this.playerData.xp / this.playerData.nextLevelXp) * 100); },
                
                // çƒ­åŠ›å›¾è®¡ç®— (Mock logic for display, real logic would process dates)
                activityHeatmap() {
                    // è¿™é‡Œç®€å•æ¨¡æ‹Ÿæœ€è¿‘14å¤©çš„æ•°æ®ï¼Œå®é™…åº”è¯¥éå† notes, books, kbDocs çš„åˆ›å»ºæ—¶é—´
                    const days = [];
                    const today = new Date();
                    for(let i=13; i>=0; i--) {
                        const d = new Date(today);
                        d.setDate(today.getDate() - i);
                        const dateStr = d.toISOString().split('T')[0];
                        // ç®€å•ç»Ÿè®¡å½“å¤©çš„è®°å½•æ•°
                        let count = this.notes.filter(n => n.createdAt.startsWith(dateStr)).length;
                        count += this.books.filter(b => b.createdAt && b.createdAt.startsWith(dateStr)).length;
                        
                        let level = 0;
                        if(count > 0) level = 1;
                        if(count > 2) level = 2;
                        if(count > 4) level = 3;
                        if(count > 6) level = 4;
                        
                        days.push({ date: dateStr, count, level });
                    }
                    return days;
                },

                // å¤ç›˜ç­›é€‰é€»è¾‘
                allNoteTags() {
                    const tags = new Set();
                    this.notes.forEach(n => {
                        if(n.tags && Array.isArray(n.tags)) n.tags.forEach(t => tags.add(t));
                    });
                    return Array.from(tags);
                },
                filteredNotes() {
                    let res = this.notes.filter(n => {
                        // ç±»å‹ç­›é€‰
                        const type = n.type || 'daily';
                        if (type !== this.activeReviewTab) return false;
                        return true;
                    });
                    
                    // æœç´¢
                    if(this.noteFilters.search) {
                        const q = this.noteFilters.search.toLowerCase();
                        res = res.filter(n => n.title.toLowerCase().includes(q) || n.content.toLowerCase().includes(q));
                    }
                    // æ ‡ç­¾
                    if(this.noteFilters.selectedTags.length > 0) {
                        res = res.filter(n => n.tags && n.tags.some(t => this.noteFilters.selectedTags.includes(t)));
                    }
                    // æ’åº
                    res.sort((a,b) => {
                        const da = new Date(a.createdAt), db = new Date(b.createdAt);
                        return this.noteFilters.sortBy === 'newest' ? db - da : da - db;
                    });
                    return res;
                },

                // ä¹¦ç±ç­›é€‰é€»è¾‘
                allBookTags() {
                    const tags = new Set();
                    this.books.forEach(b => {
                        if(b.tags && Array.isArray(b.tags)) b.tags.forEach(t => tags.add(t));
                    });
                    return Array.from(tags);
                },
                filteredBooks() {
                    let res = [...this.books];
                    // çŠ¶æ€
                    if(this.bookFilters.status !== 'all') {
                        res = res.filter(b => b.status === this.bookFilters.status);
                    }
                    // æœç´¢
                    if(this.bookFilters.search) {
                        const q = this.bookFilters.search.toLowerCase();
                        res = res.filter(b => b.title.toLowerCase().includes(q) || b.author.toLowerCase().includes(q));
                    }
                    // æ ‡ç­¾
                    if(this.bookFilters.selectedTags.length > 0) {
                        res = res.filter(b => b.tags && b.tags.some(t => this.bookFilters.selectedTags.includes(t)));
                    }
                    return res;
                },

                // çŸ¥è¯†åº“ç­›é€‰
                filteredKbDocs() {
                    let res = [...this.kbDocs];
                    if (this.kbCurrentCategory !== 'all') {
                        res = res.filter(d => d.categoryId === this.kbCurrentCategory.id);
                    }
                    if (this.kbSearch) {
                        const q = this.kbSearch.toLowerCase();
                        res = res.filter(d => d.title.toLowerCase().includes(q));
                    }
                    return res.sort((a,b) => new Date(b.updatedAt) - new Date(a.updatedAt));
                }
            },
            methods: {
                // å·¥å…·å‡½æ•°
                showMessage(text, type='success') { this.message = text; this.messageType = type; setTimeout(()=>this.message='', 3000); },
                formatDate(str) { if(!str) return ''; return new Date(str).toLocaleString('zh-CN'); },
                formatDateShort(str) { if(!str) return ''; return new Date(str).toLocaleDateString('zh-CN'); },
                getReviewTypeName(type) {
                    const map = { daily: 'æ—¥å¸¸è®°å½•', weekly: 'å‘¨å¤ç›˜', yearly: 'å¹´ç»ˆæ€»ç»“' };
                    return map[type] || 'è®°å½•';
                },

                // Auth
                async login() {
                    if(!this.email || !this.password) return this.showMessage('è¯·è¾“å…¥é‚®ç®±å¯†ç ', 'error');
                    this.loading = true;
                    const { data, error } = await sb.auth.signInWithPassword({ email: this.email, password: this.password });
                    if(error) {
                        // å°è¯•æ³¨å†Œ
                        const { error: regError } = await sb.auth.signUp({ email: this.email, password: this.password });
                        this.loading = false;
                        if(regError) return this.showMessage(error.message, 'error');
                        return this.showMessage('æ³¨å†ŒæˆåŠŸï¼Œè¯·ç™»å½•', 'success');
                    }
                    this.isLoggedIn = true; this.userId = data.user.id; this.userEmail = data.user.email;
                    this.loading = false;
                    this.loadData();
                },
                async logout() { await sb.auth.signOut(); this.isLoggedIn = false; window.location.reload(); },

                // æ•°æ®åŠ è½½
                async loadData() {
                    this.syncing = true;
                    // å¹¶è¡ŒåŠ è½½ (ç®€åŒ–é€»è¾‘)
                    const [p, n, b, kc, kd] = await Promise.all([
                        sb.from('players').select('*').eq('user_id', this.userId).single(),
                        sb.from('notes').select('*').eq('user_id', this.userId),
                        sb.from('books').select('*').eq('user_id', this.userId),
                        sb.from('kb_categories').select('*').eq('user_id', this.userId),
                        sb.from('kb_notes').select('*').eq('user_id', this.userId)
                    ]);
                    
                    if(p.data) this.playerData = p.data.data;
                    if(n.data) this.notes = n.data.map(i => i.data);
                    if(b.data) this.books = b.data.map(i => i.data);
                    if(kc.data) this.kbCategories = kc.data.map(i => i.data);
                    if(kd.data) this.kbDocs = kd.data.map(i => i.data);
                    
                    this.syncing = false;
                },
                async syncData() { await this.saveAll(); this.loadData(); },
                async saveAll() {
                    this.syncing = true;
                    // åˆ é™¤æ—§æ•°æ® (ç®€åŒ–æ–¹æ¡ˆï¼Œå®é™…åº”å¢é‡æ›´æ–°)
                    await Promise.all([
                        sb.from('notes').delete().eq('user_id', this.userId),
                        sb.from('books').delete().eq('user_id', this.userId),
                        sb.from('kb_categories').delete().eq('user_id', this.userId),
                        sb.from('kb_notes').delete().eq('user_id', this.userId)
                    ]);
                    
                    // å†™å…¥æ–°æ•°æ®
                    const wrap = (list) => list.map(d => ({ user_id: this.userId, data: d }));
                    await sb.from('players').upsert({ user_id: this.userId, data: this.playerData });
                    if(this.notes.length) await sb.from('notes').insert(wrap(this.notes));
                    if(this.books.length) await sb.from('books').insert(wrap(this.books));
                    if(this.kbCategories.length) await sb.from('kb_categories').insert(wrap(this.kbCategories));
                    if(this.kbDocs.length) await sb.from('kb_notes').insert(wrap(this.kbDocs));
                    
                    this.syncing = false; this.showMessage('äº‘ç«¯åŒæ­¥å®Œæˆ');
                },

                // æ¸¸æˆåŒ–
                addXp(amount) {
                    this.playerData.xp += amount;
                    if(this.playerData.xp >= this.playerData.nextLevelXp) {
                        this.playerData.xp -= this.playerData.nextLevelXp;
                        this.playerData.level++;
                        this.playerData.nextLevelXp = Math.floor(this.playerData.nextLevelXp * 1.5);
                        this.showMessage(`å‡çº§äº†ï¼Lv.${this.playerData.level} ğŸ‰`);
                    }
                },

                // å¤ç›˜ç³»ç»Ÿé€»è¾‘
                applyTemplate(type) {
                    if (type === 'weekly') {
                        this.newNote.content = "## æœ¬å‘¨ç›®æ ‡å®Œæˆæƒ…å†µ\n- \n\n## KPTå¤ç›˜\n**Keep (ä¿æŒ):**\n- \n\n**Problem (é—®é¢˜):**\n- \n\n**Try (å°è¯•):**\n- \n\n## ä¸‹å‘¨è®¡åˆ’\n- ";
                        this.newNote.tags = "å‘¨å¤ç›˜, KPT";
                    } else if (type === 'yearly') {
                        this.newNote.content = "## å¹´åº¦å…³é”®è¯\n\n## å…³é”®æˆå°± (Highlights)\n1. \n2. \n\n## é—æ†¾ä¸æ•™è®­\n- \n\n## æ˜å¹´è§„åˆ’\n- ";
                        this.newNote.tags = "å¹´ç»ˆæ€»ç»“, è§„åˆ’";
                    }
                },
                saveNote() {
                    if(!this.newNote.title) return this.showMessage('è¯·è¾“å…¥æ ‡é¢˜', 'error');
                    const tagsArr = this.newNote.tags.split(/[,ï¼Œ]/).map(t => t.trim()).filter(t => t);
                    this.notes.unshift({
                        id: Date.now(),
                        title: this.newNote.title,
                        content: this.newNote.content,
                        tags: tagsArr,
                        type: this.activeReviewTab, // å…³é”®ï¼šä¿å­˜ç±»å‹
                        createdAt: new Date().toISOString()
                    });
                    this.addXp(15);
                    this.newNote = { title: '', content: '', tags: '' };
                    this.showReviewForm = false;
                    this.saveAll();
                },
                deleteNote(id) {
                    if(confirm('ç¡®å®šåˆ é™¤æ­¤è®°å½•?')) {
                        this.notes = this.notes.filter(n => n.id !== id);
                        this.saveAll();
                    }
                },
                toggleNoteTagFilter(tag) {
                    const idx = this.noteFilters.selectedTags.indexOf(tag);
                    if(idx > -1) this.noteFilters.selectedTags.splice(idx, 1);
                    else this.noteFilters.selectedTags.push(tag);
                },
                viewNoteDetail(note) { this.viewingItem = { ...note, type: 'note' }; },

                // è¯»ä¹¦ç¬”è®°é€»è¾‘
                saveBook() {
                    if(!this.newBook.title) return this.showMessage('è¯·è¾“å…¥ä¹¦å', 'error');
                    const tagsArr = this.newBook.tags.split(/[,ï¼Œ]/).map(t => t.trim()).filter(t => t);
                    this.books.unshift({
                        id: Date.now(),
                        ...this.newBook,
                        tags: tagsArr,
                        createdAt: new Date().toISOString()
                    });
                    this.addXp(20);
                    this.newBook = { title: '', author: '', status: 'reading', rating: 0, notes: '', insights: '', tags: '' };
                    this.showBookForm = false;
                    this.saveAll();
                },
                deleteBook(id) {
                    if(confirm('åˆ é™¤æ­¤ä¹¦?')) {
                        this.books = this.books.filter(b => b.id !== id);
                        this.saveAll();
                    }
                },
                toggleBookTagFilter(tag) {
                    const idx = this.bookFilters.selectedTags.indexOf(tag);
                    if(idx > -1) this.bookFilters.selectedTags.splice(idx, 1);
                    else this.bookFilters.selectedTags.push(tag);
                },
                viewBookDetail(book) { this.viewingItem = { ...book, type: 'book', content: book.notes }; },

                // çŸ¥è¯†åº“é€»è¾‘
                openKnowledgeBase() { this.showKnowledgeBase = true; },
                closeKnowledgeBase() { this.showKnowledgeBase = false; },
                createKbCategory() {
                    const name = prompt('è¾“å…¥åˆ†ç±»åç§°:');
                    if(name) {
                        this.kbCategories.push({ id: Date.now(), name, icon: 'ğŸ“' });
                        this.saveAll();
                    }
                },
                getKbCount(catId) { return this.kbDocs.filter(d => d.categoryId === catId).length; },
                openKbEditor() { 
                    this.kbEditorData = { id: null, title: '', content: '', categoryId: this.kbCurrentCategory.id || null };
                    this.kbEditorMode = true; 
                },
                editKbDoc(doc) {
                    this.kbEditorData = { ...doc };
                    this.kbEditorMode = true;
                },
                saveKbDoc() {
                    if(!this.kbEditorData.title) return alert('æ ‡é¢˜ä¸èƒ½ä¸ºç©º');
                    const now = new Date().toISOString();
                    if(this.kbEditorData.id) {
                        // Update
                        const idx = this.kbDocs.findIndex(d => d.id === this.kbEditorData.id);
                        this.kbDocs[idx] = { ...this.kbEditorData, updatedAt: now };
                    } else {
                        // Create
                        this.kbDocs.unshift({
                            id: Date.now(),
                            ...this.kbEditorData,
                            createdAt: now,
                            updatedAt: now
                        });
                        this.addXp(10);
                    }
                    this.kbEditorMode = false;
                    this.saveAll();
                },
                deleteKbDoc(id) {
                    if(confirm('åˆ é™¤æ–‡æ¡£?')) {
                        this.kbDocs = this.kbDocs.filter(d => d.id !== id);
                        this.saveAll();
                    }
                },
                viewKbDoc(doc) {
                    // åœ¨çŸ¥è¯†åº“å†…ï¼Œç›´æ¥å¤ç”¨ç¼–è¾‘æ¨¡å¼ä½œä¸ºæŸ¥çœ‹æ¨¡å¼ï¼ˆç®€åŒ–é€»è¾‘ï¼‰ï¼Œæˆ–è€…æ–°å»ºæŸ¥çœ‹é€»è¾‘
                    // è¿™é‡Œä¸ºäº†ä½“éªŒï¼Œæˆ‘ä»¬è¿›å…¥ç¼–è¾‘æ¨¡å¼ä½†å¯ä»¥ä½œä¸ºæŸ¥çœ‹
                    this.editKbDoc(doc);
                }
            },
            mounted() {
                // æ£€æŸ¥ç™»å½•ä¼šè¯
                sb.auth.getSession().then(({ data: { session } }) => {
                    if(session) {
                        this.isLoggedIn = true;
                        this.userId = session.user.id;
                        this.userEmail = session.user.email;
                        this.loadData();
                    }
                });
            }
        }).mount('#app');
    </script>
</body>
</html>

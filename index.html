<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸ªäººç©ºé—´ - ç»ˆæç‰ˆ</title>
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <!-- Supabase -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Marked.js -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- å­—ä½“ -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* ========== å…¨å±€æ ·å¼ ========== */
        :root {
            --bg-color: #fef9f3;
            --text-color: #5a4a42;
            --accent-pink: #ff9a8b;
            --card-border: 2.5px solid #5a4a42;
            --card-shadow: 6px 6px 0px #d4b8a7;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Noto Sans SC', sans-serif;
            background: var(--bg-color);
            min-height: 100vh;
            color: var(--text-color);
            padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }

        /* ç¦æ­¢é€‰ä¸­ */
        h1, h2, h3, h4, .level-display, .review-tab, .kb-nav-item, .toggle-btn, .preview-label {
            user-select: none; -webkit-user-select: none; cursor: default;
        }
        button, .btn, .btn-sm, .collapse-btn, .review-tab, .kb-nav-item, .toggle-btn, .quest-item, .note-card, .book-card, .case-card {
            cursor: pointer;
        }

        /* âš¡ ä¼˜åŒ–ï¼šå¸é¡¶å¯¼èˆªæ æ ·å¼ */
        .header {
            text-align: center; margin-bottom: 30px; padding: 20px 30px;
            border-radius: 20px;
            box-shadow: 8px 8px 0px #e0c9b8; border: 3px solid #5a4a42;
            display: flex; flex-direction: column; align-items: center;
            /* å¸é¡¶æ ¸å¿ƒä»£ç  */
            position: sticky; top: 10px; z-index: 100;
            background: rgba(255, 250, 240, 0.95); /* å¾®é€æ˜èƒŒæ™¯ */
            backdrop-filter: blur(8px); /* æ¯›ç»ç’ƒç‰¹æ•ˆ */
        }
        .header h1 { font-size: 2.2em; font-weight: 700; text-shadow: 3px 3px 0px #ffd6cc; margin-bottom: 10px; }

        /* å•†åº—æŒ‰é’® */
        .shop-btn-group { display: flex; justify-content: center; gap: 15px; margin-top: 15px; }
        .shop-btn-big { padding: 8px 24px !important; font-size: 1em !important; width: auto !important; min-width: 80px; height: 40px; display: flex; justify-content: center; align-items: center; }
        .shop-btn-big:active { transform: translateY(2px); }

        .grid { display: grid; grid-template-columns: 1fr; gap: 30px; margin-bottom: 40px; }
        
        .card {
            background: #fffefc; border-radius: 20px; padding: 30px;
            box-shadow: var(--card-shadow); border: var(--card-border);
            transition: transform 0.3s; position: relative;
        }
        .card:hover { transform: translateY(-3px); }
        .card h2 {
            margin-bottom: 20px; padding-bottom: 15px; border-bottom: 3px dotted #ff9a8b;
            font-size: 1.4em; font-weight: 700; display: flex; justify-content: space-between; align-items: center;
        }

        .btn {
            background: linear-gradient(90deg, #ff9a8b, #ff6b6b); border: none; padding: 12px 30px;
            border-radius: 50px; color: white; cursor: pointer; font-size: 16px; font-weight: 700;
            box-shadow: 4px 4px 0px #d45d5d; transition: all 0.2s;
        }
        .btn:hover:not(:disabled) { transform: translateY(-2px); }
        .btn-sm {
            padding: 6px 15px; font-size: 0.9em; border-radius: 20px;
            background: linear-gradient(90deg, #4ecdc4, #a3de83);
            box-shadow: 3px 3px 0px #2ba69b; border: none; color: white; font-weight: bold; cursor: pointer;
        }
        .btn-upload { background: #eee; color: #555; box-shadow: none; border: 1px solid #ccc; display: inline-flex; align-items: center; gap: 5px; transition: background 0.3s; }
        .btn-upload:hover { background: #e0e0e0; }
        .btn-danger { background: #ff6b6b; box-shadow: 3px 3px 0px #c0392b; }
        .collapse-btn { background: #fffaf5; border: 2px solid #ff9a8b; color: #ff6b6b; padding: 4px 12px; border-radius: 12px; font-size: 0.8em; font-weight: bold; }

        .note-input, .note-textarea {
            width: 100%; padding: 12px; border: 2px solid #e0c9b8; border-radius: 12px;
            font-size: 15px; margin-bottom: 10px; background: #fffaf9; font-family: inherit;
        }
        .note-textarea { margin-bottom: 0; border-bottom-left-radius: 0; border-bottom-right-radius: 0; border-bottom: 1px dashed #e0c9b8; resize: none; overflow-y: hidden; min-height: 80px; }
        
        .live-preview { width: 100%; min-height: 60px; max-height: 300px; overflow-y: auto; background: #fff; border: 2px solid #e0c9b8; border-top: none; border-radius: 0 0 12px 12px; padding: 15px; margin-bottom: 10px; }
        .preview-label { font-size: 0.75em; color: #999; font-weight: bold; margin-bottom: 5px; display: block; text-transform: uppercase; letter-spacing: 1px; }

        .goal-mode-switch { display: flex; background: #eee; border-radius: 8px; padding: 4px; margin-bottom: 10px; width: fit-content; }
        .mode-btn { padding: 5px 15px; cursor: pointer; border-radius: 6px; font-size: 0.9em; color: #666; transition: all 0.2s; user-select: none; }
        .mode-btn:hover { background: rgba(255,255,255,0.5); }
        .mode-btn.active { background: white; color: #ff9a8b; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        input[type=range] { accent-color: #ff9a8b; cursor: pointer; }

        .pagination-controls { display: flex; justify-content: center; align-items: center; gap: 15px; margin-top: 20px; padding-top: 15px; border-top: 2px dashed #e0c9b8; }
        .page-info { font-size: 0.9em; font-weight: bold; color: #7a6a62; }
        .btn-page { background: #fff; border: 2px solid #e0c9b8; border-radius: 8px; padding: 5px 12px; cursor: pointer; color: #5a4a42; font-weight: bold; transition: all 0.2s; }
        .btn-page:hover:not(:disabled) { background: #fffaf0; border-color: #ff9a8b; color: #ff9a8b; }
        .btn-page:disabled { opacity: 0.5; cursor: not-allowed; background: #eee; }

        .search-bar { padding: 12px 15px; border: 2px solid #5a4a42; border-radius: 50px; width: 100%; margin-bottom: 20px; background: white; font-weight: bold; }

        .markdown-content { line-height: 1.8; color: #444; overflow-wrap: break-word; }
        .markdown-content h1, .markdown-content h2 { border-bottom: 1px dashed #e0c9b8; padding-bottom: 5px; margin-top: 10px; }
        .markdown-content img { max-width: 100%; border-radius: 8px; margin: 10px 0; border: 1px solid #eee; display: block; }
        .markdown-content blockquote { border-left: 4px solid #ff9a8b; background: #fffaf5; padding: 5px 15px; color: #666; margin: 10px 0; }
        .markdown-content pre { background: #333; color: white; padding: 10px; border-radius: 8px; overflow-x: auto; }
        .markdown-content pre code { font-family: monospace; }
        .markdown-content a { color: #ff9a8b; text-decoration: none; border-bottom: 1px dotted #ff9a8b; }

        .quest-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; }
        .quest-item { background: #fffaf5; border: 2px solid #e0c9b8; border-radius: 15px; padding: 15px; display: flex; align-items: center; cursor: pointer; }
        .quest-item.completed { background: #e8f5e9; border-color: #a3de83; opacity: 0.8; }
        .checkbox-custom { width: 24px; height: 24px; border: 2px solid #5a4a42; border-radius: 6px; margin-right: 15px; display: flex; align-items: center; justify-content: center; background: white; flex-shrink: 0; }
        .quest-item.completed .checkbox-custom { background: #a3de83; border-color: #2e7d32; }
        .quest-item.completed .checkbox-custom::after { content: 'âœ”'; color: white; font-weight: bold; }

        .shop-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; }
        .shop-card { background: #fff; border: 2px solid #e0c9b8; border-radius: 15px; padding: 15px; text-align: center; }

        .chart-container { width: 100%; height: 300px; background: #fff; border: 2px solid #e0c9b8; border-radius: 15px; padding: 15px; margin-bottom: 20px; }
        
        .level-display { font-size: 3em; font-weight: 800; text-align: center; color: #ff6b6b; margin: 10px 0; }
        .xp-progress { height: 20px; background: #ffe8d6; border-radius: 12px; overflow: hidden; border: 2px solid #5a4a42; margin: 10px 0; }
        .xp-fill { height: 100%; background: linear-gradient(90deg, #4ecdc4, #a3de83); transition: width 0.5s ease; }

        .book-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .book-card { background: #fff; border-radius: 16px; padding: 15px; box-shadow: 3px 3px 0px #d4b8a7; border: 2px solid #e0c9b8; display: flex; flex-direction: column; cursor: pointer; height: 220px; transition: transform 0.2s;}
        .book-card:hover { transform: translateY(-5px); border-color: #ff9a8b; }
        .book-title { font-weight: bold; font-size: 1.1em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .book-preview { flex: 1; font-size: 0.85em; color: #666; margin: 10px 0; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 4; -webkit-box-orient: vertical; }
        .star-rating { display: inline-flex; font-size: 1.2em; cursor: pointer; }
        .star { color: #ddd; transition: color 0.2s; margin-right: 2px; }
        .star.active { color: #ffc107; text-shadow: 1px 1px 0 #d39e00; }
        .tag-pill { background: #e8f5e9; color: #2e7d32; border: 1px solid #a5d6a7; border-radius: 12px; padding: 2px 8px; font-size: 0.75em; font-weight: bold; margin-right: 4px; display: inline-block;}

        .review-tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #e0c9b8; padding-bottom: 10px; overflow-x: auto; }
        .review-tab { padding: 8px 18px; border: 2px solid #e0c9b8; background: #fffaf5; border-radius: 15px 15px 0 0; cursor: pointer; font-weight: 600; white-space: nowrap; }
        .review-tab.active { background: #ff9a8b; color: white; border-color: #ff9a8b; }
        .note-card { background: #fffaf5; padding: 20px; border-radius: 15px; margin-bottom: 15px; border: 2px solid #e0c9b8; cursor: pointer; transition: transform 0.2s, border-color 0.2s; }
        .note-card:hover { border-color: #ff9a8b; }
        .note-preview-box { max-height: 100px; overflow: hidden; position: relative; }
        .note-preview-box::after { content: ""; position: absolute; bottom: 0; left: 0; right: 0; height: 40px; background: linear-gradient(to bottom, transparent, #fffaf5); pointer-events: none; }

        .case-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; }
        .case-card { background: #fff; border-radius: 16px; padding: 20px; box-shadow: 4px 4px 0px #d4b8a7; border: 2px solid #e0c9b8; cursor: pointer; }
        
        .toggle-group { display: flex; background: #e0c9b8; border-radius: 8px; padding: 4px; gap: 4px; margin-bottom: 10px; width: fit-content; }
        .toggle-btn { padding: 5px 15px; border: none; background: transparent; cursor: pointer; border-radius: 6px; font-weight: bold; color: #5a4a42; }
        .toggle-btn.active { background: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }

        .modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(90, 74, 66, 0.6); backdrop-filter: blur(3px); 
            z-index: 999; display: flex; justify-content: center; align-items: center; 
        }
        .detail-modal { background: #fffefc; width: 90%; max-width: 700px; max-height: 85vh; border-radius: 20px; border: 3px solid #5a4a42; padding: 30px; overflow-y: auto; position: relative; box-shadow: 10px 10px 0px rgba(0,0,0,0.2); }
        .close-modal { position: absolute; top: 15px; right: 20px; font-size: 1.5em; cursor: pointer; color: #999; z-index: 10; }
        .detail-section { margin-top: 20px; background: #fffaf5; padding: 15px; border-radius: 10px; border: 1px dashed #e0c9b8; }
        
        .kb-window { width: 95%; max-width: 1400px; height: 90vh; background: #fef9f3; border-radius: 20px; border: 4px solid #5a4a42; display: flex; overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.3); }
        .kb-sidebar { width: 250px; background: #fffaf0; border-right: 2px solid #e0c9b8; display: flex; flex-direction: column; }
        .kb-main { flex: 1; display: flex; flex-direction: column; background: #fffefc; }
        .kb-nav-item { padding: 15px 20px; cursor: pointer; color: #5a4a42; font-weight: 500; border-left: 4px solid transparent; }
        .kb-nav-item.active { background: #ffe8d6; border-left-color: #ff9a8b; font-weight: bold; }
        .kb-content { flex: 1; padding: 40px; overflow-y: auto; }
        .kb-toolbar { padding: 15px 30px; border-bottom: 2px dashed #e0c9b8; display: flex; justify-content: space-between; align-items: center; background: #fffaf5; }
        .kb-list-item { padding: 15px; border: 1px solid #e0c9b8; border-radius: 10px; margin-bottom: 10px; cursor: pointer; background: #fff; display: flex; justify-content: space-between; align-items: center; }

        .login-box { max-width: 400px; margin: 60px auto; text-align: center; }
        .status-message { padding: 10px; border-radius: 10px; margin-top: 15px; font-weight: bold; }
        .status-error { background: #ffe5e5; color: #d32f2f; border: 2px solid #ffcdd2; }
        .status-success { background: #e8f5e9; color: #2e7d32; border: 2px solid #c8e6c9; }
        
        .goal-list { display: grid; grid-template-columns: 1fr; gap: 20px; }
        .goal-item { background: #fffaf5; border: 2px solid #e0c9b8; border-radius: 15px; padding: 20px; }
        .goal-progress-bg { height: 16px; background: #eee; border-radius: 8px; overflow: hidden; border: 1px solid #ddd; margin: 10px 0; }
        .goal-progress-fill { height: 100%; transition: width 0.5s; border-radius: 8px; }
        .p-low { background: linear-gradient(90deg, #ff9a8b, #ff6b6b); }
        .p-mid { background: linear-gradient(90deg, #f6d365, #fda085); }
        .p-high { background: linear-gradient(90deg, #84fab0, #8fd3f4); }
        .p-done { background: linear-gradient(90deg, #4ecdc4, #556270); }

        @media (max-width: 768px) {
            .kb-window { width: 100%; height: 100vh; border-radius: 0; }
            .kb-sidebar { width: 80px; }
            .kb-nav-item span:not(.count) { display: none; }
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- ç™»å½• -->
        <div v-if="!isLoggedIn" class="login-box">
            <div class="card">
                <h1 style="font-size: 3em; margin-bottom: 10px;">â˜¯ï¸</h1>
                <h2 style="justify-content: center;">ä¸ªäººç©ºé—´</h2>
                <input type="email" v-model="email" placeholder="é‚®ç®±" class="note-input">
                <input type="password" v-model="password" placeholder="å¯†ç " class="note-input">
                <button class="btn" @click="login" :disabled="loading">{{ loading ? 'éªŒè¯ä¸­...' : 'è¿›å…¥' }}</button>
                <div v-if="message" :class="['status-message', messageType === 'success' ? 'status-success' : 'status-error']">{{ message }}</div>
            </div>
        </div>

    <div v-else class="container">
        <div class="header">
            <h1>ğŸ‘‹ {{ userEmail.split('@')[0] }} çš„ç©ºé—´</h1>
            <div>
                <button class="btn-sm" @click="syncData" :disabled="syncing">{{ syncing ? 'â˜ï¸ åŒæ­¥ä¸­...' : 'ğŸ”„ åŒæ­¥æ•°æ®' }}</button>
                <button class="btn-sm btn-danger" @click="logout" style="margin-left: 10px;">é€€å‡º</button>
            </div>
            <div v-if="message" :class="['status-message', messageType === 'success' ? 'status-success' : 'status-error']" style="margin-top: 10px;">{{ message }}</div>
        </div>
<!-- ä¸´æ—¶æŒ‰é’®ï¼šç‚¹ä¸€ä¸‹å°±ä¼šåˆ é™¤æœ€åä¸€æ¡èµ„äº§è®°å½• -->
<button class="btn-sm btn-danger" @click="playerData.assetHistory.pop(); savePlayerData(); loadChart();">ğŸ—‘ï¸ ä¿®å¤å›¾è¡¨</button>
        <div class="grid">
            <!-- è§’è‰²çŠ¶æ€ -->
            <div class="card">
                <h2>ğŸ“Š è§’è‰²çŠ¶æ€ <button class="collapse-btn" @click="collapsed.stats = !collapsed.stats">{{ collapsed.stats ? 'å±•å¼€' : 'æ”¶èµ·' }}</button></h2>
                <div v-show="!collapsed.stats">
                    <div class="level-display">Lv.{{ playerData.level }}</div>
                    <div class="xp-progress"><div class="xp-fill" :style="{width: xpPercentage + '%'}"></div></div>
                    <div style="text-align: center; font-weight: bold; color: #7a6a62;">{{ playerData.xp }} / {{ playerData.nextLevelXp }} XP</div>
                </div>
            </div>

            <!-- æ¯æ—¥ä»»åŠ¡ -->
            <div class="card">
                <h2>âš”ï¸ æ¯æ—¥ä»»åŠ¡ <button class="collapse-btn" @click="collapsed.quests = !collapsed.quests">{{ collapsed.quests ? 'å±•å¼€' : 'æ”¶èµ·' }}</button></h2>
                <div v-show="!collapsed.quests">
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <input v-model="newQuestTitle" placeholder="æ·»åŠ æ¯æ—¥ä»»åŠ¡..." class="note-input" style="margin-bottom: 0;">
                        <button class="btn-sm" @click="addDailyQuest" style="width: 80px;">â•</button>
                    </div>
                    <div class="quest-list">
                        <div v-for="quest in playerData.dailyTasks || []" :key="quest.id" class="quest-item" :class="{completed: quest.completed}" @click="toggleQuest(quest)">
                            <div class="checkbox-custom"></div>
                            <div style="flex: 1;">
                                <div style="font-weight: bold;">{{ quest.title }}</div>
                                <div style="font-size: 0.8em; color: #7a6a62;">å¥–åŠ±: +5 XP</div>
                            </div>
                            <button class="btn-sm btn-danger" @click.stop="deleteDailyQuest(quest.id)" style="width: auto; padding: 5px 10px; margin-left: 10px;">âœ•</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ç›®æ ‡ç®¡ç† -->
            <div class="card">
                <h2>ğŸ¯ é˜¶æ®µç›®æ ‡ <button class="collapse-btn" @click="collapsed.goals = !collapsed.goals">{{ collapsed.goals ? 'å±•å¼€' : 'æ”¶èµ·' }}</button></h2>
                <div v-show="!collapsed.goals">
                    <div style="background: #fffaf5; padding: 15px; border: 2px dashed #e0c9b8; border-radius: 12px; margin-bottom: 20px;">
                        <div class="goal-mode-switch">
                            <div class="mode-btn" :class="{active: newGoal.mode === 'numeric'}" @click="newGoal.mode = 'numeric'">ğŸ”¢ æ•°å€¼é‡åŒ–</div>
                            <div class="mode-btn" :class="{active: newGoal.mode === 'slider'}" @click="newGoal.mode = 'slider'">ğŸšï¸ è¿›åº¦æ»‘å—</div>
                        </div>

                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <input v-model="newGoal.title" placeholder="ç›®æ ‡å†…å®¹..." class="note-input" style="flex: 2; margin: 0;">
                            <template v-if="newGoal.mode === 'numeric'">
                                <input v-model.number="newGoal.target" type="number" placeholder="ç›®æ ‡å€¼" class="note-input" style="flex: 1; margin: 0; min-width: 80px;">
                                <input v-model="newGoal.unit" placeholder="å•ä½" class="note-input" style="flex: 1; margin: 0; min-width: 60px;">
                            </template>
                            <button class="btn-sm" @click="addGoal" style="height: 42px; width: 80px;">æ·»åŠ </button>
                        </div>
                    </div>

                    <div class="goal-list">
                        <div v-for="(goal, index) in playerData.goals || []" :key="index" class="goal-item" :class="{completed: calculateProgress(goal) >= 100}">
                            <div style="display:flex; justify-content:space-between; font-weight:bold; margin-bottom:10px;">
                                <span :style="{textDecoration: calculateProgress(goal) >= 100 ? 'line-through' : 'none'}">{{ goal.title }}</span>
                                <span :style="{color: getProgressColor(calculateProgress(goal))}">{{ calculateProgress(goal) }}%</span>
                            </div>
                            
                            <div class="goal-progress-bg">
                                <div class="goal-progress-fill" :class="getProgressClass(calculateProgress(goal))" :style="{width: Math.min(100, calculateProgress(goal)) + '%'}"></div>
                            </div>

                            <div style="margin-top:10px; display:flex; align-items:center; gap:10px;">
                                <template v-if="goal.mode === 'numeric'">
                                    <div style="display:flex; align-items:center; background: white; padding: 2px 8px; border-radius: 8px; border: 1px solid #ddd;">
                                        <input type="number" v-model.number="goal.current" style="border:none; width: 60px; font-weight:bold; text-align:right; outline:none;" @change="savePlayerData">
                                        <span style="font-size:0.8em; color:#666; margin-left: 5px;"> / {{ goal.target }} {{ goal.unit }}</span>
                                    </div>
                                </template>
                                <template v-else>
                                    <span style="font-size:0.8em; color:#666;">0%</span>
                                    <input type="range" v-model.number="goal.current" min="0" max="100" step="1" style="flex:1;" @change="savePlayerData">
                                    <span style="font-size:0.8em; color:#666;">100%</span>
                                </template>
                                <button class="btn-sm btn-danger" @click="deleteGoal(index)" style="padding: 4px 10px;">âœ•</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ç§¯åˆ†å•†åº— -->
            <div class="card">
                <h2>ğŸ¦ ç§¯åˆ†å•†åº— <button class="collapse-btn" @click="collapsed.shop = !collapsed.shop">{{ collapsed.shop ? 'å±•å¼€' : 'æ”¶èµ·' }}</button></h2>
                <div v-show="!collapsed.shop">
                    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                        <input v-model="newShopItem.name" placeholder="å•†å“..." class="note-input" style="margin:0;">
                        <input v-model.number="newShopItem.cost" type="number" placeholder="XP" class="note-input" style="width: 80px; margin:0;">
                        <button class="btn-sm" @click="addShopItem">ä¸Šæ¶</button>
                    </div>
                    <div class="shop-grid">
                        <div v-for="item in playerData.shopItems || []" :key="item.id" class="shop-card">
                            <div><span style="font-size:2em">{{ item.icon }}</span><h3>{{ item.name }}</h3><div style="color:#ff9a8b;font-weight:bold">{{ item.cost }} XP</div></div>
                            <div class="shop-btn-group">
                                <button class="btn-sm shop-btn-big" :disabled="playerData.xp < item.cost" @click="buyItem(item)">å…‘æ¢</button>
                                <button class="btn-sm btn-danger shop-btn-big" @click="deleteShopItem(item.id)">åˆ é™¤</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å¤ç›˜ & èµ„äº§ -->
            <div class="card">
                <h2>ğŸ”„ å¤ç›˜ & èµ„äº§ <button class="collapse-btn" @click="collapsed.reviews = !collapsed.reviews">{{ collapsed.reviews ? 'å±•å¼€' : 'æ”¶èµ·' }}</button></h2>
                <div v-show="!collapsed.reviews">
                    <div class="review-tabs">
                        <div class="review-tab" :class="{active: activeReviewTab === 'stock'}" @click="activeReviewTab = 'stock'; reviewPage = 1; loadChart()">ğŸ“ˆ è‚¡ç¥¨/èµ„äº§</div>
                        <div class="review-tab" :class="{active: activeReviewTab === 'daily'}" @click="activeReviewTab = 'daily'; reviewPage = 1">ğŸ“ æ—¥å¸¸</div>
                        <div class="review-tab" :class="{active: activeReviewTab === 'weekly'}" @click="activeReviewTab = 'weekly'; reviewPage = 1">ğŸ“… å‘¨å¤ç›˜</div>
                        <div class="review-tab special" @click="showReviewForm = !showReviewForm">{{ showReviewForm ? 'âœ–ï¸ å–æ¶ˆ' : 'â• æ–°å»º' }}</div>
                    </div>
                    <div v-show="activeReviewTab === 'stock'" class="chart-container"><canvas id="assetChart"></canvas></div>
                    <div v-if="showReviewForm" style="background:#fffaf5;padding:20px;border:2px dashed #ff9a8b;border-radius:15px;margin-bottom:20px;">
                        <div v-if="activeReviewTab === 'stock'">
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px;">
                                <input v-model="newStockData.code" placeholder="ä»£ç /åç§°" class="note-input" style="margin:0;">
                                <select v-model="newStockData.action" class="note-input" style="margin:0;"><option value="buy">ğŸ”µ ä¹°å…¥</option><option value="sell">ğŸ”´ å–å‡º</option><option value="hold">âšª æŒä»“</option></select>
                                <input v-model="newStockData.price" placeholder="ä»·æ ¼" class="note-input" style="margin:0;">
                                <input v-model="newStockData.profit" placeholder="ç›ˆäº" class="note-input" style="margin:0;">
                            </div>
                            <input v-model.number="newStockData.totalAsset" type="number" placeholder="å½“å‰æ€»å‡€å€¼..." class="note-input">
                        </div>
                        <input v-if="activeReviewTab !== 'stock'" v-model="newNote.title" placeholder="æ ‡é¢˜..." class="note-input">
                        
                        <!-- âš¡ ä¼˜åŒ–ï¼šCtrl+Enter å’Œ è‡ªåŠ¨é«˜åº¦ -->
                        <textarea v-model="newNote.content" class="note-textarea" 
                            placeholder="æ”¯æŒ Markdown (Ctrl+Enter æäº¤)..."
                            @input="autoResize"
                            @keydown.ctrl.enter.prevent="saveNote"
                            @paste="handlePaste($event, 'newNote.content')"></textarea>
                        
                        <div v-if="newNote.content" class="live-preview"><span class="preview-label">ğŸ‘ï¸ å®æ—¶é¢„è§ˆ</span><div class="markdown-content" v-html="renderMarkdown(newNote.content)"></div></div>
                        
                        <div style="margin-bottom:10px;">
                            <input type="file" ref="reviewFileInput" @change="handleFileUpload($event, 'newNote.content')" style="display:none" accept="image/*">
                            <button class="btn-sm btn-upload" @click="$refs.reviewFileInput.click()" :disabled="uploading">{{ uploading ? 'â³' : 'ğŸ“¸ æ’å…¥å›¾ç‰‡' }}</button>
                        </div>

                        <button class="btn" @click="saveNote" :disabled="uploading">ğŸ’¾ ä¿å­˜</button>
                    </div>

                    <div v-for="note in paginatedNotes" :key="note.id" class="note-card" @click="viewingNote = note">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div>
                                <div style="font-size:0.8em;color:#999;margin-bottom:5px">{{ formatDate(note.createdAt) }}</div>
                                <div v-if="note.type === 'stock'" style="padding-bottom:5px;border-bottom:1px dashed #ddd;margin-bottom:5px; display:inline-block;">
                                    <strong>{{ note.stockData?.code }}</strong> 
                                    <span :style="{color: note.stockData?.action==='buy'?'red':'green'}"> {{ note.stockData?.action }}</span>
                                    <span v-if="note.stockData?.totalAsset" style="margin-left:10px; color:#2e7d32;font-weight:bold">ğŸ’° {{ note.stockData.totalAsset }}</span>
                                </div>
                                <h3 v-if="note.title" style="margin-bottom:5px;">{{ note.title }}</h3>
                            </div>
                            <span style="color:#ff9a8b; font-size:1.5em;">&rsaquo;</span>
                        </div>
                        <div class="markdown-content note-preview-box" v-html="renderMarkdown(note.content)"></div>
                    </div>

                    <div v-if="filteredNotes.length > reviewPageSize" class="pagination-controls">
                        <button class="btn-page" :disabled="reviewPage === 1" @click="reviewPage--">â† ä¸Šä¸€é¡µ</button>
                        <span class="page-info">ç¬¬ {{ reviewPage }} / {{ totalReviewPages }} é¡µ</span>
                        <button class="btn-page" :disabled="reviewPage === totalReviewPages" @click="reviewPage++">ä¸‹ä¸€é¡µ â†’</button>
                    </div>
                </div>
            </div>

            <transition name="fade">
            <div v-if="viewingNote" class="modal-overlay" @click.self="viewingNote = null">
                <div class="detail-modal">
                    <span class="close-modal" @click="viewingNote = null">&times;</span>
                    <div style="padding-bottom:15px; border-bottom:2px solid #5a4a42; margin-bottom:20px;">
                        <div style="font-size:0.9em; color:#999;">{{ formatDate(viewingNote.createdAt) }}</div>
                        <div v-if="viewingNote.type === 'stock'" style="margin-top:10px; font-size:1.1em;">
                            <strong>{{ viewingNote.stockData?.code }}</strong> 
                            <span :style="{color: viewingNote.stockData?.action==='buy'?'red':'green'}"> {{ viewingNote.stockData?.action }}</span>
                            <div v-if="viewingNote.stockData?.price">ä»·æ ¼: {{ viewingNote.stockData.price }}</div>
                            <div v-if="viewingNote.stockData?.profit">ç›ˆäº: {{ viewingNote.stockData.profit }}</div>
                            <div v-if="viewingNote.stockData?.totalAsset" style="color:#2e7d32;font-weight:bold; margin-top:5px;">ğŸ’° æ€»å‡€å€¼: {{ viewingNote.stockData.totalAsset }}</div>
                        </div>
                        <h2 v-if="viewingNote.title" style="margin-top:10px; border:none;">{{ viewingNote.title }}</h2>
                    </div>
                    <div class="markdown-content" v-html="renderMarkdown(viewingNote.content)"></div>
                    <button class="btn-sm btn-danger" @click="deleteNote(viewingNote.id); viewingNote = null;" style="margin-top: 30px; float: right;">åˆ é™¤æ­¤è®°å½•</button>
                </div>
            </div>
            </transition>

            <!-- ğŸ“š è¯»ä¹¦ç¬”è®° -->
            <div class="card">
                <h2>ğŸ“š è¯»ä¹¦ç¬”è®° <button class="collapse-btn" @click="collapsed.books = !collapsed.books">{{ collapsed.books ? 'å±•å¼€' : 'æ”¶èµ·' }}</button></h2>
                <div v-show="!collapsed.books">
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <input v-model="bookSearchInput" @input="onSearchInput" class="search-bar" placeholder="ğŸ” æœç´¢ä¹¦åã€ä½œè€…..." style="margin-bottom: 0;">
                        <button class="btn" style="width: auto; white-space: nowrap;" @click="showBookForm = !showBookForm">{{ showBookForm ? 'æ”¶èµ·' : 'ğŸ“–' }}</button>
                    </div>

                    <div v-if="showBookForm" style="background: #fffaf5; padding: 20px; border: 2px dashed #5a4a42; border-radius: 15px; margin-bottom: 20px;">
                        <div style="display: flex; gap: 10px;">
                            <input v-model="newBook.title" placeholder="ä¹¦å" class="note-input">
                            <input v-model="newBook.author" placeholder="ä½œè€…" class="note-input">
                        </div>
                        <input v-model="newBook.tags" placeholder="æ ‡ç­¾ (é€—å·åˆ†éš”)..." class="note-input">
                        <div style="margin-bottom: 15px;">
                            <span v-for="n in 5" :key="n" class="star" :class="{active: n <= newBook.rating}" @click="newBook.rating = n">â˜…</span>
                        </div>
                        
                        <textarea v-model="newBook.content" placeholder="æ ¸å¿ƒç¬”è®° (Ctrl+Enter æäº¤)..." class="note-textarea" @input="autoResize" @keydown.ctrl.enter.prevent="saveBook" @paste="handlePaste($event, 'newBook.content')"></textarea>
                        <div v-if="newBook.content" class="live-preview"><span class="preview-label">ğŸ‘ï¸ ç¬”è®°é¢„è§ˆ</span><div class="markdown-content" v-html="renderMarkdown(newBook.content)"></div></div>

                        <div style="margin-bottom:10px;">
                            <input type="file" ref="bookFileInput" @change="handleFileUpload($event, 'newBook.content')" style="display:none" accept="image/*">
                            <button class="btn-sm btn-upload" @click="$refs.bookFileInput.click()" :disabled="uploading">{{ uploading ? 'â³' : 'ğŸ“¸ æ’å…¥å›¾ç‰‡' }}</button>
                        </div>

                        <textarea v-model="newBook.thoughts" placeholder="æ„Ÿæ‚Ÿä¸è‡´è°¢ (Ctrl+Enter æäº¤)..." class="note-textarea" style="background: #f0fdf4; border-color: #a3de83;" @input="autoResize" @keydown.ctrl.enter.prevent="saveBook" @paste="handlePaste($event, 'newBook.thoughts')"></textarea>
                        
                        <button class="btn" @click="saveBook" :disabled="uploading">ğŸ’¾ ä¿å­˜ç¬”è®°</button>
                    </div>

                    <div class="book-list">
                        <div v-for="book in filteredBooks" :key="book.id" class="book-card" @click="viewingBook = book">
                            <div style="display:flex; justify-content:space-between;">
                                <div class="book-title" :title="book.title">{{ book.title }}</div>
                                <div style="color:#ffc107">â˜… {{ book.rating }}</div>
                            </div>
                            <div style="font-size:0.8em; color:#888; margin-bottom:8px;">{{ book.author }}</div>
                            <div v-if="book.tags && book.tags.length" style="margin-bottom:8px; overflow:hidden; white-space:nowrap;">
                                <span v-for="tag in book.tags" :key="tag" class="tag-pill">#{{ tag }}</span>
                            </div>
                            <div class="book-preview">{{ book.content }}</div>
                            <div style="font-size:0.8em; text-align:right; color:#ff9a8b; margin-top:auto;">ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ… &rsaquo;</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ğŸ“‚ çŸ¥è¯†åº“ -->
            <div class="card">
                 <h2>ğŸ“‚ çŸ¥è¯†åº“</h2>
                 <p style="margin-bottom:15px; color:#666;">è®°å½•æ²‰æ·€ï¼Œæ„å»ºä½“ç³»ã€‚</p>
                 <button class="btn" @click="showKnowledgeBase = true">æ‰“å¼€çŸ¥è¯†åº“</button>
            </div>

            <!-- â˜¯ï¸ æ˜“å­¦å‘½ä¾‹ -->
            <div class="card">
                 <h2>â˜¯ï¸ æ˜“å­¦å‘½ä¾‹ <button class="collapse-btn" @click="collapsed.cases = !collapsed.cases">{{ collapsed.cases ? 'å±•å¼€' : 'æ”¶èµ·' }}</button></h2>
                 <div v-show="!collapsed.cases">
                     <button class="btn" style="margin-bottom: 20px;" @click="showCaseForm = !showCaseForm">{{ showCaseForm ? 'æ”¶èµ·' : 'âœ¨ è®°å½•æ–°å‘½ä¾‹' }}</button>
                     
                     <div v-if="showCaseForm" style="background:#fffaf9; padding:15px; border-radius:10px; border:2px dashed #e0c9b8; margin-bottom:20px;">
                        <input v-model="newCase.title" placeholder="å‘½ä¸» / æ¦‚è¦..." class="note-input">
                        <textarea v-model="newCase.content" placeholder="æ–­è¯­ä¸å¤ç›˜ (Ctrl+Enter æäº¤)..." class="note-textarea" @input="autoResize" @keydown.ctrl.enter.prevent="saveCase" @paste="handlePaste($event, 'newCase.content')"></textarea>
                        <div v-if="newCase.content" class="live-preview"><span class="preview-label">ğŸ‘ï¸ å®æ—¶é¢„è§ˆ</span><div class="markdown-content" v-html="renderMarkdown(newCase.content)"></div></div>

                         <div style="margin-bottom:10px;">
                            <input type="file" ref="caseFileInput" @change="handleFileUpload($event, 'newCase.content')" style="display:none" accept="image/*">
                            <button class="btn-sm btn-upload" @click="$refs.caseFileInput.click()" :disabled="uploading">{{ uploading ? 'â³' : 'ğŸ“¸ æ’å…¥å›¾ç‰‡' }}</button>
                        </div>
                        <button class="btn-sm" @click="saveCase" :disabled="uploading">ä¿å­˜</button>
                     </div>

                     <div class="case-grid">
                        <div v-for="c in cases" :key="c.id" class="case-card" @click="viewingItem = { ...c, type: 'case' }">
                            <div style="font-weight:bold; margin-bottom:5px;">{{ c.title }}</div>
                            <div style="font-size:0.8em;color:#666;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">{{c.content}}</div>
                        </div>
                     </div>
                 </div>
            </div>
        </div>
    </div>

    <transition name="fade">
    <div v-if="viewingBook" class="modal-overlay" @click.self="viewingBook = null">
        <div class="detail-modal">
            <span class="close-modal" @click="viewingBook = null">&times;</span>
            <div style="padding-bottom:15px; border-bottom:2px solid #5a4a42; margin-bottom:20px;">
                <h1 style="margin-bottom:5px;">{{ viewingBook.title }}</h1>
                <div style="color:#666; font-size:1.1em;">ä½œè€…: {{ viewingBook.author }}</div>
                <div style="margin-top:10px;">
                     <span v-for="n in 5" :key="n" class="star" :class="{active: n <= viewingBook.rating}">â˜…</span>
                </div>
                <div v-if="viewingBook.tags && viewingBook.tags.length" style="margin-top:10px;">
                    <span v-for="tag in viewingBook.tags" :key="tag" class="tag-pill">#{{ tag }}</span>
                </div>
            </div>
            <div class="detail-section"><h4>ğŸ“ æ ¸å¿ƒç¬”è®°</h4><div class="markdown-content" v-html="renderMarkdown(viewingBook.content || 'æš‚æ— ç¬”è®°')"></div></div>
            <div v-if="viewingBook.thoughts" class="detail-section" style="background: #f0fdf4; border-color: #a3de83;"><h4 style="color: #2e7d32; border-color: #2e7d32;">ğŸ™ æ„Ÿæ‚Ÿä¸è‡´è°¢</h4><div class="markdown-content" style="color: #1b5e20;" v-html="renderMarkdown(viewingBook.thoughts)"></div></div>
            <button class="btn-sm btn-danger" @click="deleteBook(viewingBook.id)" style="margin-top: 30px; float: right;">åˆ é™¤æ­¤è®°å½•</button>
        </div>
    </div>
    </transition>

    <transition name="fade">
    <div v-if="showKnowledgeBase" class="modal-overlay" @click.self="showKnowledgeBase = false">
        <div class="kb-window">
            <div class="kb-sidebar">
                <div style="padding: 20px; font-weight: bold; border-bottom: 2px dashed #e0c9b8; background: #fffaf0;">
                    ğŸ“š çŸ¥è¯†åº“ <span @click="addKbCategory" style="float:right; cursor:pointer; color:#ff9a8b;">+</span>
                </div>
                <div style="flex: 1; overflow-y: auto;">
                    <div class="kb-nav-item" :class="{active: kbCurrentCategory === 'all'}" @click="selectKbCategory('all')">ğŸ“‚ å…¨éƒ¨æ–‡æ¡£</div>
                    <div v-for="cat in kbCategories" :key="cat.id" class="kb-nav-item" :class="{active: kbCurrentCategory && kbCurrentCategory.id === cat.id}" @click="selectKbCategory(cat)">
                        ğŸ“ {{ cat.name }}
                    </div>
                </div>
            </div>
            <div class="kb-main">
                <div class="kb-toolbar">
                    <span style="font-weight:bold; color:#5a4a42; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">{{ kbCurrentCategory === 'all' ? 'å…¨éƒ¨æ–‡æ¡£' : kbCurrentCategory.name }}</span>
                    <button class="btn-sm" @click="openKbEditor()">+ æ–°å»º</button>
                </div>
                <div class="kb-content">
                    <div v-if="kbEditorMode">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <input v-model="kbEditorData.title" placeholder="æ–‡æ¡£æ ‡é¢˜" class="note-input" style="font-size:1.2em; font-weight:bold; width: 60%; margin:0;">
                            <div class="toggle-group">
                                <button class="toggle-btn" :class="{active: !kbPreviewMode}" @click="kbPreviewMode = false">âœï¸ ç¼–è¾‘</button>
                                <button class="toggle-btn" :class="{active: kbPreviewMode}" @click="kbPreviewMode = true">ğŸ‘ï¸ é¢„è§ˆ</button>
                            </div>
                        </div>
                        <div style="margin-top: 15px;">
                            <div v-show="!kbPreviewMode">
                                <textarea v-model="kbEditorData.content" class="note-textarea" style="height: 50vh; font-family: monospace; border-bottom: 2px solid #e0c9b8; border-radius: 12px;" placeholder="# æ ‡é¢˜ &#10;- åˆ—è¡¨ &#10;**åŠ ç²—** &#10;ï¼ˆæ”¯æŒç›´æ¥ç²˜è´´å›¾ç‰‡ï¼‰" @paste="handlePaste($event, 'kbEditorData.content')"></textarea>
                                <div style="margin-top:10px;">
                                    <input type="file" ref="kbFileInput" @change="handleFileUpload($event, 'kbEditorData.content')" style="display:none" accept="image/*">
                                    <button class="btn-sm btn-upload" @click="$refs.kbFileInput.click()" :disabled="uploading">{{ uploading ? 'â³' : 'ğŸ“¸ æ’å…¥å›¾ç‰‡' }}</button>
                                </div>
                            </div>
                            <div v-show="kbPreviewMode" class="markdown-content" style="height: 50vh; overflow-y: auto; background: white; border: 2px solid #e0c9b8; border-radius: 12px; padding: 20px;" v-html="renderMarkdown(kbEditorData.content || 'æš‚æ— å†…å®¹')"></div>
                        </div>
                        <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 15px;">
                            <button class="btn" style="background:#ccc; width:auto;" @click="kbEditorMode = false">å–æ¶ˆ</button>
                            <button v-if="kbEditorData.id" class="btn btn-danger" style="width:auto;" @click="deleteKbDoc(kbEditorData.id)">åˆ é™¤</button>
                            <button class="btn" style="width:auto;" @click="saveKbDoc">ä¿å­˜</button>
                        </div>
                    </div>
                    <div v-else-if="viewingKbDoc">
                        <div style="border-bottom: 2px solid #e0c9b8; padding-bottom: 15px; margin-bottom: 20px; display:flex; justify-content:space-between; align-items:center;">
                            <div style="overflow: hidden;">
                                <h1 style="font-size: 1.8em; margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">{{ viewingKbDoc.title }}</h1>
                                <span style="color:#999; font-size:0.8em;">æœ€åæ›´æ–°: {{ formatDate(viewingKbDoc.updatedAt) }}</span>
                            </div>
                            <div style="display:flex; gap:10px; flex-shrink: 0;">
                                <button class="btn-sm" style="background:#ddd; color:#555;" @click="viewingKbDoc = null">è¿”å›</button>
                                <button class="btn-sm" @click="editKbDoc(viewingKbDoc)">âœï¸ ç¼–è¾‘</button>
                            </div>
                        </div>
                        <div class="markdown-content" v-html="renderMarkdown(viewingKbDoc.content)"></div>
                    </div>
                    <div v-else>
                        <div v-for="doc in filteredKbDocs" :key="doc.id" class="kb-list-item" @click="viewingKbDoc = doc">
                            <div style="flex:1; overflow:hidden;">
                                <div style="font-weight: bold; font-size: 1.1em; color:#5a4a42; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">ğŸ“„ {{ doc.title || 'æ— æ ‡é¢˜æ–‡æ¡£' }}</div>
                                <div style="font-size: 0.8em; color: #999; margin-top:5px;">{{ formatDate(doc.updatedAt) }}</div>
                            </div>
                            <span style="color:#ff9a8b; font-size:1.2em; margin-left:10px;">&rsaquo;</span>
                        </div>
                        <div v-if="filteredKbDocs.length === 0" style="text-align: center; color: #999; margin-top: 50px;"><div style="font-size:3em; margin-bottom:10px;">ğŸ“­</div>æ­¤åˆ†ç±»ä¸‹æš‚æ— æ–‡æ¡£</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </transition>

    <transition name="fade">
    <div v-if="viewingItem" class="modal-overlay" @click.self="viewingItem = null">
        <div class="detail-modal">
             <span class="close-modal" @click="viewingItem = null">&times;</span>
             <h2>{{ viewingItem.title }}</h2>
             <div class="markdown-content" v-html="renderMarkdown(viewingItem.content)"></div>
             <button class="btn-sm btn-danger" @click="deleteItem(viewingItem)" style="margin-top: 20px;">åˆ é™¤</button>
        </div>
    </div>
    </transition>
</div>

<script>
    const SUPABASE_URL = 'https://zqmgigcnruvvdcholbuj.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpxbWdpZ2NucnV2dmRjaG9sYnVqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4NjgzNjEsImV4cCI6MjA4MTQ0NDM2MX0.IHzDp7o5M9QM8IBWy2ri5gS9h9nm0zk3AaPTNveDqXI';
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    const { createApp } = Vue;

    createApp({
        data() {
            return {
                isLoggedIn: false, userId: null, userEmail: '', email: '', password: '',
                loading: false, syncing: false, uploading: false, message: '', messageType: '',
                collapsed: { goals: false, stats: false, quests: false, shop: false, reviews: false, books: false, cases: false },
                playerData: { level: 1, xp: 0, nextLevelXp: 100, goals: [], dailyTasks: [], lastLoginDate: '', shopItems: [], assetHistory: [] },
                newGoal: { title: '', target: null, current: 0, unit: '', mode: 'numeric' },
                newQuestTitle: '', newShopItem: { name: '', cost: 50, icon: 'ğŸ¥¤' },
                notes: [], cases: [], books: [], kbCategories: [], kbDocs: [],
                activeReviewTab: 'stock', showReviewForm: false, newNote: { title: '', content: '' },
                newStockData: { code: '', action: 'buy', price: '', profit: '', totalAsset: null },
                showBookForm: false, bookSearchInput: '', bookSearchQuery: '', searchTimer: null, 
                viewingBook: null, newBook: { title: '', author: '', rating: 5, content: '', thoughts: '', tags: '' },
                showKnowledgeBase: false, kbCurrentCategory: 'all', kbEditorMode: false, kbPreviewMode: false,
                viewingKbDoc: null, kbEditorData: {}, showCaseForm: false, newCase: { title: '', content: '' }, viewingItem: null,
                chartInstance: null, reviewPage: 1, reviewPageSize: 5, viewingNote: null
            };
        },
        computed: {
            xpPercentage() { return Math.min(100, (this.playerData.xp / this.playerData.nextLevelXp) * 100); },
            filteredNotes() {
                let res = this.notes.filter(n => (!n.type && this.activeReviewTab==='daily') || n.type===this.activeReviewTab);
                return res.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));
            },
            paginatedNotes() {
                const start = (this.reviewPage - 1) * this.reviewPageSize;
                const end = start + this.reviewPageSize;
                return this.filteredNotes.slice(start, end);
            },
            totalReviewPages() { return Math.ceil(this.filteredNotes.length / this.reviewPageSize) || 1; },
            filteredBooks() {
                let list = this.books;
                if (this.bookSearchQuery) {
                    const q = this.bookSearchQuery.toLowerCase();
                    list = list.filter(b => (b.title && b.title.toLowerCase().includes(q)) || (b.author && b.author.toLowerCase().includes(q)) || (b.content && b.content.toLowerCase().includes(q)) || (b.thoughts && b.thoughts.toLowerCase().includes(q)));
                }
                return list;
            },
            filteredKbDocs() {
                if (this.kbCurrentCategory === 'all') return this.kbDocs;
                return this.kbDocs.filter(d => d.categoryId === this.kbCurrentCategory.id);
            }
        },
        methods: {
            showMessage(txt, type='success') { this.message = txt; this.messageType = type; setTimeout(()=>this.message='', 4000); },
            formatDate(str) { if(!str) return ''; return new Date(str).toLocaleString('zh-CN'); },
            calculateProgress(goal) { return goal.mode === 'text' ? (goal.current || 0) : (!goal.target ? 0 : Math.round((goal.current / goal.target) * 100)); },
            getProgressColor(p) { return p < 30 ? '#ff6b6b' : (p < 80 ? '#ffcc00' : '#2e7d32'); },
            getProgressClass(p) { return p >= 100 ? 'p-done' : (p < 30 ? 'p-low' : (p < 80 ? 'p-mid' : 'p-high')); },
            deduplicate(arr) { if (!arr || !Array.isArray(arr)) return []; const seen = new Set(); return arr.filter(item => { const id = item.id; if (seen.has(id)) return false; seen.add(id); return true; }); },
            
            renderMarkdown(text) { if (!text) return ''; try { return marked.parse(text); } catch(e) { return text; } },

            autoResize(event) { const el = event.target; el.style.height = 'auto'; el.style.height = el.scrollHeight + 'px'; },
            onSearchInput() { if (this.searchTimer) clearTimeout(this.searchTimer); this.searchTimer = setTimeout(() => { this.bookSearchQuery = this.bookSearchInput; }, 300); },

            async saveOne(tableName, item) {
                if (!this.userId) return;
                try {
                    const { count, error } = await sb.from(tableName).update({ data: item }).eq('user_id', this.userId).eq('data->>id', item.id).select('id', { count: 'exact' });
                    if (error) throw error;
                    if (count === 0) { const { error: insertError } = await sb.from(tableName).insert({ user_id: this.userId, data: item }); if(insertError) throw insertError; }
                } catch (err) { console.error('ä¿å­˜å¤±è´¥:', err); this.showMessage('åŒæ­¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ', 'error'); }
            },
            async deleteOne(tableName, itemId) { if (!this.userId) return; await sb.from(tableName).delete().eq('user_id', this.userId).eq('data->>id', itemId); },
            async savePlayerData() { if (!this.userId) return; await sb.from('players').upsert({ user_id: this.userId, data: this.playerData }, { onConflict: 'user_id' }); },

            async compressImage(file) {
                if (file.type === 'image/gif') return file;
                return new Promise((resolve) => {
                    const reader = new FileReader(); reader.readAsDataURL(file);
                    reader.onload = (event) => {
                        const img = new Image(); img.src = event.target.result;
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            let width = img.width, height = img.height; const MAX_WIDTH = 1280;
                            if (width > MAX_WIDTH) { height = Math.round(height * (MAX_WIDTH / width)); width = MAX_WIDTH; }
                            canvas.width = width; canvas.height = height; const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);
                            canvas.toBlob((blob) => { resolve(new File([blob], file.name, { type: 'image/jpeg', lastModified: Date.now() })); }, 'image/jpeg', 0.7); 
                        };
                    };
                });
            },
            async handlePaste(event, modelPath) {
                const items = (event.clipboardData || event.originalEvent.clipboardData).items;
                for (let item of items) { if (item.kind === 'file' && item.type.startsWith('image/')) { event.preventDefault(); const file = item.getAsFile(); await this.performUpload(file, modelPath, event.target); return; } }
            },
            async handleFileUpload(event, modelPath) { const file = event.target.files[0]; if (!file) return; await this.performUpload(file, modelPath, null); event.target.value = ''; },
            async performUpload(file, modelPath, textareaEl) {
                if (file.size > 10 * 1024 * 1024) return alert('å›¾ç‰‡ä¸èƒ½è¶…è¿‡ 10MB');
                this.uploading = true;
                try {
                    const processedFile = await this.compressImage(file);
                    const fileName = `${this.userId}/${Date.now()}_${processedFile.name.replace(/[^a-zA-Z0-9.]/g, '')}`;
                    const { error } = await sb.storage.from('images').upload(fileName, processedFile);
                    if (error) throw error;
                    const { data: { publicUrl } } = sb.storage.from('images').getPublicUrl(fileName);
                    const markdownImg = `![image](${publicUrl})`;
                    const keys = modelPath.split('.');
                    if (keys.length === 2) {
                        const originalText = this[keys[0]][keys[1]] || '';
                        if (textareaEl) {
                            const start = textareaEl.selectionStart, end = textareaEl.selectionEnd;
                            const newText = originalText.substring(0, start) + markdownImg + originalText.substring(end);
                            this[keys[0]][keys[1]] = newText;
                            this.$nextTick(() => { const newPos = start + markdownImg.length; textareaEl.selectionStart = textareaEl.selectionEnd = newPos; textareaEl.focus(); textareaEl.style.height = 'auto'; textareaEl.style.height = textareaEl.scrollHeight + 'px'; });
                        } else { this[keys[0]][keys[1]] = originalText + '\n' + markdownImg + '\n'; }
                    }
                    this.showMessage('ğŸ“¸ å›¾ç‰‡å·²æ’å…¥');
                } catch (error) { console.error(error); this.showMessage('ä¸Šä¼ å¤±è´¥: ' + error.message, 'error'); } finally { this.uploading = false; }
            },

            async login() {
                this.loading = true; const { data, error } = await sb.auth.signInWithPassword({ email: this.email, password: this.password }); this.loading = false;
                if (error) return this.showMessage(error.message, 'error');
                this.isLoggedIn = true; this.userId = data.user.id; this.userEmail = data.user.email; this.loadData();
            },
            async logout() { await sb.auth.signOut(); this.isLoggedIn = false; },

            async loadData() {
                this.syncing = true;
                const [p, n, b, kc, kd, cs] = await Promise.all([
                    sb.from('players').select('*').eq('user_id', this.userId).single(),
                    sb.from('notes').select('*').eq('user_id', this.userId),
                    sb.from('books').select('*').eq('user_id', this.userId),
                    sb.from('kb_categories').select('*').eq('user_id', this.userId),
                    sb.from('kb_notes').select('*').eq('user_id', this.userId),
                    sb.from('cases').select('*').eq('user_id', this.userId)
                ]);
                if(p.data && p.data.data) {
                    this.playerData = { ...this.playerData, ...p.data.data };
                    if(!this.playerData.dailyTasks) this.playerData.dailyTasks = [];
                    if(!this.playerData.shopItems) this.playerData.shopItems = [];
                    if(!this.playerData.assetHistory) this.playerData.assetHistory = [];
                    this.checkDailyReset();
                }
                if(n.data) this.notes = this.deduplicate(n.data.map(i => i.data));
                if(b.data) this.books = this.deduplicate(b.data.map(i => i.data));
                if(kc.data) this.kbCategories = this.deduplicate(kc.data.map(i => i.data));
                if(kd.data) this.kbDocs = this.deduplicate(kd.data.map(i => i.data)).filter(d => d && d.id);
                if(cs.data) this.cases = this.deduplicate(cs.data.map(i => i.data));
                this.syncing = false; setTimeout(() => this.loadChart(), 500);
            },
            async syncData() { this.syncing = true; await this.saveAll(); this.syncing = false; this.showMessage('åŒæ­¥å®Œæˆ'); },
            async saveAll() {
                if (!this.userId) return;
                this.kbDocs = this.deduplicate(this.kbDocs);
                await this.savePlayerData();
                const saveTbl = async (t, d) => { await sb.from(t).delete().eq('user_id', this.userId); if(d.length) await sb.from(t).insert(d.map(x=>({user_id:this.userId, data:x}))); };
                await Promise.all([ saveTbl('notes', this.notes), saveTbl('cases', this.cases), saveTbl('books', this.books), saveTbl('kb_notes', this.kbDocs), saveTbl('kb_categories', this.kbCategories) ]);
            },

            checkDailyReset() { const today = new Date().toDateString(); if (this.playerData.lastLoginDate !== today) { this.playerData.dailyTasks.forEach(t => t.completed = false); this.playerData.lastLoginDate = today; this.savePlayerData(); this.showMessage('â˜€ï¸ æ¯æ—¥ä»»åŠ¡å·²åˆ·æ–°'); } },
            addDailyQuest() { if(this.newQuestTitle){ this.playerData.dailyTasks.push({id:Date.now(),title:this.newQuestTitle,completed:false}); this.newQuestTitle=''; this.savePlayerData(); } },
            toggleQuest(q) { if(!q.completed){ q.completed=true; this.addXp(5); if(this.playerData.dailyTasks.every(t=>t.completed))this.addXp(20); this.savePlayerData(); } },
            deleteDailyQuest(id) { if(confirm('åˆ ?')){ this.playerData.dailyTasks=this.playerData.dailyTasks.filter(t=>t.id!==id); this.savePlayerData(); } },

            addShopItem() { this.playerData.shopItems.push({ id: Date.now(), ...this.newShopItem }); this.newShopItem={name:'',cost:50,icon:'âœ¨'}; this.savePlayerData(); },
            deleteShopItem(id) { this.playerData.shopItems=this.playerData.shopItems.filter(i=>i.id!==id); this.savePlayerData(); },
            buyItem(item) { 
                if(this.playerData.xp>=item.cost && confirm(`å…‘æ¢ ${item.name}?`)){ 
                    this.playerData.xp-=item.cost; 
                    const note = {id:Date.now(),type:'daily',createdAt:new Date().toISOString(),title:'ğŸ å•†åº—å…‘æ¢',content:item.name};
                    this.notes.unshift(note); 
                    this.saveOne('notes', note).catch(console.error);
                    this.savePlayerData(); 
                } 
            },

            loadChart() {
                if(this.activeReviewTab!=='stock')return; 
                if(typeof Chart === 'undefined') return;
                const ctx=document.getElementById('assetChart'); if(!ctx)return;
                const h=(this.playerData.assetHistory||[]).sort((a,b)=>new Date(a.date)-new Date(b.date));
                const labels = h.map(x=>new Date(x.date).toLocaleDateString());
                const data = h.map(x=>x.value);

                if(this.chartInstance) {
                    // âš¡ ä¼˜åŒ–ï¼šå›¾è¡¨å¹³æ»‘æ›´æ–°
                    this.chartInstance.data.labels = labels;
                    this.chartInstance.data.datasets[0].data = data;
                    this.chartInstance.update();
                } else {
                    this.chartInstance=new Chart(ctx,{type:'line',data:{labels:labels,datasets:[{data:data,borderColor:'#4ecdc4',backgroundColor:'rgba(78,205,196,0.1)',tension:0.3,fill:true}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},animation:{duration:800}}});
                }
            },
            
            saveNote() { 
                // âš¡ ä¼˜åŒ–ï¼šä¹è§‚ UI - é›¶å»¶è¿Ÿä¿å­˜
                const now = new Date().toISOString();
                let itemToSave = null;

                if(this.activeReviewTab==='stock'){
                    if(this.newStockData.totalAsset){ 
                        this.playerData.assetHistory.push({date:now, value:this.newStockData.totalAsset}); 
                        this.savePlayerData();
                        setTimeout(()=>this.loadChart(), 0); 
                    }
                    if(this.newStockData.code) {
                        itemToSave = {id:Date.now(),type:'stock',createdAt:now,content:this.newNote.content,stockData:{...this.newStockData}};
                    }
                } else if(this.newNote.title || this.newNote.content) { 
                    itemToSave = {id:Date.now(),type:this.activeReviewTab,createdAt:now,...this.newNote};
                }
                
                if(itemToSave) {
                    this.notes.unshift(itemToSave);
                    // ç«‹å³æ¸…ç©ºï¼Œæå‡ä½“éªŒ
                    this.newStockData={code:'',action:'buy',price:'',profit:'',totalAsset:null}; 
                    this.newNote={title:'',content:''}; 
                    this.showReviewForm=false; 
                    
                    this.saveOne('notes', itemToSave).catch(e => { console.error(e); this.showMessage('åå°åŒæ­¥å‡ºé”™', 'error'); });
                    
                    this.addXp(10); 
                    this.savePlayerData();
                    this.reviewPage = 1;
                }
            },
            deleteNote(id){ if(confirm('åˆ ?')){ this.notes=this.notes.filter(n=>n.id!==id); this.deleteOne('notes', id); } },

            addGoal() { 
                if (this.newGoal.title) {
                    const isSlider = this.newGoal.mode === 'slider'; const target = isSlider ? 100 : (this.newGoal.target || 100); const unit = isSlider ? '' : (this.newGoal.unit || '');
                    this.playerData.goals.push({ title: this.newGoal.title, mode: this.newGoal.mode, current: 0, unit: unit, target: target });
                    const currentMode = this.newGoal.mode; this.newGoal = { title: '', target: null, current: 0, unit: '', mode: currentMode };
                    this.savePlayerData(); 
                } 
            },
            deleteGoal(i) { if(confirm('åˆ ?')){ this.playerData.goals.splice(i,1); this.savePlayerData(); } },
            addXp(v) { 
                this.playerData.xp += v; 
                // æ£€æŸ¥æ˜¯å¦è¾¾åˆ°å‡çº§æ ‡å‡†
                if(this.playerData.xp >= this.playerData.nextLevelXp){
                    // æ‰£é™¤å½“å‰ç­‰çº§æ‰€éœ€ç»éªŒ
                    this.playerData.xp -= this.playerData.nextLevelXp;
                    // ç­‰çº§ +1
                    this.playerData.level++;
                    // ğŸ“ˆ æ ¸å¿ƒä¿®æ”¹ï¼šä¸‹ä¸€çº§æ‰€éœ€ç»éªŒå¢åŠ  50 ç‚¹
                    // æ¯”å¦‚ï¼š1çº§å‡2çº§è¦100ï¼Œ2çº§å‡3çº§å°±è¦150ï¼Œ3çº§å‡4çº§è¦200...
                    this.playerData.nextLevelXp += 50;
                } 
            },

            saveCase() { 
                if(this.newCase.title){ 
                    const newItem = {id:Date.now(),type:'case',createdAt:new Date().toISOString(),...this.newCase};
                    this.cases.unshift(newItem); 
                    this.newCase={title:'',content:''}; this.showCaseForm=false; 
                    this.saveOne('cases', newItem).catch(console.error);
                    this.addXp(20); this.savePlayerData();
                } 
            },
            saveBook() { 
                if(this.newBook.title){ 
                    const tags = this.newBook.tags ? this.newBook.tags.split(/[,ï¼Œ]/).map(t=>t.trim()).filter(t=>t) : [];
                    const newItem = {id:Date.now(),...this.newBook, tags, createdAt:new Date().toISOString()};
                    this.books.unshift(newItem); 
                    this.newBook={title:'',author:'',rating:5,content:'',thoughts:'',tags:''}; this.showBookForm=false; 
                    this.saveOne('books', newItem).catch(console.error);
                    this.addXp(20); this.savePlayerData();
                } 
            },
            deleteBook(id) { if(confirm('åˆ é™¤æ­¤ä¹¦?')){ this.books=this.books.filter(b=>b.id!==id); this.viewingBook=null; this.deleteOne('books', id); } },

            selectKbCategory(c) { this.kbCurrentCategory = c; this.viewingKbDoc = null; this.kbEditorMode = false; },
            openKbEditor() { this.kbEditorMode=true; this.kbPreviewMode=false; this.viewingKbDoc=null; this.kbEditorData={id:null,title:'',content:'',categoryId: this.kbCurrentCategory==='all'?null:this.kbCurrentCategory.id}; },
            editKbDoc(d) { this.kbEditorData={...d}; this.kbEditorMode=true; this.kbPreviewMode=false; this.viewingKbDoc=null; },
            saveKbDoc() { 
                const now=new Date().toISOString(); let docToSave = null;
                if(this.kbEditorData.id){ 
                    const i=this.kbDocs.findIndex(d=>d.id===this.kbEditorData.id); 
                    if(i!==-1) { this.kbDocs[i]={...this.kbDocs[i],...this.kbEditorData,updatedAt:now}; this.viewingKbDoc = this.kbDocs[i]; docToSave = this.kbDocs[i]; }
                } else { 
                    const newId = Date.now(); docToSave = {id:newId,title:this.kbEditorData.title||'æ— æ ‡é¢˜',content:this.kbEditorData.content,categoryId:this.kbEditorData.categoryId,createdAt:now,updatedAt:now};
                    this.kbDocs.unshift(docToSave); 
                }
                if (docToSave) this.saveOne('kb_notes', docToSave).catch(console.error);
                this.kbEditorMode=false; 
            },
            deleteKbDoc(id) { if(confirm('åˆ é™¤?')){ this.kbDocs=this.kbDocs.filter(d=>d.id!==id); this.kbEditorMode=false; this.viewingKbDoc=null; this.deleteOne('kb_notes', id); } },
            addKbCategory() { const n=prompt('æ–°åˆ†ç±»å'); if(n){ const item = {id:Date.now(),name:n}; this.kbCategories.push(item); this.saveOne('kb_categories', item).catch(console.error); } },
            deleteItem(item) { if(!confirm('åˆ é™¤?'))return; if(item.type==='case') { this.cases=this.cases.filter(c=>c.id!==item.id); this.deleteOne('cases', item.id); } this.viewingItem=null; }
        },
        mounted() {
            // ğŸ› ä¿®å¤ Marked.js å›¾ç‰‡æ¸²æŸ“
            const renderer = new marked.Renderer();
            renderer.image = function(token) {
                let href, text; if (typeof token === 'object' && !arguments[1]) { ({ href, text } = token); } else { href = token; text = arguments[2]; }
                return `<img src="${href}" alt="${text||''}" loading="lazy" style="max-width:100%; border-radius:8px; display:block; margin:10px 0;">`;
            };
            renderer.link = function(token) {
                let href, text; if (typeof token === 'object' && !arguments[1]) { ({ href, text } = token); } else { href = token; text = arguments[2]; }
                return `<a href="${href}" target="_blank" rel="noopener noreferrer" style="color:#ff9a8b; text-decoration:none; border-bottom:1px dotted #ff9a8b;">${text}</a>`;
            };
            marked.use({ renderer });

            // ğŸ§  æ™ºèƒ½æ—¥æœŸæ£€æµ‹
            document.addEventListener("visibilitychange", () => {
                if (document.visibilityState === 'visible' && this.isLoggedIn) { this.checkDailyReset(); }
            });

            sb.auth.getSession().then(({ data: { session } }) => {
                if(session) { this.isLoggedIn = true; this.userId = session.user.id; this.userEmail = session.user.email; this.loadData(); }
            });
        }
    }).mount('#app');
</script>
</body>
</html>




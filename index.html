<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸ªäººç©ºé—´ - å‡çº§ç‰ˆ</title>
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <!-- Supabase -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- å­—ä½“ -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* ========== å…¨å±€æ ·å¼ (ä¿æŒæš–è‰²æ‰‹è´¦é£) ========== */
        :root {
            --bg-color: #fef9f3;
            --text-color: #5a4a42;
            --accent-pink: #ff9a8b;
            --accent-green: #a3de83;
            --accent-blue: #8fd3f4;
            --card-border: 2.5px solid #5a4a42;
            --card-shadow: 6px 6px 0px #d4b8a7;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Noto Sans SC', sans-serif;
            background: var(--bg-color);
            min-height: 100vh;
            color: var(--text-color);
            padding: 20px;
        }

        .container { max-width: 1400px; margin: 0 auto; }

        /* å¤´éƒ¨ */
        .header {
            text-align: center; margin-bottom: 30px; padding: 30px;
            background: #fffaf0; border-radius: 24px;
            box-shadow: 8px 8px 0px #e0c9b8; border: 3px solid #5a4a42;
            display: flex; flex-direction: column; align-items: center;
        }
        .header h1 { font-size: 2.2em; font-weight: 700; text-shadow: 3px 3px 0px #ffd6cc; margin-bottom: 10px; }

        /* å¸ƒå±€ */
        .grid { display: grid; grid-template-columns: 1fr; gap: 30px; margin-bottom: 40px; }
        
        /* é€šç”¨å¡ç‰‡ */
        .card {
            background: #fffefc; border-radius: 20px; padding: 30px;
            box-shadow: var(--card-shadow); border: var(--card-border);
            transition: transform 0.3s; position: relative;
        }
        .card:hover { transform: translateY(-3px); }
        .card h2 {
            margin-bottom: 20px; padding-bottom: 15px; border-bottom: 3px dotted #ff9a8b;
            font-size: 1.4em; font-weight: 700; display: flex; justify-content: space-between; align-items: center;
        }

        /* æŒ‰é’® */
        .btn {
            background: linear-gradient(90deg, #ff9a8b, #ff6b6b); border: none; padding: 12px 30px;
            border-radius: 50px; color: white; cursor: pointer; font-size: 16px; font-weight: 700;
            box-shadow: 4px 4px 0px #d45d5d; transition: all 0.2s; width: 100%;
        }
        .btn:hover:not(:disabled) { transform: translateY(-2px); }
        .btn-sm {
            padding: 6px 15px; font-size: 0.9em; border-radius: 20px;
            background: linear-gradient(90deg, #4ecdc4, #a3de83);
            box-shadow: 3px 3px 0px #2ba69b; border: none; color: white; font-weight: bold; cursor: pointer;
        }
        .btn-danger { background: #ff6b6b; box-shadow: 3px 3px 0px #c0392b; }
        .collapse-btn {
            background: #fffaf5; border: 2px solid #ff9a8b; color: #ff6b6b;
            padding: 4px 12px; border-radius: 12px; font-size: 0.8em; font-weight: bold; cursor: pointer;
        }

        /* è¾“å…¥æ¡† */
        .note-input, .note-textarea {
            width: 100%; padding: 12px; border: 2px solid #e0c9b8; border-radius: 12px;
            font-size: 15px; margin-bottom: 15px; background: #fffaf9; font-family: inherit;
        }
        .note-input:focus, .note-textarea:focus { outline: none; border-color: #ff9a8b; box-shadow: 2px 2px 0px #ffd6cc; }

        /* ========== æ¯æ—¥ä»»åŠ¡ ========== */
        .quest-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; }
        .quest-item {
            background: #fffaf5; border: 2px solid #e0c9b8; border-radius: 15px; padding: 15px;
            display: flex; align-items: center; transition: all 0.2s; cursor: pointer;
        }
        .quest-item:hover { background: #fff0e6; }
        .quest-item.completed { background: #e8f5e9; border-color: #a3de83; opacity: 0.8; }
        .checkbox-custom {
            width: 24px; height: 24px; border: 2px solid #5a4a42; border-radius: 6px; margin-right: 15px;
            display: flex; align-items: center; justify-content: center; background: white;
            flex-shrink: 0;
        }
        .quest-item.completed .checkbox-custom { background: #a3de83; border-color: #2e7d32; }
        .quest-item.completed .checkbox-custom::after { content: 'âœ”'; color: white; font-weight: bold; }

        /* ========== ç§¯åˆ†å•†åº— ========== */
        .shop-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }
        .shop-card {
            background: #fff; border: 2px solid #e0c9b8; border-radius: 15px; padding: 15px; text-align: center;
            display: flex; flex-direction: column; justify-content: space-between; height: 100%;
        }
        .shop-icon { font-size: 2.5em; margin-bottom: 10px; display: block; }
        .shop-price { color: #ff9a8b; font-weight: bold; margin: 10px 0; }
        .btn-buy { background: #5a4a42; color: #fff; border: none; padding: 8px; border-radius: 10px; cursor: pointer; width: 100%; font-weight: bold; }
        .btn-buy:disabled { background: #ccc; cursor: not-allowed; }

        /* ========== èµ„äº§å›¾è¡¨ ========== */
        .chart-container {
            width: 100%; height: 300px; background: #fff; border: 2px solid #e0c9b8; border-radius: 15px; padding: 15px; margin-bottom: 20px;
        }

        /* ========== ç›®æ ‡ & è¿›åº¦ ========== */
        .goal-mode-switch { display: flex; gap: 10px; margin-bottom: 15px; }
        .mode-btn { 
            flex: 1; padding: 8px; text-align: center; border: 2px solid #e0c9b8; border-radius: 10px; cursor: pointer; font-weight: bold; color: #999;
            background: #fff; transition: all 0.2s;
        }
        .mode-btn.active { border-color: #ff9a8b; color: #ff6b6b; background: #fff0eb; }

        .goal-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; }
        .goal-item {
            background: #fffaf5; border: 2px solid #e0c9b8; border-radius: 15px; padding: 20px;
            transition: all 0.3s; display: flex; flex-direction: column; justify-content: space-between;
        }
        .goal-item.completed { background: #e8f5e9; border-color: #a3de83; box-shadow: inset 0 0 10px rgba(163, 222, 131, 0.2); }
        .goal-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; font-weight: bold; font-size: 1.1em; }
        .goal-progress-bg { height: 16px; background: #eee; border-radius: 8px; overflow: hidden; border: 1px solid #ddd; position: relative; margin: 10px 0; }
        .goal-progress-fill { height: 100%; transition: width 0.5s, background-color 0.3s; border-radius: 8px; display: flex; align-items: center; justify-content: flex-end; }
        .goal-input-group { display: flex; align-items: center; gap: 8px; margin-top: 10px; }
        .goal-input-small { flex: 1; padding: 6px; border: 1px solid #d4b8a7; border-radius: 6px; font-size: 0.9em; text-align: center; font-weight: bold; color: #5a4a42; }

        /* è¿›åº¦æ¡é¢œè‰² */
        .p-low { background: linear-gradient(90deg, #ff9a8b, #ff6b6b); }
        .p-mid { background: linear-gradient(90deg, #f6d365, #fda085); }
        .p-high { background: linear-gradient(90deg, #84fab0, #8fd3f4); }
        .p-done { background: linear-gradient(90deg, #4ecdc4, #556270); }

        .level-display { font-size: 4em; font-weight: 800; text-align: center; color: #ff6b6b; text-shadow: 3px 3px 0px #ffd6cc; margin: 10px 0; }
        .xp-progress { height: 24px; background: #ffe8d6; border-radius: 12px; overflow: hidden; border: 2px solid #5a4a42; margin: 10px 0; }
        .xp-fill { height: 100%; background: linear-gradient(90deg, #4ecdc4, #a3de83); transition: width 0.5s ease; }
        
        .skill-item { padding: 15px; background: #fffaf5; border-radius: 15px; margin: 15px 0; border: 2px solid #e0c9b8; display: flex; justify-content: space-between; align-items: center; }
        
        /* ========== ğŸ† æˆå°±ç³»ç»Ÿ (å‡çº§) ========== */
        .achievement-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 20px; }
        .achievement-card { 
            background: #fffefc; border-radius: 15px; padding: 20px; text-align: center; 
            box-shadow: 3px 3px 0px #d4b8a7; border: 2px solid #5a4a42; position: relative;
        }
        .achievement-card.locked { opacity: 0.7; border-style: dashed; }
        .achievement-card.unlocked { border-color: #f6d365; background: #fffff0; }
        .achievement-icon { font-size: 3em; margin-bottom: 10px; display: block; }
        .ach-edit-controls { margin-top: 10px; padding-top: 10px; border-top: 1px dashed #ddd; display: flex; gap: 5px; justify-content: center;}

        /* ========== ğŸ“š è¯»ä¹¦ç¬”è®° (æ–°å¢) ========== */
        .book-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .book-card {
            background: #fff; border-radius: 16px; padding: 20px; 
            box-shadow: 4px 4px 0px #d4b8a7; border: 2px solid #e0c9b8; 
            display: flex; flex-direction: column;
        }
        .star-rating { display: inline-flex; font-size: 1.2em; cursor: pointer; }
        .star { color: #ddd; transition: color 0.2s; margin-right: 2px; }
        .star.active { color: #ffc107; text-shadow: 1px 1px 0 #d39e00; }
        
        /* å¤ç›˜/ç¬”è®° */
        .review-tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #e0c9b8; padding-bottom: 10px; overflow-x: auto; }
        .review-tab { padding: 8px 18px; border: 2px solid #e0c9b8; background: #fffaf5; border-radius: 15px 15px 0 0; cursor: pointer; font-weight: 600; transition: all 0.2s; white-space: nowrap; }
        .review-tab.active { background: #ff9a8b; color: white; border-color: #ff9a8b; transform: translateY(2px); }
        .review-tab.special { background: #a3de83; border-color: #88c967; color: #2d5a27; }
        .stock-tag { display: inline-block; padding: 2px 6px; font-size: 0.8em; border-radius: 4px; color: white; margin-right: 5px; }
        .bg-red { background: #e53935; } .bg-green { background: #43a047; } .bg-gray { background: #555; }
        .note-card { background: #fffaf5; padding: 20px; border-radius: 15px; margin-bottom: 15px; border: 2px solid #e0c9b8; position: relative; }
        .type-switcher { position: absolute; top: 15px; right: 15px; padding: 4px; border-radius: 6px; border: 1px solid #e0c9b8; background: white; font-size: 0.8em; color: #5a4a42; cursor: pointer; }

        /* å‘½ä¾‹ */
        .case-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .case-card { background: #fff; border-radius: 16px; padding: 20px; box-shadow: 4px 4px 0px #d4b8a7; border: 2px solid #e0c9b8; cursor: pointer; transition: all 0.2s; }
        .image-upload-area { border: 2px dashed #e0c9b8; padding: 20px; text-align: center; border-radius: 10px; margin-bottom: 15px; cursor: pointer; background: #fffaf9; }
        
        /* çŸ¥è¯†åº“å¼¹çª— */
        .kb-overlay { position: fixed; inset: 0; background: rgba(90, 74, 66, 0.6); backdrop-filter: blur(3px); z-index: 999; display: flex; justify-content: center; align-items: center; }
        .kb-window { width: 95%; max-width: 1400px; height: 90vh; background: #fef9f3; border-radius: 20px; border: 4px solid #5a4a42; display: flex; overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.3); }
        .kb-sidebar { width: 250px; background: #fffaf0; border-right: 2px solid #e0c9b8; display: flex; flex-direction: column; }
        .kb-main { flex: 1; display: flex; flex-direction: column; background: #fffefc; }
        .kb-nav-item { padding: 12px 20px; cursor: pointer; color: #5a4a42; font-weight: 500; display: flex; justify-content: space-between; }
        .kb-nav-item.active { background: #ffe8d6; border-right: 4px solid #ff9a8b; }
        .kb-content { flex: 1; padding: 40px; overflow-y: auto; }
        .kb-toolbar { padding: 15px 30px; border-bottom: 2px dashed #e0c9b8; display: flex; justify-content: space-between; align-items: center; background: #fffaf5; }

        .login-box { max-width: 400px; margin: 100px auto; text-align: center; }
        .status-message { padding: 10px; border-radius: 10px; margin-top: 15px; font-weight: bold; }
        .status-error { background: #ffe5e5; color: #d32f2f; border: 2px solid #ffcdd2; }
        .status-success { background: #e8f5e9; color: #2e7d32; border: 2px solid #c8e6c9; }

        @media (max-width: 768px) {
            .kb-window { width: 100%; height: 100vh; border-radius: 0; }
            .kb-sidebar { width: 60px; }
            .kb-nav-item span:not(.count) { display: none; }
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- ç™»å½• -->
        <div v-if="!isLoggedIn" class="login-box">
            <div class="card">
                <h1 style="font-size: 3em; margin-bottom: 10px;">â˜¯ï¸</h1>
                <h2 style="justify-content: center;">ä¸ªäººç©ºé—´</h2>
                <p style="margin-bottom: 20px; color: #7a6a62;">è®°å½• </p>
                <input type="email" v-model="email" placeholder="é‚®ç®±" class="note-input">
                <input type="password" v-model="password" placeholder="å¯†ç " class="note-input">
                <button class="btn" @click="login" :disabled="loading">{{ loading ? 'éªŒè¯ä¸­...' : 'è¿›å…¥' }}</button>
                <div v-if="message" :class="['status-message', messageType === 'success' ? 'status-success' : 'status-error']">{{ message }}</div>
            </div>
        </div>
<!-- ä¸»ç•Œé¢ -->
    <div v-else class="container">
        <div class="header">
            <h1>ğŸ‘‹ {{ userEmail.split('@')[0] }} çš„ç©ºé—´</h1>
            <div>
                <button class="btn-sm" @click="syncData" :disabled="syncing">{{ syncing ? 'â˜ï¸ åŒæ­¥ä¸­...' : 'ğŸ”„ åŒæ­¥æ•°æ®' }}</button>
                <button class="btn-sm btn-danger" @click="logout" style="margin-left: 10px;">é€€å‡º</button>
            </div>
            <div v-if="message" :class="['status-message', messageType === 'success' ? 'status-success' : 'status-error']" style="margin-top: 10px;">{{ message }}</div>
        </div>

        <div class="grid">
            <!-- æ¨¡å—1ï¼šçŠ¶æ€ (Level & XP) -->
            <div class="card">
                <h2>ğŸ“Š è§’è‰²çŠ¶æ€ <button class="collapse-btn" @click="collapsed.stats = !collapsed.stats">{{ collapsed.stats ? 'å±•å¼€' : 'æ”¶èµ·' }}</button></h2>
                <div v-show="!collapsed.stats">
                    <div class="level-display">Lv.{{ playerData.level }}</div>
                    <div class="xp-progress"><div class="xp-fill" :style="{width: xpPercentage + '%'}"></div></div>
                    <div style="text-align: center; font-weight: bold; color: #7a6a62;">{{ playerData.xp }} / {{ playerData.nextLevelXp }} XP</div>
                </div>
            </div>

            <!-- æ¯æ—¥ä»»åŠ¡ -->
            <div class="card">
                <h2>âš”ï¸ æ¯æ—¥ä»»åŠ¡ <button class="collapse-btn" @click="collapsed.quests = !collapsed.quests">{{ collapsed.quests ? 'å±•å¼€' : 'æ”¶èµ·' }}</button></h2>
                <div v-show="!collapsed.quests">
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <input v-model="newQuestTitle" placeholder="æ·»åŠ æ¯æ—¥ä»»åŠ¡ (å¦‚: æ—©èµ·/çœ‹ç›˜)..." class="note-input" style="margin-bottom: 0;">
                        <button class="btn-sm" @click="addDailyQuest" style="width: 80px;">â• æ·»åŠ </button>
                    </div>
                    <div class="quest-list">
                        <div v-for="quest in playerData.dailyTasks || []" :key="quest.id" class="quest-item" :class="{completed: quest.completed}" @click="toggleQuest(quest)">
                            <div class="checkbox-custom"></div>
                            <div style="flex: 1;">
                                <div style="font-weight: bold;">{{ quest.title }}</div>
                                <div style="font-size: 0.8em; color: #7a6a62;">å¥–åŠ±: +5 XP</div>
                            </div>
                            <button class="btn-sm btn-danger" @click.stop="deleteDailyQuest(quest.id)" style="width: auto; padding: 5px 10px; margin-left: 10px;">âœ•</button>
                        </div>
                    </div>
                    <div style="text-align: center; font-size: 0.8em; color: #999; margin-top: 15px;">â³ ä»»åŠ¡å°†äºæ¯æ—¥å‡Œæ™¨è‡ªåŠ¨é‡ç½®</div>
                </div>
            </div>

            <!-- ç›®æ ‡ç®¡ç† (OKR) -->
            <div class="card">
                <h2>ğŸ¯ é˜¶æ®µç›®æ ‡ <button class="collapse-btn" @click="collapsed.goals = !collapsed.goals">{{ collapsed.goals ? 'å±•å¼€' : 'æ”¶èµ·' }}</button></h2>
                <div v-show="!collapsed.goals">
                    <!-- æ·»åŠ ç›®æ ‡ -->
                    <div style="background: #fffaf5; padding: 15px; border: 2px dashed #e0c9b8; border-radius: 12px; margin-bottom: 20px;">
                        <div class="goal-mode-switch">
                            <div class="mode-btn" :class="{active: newGoal.mode === 'numeric'}" @click="newGoal.mode = 'numeric'">ğŸ”¢ æ•°å€¼è¿›åº¦</div>
                            <div class="mode-btn" :class="{active: newGoal.mode === 'text'}" @click="newGoal.mode = 'text'">ğŸš© å…³é”®æˆæœ</div>
                        </div>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <input v-model="newGoal.title" placeholder="ç›®æ ‡å†…å®¹..." class="note-input" style="flex: 2; margin: 0;">
                            <template v-if="newGoal.mode === 'numeric'">
                                <input v-model.number="newGoal.target" type="number" placeholder="ç›®æ ‡æ•°" class="note-input" style="flex: 1; margin: 0;">
                                <input v-model="newGoal.unit" placeholder="å•ä½" class="note-input" style="flex: 1; margin: 0;">
                            </template>
                            <button class="btn-sm" @click="addGoal" style="height: 42px; width: 80px;">æ·»åŠ </button>
                        </div>
                    </div>
                    <!-- ç›®æ ‡åˆ—è¡¨ -->
                    <div class="goal-list">
                        <div v-for="(goal, index) in playerData.goals || []" :key="index" class="goal-item" :class="{completed: calculateProgress(goal) >= 100}">
                            <div class="goal-header">
                                <span :style="{textDecoration: calculateProgress(goal) >= 100 ? 'line-through' : 'none'}">{{ goal.title }}</span>
                                <span :style="{color: getProgressColor(calculateProgress(goal))}">{{ calculateProgress(goal) }}%</span>
                            </div>
                            <div v-if="goal.mode === 'numeric' || !goal.mode" class="goal-meta">
                                <span>ğŸ¯ ç›®æ ‡: {{ goal.target }} {{ goal.unit }}</span>
                            </div>
                            <div v-else class="goal-desc">å…³é”®æˆæœï¼š{{ goal.targetText || 'å®Œæˆä»»åŠ¡' }}</div>
                            <div class="goal-progress-bg">
                                <div class="goal-progress-fill" :class="getProgressClass(calculateProgress(goal))" :style="{width: Math.min(100, calculateProgress(goal)) + '%'}"></div>
                            </div>
                            <div class="goal-input-group">
                                <label style="font-size: 0.8em; color: #999;">è¿›åº¦:</label>
                                <template v-if="goal.mode === 'numeric' || !goal.mode">
                                    <input type="number" v-model.number="goal.current" class="goal-input-small" @change="saveAll">
                                    <span style="font-size: 0.8em;">{{ goal.unit }}</span>
                                </template>
                                <template v-else>
                                    <input type="range" v-model.number="goal.current" min="0" max="100" style="flex: 1;" @change="saveAll">
                                </template>
                                <button class="btn-sm btn-danger" @click="deleteGoal(index)" style="margin-left: auto;">âœ•</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ç§¯åˆ†å•†åº— -->
            <div class="card">
                <h2>ğŸ¦ ç§¯åˆ†å•†åº— <button class="collapse-btn" @click="collapsed.shop = !collapsed.shop">{{ collapsed.shop ? 'å±•å¼€' : 'æ”¶èµ·' }}</button></h2>
                <div v-show="!collapsed.shop">
                    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                        <input v-model="newShopItem.name" placeholder="å•†å“å..." class="note-input" style="margin-bottom: 0;">
                        <input v-model.number="newShopItem.cost" type="number" placeholder="XP" class="note-input" style="width: 100px; margin-bottom: 0;">
                        <input v-model="newShopItem.icon" placeholder="å›¾æ ‡" class="note-input" style="width: 80px; margin-bottom: 0;">
                        <button class="btn-sm" @click="addShopItem">ä¸Šæ¶</button>
                    </div>
                    <div class="shop-grid">
                        <div v-for="item in playerData.shopItems || []" :key="item.id" class="shop-card">
                            <div>
                                <span class="shop-icon">{{ item.icon }}</span>
                                <h3>{{ item.name }}</h3>
                                <div class="shop-price">{{ item.cost }} XP</div>
                            </div>
                            <div style="display: flex; gap: 5px;">
                                <button class="btn-buy" :disabled="playerData.xp < item.cost" @click="buyItem(item)">
                                    {{ playerData.xp < item.cost ? 'XPä¸è¶³' : 'ğŸ’° å…‘æ¢' }}
                                </button>
                                <button class="btn-sm btn-danger" style="width: 30px; padding: 0;" @click="deleteShopItem(item.id)">âœ•</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å¤ç›˜ & èµ„äº§ -->
            <div class="card">
                <h2>ğŸ”„ å¤ç›˜ & èµ„äº§ <button class="collapse-btn" @click="collapsed.reviews = !collapsed.reviews">{{ collapsed.reviews ? 'å±•å¼€' : 'æ”¶èµ·' }}</button></h2>
                <div v-show="!collapsed.reviews">
                    <div class="review-tabs">
                        <div class="review-tab" :class="{active: activeReviewTab === 'stock'}" @click="activeReviewTab = 'stock'; loadChart()">ğŸ“ˆ è‚¡ç¥¨/èµ„äº§</div>
                        <div class="review-tab" :class="{active: activeReviewTab === 'daily'}" @click="activeReviewTab = 'daily'">ğŸ“ æ—¥å¸¸</div>
                        <div class="review-tab" :class="{active: activeReviewTab === 'weekly'}" @click="activeReviewTab = 'weekly'">ğŸ“… å‘¨å¤ç›˜</div>
                        <div class="review-tab special" @click="showReviewForm = !showReviewForm">{{ showReviewForm ? 'âœ–ï¸ å–æ¶ˆ' : 'â• æ–°å»º' }}</div>
                    </div>

                    <div v-show="activeReviewTab === 'stock'" class="chart-container">
                        <canvas id="assetChart"></canvas>
                    </div>

                    <div v-if="showReviewForm" style="background: #fffaf5; padding: 20px; border: 2px dashed #ff9a8b; border-radius: 15px; margin-bottom: 20px;">
                        <div v-if="activeReviewTab === 'stock'">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                                <input v-model="newStockData.code" placeholder="ä»£ç /åç§°" class="note-input" style="margin: 0;">
                                <select v-model="newStockData.action" class="note-input" style="margin: 0;">
                                    <option value="buy">ğŸ”µ ä¹°å…¥</option>
                                    <option value="sell">ğŸ”´ å–å‡º</option>
                                    <option value="hold">âšª æŒä»“/è®°å½•</option>
                                </select>
                                <input v-model="newStockData.price" placeholder="äº¤æ˜“ä»·æ ¼" class="note-input" style="margin: 0;">
                                <input v-model="newStockData.profit" placeholder="ç›ˆäºé¢" class="note-input" style="margin: 0;">
                            </div>
                            <div style="background: #e8f5e9; padding: 10px; border-radius: 10px; margin-bottom: 10px;">
                                <label style="font-weight: bold; color: #2e7d32;">ğŸ’µ å½“å‰æ€»èµ„äº§:</label>
                                <input v-model.number="newStockData.totalAsset" type="number" placeholder="è¾“å…¥å½“å‰æ€»å‡€å€¼..." class="note-input" style="margin-top: 5px;">
                            </div>
                        </div>

                        <input v-if="activeReviewTab !== 'stock'" v-model="newNote.title" placeholder="æ ‡é¢˜..." class="note-input">
                        <textarea v-model="newNote.content" :placeholder="activeReviewTab === 'stock' ? 'é€»è¾‘åˆ†æ...' : 'å†…å®¹...'" class="note-textarea" style="height: 150px;"></textarea>
                        <button class="btn" @click="saveNote">ğŸ’¾ ä¿å­˜è®°å½•</button>
                    </div>

                    <div v-for="note in filteredNotes" :key="note.id" class="note-card">
                        <select v-model="note.type" @change="saveAll()" class="type-switcher">
                            <option value="daily">ğŸ“ æ—¥å¸¸</option>
                            <option value="stock">ğŸ“ˆ è‚¡ç¥¨</option>
                            <option value="weekly">ğŸ“… å‘¨æŠ¥</option>
                        </select>

                        <div style="font-size: 0.85em; color: #999; margin-bottom: 5px;">{{ formatDate(note.createdAt) }}</div>
                        
                        <div v-if="note.type === 'stock'" style="margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px dashed #e0c9b8;">
                            <span class="stock-tag" :class="note.stockData?.action === 'buy' ? 'bg-red' : (note.stockData?.action === 'sell' ? 'bg-green' : 'bg-gray')">
                                {{ note.stockData?.action === 'buy' ? 'ä¹°å…¥' : (note.stockData?.action === 'sell' ? 'å–å‡º' : 'æŒä»“') }}
                            </span>
                            <strong>{{ note.stockData?.code }}</strong>
                            <span v-if="note.stockData?.price" style="margin-left: 10px;">@ {{ note.stockData?.price }}</span>
                            <span v-if="note.stockData?.profit" style="float: right; font-weight: bold;" :style="{color: parseFloat(note.stockData.profit) > 0 ? '#e53935' : '#43a047'}">
                                {{ parseFloat(note.stockData.profit) > 0 ? '+' : '' }}{{ note.stockData.profit }}
                            </span>
                            <div v-if="note.stockData?.totalAsset" style="margin-top: 5px; color: #2e7d32; font-size: 0.9em; font-weight: bold;">
                                ğŸ’° å½“æ—¶å‡€å€¼: {{ note.stockData.totalAsset }}
                            </div>
                        </div>

                        <h3 v-if="note.title">{{ note.title }}</h3>
                        <p style="white-space: pre-wrap; line-height: 1.6; color: #5a4a42;">{{ note.content }}</p>
                        <button class="btn-sm btn-danger" @click="deleteNote(note.id)" style="margin-top: 10px; float: right;">åˆ é™¤</button>
                        <div style="clear: both;"></div>
                    </div>
                </div>
            </div>

            <!-- æŠ€èƒ½ä¿®ç‚¼ -->
            <div class="card">
                <h2>âš¡ æŠ€èƒ½ä¿®ç‚¼ <button class="collapse-btn" @click="collapsed.skills = !collapsed.skills">{{ collapsed.skills ? 'å±•å¼€' : 'æ”¶èµ·' }}</button></h2>
                <div v-show="!collapsed.skills">
                    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                        <input v-model="newSkillName" placeholder="æ–°æŠ€èƒ½åç§°..." class="note-input" style="margin-bottom: 0;">
                        <button class="btn" @click="addNewSkillInline" style="width: 120px;">âœ¨ ä¹ å¾—</button>
                    </div>
                    <div v-for="skill in skills" :key="skill.id" class="skill-item">
                        <div style="flex: 1; padding-right: 20px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <strong style="font-size: 1.1em;">{{ skill.icon }} {{ skill.name }}</strong>
                                <span style="color: #999;">Lv.{{ skill.level }}</span>
                            </div>
                            <div class="xp-progress" style="height: 8px; margin: 0;"><div class="xp-fill" :style="{width: (skill.xp / skill.maxXp * 100) + '%'}"></div></div>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn-sm" @click="practiceSkill(skill.id)">ğŸ”¥ ç»ƒä¹ </button>
                            <button class="btn-sm btn-danger" @click="deleteSkill(skill.id)">âœ•</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ğŸ†• å•ç‹¬æ¿å—ï¼šæˆå°±ç³»ç»Ÿ (å‡çº§ç‰ˆ) -->
            <div class="card">
                <h2>ğŸ… è£è€€æˆå°± <button class="collapse-btn" @click="collapsed.achievements = !collapsed.achievements">{{ collapsed.achievements ? 'å±•å¼€' : 'æ”¶èµ·' }}</button></h2>
                <div v-show="!collapsed.achievements">
                    <!-- æ·»åŠ æˆå°± -->
                    <div style="background: #fffaf5; padding: 15px; border-radius: 15px; border: 2px dashed #e0c9b8; margin-bottom: 20px;">
                        <h4 style="margin-bottom: 10px;">æ·»åŠ æ–°æˆå°±</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                            <input v-model="newAchievement.name" placeholder="æˆå°±å" class="note-input">
                            <input v-model="newAchievement.description" placeholder="æè¿°" class="note-input">
                            <input v-model="newAchievement.icon" placeholder="å›¾æ ‡ (ğŸ†)" class="note-input">
                            <input v-model.number="newAchievement.requirement" type="number" placeholder="ç›®æ ‡å€¼ (å¦‚100)" class="note-input">
                        </div>
                        <button class="btn-sm" @click="addAchievement" style="width: 100%; margin-top: 10px;">â• åˆ›å»ºæˆå°±</button>
                    </div>

                    <!-- æˆå°±åˆ—è¡¨ -->
                    <div class="achievement-grid">
                        <div v-for="ach in achievements" :key="ach.id" class="achievement-card" :class="{locked: ach.current < ach.requirement, unlocked: ach.current >= ach.requirement}">
                            <span class="achievement-icon">{{ ach.icon }}</span>
                            <h3>{{ ach.name }}</h3>
                            <p style="font-size: 0.9em; color: #666; height: 40px;">{{ ach.description }}</p>
                            <div style="font-weight: bold; margin: 10px 0;" :style="{color: ach.current >= ach.requirement ? '#ffa502' : '#999'}">
                                {{ ach.current }} / {{ ach.requirement }}
                            </div>
                            
                            <!-- ä¿®æ”¹è¿›åº¦ä¸åˆ é™¤ -->
                            <div class="ach-edit-controls">
                                <input type="number" v-model.number="ach.current" style="width: 60px; border: 1px solid #ccc; border-radius: 5px; padding: 2px;" @change="saveAll()">
                                <button class="btn-sm btn-danger" style="padding: 2px 8px; font-size: 0.8em;" @click="deleteAchievement(ach.id)">ğŸ—‘ï¸</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ğŸ†• å•ç‹¬æ¿å—ï¼šè¯»ä¹¦ç¬”è®° (Books) -->
            <div class="card">
                <h2>ğŸ“š è¯»ä¹¦ç¬”è®° <button class="collapse-btn" @click="collapsed.books = !collapsed.books">{{ collapsed.books ? 'å±•å¼€' : 'æ”¶èµ·' }}</button></h2>
                <div v-show="!collapsed.books">
                    <button class="btn" style="margin-bottom: 20px;" @click="showBookForm = !showBookForm">{{ showBookForm ? 'æ”¶èµ·' : 'ğŸ“– è®°å½•æ–°ä¹¦' }}</button>
                    
                    <div v-if="showBookForm" style="background: #fffaf5; padding: 20px; border: 2px dashed #5a4a42; border-radius: 15px; margin-bottom: 20px;">
                        <div style="display: flex; gap: 10px;">
                            <input v-model="newBook.title" placeholder="ä¹¦å" class="note-input">
                            <input v-model="newBook.author" placeholder="ä½œè€…" class="note-input">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="font-weight: bold; margin-right: 10px;">æ¨èæŒ‡æ•°:</label>
                            <div class="star-rating">
                                <span v-for="n in 5" :key="n" class="star" :class="{active: n <= newBook.rating}" @click="newBook.rating = n">â˜…</span>
                            </div>
                        </div>
                        <textarea v-model="newBook.content" placeholder="æ ¸å¿ƒç¬”è®°..." class="note-textarea" style="height: 100px;"></textarea>
                        <textarea v-model="newBook.thoughts" placeholder="æ„Ÿæ‚Ÿä¸è‡´è°¢ (Gratitude)..." class="note-textarea" style="height: 80px; background: #f0fdf4; border-color: #a3de83;"></textarea>
                        <button class="btn" @click="saveBook">ğŸ’¾ ä¿å­˜ç¬”è®°</button>
                    </div>

                    <div class="book-list">
                        <div v-for="book in books" :key="book.id" class="book-card">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                <h3 style="margin-bottom: 5px;">{{ book.title }}</h3>
                                <div class="star-rating" style="cursor: default;">
                                    <span v-for="n in 5" :key="n" class="star" :class="{active: n <= book.rating}">â˜…</span>
                                </div>
                            </div>
                            <div style="color: #888; font-size: 0.9em; margin-bottom: 15px;">ğŸ‘¤ {{ book.author }}</div>
                            <div style="background: #fffaf5; padding: 10px; border-radius: 8px; margin-bottom: 10px;">
                                <strong>ğŸ“ ç¬”è®°:</strong>
                                <p style="white-space: pre-wrap; font-size: 0.95em;">{{ book.content }}</p>
                            </div>
                            <div v-if="book.thoughts" style="background: #f0fdf4; padding: 10px; border-radius: 8px; border: 1px dashed #a3de83;">
                                <strong style="color: #2e7d32;">ğŸ™ æ„Ÿæ‚Ÿ:</strong>
                                <p style="white-space: pre-wrap; font-size: 0.95em; color: #1b5e20;">{{ book.thoughts }}</p>
                            </div>
                            <button class="btn-sm btn-danger" @click="deleteBook(book.id)" style="align-self: flex-end; margin-top: 15px;">åˆ é™¤</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- çŸ¥è¯†åº“å…¥å£ -->
            <div class="card">
                <h2>ğŸ“‚ çŸ¥è¯†åº“</h2>
                <p style="margin-bottom: 15px; color: #666;">æ•´ç†ä½ çš„çŸ¥è¯†ä½“ç³»ã€‚</p>
                <button class="btn" @click="showKnowledgeBase = true">æ‰“å¼€çŸ¥è¯†åº“</button>
            </div>

            <!-- æ˜“å­¦å‘½ä¾‹ -->
            <div class="card">
                <h2>â˜¯ï¸ æ˜“å­¦å‘½ä¾‹ <button class="collapse-btn" @click="collapsed.cases = !collapsed.cases">{{ collapsed.cases ? 'å±•å¼€' : 'æ”¶èµ·' }}</button></h2>
                <div v-show="!collapsed.cases">
                    <button class="btn" style="margin-bottom: 20px;" @click="showCaseForm = !showCaseForm">{{ showCaseForm ? 'æ”¶èµ·' : 'âœ¨ è®°å½•æ–°å‘½ä¾‹' }}</button>
                    <div v-if="showCaseForm" style="background: #fffaf5; padding: 20px; border: 2px dashed #5a4a42; border-radius: 15px; margin-bottom: 20px;">
                        <input v-model="newCase.title" placeholder="å‘½ä¸»ç§°å‘¼ / å…«å­—æ¦‚è¦" class="note-input">
                        <div class="image-upload-area" @click="$refs.fileInput.click()">
                            <input type="file" ref="fileInput" @change="handleImageUpload" style="display: none;" accept="image/*">
                            <div v-if="newCase.image"><img :src="newCase.image" style="max-height: 200px; max-width: 100%;"></div>
                            <div v-else>ğŸ“· ç‚¹å‡»ä¸Šä¼ æ’ç›˜å›¾ç‰‡</div>
                        </div>
                        <textarea v-model="newCase.content" placeholder="æ–­è¯­ä¸å¤ç›˜..." class="note-textarea" style="height: 100px;"></textarea>
                        <button class="btn" @click="saveCase">ğŸ’¾ ä¿å­˜</button>
                    </div>
                    <div class="case-grid">
                        <div v-for="c in cases" :key="c.id" class="case-card" @click="viewingItem = { ...c, type: 'case' }">
                            <img v-if="c.image" :src="c.image" style="width: 100%; height: 120px; object-fit: cover; border-radius: 10px;">
                            <h3>{{ c.title }}</h3>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- çŸ¥è¯†åº“å¼¹çª— (å·²ä¿®å¤) -->
    <div v-if="showKnowledgeBase" class="kb-overlay" @click.self="showKnowledgeBase = false">
        <div class="kb-window">
            <div class="kb-sidebar">
                <div style="padding: 20px; font-weight: bold; border-bottom: 2px dashed #e0c9b8;">ğŸ“š çŸ¥è¯†åº“ <span @click="addKbCategory" style="float:right; cursor:pointer;">+</span></div>
                <div style="flex: 1; overflow-y: auto;">
                    <div class="kb-nav-item" :class="{active: kbCurrentCategory === 'all'}" @click="kbCurrentCategory = 'all'">ğŸ“‚ å…¨éƒ¨</div>
                    <div v-for="cat in kbCategories" :key="cat.id" class="kb-nav-item" :class="{active: kbCurrentCategory && kbCurrentCategory.id === cat.id}" @click="kbCurrentCategory = cat">ğŸ“ {{ cat.name }}</div>
                </div>
            </div>
            <div class="kb-main">
                <div class="kb-toolbar">
                    <span>{{ kbCurrentCategory === 'all' ? 'å…¨éƒ¨' : kbCurrentCategory.name }}</span>
                    <button class="btn-sm" @click="openKbEditor()">+ æ–°å»ºæ–‡æ¡£</button>
                </div>
                <div class="kb-content">
                    <div v-if="kbEditorMode">
                        <input v-model="kbEditorData.title" placeholder="æ ‡é¢˜" class="note-input">
                        <textarea v-model="kbEditorData.content" class="note-textarea" style="height: 400px;"></textarea>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn" @click="saveKbDoc">ä¿å­˜</button>
                            <!-- æ–°å¢ï¼šåˆ é™¤æŒ‰é’® -->
                            <button v-if="kbEditorData.id" class="btn btn-danger" @click="deleteKbDoc(kbEditorData.id)">ğŸ—‘ï¸ åˆ é™¤</button>
                            <button class="btn" style="background: #ccc;" @click="kbEditorMode = false">å–æ¶ˆ</button>
                        </div>
                    </div>
                    <!-- ä¿®å¤åˆ—è¡¨æ˜¾ç¤ºé€»è¾‘ -->
                    <div v-else>
                        <div v-for="doc in filteredKbDocs" :key="doc.id" style="padding: 15px; border-bottom: 1px dashed #e0c9b8; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='#fffaf5'" onmouseout="this.style.background='transparent'" @click="editKbDoc(doc)">
                            <div style="font-weight: bold; font-size: 1.1em;">ğŸ“„ {{ doc.title || 'æ— æ ‡é¢˜æ–‡æ¡£' }}</div>
                            <div style="font-size: 0.8em; color: #999;">{{ formatDate(doc.updatedAt) }}</div>
                        </div>
                        <div v-if="filteredKbDocs.length === 0" style="text-align: center; color: #999; margin-top: 50px;">è¿™é‡Œè¿˜æ²¡æœ‰å†…å®¹</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- è¯¦æƒ…å¼¹çª— -->
    <div v-if="viewingItem" class="kb-overlay" @click.self="viewingItem = null">
        <div class="card" style="width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto;">
            <h2>{{ viewingItem.title }}</h2>
            <img v-if="viewingItem.image" :src="viewingItem.image" style="width: 100%; margin: 10px 0; border-radius: 10px;">
            <p style="white-space: pre-wrap;">{{ viewingItem.content }}</p>
            <button class="btn-sm btn-danger" @click="deleteItem(viewingItem)" style="margin-top: 20px;">åˆ é™¤</button>
        </div>
    </div>
</div>

<script>
    const SUPABASE_URL = 'https://zqmgigcnruvvdcholbuj.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpxbWdpZ2NucnV2dmRjaG9sYnVqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4NjgzNjEsImV4cCI6MjA4MTQ0NDM2MX0.IHzDp7o5M9QM8IBWy2ri5gS9h9nm0zk3AaPTNveDqXI';
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    const { createApp } = Vue;

    createApp({
        data() {
            return {
                isLoggedIn: false, userId: null, userEmail: '', email: '', password: '',
                loading: false, syncing: false, message: '', messageType: '',
                
                collapsed: { goals: false, stats: false, skills: false, achievements: false, reviews: false, books: false, cases: true, quests: false, shop: false },
                
                playerData: { 
                    level: 1, xp: 0, nextLevelXp: 100, 
                    goals: [], dailyTasks: [], lastLoginDate: '', shopItems: [], assetHistory: []
                },
                
                // æ–°å¢è¾“å…¥æ¨¡å‹
                newGoal: { title: '', target: null, current: 0, unit: '', mode: 'numeric' },
                newQuestTitle: '', 
                newShopItem: { name: '', cost: 50, icon: 'ğŸ¥¤' },
                newAchievement: { name: '', description: '', icon: 'ğŸ†', requirement: 100, current: 0 }, // ğŸ†•
                newBook: { title: '', author: '', rating: 5, content: '', thoughts: '' }, // ğŸ†•

                skills: [], achievements: [], notes: [], cases: [], books: [],
                kbCategories: [], kbDocs: [],
                
                activeReviewTab: 'stock', showReviewForm: false,
                newNote: { title: '', content: '' },
                newStockData: { code: '', action: 'buy', price: '', profit: '', totalAsset: null },
                newSkillName: '',
                
                // å¼¹çª—ç›¸å…³
                showKnowledgeBase: false, kbCurrentCategory: 'all', kbEditorMode: false, kbEditorData: {},
                showCaseForm: false, showBookForm: false, newCase: { title: '', content: '', image: null }, viewingItem: null,
                
                chartInstance: null
            };
        },
        computed: {
            xpPercentage() { return Math.min(100, (this.playerData.xp / this.playerData.nextLevelXp) * 100); },
            filteredNotes() {
                let res = this.notes.filter(n => {
                    if (!n.type && this.activeReviewTab === 'daily') return true; 
                    if (n.type === this.activeReviewTab) return true;
                    return false;
                });
                return res.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));
            },
            // ä¿®å¤çŸ¥è¯†åº“ç­›é€‰é€»è¾‘
            filteredKbDocs() {
                if (this.kbCurrentCategory === 'all') return this.kbDocs;
                return this.kbDocs.filter(d => d.categoryId === this.kbCurrentCategory.id);
            }
        },
        methods: {
            showMessage(txt, type='success') { this.message = txt; this.messageType = type; setTimeout(()=>this.message='', 4000); },
            formatDate(str) { if(!str) return ''; return new Date(str).toLocaleString('zh-CN'); },
            
            calculateProgress(goal) { return goal.mode === 'text' ? (goal.current || 0) : (!goal.target ? 0 : Math.round((goal.current / goal.target) * 100)); },
            getProgressColor(p) { return p < 30 ? '#ff6b6b' : (p < 80 ? '#ffcc00' : '#2e7d32'); },
            getProgressClass(p) { return p >= 100 ? 'p-done' : (p < 30 ? 'p-low' : (p < 80 ? 'p-mid' : 'p-high')); },

            async login() {
                if (!this.email || !this.password) return;
                this.loading = true;
                const { data, error } = await sb.auth.signInWithPassword({ email: this.email, password: this.password });
                this.loading = false;
                if (error) return this.showMessage(error.message, 'error');
                this.isLoggedIn = true; this.userId = data.user.id; this.userEmail = data.user.email;
                this.loadData();
            },
            async logout() { await sb.auth.signOut(); this.isLoggedIn = false; },

            async loadData() {
                this.syncing = true;
                const [p, s, a, n, b, kc, kd, cs] = await Promise.all([
                    sb.from('players').select('*').eq('user_id', this.userId).single(),
                    sb.from('skills').select('*').eq('user_id', this.userId),
                    sb.from('achievements').select('*').eq('user_id', this.userId),
                    sb.from('notes').select('*').eq('user_id', this.userId),
                    sb.from('books').select('*').eq('user_id', this.userId),
                    sb.from('kb_categories').select('*').eq('user_id', this.userId),
                    sb.from('kb_notes').select('*').eq('user_id', this.userId),
                    sb.from('cases').select('*').eq('user_id', this.userId)
                ]);
                
                if(p.data && p.data.data) {
                    this.playerData = { ...this.playerData, ...p.data.data };
                    // è¡¥å…¨å­—æ®µ
                    if(!this.playerData.dailyTasks) this.playerData.dailyTasks = [];
                    if(!this.playerData.shopItems) this.playerData.shopItems = [
                        {id: 1, name: 'å–å¥¶èŒ¶', cost: 50, icon: 'ğŸ¥¤'},
                        {id: 2, name: 'èµ–åºŠåˆ¸', cost: 200, icon: 'ğŸ›Œ'}
                    ];
                    if(!this.playerData.assetHistory) this.playerData.assetHistory = [];
                    this.checkDailyReset();
                }

                if(s.data) this.skills = s.data.map(i => i.data);
                if(a.data) this.achievements = a.data.map(i => i.data);
                if(n.data) this.notes = n.data.map(i => i.data);
                if(b.data) this.books = b.data.map(i => i.data); // è½½å…¥ä¹¦ç±
                if(kc.data) this.kbCategories = kc.data.map(i => i.data);
                if(kd.data) this.kbDocs = kd.data.map(i => i.data);
                if(cs.data) this.cases = cs.data.map(i => i.data);
                
                this.syncing = false;
                setTimeout(() => this.loadChart(), 500);
            },

            async saveAll() {
                if (!this.userId) return;
                await sb.from('players').upsert({ user_id: this.userId, data: this.playerData }, { onConflict: 'user_id' });
                
                const saveTbl = async (t, d) => { await sb.from(t).delete().eq('user_id', this.userId); if(d.length) await sb.from(t).insert(d.map(x=>({user_id:this.userId, data:x}))); };
                
                await Promise.all([
                    saveTbl('skills', this.skills),
                    saveTbl('achievements', this.achievements),
                    saveTbl('notes', this.notes),
                    saveTbl('cases', this.cases),
                    saveTbl('books', this.books),
                    saveTbl('kb_notes', this.kbDocs),
                    saveTbl('kb_categories', this.kbCategories)
                ]);
            },
            async syncData() { this.syncing = true; await this.saveAll(); this.syncing = false; this.showMessage('åŒæ­¥å®Œæˆ'); },

            checkDailyReset() {
                const today = new Date().toDateString();
                if (this.playerData.lastLoginDate !== today) {
                    this.playerData.dailyTasks.forEach(t => t.completed = false);
                    this.playerData.lastLoginDate = today;
                    this.saveAll();
                    this.showMessage('â˜€ï¸ æ–°çš„ä¸€å¤©ï¼Œæ¯æ—¥ä»»åŠ¡å·²åˆ·æ–°ï¼');
                }
            },
            addDailyQuest() {
                if (!this.newQuestTitle) return;
                this.playerData.dailyTasks.push({ id: Date.now(), title: this.newQuestTitle, completed: false });
                this.newQuestTitle = '';
                this.saveAll();
            },
            toggleQuest(quest) {
                if (quest.completed) return; 
                quest.completed = true;
                this.addXp(5);
                if (this.playerData.dailyTasks.every(t => t.completed)) {
                    this.showMessage('ğŸ”¥ å…¨å‹¤è¾¾æˆï¼å¥–åŠ± 20 XP');
                    this.addXp(20);
                }
                this.saveAll();
            },
            deleteDailyQuest(id) {
                if (confirm('ç¡®å®šåˆ é™¤?')) {
                    this.playerData.dailyTasks = this.playerData.dailyTasks.filter(t => t.id !== id);
                    this.saveAll();
                }
            },

            addShopItem() {
                this.playerData.shopItems.push({ id: Date.now(), ...this.newShopItem });
                this.newShopItem = { name: '', cost: 50, icon: 'âœ¨' };
                this.saveAll();
            },
            deleteShopItem(id) { this.playerData.shopItems = this.playerData.shopItems.filter(i => i.id !== id); this.saveAll(); },
            buyItem(item) {
                if (this.playerData.xp >= item.cost) {
                    if(!confirm(`ç¡®è®¤æ¶ˆè€— ${item.cost} XP?`)) return;
                    this.playerData.xp -= item.cost;
                    this.notes.unshift({ id: Date.now(), type: 'daily', createdAt: new Date().toISOString(), title: 'ğŸ å•†åº—å…‘æ¢', content: `å…‘æ¢: ${item.name}` });
                    this.showMessage(`å…‘æ¢æˆåŠŸ: ${item.name}`);
                    this.saveAll();
                }
            },

            loadChart() {
                if (this.activeReviewTab !== 'stock') return;
                const ctx = document.getElementById('assetChart');
                if (!ctx) return;
                if (this.chartInstance) this.chartInstance.destroy();
                const history = (this.playerData.assetHistory || []).sort((a,b) => new Date(a.date) - new Date(b.date));
                this.chartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: history.map(h => new Date(h.date).toLocaleDateString()),
                        datasets: [{
                            label: 'æ€»èµ„äº§å‡€å€¼', data: history.map(h => h.value),
                            borderColor: '#4ecdc4', backgroundColor: 'rgba(78, 205, 196, 0.1)', tension: 0.3, fill: true
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
                });
            },

            addGoal() { if(!this.newGoal.title)return; this.playerData.goals.push({title:this.newGoal.title, mode:this.newGoal.mode, current:0, unit:this.newGoal.unit||'', target:this.newGoal.target||100, targetText: 'å®Œæˆ'}); this.newGoal={title:'',target:null,current:0,unit:'',mode:'numeric'}; this.saveAll(); },
            deleteGoal(i) { if(confirm('åˆ é™¤?')) { this.playerData.goals.splice(i,1); this.saveAll(); } },
            addXp(v) { this.playerData.xp+=v; if(this.playerData.xp>=this.playerData.nextLevelXp){ this.playerData.xp-=this.playerData.nextLevelXp; this.playerData.level++; this.showMessage('å‡çº§äº†! Lv.'+this.playerData.level); } },
            
            saveNote() {
                if(this.activeReviewTab === 'stock') {
                    if(!this.newStockData.code && !this.newStockData.totalAsset) return;
                    if (this.newStockData.totalAsset) {
                        this.playerData.assetHistory.push({ date: new Date().toISOString(), value: this.newStockData.totalAsset });
                        setTimeout(() => this.loadChart(), 100);
                    }
                    this.notes.unshift({ id: Date.now(), type: 'stock', createdAt: new Date().toISOString(), content: `é€»è¾‘: ${this.newStockData.action} - ${this.newNote.content}`, stockData: {...this.newStockData} });
                    this.newStockData = { code:'', action:'buy', price:'', profit:'', totalAsset: null };
                } else {
                    if(!this.newNote.title) return;
                    this.notes.unshift({ id: Date.now(), type: this.activeReviewTab, createdAt: new Date().toISOString(), ...this.newNote });
                    this.newNote = { title:'', content:'' };
                }
                this.showReviewForm = false; this.addXp(10); this.saveAll();
            },
            deleteNote(id) { if(confirm('åˆ é™¤?')) { this.notes=this.notes.filter(n=>n.id!==id); this.saveAll(); } },
            
            addNewSkillInline() { if(this.newSkillName){this.skills.push({id:Date.now(),name:this.newSkillName,icon:'âœ¨',level:1,xp:0,maxXp:50}); this.newSkillName=''; this.addXp(10); this.saveAll();} },
            practiceSkill(id) { const s=this.skills.find(x=>x.id===id); if(s){ s.xp+=10; if(s.xp>=s.maxXp){s.xp=0;s.level++;s.maxXp=Math.floor(s.maxXp*1.5);} this.addXp(5); this.saveAll(); } },
            deleteSkill(id) { if(confirm('åˆ é™¤?')) { this.skills=this.skills.filter(x=>x.id!==id); this.saveAll(); } },
            
            handleImageUpload(e) { const file = e.target.files[0]; if(!file)return; const reader = new FileReader(); reader.onload = (evt) => { const img = new Image(); img.src = evt.target.result; img.onload = () => { const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d'); const maxW = 800; let w=img.width, h=img.height; if(w>maxW){ h=Math.round(h*(maxW/w)); w=maxW; } canvas.width=w; canvas.height=h; ctx.drawImage(img,0,0,w,h); this.newCase.image=canvas.toDataURL('image/jpeg',0.7); } }; reader.readAsDataURL(file); },
            saveCase() { if(!this.newCase.title)return; this.cases.unshift({id:Date.now(), type:'case', createdAt:new Date().toISOString(), ...this.newCase}); this.newCase={title:'',content:'',image:null}; this.showCaseForm=false; this.addXp(30); this.saveAll(); },
            
            // ========== çŸ¥è¯†åº“ä¿®å¤é€»è¾‘ ==========
            openKbEditor() { this.kbEditorMode=true; this.kbEditorData={id:null,title:'',content:'',categoryId: this.kbCurrentCategory === 'all' ? null : this.kbCurrentCategory.id}; },
            editKbDoc(d) { this.kbEditorData={...d}; this.kbEditorMode=true; },
            saveKbDoc() { 
                const now=new Date().toISOString(); 
                if(this.kbEditorData.id){
                    // ç¼–è¾‘æ¨¡å¼ï¼šæ‰¾åˆ°å¹¶æ›´æ–°
                    const i=this.kbDocs.findIndex(d=>d.id===this.kbEditorData.id);
                    if(i !== -1) {
                        this.kbDocs[i] = {...this.kbDocs[i], ...this.kbEditorData, updatedAt:now};
                    }
                } else {
                    // æ–°å¢æ¨¡å¼
                    this.kbDocs.unshift({
                        id: Date.now(), 
                        title: this.kbEditorData.title || 'æ— æ ‡é¢˜',
                        content: this.kbEditorData.content,
                        categoryId: this.kbEditorData.categoryId,
                        createdAt: now, updatedAt: now
                    });
                }
                this.kbEditorMode=false; 
                this.saveAll(); 
            },
            deleteKbDoc(id) {
                if(confirm('ç¡®å®šåˆ é™¤æ­¤æ–‡æ¡£å—ï¼Ÿ')) {
                    this.kbDocs = this.kbDocs.filter(d => d.id !== id);
                    this.kbEditorMode = false;
                    this.saveAll();
                }
            },
            addKbCategory() { const n=prompt('åˆ†ç±»å'); if(n)this.kbCategories.push({id:Date.now(),name:n}); this.saveAll(); },
            
            // ========== ğŸ†• æ–°å¢åŠŸèƒ½é€»è¾‘ ==========
            
            // æˆå°± CRUD
            addAchievement() {
                if(!this.newAchievement.name) return;
                this.achievements.push({ id: Date.now(), ...this.newAchievement });
                this.newAchievement = { name: '', description: '', icon: 'ğŸ†', requirement: 100, current: 0 };
                this.saveAll();
            },
            deleteAchievement(id) {
                if(confirm('åˆ é™¤æ­¤æˆå°±?')) {
                    this.achievements = this.achievements.filter(a => a.id !== id);
                    this.saveAll();
                }
            },

            // ä¹¦ç± CRUD
            saveBook() {
                if(!this.newBook.title) return;
                this.books.unshift({
                    id: Date.now(),
                    ...this.newBook,
                    createdAt: new Date().toISOString()
                });
                this.newBook = { title: '', author: '', rating: 5, content: '', thoughts: '' };
                this.showBookForm = false;
                this.addXp(20);
                this.saveAll();
            },
            deleteBook(id) {
                if(confirm('ç§»é™¤è¿™æœ¬ä¹¦?')) {
                    this.books = this.books.filter(b => b.id !== id);
                    this.saveAll();
                }
            },

            deleteItem(item) { if(!confirm('åˆ é™¤?'))return; if(item.type==='case')this.cases=this.cases.filter(c=>c.id!==item.id); this.viewingItem=null; this.saveAll(); }
        },
        mounted() {
            sb.auth.getSession().then(({ data: { session } }) => {
                if(session) { this.isLoggedIn = true; this.userId = session.user.id; this.userEmail = session.user.email; this.loadData(); }
            });
        }
    }).mount('#app');
</script>
</body>
</html>

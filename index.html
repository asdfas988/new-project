<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> ä¸ªäººç©ºé—´ </title>
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <!-- Supabase -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <!-- Chart.js (å›¾è¡¨åº“) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- å­—ä½“ -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* ========== å…¨å±€æ ·å¼ ========== */
        :root {
            --bg-color: #fef9f3;
            --text-color: #5a4a42;
            --accent-pink: #ff9a8b;
            --accent-green: #a3de83;
            --accent-blue: #8fd3f4;
            --card-border: 2.5px solid #5a4a42;
            --card-shadow: 6px 6px 0px #d4b8a7;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Noto Sans SC', sans-serif;
            background: var(--bg-color);
            min-height: 100vh;
            color: var(--text-color);
            padding: 20px;
        }

        .container { max-width: 1400px; margin: 0 auto; }

        /* å¤´éƒ¨ & æœç´¢ */
        .header {
            text-align: center; margin-bottom: 30px; padding: 20px;
            background: #fffaf0; border-radius: 24px;
            box-shadow: 8px 8px 0px #e0c9b8; border: 3px solid #5a4a42;
            display: flex; flex-direction: column; align-items: center; position: relative;
        }
        .search-box {
            position: absolute; right: 20px; top: 20px;
            display: flex; align-items: center;
        }
        .search-input {
            padding: 8px 15px; border-radius: 20px; border: 2px solid #e0c9b8;
            outline: none; transition: all 0.3s; width: 200px;
        }
        .search-input:focus { width: 300px; border-color: #ff9a8b; }
        
        /* å¸ƒå±€ */
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 30px; margin-bottom: 40px; }
        .full-width { grid-column: 1 / -1; }

        /* é€šç”¨å¡ç‰‡ */
        .card {
            background: #fffefc; border-radius: 20px; padding: 30px;
            box-shadow: var(--card-shadow); border: var(--card-border);
            transition: transform 0.3s; position: relative; h-100;
            display: flex; flex-direction: column;
        }
        .card:hover { transform: translateY(-3px); }
        .card h2 {
            margin-bottom: 20px; padding-bottom: 15px; border-bottom: 3px dotted #ff9a8b;
            font-size: 1.4em; font-weight: 700; display: flex; justify-content: space-between; align-items: center;
        }

        /* æŒ‰é’®ä¸äº¤äº’ */
        .btn {
            background: linear-gradient(90deg, #ff9a8b, #ff6b6b); border: none; padding: 12px 30px;
            border-radius: 50px; color: white; cursor: pointer; font-size: 16px; font-weight: 700;
            box-shadow: 4px 4px 0px #d45d5d; transition: all 0.2s; width: 100%; text-align: center;
        }
        .btn:hover:not(:disabled) { transform: translateY(-2px); }
        .btn-sm {
            padding: 6px 15px; font-size: 0.9em; border-radius: 20px;
            background: linear-gradient(90deg, #4ecdc4, #a3de83);
            box-shadow: 3px 3px 0px #2ba69b; border: none; color: white; font-weight: bold; cursor: pointer;
        }
        .btn-danger { background: #ff6b6b; box-shadow: 3px 3px 0px #c0392b; }
        .collapse-btn {
            background: #fffaf5; border: 2px solid #ff9a8b; color: #ff6b6b;
            padding: 4px 12px; border-radius: 12px; font-size: 0.8em; font-weight: bold; cursor: pointer;
        }

        /* è¾“å…¥æ¡† */
        .note-input, .note-textarea {
            width: 100%; padding: 12px; border: 2px solid #e0c9b8; border-radius: 12px;
            font-size: 15px; margin-bottom: 15px; background: #fffaf9; font-family: inherit;
        }
        .note-input:focus, .note-textarea:focus { outline: none; border-color: #ff9a8b; box-shadow: 2px 2px 0px #ffd6cc; }

        /* æ¯æ—¥å§”æ‰˜ */
        .quest-item {
            padding: 12px; margin: 8px 0; background: #fff; border-radius: 12px; 
            cursor: pointer; display: flex; align-items: center; border: 2px solid #eee;
            transition: all 0.2s;
        }
        .quest-item:hover { border-color: #a3de83; transform: scale(1.02); }
        .quest-done { background: #e8f5e9; border-color: #a3de83; opacity: 0.7; }

        /* å•†åº— */
        .shop-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; }
        .shop-item {
            border: 2px solid #e0c9b8; border-radius: 12px; padding: 15px; text-align: center; cursor: pointer;
            transition: all 0.2s; background: #fff;
        }
        .shop-item:hover { border-color: #ff9a8b; background: #fff0eb; }
        
        /* æ ‡ç­¾ */
        .tag-pill {
            display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 0.75em;
            margin-right: 5px; color: white; background: #764ba2;
        }

        /* è¿›åº¦æ¡ä¸çŠ¶æ€ */
        .level-display { font-size: 3em; font-weight: 800; text-align: center; color: #ff6b6b; text-shadow: 3px 3px 0px #ffd6cc; }
        .xp-progress { height: 20px; background: #ffe8d6; border-radius: 12px; overflow: hidden; border: 2px solid #5a4a42; margin: 10px 0; }
        .xp-fill { height: 100%; background: linear-gradient(90deg, #4ecdc4, #a3de83); transition: width 0.5s ease; }

        /* å¤ç›˜ Tab */
        .review-tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #e0c9b8; padding-bottom: 10px; overflow-x: auto; }
        .review-tab { padding: 8px 18px; border: 2px solid #e0c9b8; background: #fffaf5; border-radius: 15px 15px 0 0; cursor: pointer; font-weight: 600; white-space: nowrap; }
        .review-tab.active { background: #ff9a8b; color: white; border-color: #ff9a8b; transform: translateY(2px); }

        /* ç™»å½•æ¡† */
        .login-box { max-width: 400px; margin: 100px auto; text-align: center; }
        .status-message { 
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%); 
            padding: 12px 30px; border-radius: 50px; font-weight: bold; z-index: 2000;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2); animation: slideDown 0.3s ease;
        }
        .status-error { background: #ffebee; color: #c62828; border: 2px solid #ef9a9a; }
        .status-success { background: #e8f5e9; color: #2e7d32; border: 2px solid #a5d6a7; }

        /* å“åº”å¼ */
        @media (max-width: 768px) {
            .header { padding: 15px; }
            .header h1 { font-size: 1.5em; margin-top: 40px; }
            .search-box { width: 100%; top: 10px; right: 0; padding: 0 15px; }
            .search-input { width: 100%; }
            .search-input:focus { width: 100%; }
            .grid { grid-template-columns: 1fr; }
        }

        @keyframes slideDown { from {top: -50px;} to {top: 20px;} }
    </style>
</head>
<body>
    <div id="app">
        <!-- æ¶ˆæ¯æç¤º -->
        <div v-if="message" :class="['status-message', messageType === 'success' ? 'status-success' : 'status-error']">
            {{ message }}
        </div>

        <!-- ç™»å½•ç•Œé¢ -->
        <div v-if="!isLoggedIn" class="login-box">
            <div class="card">
                <h1 style="font-size: 3em; margin-bottom: 10px;">â˜¯ï¸</h1>
                <h2 style="justify-content: center;">ä¸ªäººç©ºé—´ <span style="font-size:0.5em; color:#999">Evolution</span></h2>
                <input type="email" v-model="email" placeholder="é‚®ç®±" class="note-input">
                <input type="password" v-model="password" placeholder="å¯†ç " class="note-input">
                <button class="btn" @click="login" :disabled="loading">{{ loading ? 'éªŒè¯ä¸­...' : 'è¿›å…¥æˆ‘çš„ä¸–ç•Œ' }}</button>
            </div>
        </div>

        <!-- ä¸»ç•Œé¢ -->
        <div v-else class="container">
            <!-- å¤´éƒ¨ -->
            <div class="header">
                <div class="search-box">
                    <input type="text" v-model="searchQuery" placeholder="ğŸ” æœç´¢ç¬”è®°/å‘½ä¾‹/ä¹¦ç±..." class="search-input">
                </div>
                <h1>ğŸ‘‹ {{ userEmail.split('@')[0] }} çš„ç©ºé—´</h1>
                <div style="margin-top: 10px;">
                    <button class="btn-sm" @click="syncData" :disabled="syncing">{{ syncing ? 'â˜ï¸ åŒæ­¥ä¸­...' : 'ğŸ”„ åŒæ­¥æ•°æ®' }}</button>
                    <button class="btn-sm btn-danger" @click="logout" style="margin-left: 10px;">é€€å‡º</button>
                </div>
            </div>

            <!-- æœç´¢ç»“æœè¦†ç›–å±‚ -->
            <div v-if="searchQuery" class="card full-width" style="margin-bottom: 30px; border-color: #ff9a8b;">
                <h2>ğŸ” æœç´¢ç»“æœ: "{{ searchQuery }}" <button class="btn-sm" @click="searchQuery=''">å…³é—­</button></h2>
                <div v-if="searchResults.length === 0" style="color: #999;">æ²¡æœ‰æ‰¾åˆ°ç›¸å…³å†…å®¹</div>
                <div v-for="item in searchResults" :key="item.id" style="padding: 10px; border-bottom: 1px dashed #eee; cursor: pointer;" @click="viewItemDetail(item)">
                    <strong>{{ item.type === 'book' ? 'ğŸ“–' : (item.type === 'case' ? 'â˜¯ï¸' : 'ğŸ“') }} {{ item.title || item.code || 'æ— æ ‡é¢˜' }}</strong>
                    <p style="font-size: 0.8em; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">{{ item.content || item.logic || item.notes }}</p>
                </div>
            </div>

            <div class="grid">
                <!-- æ¨¡å—1ï¼šçŠ¶æ€ & æ¯æ—¥å§”æ‰˜ -->
                <div class="card">
                    <h2>ğŸ“Š è§’è‰²çŠ¶æ€</h2>
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div class="level-display">Lv.{{ playerData.level }}</div>
                        <div style="flex:1; margin-left: 20px;">
                            <div class="xp-progress"><div class="xp-fill" :style="{width: xpPercentage + '%'}"></div></div>
                            <div style="text-align: right; font-weight: bold; color: #7a6a62;">{{ playerData.xp }} / {{ playerData.nextLevelXp }} XP</div>
                        </div>
                    </div>

                    <h3 style="margin-top: 20px; font-size: 1.1em;">â˜€ï¸ æ¯æ—¥å§”æ‰˜ <span style="font-size:0.7em; color:#999; font-weight:normal;">(æ¯å¤©0ç‚¹åˆ·æ–°)</span></h3>
                    <div v-for="quest in playerData.dailyQuests" :key="quest.id" 
                         class="quest-item" :class="{'quest-done': quest.done}"
                         @click="toggleQuest(quest)">
                        <span style="margin-right: 10px;">{{ quest.done ? 'âœ…' : 'â¬œ' }}</span>
                        <span :style="{textDecoration: quest.done ? 'line-through' : 'none'}">{{ quest.text }}</span>
                        <span style="margin-left: auto; font-size: 0.8em; color: #ff9a8b; font-weight: bold;">+{{ quest.xp }} XP</span>
                    </div>
                </div>

                <!-- æ¨¡å—2ï¼šèµ„äº§æ›²çº¿ & ç›®æ ‡ -->
                <div class="card">
                    <h2>ğŸ“ˆ è´¢å¯Œ & ç›®æ ‡</h2>
                    <div style="height: 200px; margin-bottom: 20px;">
                        <canvas id="assetChart"></canvas>
                    </div>
                    
                    <div style="background: #fffaf5; padding: 10px; border-radius: 10px; border: 1px dashed #e0c9b8; margin-bottom: 15px;">
                         <div style="display: flex; gap: 5px; margin-bottom: 5px;">
                            <input v-model="newGoal.title" placeholder="æ–°ç›®æ ‡ (å¦‚: æ”’10ä¸‡)" class="note-input" style="margin:0; flex:2;">
                            <input v-model.number="newGoal.target" placeholder="ç›®æ ‡å€¼" type="number" class="note-input" style="margin:0; flex:1;">
                            <button class="btn-sm" @click="addGoal" style="width: 60px;">+</button>
                         </div>
                    </div>

                    <div style="max-height: 200px; overflow-y: auto;">
                        <div v-for="(goal, index) in playerData.goals" :key="index" style="margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #eee;">
                            <div style="display:flex; justify-content:space-between; font-weight:bold;">
                                <span>{{ goal.title }}</span>
                                <span :style="{color: getProgressColor(calculateProgress(goal))}">{{ calculateProgress(goal) }}%</span>
                            </div>
                            <div class="xp-progress" style="height: 8px;"><div class="xp-fill" :class="getProgressClass(calculateProgress(goal))" :style="{width: Math.min(100, calculateProgress(goal)) + '%'}"></div></div>
                            <div style="display:flex; gap: 5px; align-items: center;">
                                <input type="number" v-model.number="goal.current" @change="saveAll" style="width: 60px; padding: 2px; border: 1px solid #ccc; border-radius: 4px;">
                                <span style="font-size: 0.8em; color: #999;">/ {{ goal.target }} {{ goal.unit }}</span>
                                <button class="btn-sm btn-danger" @click="deleteGoal(index)" style="padding: 2px 8px; margin-left: auto;">âœ•</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æ¨¡å—3ï¼šç§¯åˆ†å•†åº— -->
                <div class="card">
                    <h2>ğŸ¦ ç§¯åˆ†å•†åº— <span style="font-size:0.6em; color:#7a6a62; font-weight:normal;">XPä½™é¢: {{ playerData.xp }}</span></h2>
                    <div class="shop-grid">
                        <div v-for="item in playerData.shopItems" :key="item.id" class="shop-item" @click="buyItem(item)">
                            <div style="font-size: 2em;">{{ item.icon }}</div>
                            <div style="font-weight: bold; margin: 5px 0;">{{ item.name }}</div>
                            <div style="color: #ff9a8b; font-weight: bold;">ğŸ’ {{ item.cost }} XP</div>
                        </div>
                    </div>
                    <div style="margin-top: 15px; border-top: 1px dashed #e0c9b8; padding-top: 10px;">
                        <input v-model="newShopItem.name" placeholder="è‡ªå®šä¹‰å¥–åŠ±..." class="note-input" style="margin-bottom: 5px;">
                        <div style="display:flex; gap:5px;">
                            <input v-model.number="newShopItem.cost" placeholder="èŠ±è´¹XP" type="number" class="note-input" style="margin:0;">
                            <input v-model="newShopItem.icon" placeholder="å›¾æ ‡(Emoji)" class="note-input" style="margin:0; width: 60px;">
                            <button class="btn-sm" @click="addShopItem">æ·»åŠ </button>
                        </div>
                    </div>
                </div>

                <!-- æ¨¡å—4ï¼šå¤ç›˜ç¬”è®° (å…¨å®½) -->
                <div class="card full-width">
                    <h2>ğŸ”„ å¤ç›˜ä¸è¿›åŒ– <button class="btn-sm" @click="showReviewForm = !showReviewForm">{{ showReviewForm ? 'å–æ¶ˆ' : '+ æ–°å»ºç¬”è®°' }}</button></h2>
                    
                    <div class="review-tabs">
                        <div v-for="tab in ['stock','daily','weekly','yearly']" :key="tab" 
                             class="review-tab" :class="{active: activeReviewTab === tab}" 
                             @click="activeReviewTab = tab">
                            {{ getReviewTypeName(tab) }}
                        </div>
                    </div>

                    <!-- ç¬”è®°è¡¨å• -->
                    <div v-if="showReviewForm" style="background: #fffaf5; padding: 20px; border: 2px dashed #ff9a8b; border-radius: 15px; margin-bottom: 20px;">
                        
                        <!-- è‚¡ç¥¨ä¸“ç”¨ -->
                        <div v-if="activeReviewTab === 'stock'" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 10px;">
                            <input v-model="newStockData.code" placeholder="ä»£ç /åç§°" class="note-input">
                            <select v-model="newStockData.action" class="note-input">
                                <option value="buy">ğŸ”µ ä¹°å…¥</option>
                                <option value="sell">ğŸ”´ å–å‡º</option>
                                <option value="hold">âšª æŒä»“</option>
                            </select>
                            <input v-model="newStockData.price" placeholder="æˆäº¤ä»·" class="note-input">
                            <input v-model="newStockData.profit" placeholder="ç›ˆäºé¢" class="note-input">
                            <input v-model.number="newStockData.totalAssets" placeholder="ğŸ“Œ å½“å‰æ€»èµ„äº§ (ç”¨äºç”»å›¾)" class="note-input" style="border-color: #a3de83;">
                        </div>

                        <!-- é€šç”¨å­—æ®µ -->
                        <input v-if="activeReviewTab !== 'stock'" v-model="newNote.title" placeholder="æ ‡é¢˜..." class="note-input">
                        <input v-model="newNote.tags" placeholder="æ ‡ç­¾ (ç”¨é€—å·åˆ†éš”ï¼Œå¦‚: å¿ƒæ€, ç”²æœ¨, æ‰“æ¿)" class="note-input">
                        <textarea v-model="newNote.content" :placeholder="activeReviewTab === 'stock' ? 'äº¤æ˜“é€»è¾‘ä¸åæ€...' : 'æ­£æ–‡å†…å®¹...'" class="note-textarea" style="height: 120px;"></textarea>
                        <button class="btn" @click="saveNote">ğŸ’¾ ä¿å­˜å¹¶è·å¾— XP</button>
                    </div>

                    <!-- ç¬”è®°åˆ—è¡¨ -->
                    <div v-for="note in filteredNotes" :key="note.id" style="background: #f9f9f9; padding: 20px; border-radius: 15px; margin-bottom: 15px; border-left: 5px solid #e0c9b8;">
                        <div style="display:flex; justify-content:space-between; margin-bottom: 5px;">
                            <span style="font-size: 0.85em; color: #999;">{{ formatDate(note.createdAt) }}</span>
                            <div v-if="note.tags">
                                <span v-for="tag in note.tags.split(/[,ï¼Œ]/)" :key="tag" class="tag-pill">{{ tag }}</span>
                            </div>
                        </div>

                        <!-- è‚¡ç¥¨å†…å®¹ -->
                        <div v-if="note.type === 'stock'" style="margin-bottom: 10px; font-weight: bold;">
                            <span :style="{color: note.stockData?.action === 'buy' ? 'red' : 'green'}">
                                {{ note.stockData?.action === 'buy' ? 'ä¹°å…¥' : (note.stockData?.action === 'sell' ? 'å–å‡º' : 'æŒä»“') }}
                            </span>
                            {{ note.stockData?.code }}
                            <span v-if="note.stockData?.profit" style="margin-left:10px;">ç›ˆäº: {{ note.stockData.profit }}</span>
                        </div>

                        <h3 v-if="note.title">{{ note.title }}</h3>
                        <p style="white-space: pre-wrap; line-height: 1.6;">{{ note.content }}</p>
                        
                        <div style="text-align: right; margin-top: 10px;">
                            <button class="btn-sm btn-danger" @click="deleteNote(note.id)">åˆ é™¤</button>
                        </div>
                    </div>
                </div>

                <!-- æ¨¡å—5ï¼šæ˜“å­¦ & ä¹¦æˆ¿ (å›¾ç‰‡æ‡’åŠ è½½) -->
                <div class="card">
                    <h2>â˜¯ï¸ æ˜“å­¦å‘½ä¾‹</h2>
                    <button class="btn-sm" @click="showCaseForm = !showCaseForm" style="margin-bottom: 15px;">+ æ–°å‘½ä¾‹</button>
                    
                    <div v-if="showCaseForm" style="background: #fffaf5; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                        <input v-model="newCase.title" placeholder="æ ‡é¢˜/å…«å­—" class="note-input">
                        <input type="file" @change="handleImageUpload" class="note-input" accept="image/*">
                        <textarea v-model="newCase.content" placeholder="æ–­è¯­..." class="note-textarea"></textarea>
                        <button class="btn" @click="saveCase">ä¿å­˜</button>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px;">
                        <div v-for="c in cases" :key="c.id" @click="viewItemDetail(c)" style="cursor: pointer;">
                            <img :src="c.image || 'https://via.placeholder.com/150?text=No+Img'" loading="lazy" style="width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 10px; border: 1px solid #ddd;">
                            <div style="font-size: 0.8em; text-align: center; margin-top: 5px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis;">{{ c.title }}</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2>ğŸ“š è—ä¹¦é˜</h2>
                    <div v-for="book in books" :key="book.id" style="padding: 10px; border-bottom: 1px solid #eee;">
                        <div style="font-weight: bold;">{{ book.title }}</div>
                        <div style="font-size: 0.9em; color: #666;">{{ book.author }} - {{ 'â˜…'.repeat(book.rating) }}</div>
                    </div>
                    <div style="margin-top: 10px;">
                        <input v-model="newBook.title" placeholder="ä¹¦å" class="note-input" style="margin-bottom:5px;">
                        <button class="btn-sm" @click="saveBook">æ·»åŠ </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- è¯¦æƒ…å¼¹çª— -->
        <div v-if="viewingItem" style="position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; justify-content: center; align-items: center;" @click.self="viewingItem = null">
            <div class="card" style="width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto;">
                <div style="display: flex; justify-content: space-between;">
                    <h2>è¯¦æƒ…</h2> <span @click="viewingItem = null" style="cursor:pointer; font-size: 1.5em;">&times;</span>
                </div>
                <div style="margin-top: 20px;">
                    <img v-if="viewingItem.image" :src="viewingItem.image" style="width: 100%; margin-bottom: 15px; border-radius: 10px;">
                    <h3>{{ viewingItem.title || viewingItem.code }}</h3>
                    <p style="white-space: pre-wrap; line-height: 1.6;">{{ viewingItem.content || viewingItem.logic || viewingItem.notes }}</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://zqmgigcnruvvdcholbuj.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpxbWdpZ2NucnV2dmRjaG9sYnVqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4NjgzNjEsImV4cCI6MjA4MTQ0NDM2MX0.IHzDp7o5M9QM8IBWy2ri5gS9h9nm0zk3AaPTNveDqXI';
        const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    isLoggedIn: false, userId: null, userEmail: '', email: '', password: '',
                    loading: false, syncing: false, message: '', messageType: '',
                    
                    // UI State
                    activeReviewTab: 'stock', showReviewForm: false, showCaseForm: false, viewingItem: null,
                    searchQuery: '',
                    
                    // Data
                    playerData: { 
                        level: 1, xp: 0, nextLevelXp: 100, 
                        goals: [], 
                        dailyQuests: [
                            { id: 1, text: 'ğŸ§˜â€â™‚ï¸ å†¥æƒ³/ç«™æ¡©', done: false, xp: 10 },
                            { id: 2, text: 'ğŸ“– é˜…è¯»30åˆ†é’Ÿ', done: false, xp: 15 },
                            { id: 3, text: 'ğŸ“ˆ ç›˜åå¤ç›˜', done: false, xp: 20 }
                        ],
                        lastLoginDate: '',
                        shopItems: [
                            { id: 1, name: 'å¥¶èŒ¶ä¸€æ¯', cost: 50, icon: 'ğŸ¥¤' },
                            { id: 2, name: 'æ¸¸æˆä¸€å°æ—¶', cost: 100, icon: 'ğŸ®' }
                        ],
                        assetsHistory: [] // { date: '2023-01-01', value: 10000 }
                    },
                    notes: [], cases: [], books: [],
                    
                    // Forms
                    newGoal: { title: '', target: null, current: 0, unit: '', mode: 'numeric' },
                    newNote: { title: '', content: '', tags: '' },
                    newStockData: { code: '', action: 'buy', price: '', profit: '', totalAssets: null },
                    newCase: { title: '', content: '', image: null },
                    newBook: { title: '', author: '', rating: 3 },
                    newShopItem: { name: '', cost: 100, icon: 'ğŸ' },
                    
                    chartInstance: null
                };
            },
            computed: {
                xpPercentage() { return Math.min(100, (this.playerData.xp / this.playerData.nextLevelXp) * 100); },
                filteredNotes() {
                    let res = this.notes.filter(n => {
                        if (this.activeReviewTab === 'daily') return !n.type || n.type === 'daily';
                        return n.type === this.activeReviewTab;
                    });
                    return res.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));
                },
                searchResults() {
                    if (!this.searchQuery) return [];
                    const q = this.searchQuery.toLowerCase();
                    const n = this.notes.filter(x => (x.content+x.title+x.tags).toLowerCase().includes(q));
                    const c = this.cases.filter(x => (x.content+x.title).toLowerCase().includes(q));
                    const b = this.books.filter(x => (x.title).toLowerCase().includes(q));
                    return [...n, ...c, ...b];
                }
            },
            methods: {
                showMessage(txt, type='success') { this.message = txt; this.messageType = type; setTimeout(()=>this.message='', 3000); },
                formatDate(str) { return new Date(str).toLocaleDateString(); },
                getReviewTypeName(t) { const map={stock:'ğŸ“ˆ è‚¡ç¥¨',daily:'ğŸ“ æ—¥å¸¸',weekly:'ğŸ“… å‘¨å¤ç›˜',yearly:'ğŸ† å¹´æ€»ç»“'}; return map[t]||'è®°å½•'; },
                
                // Helper Colors
                getProgressColor(p) { return p < 30 ? '#ff6b6b' : (p < 80 ? '#ffcc00' : '#2e7d32'); },
                getProgressClass(p) { return p >= 100 ? 'p-done' : (p < 30 ? 'p-low' : 'p-high'); },
                calculateProgress(g) { if(!g.target) return 0; return Math.round((g.current/g.target)*100); },

                // --- Auth & Data Loading ---
                async login() {
                    if (!this.email || !this.password) return this.showMessage('è¯·è¾“å…¥è´¦å·å¯†ç ', 'error');
                    this.loading = true;
                    const { data, error } = await sb.auth.signInWithPassword({ email: this.email, password: this.password });
                    this.loading = false;
                    if (error) return this.showMessage('ç™»å½•å¤±è´¥: ' + error.message, 'error');
                    this.isLoggedIn = true; this.userId = data.user.id; this.userEmail = data.user.email;
                    this.loadData();
                },
                async logout() { await sb.auth.signOut(); this.isLoggedIn = false; },

                async loadData() {
                    this.syncing = true;
                    const [p, n, c, b] = await Promise.all([
                        sb.from('players').select('*').eq('user_id', this.userId).single(),
                        sb.from('notes').select('*').eq('user_id', this.userId),
                        sb.from('cases').select('*').eq('user_id', this.userId),
                        sb.from('books').select('*').eq('user_id', this.userId)
                    ]);
                    
                    if (p.data && p.data.data) {
                        // åˆå¹¶æ•°æ®ï¼Œé˜²æ­¢æ–°å­—æ®µä¸¢å¤±
                        this.playerData = { ...this.playerData, ...p.data.data };
                        // ç¡®ä¿æ•°ç»„åˆå§‹åŒ–
                        if (!this.playerData.dailyQuests) this.playerData.dailyQuests = [
                            { id: 1, text: 'ğŸ§˜â€â™‚ï¸ å†¥æƒ³/ç«™æ¡©', done: false, xp: 10 },
                            { id: 2, text: 'ğŸ“– é˜…è¯»30åˆ†é’Ÿ', done: false, xp: 15 },
                            { id: 3, text: 'ğŸ“ˆ ç›˜åå¤ç›˜', done: false, xp: 20 }
                        ];
                        if (!this.playerData.shopItems) this.playerData.shopItems = [];
                        if (!this.playerData.assetsHistory) this.playerData.assetsHistory = [];
                    }
                    
                    if (n.data) this.notes = n.data.map(i => i.data);
                    if (c.data) this.cases = c.data.map(i => i.data);
                    if (b.data) this.books = b.data.map(i => i.data);

                    this.checkDailyReset();
                    this.initChart();
                    this.syncing = false;
                },

                // --- Core Logic: Saving ---
                async saveAll() {
                    if (!this.userId) return;
                    // å¹¶è¡Œä¿å­˜ä¼˜åŒ–
                    await Promise.all([
                        sb.from('players').upsert({ user_id: this.userId, data: this.playerData }, { onConflict: 'user_id' }),
                        this.saveTable('notes', this.notes),
                        this.saveTable('cases', this.cases),
                        this.saveTable('books', this.books)
                    ]);
                },
                async saveTable(table, list) {
                    await sb.from(table).delete().eq('user_id', this.userId);
                    if (list.length) await sb.from(table).insert(list.map(d => ({ user_id: this.userId, data: d })));
                },
                async syncData() { this.syncing = true; await this.saveAll(); this.syncing = false; this.showMessage('åŒæ­¥æˆåŠŸ'); },

                // --- Features ---
                
                // 1. Daily Quests
                checkDailyReset() {
                    const today = new Date().toLocaleDateString();
                    if (this.playerData.lastLoginDate !== today) {
                        this.playerData.dailyQuests.forEach(q => q.done = false);
                        this.playerData.lastLoginDate = today;
                        this.saveAll();
                    }
                },
                toggleQuest(q) {
                    q.done = !q.done;
                    if (q.done) { this.addXp(q.xp); this.showMessage(`å®Œæˆ! +${q.xp} XP`); }
                    else { this.addXp(-q.xp); }
                    this.saveAll();
                },

                // 2. Shop
                addShopItem() { if(!this.newShopItem.name)return; this.playerData.shopItems.push({...this.newShopItem, id:Date.now()}); this.newShopItem={name:'',cost:100,icon:'ğŸ'}; this.saveAll(); },
                buyItem(item) {
                    if (this.playerData.xp >= item.cost) {
                        if(confirm(`ç¡®å®šèŠ±è´¹ ${item.cost} XP å…‘æ¢ "${item.name}" å—?`)) {
                            this.addXp(-item.cost);
                            this.notes.unshift({ id: Date.now(), type: 'daily', createdAt: new Date().toISOString(), title: 'ğŸ å…‘æ¢å¥–åŠ±', content: `å…‘æ¢äº†: ${item.name}`, tags: 'æ¶ˆè´¹' });
                            this.saveAll();
                            this.showMessage('å…‘æ¢æˆåŠŸï¼äº«å—ä½ çš„å¥–åŠ±å§');
                        }
                    } else {
                        this.showMessage('XP ä¸è¶³ï¼å¿«å»å®Œæˆä»»åŠ¡å§', 'error');
                    }
                },

                // 3. Chart
                initChart() {
                    const ctx = document.getElementById('assetChart');
                    if (!ctx) return;
                    if (this.chartInstance) this.chartInstance.destroy();
                    
                    const history = this.playerData.assetsHistory || [];
                    const labels = history.map(h => h.date);
                    const data = history.map(h => h.value);

                    this.chartInstance = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'æ€»èµ„äº§å‡€å€¼',
                                data: data,
                                borderColor: '#a3de83',
                                backgroundColor: 'rgba(163, 222, 131, 0.2)',
                                tension: 0.3, fill: true
                            }]
                        },
                        options: { responsive: true, maintainAspectRatio: false }
                    });
                },
                updateChart(val) {
                    if (!val) return;
                    const today = new Date().toLocaleDateString();
                    this.playerData.assetsHistory.push({ date: today, value: val });
                    // ä¿æŒæœ€è¿‘30æ¡
                    if (this.playerData.assetsHistory.length > 30) this.playerData.assetsHistory.shift();
                    this.initChart();
                },

                // 4. Notes & Search
                saveNote() {
                    const note = { id: Date.now(), type: this.activeReviewTab, createdAt: new Date().toISOString(), ...this.newNote };
                    if (this.activeReviewTab === 'stock') {
                        note.stockData = { ...this.newStockData };
                        note.content = `${this.newStockData.action === 'buy'?'ä¹°å…¥':'å–å‡º'} ${this.newStockData.code}. ${this.newNote.content}`;
                        if (this.newStockData.totalAssets) this.updateChart(this.newStockData.totalAssets);
                        this.newStockData = { code:'', action:'buy', price:'', profit:'', totalAssets:null };
                    }
                    this.notes.unshift(note);
                    this.newNote = { title:'', content:'', tags:'' };
                    this.showReviewForm = false;
                    this.addXp(20); this.saveAll();
                },
                deleteNote(id) { if(confirm('åˆ é™¤?')) { this.notes = this.notes.filter(n=>n.id!==id); this.saveAll(); } },

                // 5. Goals & XP
                addGoal() { 
                    if(!this.newGoal.title) return;
                    this.playerData.goals.push({ title: this.newGoal.title, target: this.newGoal.target || 100, current: 0, unit: '', mode: 'numeric' });
                    this.newGoal.title=''; this.saveAll(); 
                },
                deleteGoal(i) { this.playerData.goals.splice(i,1); this.saveAll(); },
                addXp(amount) { this.playerData.xp += amount; if (this.playerData.xp >= this.playerData.nextLevelXp) { this.playerData.xp -= this.playerData.nextLevelXp; this.playerData.level++; this.showMessage('ğŸ‰ å‡çº§äº†ï¼Lv.' + this.playerData.level); } },

                // 6. Others
                handleImageUpload(e) {
                    const file = e.target.files[0]; if(!file)return;
                    if(file.size > 5*1024*1024) return alert('å›¾ç‰‡è¿‡å¤§');
                    const reader = new FileReader();
                    reader.onload = (evt) => {
                        const img = new Image(); img.src = evt.target.result;
                        img.onload = () => {
                            const cvs = document.createElement('canvas'); const ctx = cvs.getContext('2d');
                            const scale = 800/img.width; 
                            cvs.width = img.width > 800 ? 800 : img.width; 
                            cvs.height = img.width > 800 ? img.height * scale : img.height;
                            ctx.drawImage(img,0,0,cvs.width,cvs.height);
                            this.newCase.image = cvs.toDataURL('image/jpeg', 0.7);
                        }
                    };
                    reader.readAsDataURL(file);
                },
                saveCase() { if(!this.newCase.title)return; this.cases.unshift({id:Date.now(), type:'case', ...this.newCase}); this.newCase={title:'',content:'',image:null}; this.showCaseForm=false; this.addXp(30); this.saveAll(); },
                saveBook() { if(!this.newBook.title)return; this.books.unshift({id:Date.now(), type:'book', ...this.newBook}); this.newBook.title=''; this.saveAll(); },
                viewItemDetail(item) { this.viewingItem = item; this.searchQuery = ''; }
            },
            mounted() {
                sb.auth.getSession().then(({ data: { session } }) => {
                    if (session) { this.isLoggedIn = true; this.userId = session.user.id; this.userEmail = session.user.email; this.loadData(); }
                });
            }
        }).mount('#app');
    </script>
</body>
</html>

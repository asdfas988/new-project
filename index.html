<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆé•¿æ‰‹è´¦</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Gochi+Hand&family=Comic+Neue:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* åŸæœ‰çš„æ‰€æœ‰æ ·å¼ä¿æŒä¸å˜ */
        /* è¿™é‡Œåº”è¯¥æœ‰æ‰€æœ‰åŸæœ‰çš„CSSæ ·å¼ */
        /* ä¸ºäº†èŠ‚çœç¯‡å¹…ï¼Œæˆ‘å‡è®¾æ‰€æœ‰åŸæœ‰æ ·å¼éƒ½å·²å­˜åœ¨ */
        
        /* æ–°å¢çš„çŸ¥è¯†åº“åŠŸèƒ½æ ·å¼ */
        .batch-actions {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #fffaf5;
            border-radius: 12px;
            border: 2px solid #e0c9b8;
        }
        
        .batch-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .batch-info {
            flex: 1;
            color: #5a4a42;
            font-weight: 600;
        }
        
        .batch-delete-btn {
            background: linear-gradient(90deg, #ff6b6b, #d45d5d);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-family: 'Comic Neue', cursive;
            font-weight: bold;
            box-shadow: 2px 2px 0px #d45d5d;
        }
        
        .batch-cancel-btn {
            background: #fffaf5;
            color: #7a6a62;
            border: 2px solid #e0c9b8;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-family: 'Comic Neue', cursive;
            font-weight: bold;
        }
        
        .note-checkbox {
            position: absolute;
            top: 15px;
            left: 15px;
            width: 18px;
            height: 18px;
            cursor: pointer;
            z-index: 10;
        }
        
        .knowledge-note-card.selected {
            border-color: #ff6b6b;
            background: rgba(255, 107, 107, 0.05);
        }
        
        .export-import-panel {
            background: #fffaf5;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 25px;
            border: 2px solid #e0c9b8;
        }
        
        .export-import-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .export-import-header h3 {
            font-family: 'Gochi Hand', cursive;
            color: #5a4a42;
            margin: 0;
        }
        
        .export-import-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .export-btn, .import-btn {
            background: linear-gradient(90deg, #9d7bff, #6a5af9);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-family: 'Comic Neue', cursive;
            font-weight: bold;
            box-shadow: 2px 2px 0px #5a4ae6;
        }
        
        .import-btn {
            background: linear-gradient(90deg, #4ecdc4, #2ba69b);
            box-shadow: 2px 2px 0px #2ba69b;
        }
        
        .export-formats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .format-option {
            background: #fffefc;
            border: 2px solid #e0c9b8;
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .format-option:hover {
            border-color: #9d7bff;
            transform: translateY(-2px);
        }
        
        .format-option.selected {
            border-color: #6a5af9;
            background: rgba(157, 123, 255, 0.05);
        }
        
        .format-icon {
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        .format-name {
            font-weight: bold;
            color: #5a4a42;
            margin-bottom: 5px;
        }
        
        .format-desc {
            color: #7a6a62;
            font-size: 0.9em;
        }
        
        .search-highlight {
            background-color: #fffacd;
            padding: 2px 0;
            border-radius: 3px;
        }
        
        .knowledge-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .knowledge-stat-card {
            background: #fffefc;
            border-radius: 12px;
            padding: 20px;
            border: 2px solid #e0c9b8;
            text-align: center;
        }
        
        .knowledge-stat-value {
            font-size: 2em;
            font-weight: 800;
            font-family: 'Gochi Hand', cursive;
            color: #6a5af9;
            margin-bottom: 5px;
        }
        
        .knowledge-stat-label {
            color: #7a6a62;
            font-size: 0.9em;
        }
        
        .pagination-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px dotted #e0c9b8;
        }
        
        .pagination-btn {
            background: #fffaf5;
            border: 2px solid #e0c9b8;
            border-radius: 20px;
            padding: 8px 16px;
            cursor: pointer;
            font-family: 'Comic Neue', cursive;
            font-weight: bold;
            color: #5a4a42;
            min-width: 100px;
        }
        
        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .pagination-btn:not(:disabled):hover {
            background: #fffaf9;
            border-color: #9d7bff;
        }
        
        .page-info {
            color: #7a6a62;
            font-weight: bold;
        }
        
        .search-advanced {
            background: #fffaf5;
            padding: 15px;
            border-radius: 10px;
            margin-top: 10px;
            border: 2px solid #e0c9b8;
        }
        
        .search-fields {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .search-field {
            display: flex;
            flex-direction: column;
        }
        
        .search-field label {
            margin-bottom: 5px;
            font-weight: 600;
            color: #5a4a42;
            font-size: 0.9em;
        }
        
        .search-field select {
            padding: 8px 12px;
            border: 2px solid #e0c9b8;
            border-radius: 8px;
            background: #fffefc;
            font-family: 'Comic Neue', cursive;
        }
        
        .search-toggle {
            background: none;
            border: none;
            color: #6a5af9;
            cursor: pointer;
            font-family: 'Comic Neue', cursive;
            font-size: 0.9em;
            text-decoration: underline;
            padding: 5px 0;
        }
        
        .quick-filters {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        
        .quick-filter {
            padding: 6px 12px;
            background: rgba(78, 205, 196, 0.1);
            border: 1px solid #4ecdc4;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.9em;
            color: #2ba69b;
            transition: all 0.3s;
        }
        
        .quick-filter:hover {
            background: rgba(78, 205, 196, 0.2);
        }
        
        .quick-filter.active {
            background: rgba(78, 205, 196, 0.3);
            border-color: #2ba69b;
            color: #2ba69b;
            font-weight: bold;
        }
        
        .empty-category {
            text-align: center;
            padding: 60px 20px;
            color: #c9b8a7;
        }
        
        .empty-category-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }
        
        .empty-category-text {
            font-size: 1.2em;
            margin-bottom: 20px;
            color: #a39687;
        }
        
        .data-backup-panel {
            background: #fffaf5;
            padding: 20px;
            border-radius: 15px;
            margin-top: 25px;
            border: 2px solid #e0c9b8;
        }
        
        .backup-info {
            color: #7a6a62;
            font-size: 0.9em;
            margin-bottom: 15px;
        }
        
        .auto-save-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #e0c9b8;
            transition: .4s;
            border-radius: 34px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: #4ecdc4;
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }
        
        .toggle-label {
            color: #5a4a42;
            font-weight: 600;
        }
        
        .backup-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .backup-btn {
            background: linear-gradient(90deg, #ff9a8b, #ff6b6b);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-family: 'Comic Neue', cursive;
            font-weight: bold;
            box-shadow: 2px 2px 0px #d45d5d;
        }
        
        .restore-btn {
            background: linear-gradient(90deg, #a3de83, #4ecdc4);
            box-shadow: 2px 2px 0px #2ba69b;
        }
        
        .shortcut-help {
            background: rgba(157, 123, 255, 0.05);
            border-left: 4px solid #9d7bff;
            padding: 15px;
            margin-top: 20px;
            border-radius: 0 8px 8px 0;
        }
        
        .shortcut-help h4 {
            color: #5a4a42;
            margin-bottom: 10px;
            font-family: 'Gochi Hand', cursive;
        }
        
        .shortcut-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }
        
        .shortcut-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px dashed #e0c9b8;
        }
        
        .shortcut-key {
            background: rgba(0, 0, 0, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            color: #5a4a42;
        }
        
        .shortcut-desc {
            color: #7a6a62;
        }
        
        .loading-more {
            text-align: center;
            padding: 20px;
            color: #7a6a62;
        }
        
        .knowledge-tools-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .knowledge-tools-left, .knowledge-tools-right {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .sort-selector {
            padding: 8px 15px;
            border: 2px solid #e0c9b8;
            border-radius: 20px;
            background: #fffefc;
            font-family: 'Comic Neue', cursive;
            color: #5a4a42;
        }
        
        .view-toggle {
            display: flex;
            border: 2px solid #e0c9b8;
            border-radius: 20px;
            overflow: hidden;
        }
        
        .view-btn {
            padding: 8px 15px;
            background: #fffaf5;
            border: none;
            cursor: pointer;
            font-family: 'Comic Neue', cursive;
            color: #7a6a62;
            transition: all 0.3s;
        }
        
        .view-btn.active {
            background: #fffefc;
            color: #5a4a42;
            font-weight: bold;
        }
        
        .knowledge-note-card.grid-view {
            /* ç½‘æ ¼è§†å›¾æ ·å¼ */
        }
        
        .knowledge-note-card.list-view {
            grid-column: 1 / -1;
            display: flex;
            flex-direction: row;
            align-items: flex-start;
        }
        
        .list-view-content {
            flex: 1;
            margin-left: 15px;
        }
        
        .note-count-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 107, 107, 0.1);
            color: #ff6b6b;
            font-size: 0.7em;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: bold;
        }
        
        .category-note-count {
            font-size: 0.8em;
            color: #7a6a62;
            margin-left: 5px;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="container">
            <!-- ç™»å½•ç•Œé¢ -->
            <div v-if="!isLoggedIn" class="login-panel">
                <div class="card">
                    <h2 style="text-align: center;">æ¬¢è¿ä½¿ç”¨æˆé•¿æ‰‹è´¦</h2>
                    <p style="text-align: center; margin-bottom: 20px; color: #7a6a62;">ç™»å½•æˆ–æ³¨å†Œå¼€å§‹ä½ çš„æˆé•¿ä¹‹æ—…</p>
                    
                    <input v-model="email" type="email" class="note-input" placeholder="é‚®ç®±" @keyup.enter="login">
                    <input v-model="password" type="password" class="note-input" placeholder="å¯†ç  (è‡³å°‘6ä½)" @keyup.enter="login">
                    
                    <div style="display: flex; gap: 12px;">
                        <button class="btn" @click="login" :disabled="loading" style="flex: 1;">
                            {{ loading ? 'ç™»å½•ä¸­...' : 'ç™»å½•' }}
                        </button>
                        <button class="btn" @click="register" :disabled="loading" style="flex: 1; background:linear-gradient(90deg, #4ecdc4, #2ba69b);">
                            {{ loading ? 'æ³¨å†Œä¸­...' : 'æ³¨å†Œ' }}
                        </button>
                    </div>
                    
                    <p style="margin-top: 18px; font-size: 0.9em; color: #7a6a62; text-align: center;">
                        æ•°æ®å­˜å‚¨åœ¨ Supabase äº‘ç«¯
                    </p>
                </div>
            </div>
            
            <!-- ä¸»ç•Œé¢ -->
            <div v-if="isLoggedIn">
                <div v-if="message" :class="['status-message', messageType === 'success' ? 'status-success' : 'status-error']">
                    {{ message }}
                </div>
                
                <div class="header">
                    <h1>æˆé•¿æ‰‹è´¦</h1>
                    <p>ç”¨æˆ·: {{ userEmail }}</p>
                    
                    <div class="action-buttons">
                        <!-- æ·»åŠ çŸ¥è¯†åº“æŒ‰é’® -->
                        <button class="btn-sm knowledge-base-btn" @click="openKnowledgeBase">
                            çŸ¥è¯†åº“
                        </button>
                        <button class="btn-sm" @click="syncData" :disabled="syncing">
                            {{ syncing ? 'åŒæ­¥ä¸­' : 'åŒæ­¥' }}
                        </button>
                        <button class="btn-sm" @click="saveAllData" :disabled="saving">
                            {{ saving ? 'ä¿å­˜ä¸­' : 'ä¿å­˜' }}
                        </button>
                        <button class="btn-sm" @click="logout" style="background:linear-gradient(90deg, #ff7b6b, #d45d5d);">
                            é€€å‡º
                        </button>
                    </div>
                </div>
                
                <!-- çŸ¥è¯†åº“æ¨¡æ€æ¡† -->
                <div v-if="showKnowledgeBase" class="knowledge-base-modal">
                    <div class="knowledge-base-content">
                        <div class="knowledge-base-header">
                            <h2>ğŸ“š æˆ‘çš„çŸ¥è¯†åº“</h2>
                            <button class="close-knowledge-base" @click="closeKnowledgeBase">
                                å…³é—­çŸ¥è¯†åº“
                            </button>
                        </div>
                        
                        <div class="knowledge-base-body">
                            <!-- å·¦ä¾§è¾¹æ  - åˆ†ç±»åˆ—è¡¨ -->
                            <div class="knowledge-base-sidebar">
                                <h3 style="margin-bottom: 20px; font-family: 'Gochi Hand'; color: #5a4a42; border-bottom: 2px dotted #ff9a8b; padding-bottom: 10px;">
                                    åˆ†ç±»
                                </h3>
                                
                                <div v-if="knowledgeCategories.length === 0 && !loadingKnowledgeData" style="text-align: center; padding: 30px 0; color: #c9b8a7;">
                                    <div style="font-size: 2.5em;">ğŸ“‚</div>
                                    <div style="margin-top: 10px;">æš‚æ— åˆ†ç±»</div>
                                </div>
                                
                                <div v-else-if="loadingKnowledgeData" class="knowledge-base-loading">
                                    <div class="loading-spinner"></div>
                                    <span>åŠ è½½ä¸­...</span>
                                </div>
                                
                                <div v-else>
                                    <div v-for="category in knowledgeCategories" 
                                         :key="category.id" 
                                         class="category-item"
                                         :class="{active: selectedCategoryId === category.id}"
                                         @click="selectCategory(category.id)">
                                        <div style="display: flex; align-items: center;">
                                            <span class="category-icon">{{ category.icon || 'ğŸ“' }}</span>
                                            <div>
                                                <div>{{ category.name }}</div>
                                                <div class="category-note-count">
                                                    {{ getCategoryNoteCount(category.id) }} ç¯‡ç¬”è®°
                                                </div>
                                            </div>
                                        </div>
                                        <div class="category-actions">
                                            <button class="category-action-btn" @click.stop="openCategoryEditor(category)">
                                                âœï¸
                                            </button>
                                            <button class="category-action-btn" @click.stop="deleteCategory(category.id)">
                                                ğŸ—‘ï¸
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <button class="add-category-btn" @click="openCategoryEditor(null)">
                                    + æ·»åŠ åˆ†ç±»
                                </button>
                                
                                <!-- æ•°æ®å¤‡ä»½é¢æ¿ -->
                                <div class="data-backup-panel">
                                    <div class="auto-save-toggle">
                                        <label class="toggle-switch">
                                            <input type="checkbox" v-model="autoSave" @change="toggleAutoSave">
                                            <span class="toggle-slider"></span>
                                        </label>
                                        <span class="toggle-label">è‡ªåŠ¨ä¿å­˜</span>
                                    </div>
                                    
                                    <div class="backup-info">
                                        æ•°æ®å·²ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨ï¼Œå®šæœŸå¯¼å‡ºå¤‡ä»½ä»¥é˜²æ•°æ®ä¸¢å¤±ã€‚
                                    </div>
                                    
                                    <div class="backup-actions">
                                        <button class="backup-btn export-btn" @click="openExportPanel">
                                            å¯¼å‡ºæ•°æ®
                                        </button>
                                        <button class="backup-btn restore-btn" @click="openImportPanel">
                                            å¯¼å…¥æ•°æ®
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- å¿«æ·é”®å¸®åŠ© -->
                                <div class="shortcut-help">
                                    <h4>ğŸ“Œ å¿«æ·é”®</h4>
                                    <div class="shortcut-list">
                                        <div class="shortcut-item">
                                            <span class="shortcut-desc">æ–°å»ºç¬”è®°</span>
                                            <span class="shortcut-key">Ctrl+N</span>
                                        </div>
                                        <div class="shortcut-item">
                                            <span class="shortcut-desc">æœç´¢</span>
                                            <span class="shortcut-key">Ctrl+F</span>
                                        </div>
                                        <div class="shortcut-item">
                                            <span class="shortcut-desc">ä¿å­˜</span>
                                            <span class="shortcut-key">Ctrl+S</span>
                                        </div>
                                        <div class="shortcut-item">
                                            <span class="shortcut-desc">å…³é—­</span>
                                            <span class="shortcut-key">Esc</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- ä¸»å†…å®¹åŒº -->
                            <div class="knowledge-base-main">
                                <div v-if="selectedCategoryId && !loadingKnowledgeData">
                                    <!-- ç»Ÿè®¡å¡ç‰‡ -->
                                    <div class="knowledge-stats">
                                        <div class="knowledge-stat-card">
                                            <div class="knowledge-stat-value">{{ categoryNotes.length }}</div>
                                            <div class="knowledge-stat-label">å½“å‰åˆ†ç±»ç¬”è®°</div>
                                        </div>
                                        <div class="knowledge-stat-card">
                                            <div class="knowledge-stat-value">{{ totalNotesCount }}</div>
                                            <div class="knowledge-stat-label">æ€»ç¬”è®°æ•°</div>
                                        </div>
                                        <div class="knowledge-stat-card">
                                            <div class="knowledge-stat-value">{{ knowledgeCategories.length }}</div>
                                            <div class="knowledge-stat-label">åˆ†ç±»æ•°</div>
                                        </div>
                                        <div class="knowledge-stat-card">
                                            <div class="knowledge-stat-value">{{ uniqueTagsCount }}</div>
                                            <div class="knowledge-stat-label">æ ‡ç­¾æ•°</div>
                                        </div>
                                    </div>
                                    
                                    <!-- å·¥å…·æ¡ -->
                                    <div class="knowledge-tools-bar">
                                        <div class="knowledge-tools-left">
                                            <button class="quick-action-btn" @click="openKnowledgeEditor(null)">
                                                + æ–°å»ºç¬”è®°
                                            </button>
                                            <button class="quick-action-btn" @click="openCategoryEditor(selectedCategory)">
                                                ç¼–è¾‘åˆ†ç±»
                                            </button>
                                            <button class="quick-action-btn" @click="toggleBatchMode" v-if="!batchMode">
                                                æ‰¹é‡æ“ä½œ
                                            </button>
                                        </div>
                                        
                                        <div class="knowledge-tools-right">
                                            <select class="sort-selector" v-model="currentSort" @change="applySort">
                                                <option value="newest">æœ€æ–°ä¼˜å…ˆ</option>
                                                <option value="oldest">æœ€æ—©ä¼˜å…ˆ</option>
                                                <option value="title_asc">æ ‡é¢˜ A-Z</option>
                                                <option value="title_desc">æ ‡é¢˜ Z-A</option>
                                            </select>
                                            
                                            <div class="view-toggle">
                                                <button class="view-btn" :class="{active: viewMode === 'grid'}" @click="viewMode = 'grid'">
                                                    ç½‘æ ¼
                                                </button>
                                                <button class="view-btn" :class="{active: viewMode === 'list'}" @click="viewMode = 'list'">
                                                    åˆ—è¡¨
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- æ‰¹é‡æ“ä½œé¢æ¿ -->
                                    <div v-if="batchMode" class="batch-actions">
                                        <input type="checkbox" class="batch-checkbox" v-model="selectAll" @change="toggleSelectAll">
                                        <div class="batch-info">
                                            å·²é€‰æ‹© {{ selectedNotes.length }} ç¯‡ç¬”è®°
                                        </div>
                                        <button class="batch-cancel-btn" @click="cancelBatchMode">
                                            å–æ¶ˆ
                                        </button>
                                        <button class="batch-delete-btn" @click="deleteSelectedNotes" :disabled="selectedNotes.length === 0">
                                            åˆ é™¤é€‰ä¸­ ({{ selectedNotes.length }})
                                        </button>
                                    </div>
                                    
                                    <!-- æœç´¢é¢æ¿ -->
                                    <div class="export-import-panel" v-if="showExportPanel || showImportPanel">
                                        <div class="export-import-header">
                                            <h3>{{ showExportPanel ? 'å¯¼å‡ºæ•°æ®' : 'å¯¼å…¥æ•°æ®' }}</h3>
                                            <button class="close-knowledge-editor" @click="closeExportImportPanel" style="padding: 8px 16px; font-size: 0.9em;">
                                                å…³é—­
                                            </button>
                                        </div>
                                        
                                        <div v-if="showExportPanel">
                                            <p style="color: #7a6a62; margin-bottom: 15px;">
                                                é€‰æ‹©å¯¼å‡ºæ ¼å¼ï¼Œæ•°æ®å°†ä¸‹è½½åˆ°æ‚¨çš„ç”µè„‘
                                            </p>
                                            
                                            <div class="export-formats">
                                                <div class="format-option" :class="{selected: exportFormat === 'json'}" @click="exportFormat = 'json'">
                                                    <div class="format-icon">ğŸ“„</div>
                                                    <div class="format-name">JSON æ ¼å¼</div>
                                                    <div class="format-desc">å®Œæ•´æ•°æ®ï¼Œé€‚åˆå¤‡ä»½å’Œè¿ç§»</div>
                                                </div>
                                                
                                                <div class="format-option" :class="{selected: exportFormat === 'markdown'}" @click="exportFormat = 'markdown'">
                                                    <div class="format-icon">ğŸ“</div>
                                                    <div class="format-name">Markdown æ ¼å¼</div>
                                                    <div class="format-desc">çº¯æ–‡æœ¬ï¼Œé€‚åˆé˜…è¯»å’Œç¼–è¾‘</div>
                                                </div>
                                                
                                                <div class="format-option" :class="{selected: exportFormat === 'html'}" @click="exportFormat = 'html'">
                                                    <div class="format-icon">ğŸŒ</div>
                                                    <div class="format-name">HTML æ ¼å¼</div>
                                                    <div class="format-desc">ç½‘é¡µæ ¼å¼ï¼Œé€‚åˆåˆ†äº«å’Œå‘å¸ƒ</div>
                                                </div>
                                            </div>
                                            
                                            <div style="margin-top: 20px;">
                                                <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #5a4a42;">
                                                    <input type="checkbox" v-model="exportIncludeCategories"> åŒ…å«åˆ†ç±»
                                                </label>
                                                <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #5a4a42;">
                                                    <input type="checkbox" v-model="exportIncludeNotes"> åŒ…å«ç¬”è®°
                                                </label>
                                                <label style="display: block; margin-bottom: 15px; font-weight: 600; color: #5a4a42;">
                                                    <input type="checkbox" v-model="exportOnlyCurrentCategory"> ä»…å½“å‰åˆ†ç±»
                                                </label>
                                            </div>
                                            
                                            <button class="btn" @click="exportData" style="width: 100%;">
                                                å¯¼å‡ºæ•°æ®
                                            </button>
                                        </div>
                                        
                                        <div v-if="showImportPanel">
                                            <p style="color: #7a6a62; margin-bottom: 15px;">
                                                é€‰æ‹©è¦å¯¼å…¥çš„æ•°æ®æ–‡ä»¶ (JSONæ ¼å¼)
                                            </p>
                                            
                                            <input type="file" id="import-file" @change="handleFileImport" accept=".json" style="display: none;">
                                            
                                            <div style="text-align: center; padding: 30px; border: 2px dashed #4ecdc4; border-radius: 12px; margin-bottom: 20px;">
                                                <div style="font-size: 3em; margin-bottom: 15px;">ğŸ“¥</div>
                                                <div style="margin-bottom: 15px; color: #5a4a42;">
                                                    æ‹–æ‹½æ–‡ä»¶åˆ°è¿™é‡Œï¼Œæˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶
                                                </div>
                                                <button class="btn" @click="document.getElementById('import-file').click()">
                                                    é€‰æ‹©æ–‡ä»¶
                                                </button>
                                            </div>
                                            
                                            <div style="margin-top: 15px;">
                                                <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #5a4a42;">
                                                    <input type="checkbox" v-model="importMerge"> åˆå¹¶åˆ°ç°æœ‰æ•°æ® (ä¸å‹¾é€‰å°†æ›¿æ¢å…¨éƒ¨æ•°æ®)
                                                </label>
                                                <label style="display: block; margin-bottom: 15px; font-weight: 600; color: #5a4a42;">
                                                    <input type="checkbox" v-model="importBackupFirst"> å¯¼å…¥å‰å¤‡ä»½å½“å‰æ•°æ®
                                                </label>
                                            </div>
                                            
                                            <button class="btn" @click="importData" :disabled="!importFileContent" style="width: 100%;">
                                                {{ importFileContent ? 'å¯¼å…¥æ•°æ®' : 'è¯·å…ˆé€‰æ‹©æ–‡ä»¶' }}
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- æœç´¢æ¡† -->
                                    <div class="knowledge-base-search" style="position: relative;">
                                        <div class="knowledge-base-search-icon">ğŸ”</div>
                                        <input 
                                            type="text" 
                                            v-model="knowledgeSearch" 
                                            placeholder="æœç´¢å½“å‰åˆ†ç±»çš„ç¬”è®°..."
                                            @input="filterKnowledgeNotes"
                                            @keydown.ctrl.f.prevent="focusSearch"
                                            ref="searchInput"
                                        >
                                        <button class="search-toggle" @click="showAdvancedSearch = !showAdvancedSearch">
                                            {{ showAdvancedSearch ? 'éšè—é«˜çº§æœç´¢' : 'é«˜çº§æœç´¢' }}
                                        </button>
                                    </div>
                                    
                                    <!-- é«˜çº§æœç´¢ -->
                                    <div v-if="showAdvancedSearch" class="search-advanced">
                                        <div class="search-fields">
                                            <div class="search-field">
                                                <label>æœç´¢èŒƒå›´</label>
                                                <select v-model="searchScope">
                                                    <option value="all">æ ‡é¢˜å’Œå†…å®¹</option>
                                                    <option value="title">ä»…æ ‡é¢˜</option>
                                                    <option value="content">ä»…å†…å®¹</option>
                                                    <option value="tags">ä»…æ ‡ç­¾</option>
                                                </select>
                                            </div>
                                            
                                            <div class="search-field">
                                                <label>æ—¶é—´èŒƒå›´</label>
                                                <select v-model="searchTimeRange">
                                                    <option value="all">å…¨éƒ¨æ—¶é—´</option>
                                                    <option value="today">ä»Šå¤©</option>
                                                    <option value="week">æœ¬å‘¨</option>
                                                    <option value="month">æœ¬æœˆ</option>
                                                    <option value="year">ä»Šå¹´</option>
                                                </select>
                                            </div>
                                            
                                            <div class="search-field">
                                                <label>æ’åºæ–¹å¼</label>
                                                <select v-model="searchSort">
                                                    <option value="relevance">ç›¸å…³æ€§</option>
                                                    <option value="newest">æœ€æ–°</option>
                                                    <option value="oldest">æœ€æ—§</option>
                                                </select>
                                            </div>
                                        </div>
                                        
                                        <button class="btn-sm" @click="applyAdvancedSearch" style="width: 100%;">
                                            åº”ç”¨æœç´¢æ¡ä»¶
                                        </button>
                                    </div>
                                    
                                    <!-- å¿«é€Ÿç­›é€‰ -->
                                    <div class="quick-filters" v-if="categoryTags.length > 0">
                                        <span class="quick-filter" 
                                              :class="{active: activeTagFilter === 'all'}"
                                              @click="setTagFilter('all')">
                                            å…¨éƒ¨
                                        </span>
                                        <span class="quick-filter" 
                                              v-for="tag in categoryTags" 
                                              :key="tag"
                                              :class="{active: activeTagFilter === tag}"
                                              @click="setTagFilter(tag)">
                                            {{ tag }}
                                        </span>
                                    </div>
                                    
                                    <!-- ç¬”è®°åˆ—è¡¨ -->
                                    <div v-if="filteredKnowledgeNotes.length === 0 && !loadingMore" class="empty-state">
                                        <div class="empty-state-icon">
                                            {{ knowledgeSearch ? 'ğŸ”' : 'ğŸ“' }}
                                        </div>
                                        <div class="empty-state-text">
                                            {{ knowledgeSearch ? 'æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„ç¬”è®°' : 'è¿™ä¸ªåˆ†ç±»è¿˜æ²¡æœ‰ç¬”è®°ï¼Œç‚¹å‡»"æ–°å»ºç¬”è®°"å¼€å§‹è®°å½•' }}
                                        </div>
                                        <button v-if="!knowledgeSearch" class="btn-sm" @click="openKnowledgeEditor(null)" style="background: linear-gradient(90deg, #9d7bff, #6a5af9); padding: 10px 20px;">
                                            + åˆ›å»ºç¬¬ä¸€ç¯‡ç¬”è®°
                                        </button>
                                    </div>
                                    
                                    <div v-else>
                                        <div class="knowledge-notes-grid" :class="{'list-view': viewMode === 'list'}">
                                            <div v-for="note in paginatedNotes" 
                                                 :key="note.id" 
                                                 class="knowledge-note-card"
                                                 :class="{selected: selectedNotes.includes(note.id), 'list-view': viewMode === 'list'}"
                                                 @click="batchMode ? toggleNoteSelection(note.id) : openNoteView(note)">
                                                
                                                <input v-if="batchMode" type="checkbox" class="note-checkbox" 
                                                       :checked="selectedNotes.includes(note.id)"
                                                       @click.stop="toggleNoteSelection(note.id)">
                                                
                                                <div v-if="!batchMode && note.tags && note.tags.length > 0" class="note-count-badge">
                                                    {{ note.tags.length }} æ ‡ç­¾
                                                </div>
                                                
                                                <div class="knowledge-note-title" v-html="highlightText(note.title)"></div>
                                                
                                                <div v-if="viewMode === 'grid'" class="knowledge-note-content" v-html="highlightText(formatNotePreview(note.content))"></div>
                                                <div v-else class="list-view-content">
                                                    <div class="knowledge-note-content" v-html="highlightText(formatNotePreview(note.content))"></div>
                                                    <div class="knowledge-note-footer">
                                                        <div class="knowledge-note-date">{{ formatDateShort(note.updatedAt || note.createdAt) }}</div>
                                                        <div class="knowledge-note-actions">
                                                            <button class="btn-sm" @click.stop="openKnowledgeEditor(note)" style="font-size: 0.8em; padding: 5px 10px;">
                                                                ç¼–è¾‘
                                                            </button>
                                                            <button class="btn-sm" @click.stop="deleteKnowledgeNote(note.id)" style="background: #ff7875; font-size: 0.8em; padding: 5px 10px;">
                                                                åˆ é™¤
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <div v-if="viewMode === 'grid'" class="knowledge-note-footer">
                                                    <div class="knowledge-note-date">{{ formatDateShort(note.updatedAt || note.createdAt) }}</div>
                                                    <div class="knowledge-note-actions">
                                                        <button class="btn-sm" @click.stop="openKnowledgeEditor(note)" style="font-size: 0.8em; padding: 5px 10px;">
                                                            ç¼–è¾‘
                                                        </button>
                                                        <button class="btn-sm" @click.stop="deleteKnowledgeNote(note.id)" style="background: #ff7875; font-size: 0.8em; padding: 5px 10px;">
                                                            åˆ é™¤
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- åˆ†é¡µæ§åˆ¶ -->
                                        <div v-if="totalPages > 1" class="pagination-controls">
                                            <button class="pagination-btn" @click="prevPage" :disabled="currentPage === 1">
                                                ä¸Šä¸€é¡µ
                                            </button>
                                            
                                            <div class="page-info">
                                                ç¬¬ {{ currentPage }} é¡µ / å…± {{ totalPages }} é¡µ
                                                (å…± {{ filteredKnowledgeNotes.length }} ç¯‡ç¬”è®°)
                                            </div>
                                            
                                            <button class="pagination-btn" @click="nextPage" :disabled="currentPage === totalPages">
                                                ä¸‹ä¸€é¡µ
                                            </button>
                                        </div>
                                        
                                        <!-- åŠ è½½æ›´å¤š -->
                                        <div v-if="currentPage < totalPages && !loadingMore" style="text-align: center; margin-top: 20px;">
                                            <button class="btn-sm" @click="loadMore" style="background: linear-gradient(90deg, #4ecdc4, #2ba69b);">
                                                åŠ è½½æ›´å¤š ({{ filteredKnowledgeNotes.length - currentPage * pageSize }} ç¯‡)
                                            </button>
                                        </div>
                                        
                                        <div v-if="loadingMore" class="loading-more">
                                            <div class="loading-spinner" style="margin-right: 10px;"></div>
                                            åŠ è½½ä¸­...
                                        </div>
                                    </div>
                                </div>
                                
                                <div v-else-if="!selectedCategoryId && !loadingKnowledgeData" class="empty-state">
                                    <div class="empty-state-icon">ğŸ“š</div>
                                    <div class="empty-state-text">è¯·é€‰æ‹©ä¸€ä¸ªåˆ†ç±»ï¼Œæˆ–åˆ›å»ºä¸€ä¸ªæ–°åˆ†ç±»</div>
                                </div>
                                
                                <div v-else class="knowledge-base-loading">
                                    <div class="loading-spinner"></div>
                                    <span>åŠ è½½ä¸­...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- çŸ¥è¯†åº“ç¬”è®°ç¼–è¾‘å™¨ï¼ˆåŸæœ‰ï¼‰ -->
                <div v-if="showKnowledgeEditor" class="knowledge-editor-modal">
                    <!-- åŸæœ‰ç¼–è¾‘å™¨å†…å®¹ -->
                </div>
                
                <!-- åˆ†ç±»ç¼–è¾‘å™¨ï¼ˆåŸæœ‰ï¼‰ -->
                <div v-if="showCategoryEditor" class="category-editor-modal">
                    <!-- åŸæœ‰ç¼–è¾‘å™¨å†…å®¹ -->
                </div>
                
                <!-- ç¬”è®°æŸ¥çœ‹å™¨ï¼ˆåŸæœ‰ï¼‰ -->
                <div v-if="showNoteView" class="knowledge-note-view-modal">
                    <!-- åŸæœ‰æŸ¥çœ‹å™¨å†…å®¹ -->
                </div>
                
                <!-- åŸæœ‰çš„å…¶ä»–å†…å®¹ä¿æŒä¸å˜ -->
                <!-- è¿™é‡Œåº”è¯¥æœ‰æ‰€æœ‰åŸæœ‰çš„HTMLå†…å®¹ -->
                <!-- ä¸ºäº†èŠ‚çœç¯‡å¹…ï¼Œæˆ‘å‡è®¾æ‰€æœ‰åŸæœ‰å†…å®¹éƒ½å·²å­˜åœ¨ -->
                <!-- æ‚¨éœ€è¦å°†åŸæœ‰çš„æ‰€æœ‰å†…å®¹æ”¾åœ¨è¿™é‡Œ -->
                
            </div>
        </div>
    </div>
    <script type="module">
        const { createApp } = Vue;
        const sb = supabase.createClient(
            'https://zqmgigcnruvvdcholbuj.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpxbWdpZ2NucnV2dmRjaG9sYnVqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4NjgzNjEsImV4cCI6MjA4MTQ0NDM2MX0.IHzDp7o5M9QM8IBWy2ri5gS9h9nm0zk3AaPTNveDqXI'
        );
        
        createApp({
            data() {
                return {
                    // åŸæœ‰çš„æ‰€æœ‰æ•°æ®
                    // è¿™é‡Œåº”è¯¥æœ‰æ‰€æœ‰åŸæœ‰çš„æ•°æ®
                    
                    // æ–°å¢çŸ¥è¯†åº“åŠŸèƒ½æ•°æ®
                    batchMode: false,
                    selectedNotes: [],
                    selectAll: false,
                    
                    showExportPanel: false,
                    showImportPanel: false,
                    exportFormat: 'json',
                    exportIncludeCategories: true,
                    exportIncludeNotes: true,
                    exportOnlyCurrentCategory: false,
                    
                    importMerge: true,
                    importBackupFirst: true,
                    importFileContent: null,
                    
                    showAdvancedSearch: false,
                    searchScope: 'all',
                    searchTimeRange: 'all',
                    searchSort: 'relevance',
                    
                    activeTagFilter: 'all',
                    
                    currentSort: 'newest',
                    viewMode: 'grid',
                    
                    // åˆ†é¡µç›¸å…³
                    currentPage: 1,
                    pageSize: 12,
                    loadingMore: false,
                    
                    // è‡ªåŠ¨ä¿å­˜
                    autoSave: true,
                    autoSaveInterval: null,
                    
                    // é”®ç›˜å¿«æ·é”®çŠ¶æ€
                    shortcutsEnabled: true
                };
            },
            computed: {
                // åŸæœ‰çš„æ‰€æœ‰è®¡ç®—å±æ€§
                // è¿™é‡Œåº”è¯¥æœ‰æ‰€æœ‰åŸæœ‰çš„è®¡ç®—å±æ€§
                
                // æ–°å¢è®¡ç®—å±æ€§
                categoryNotes() {
                    if (!this.selectedCategoryId) return [];
                    let notes = this.knowledgeNotes.filter(note => note.categoryId === this.selectedCategoryId);
                    
                    // åº”ç”¨æ ‡ç­¾ç­›é€‰
                    if (this.activeTagFilter && this.activeTagFilter !== 'all') {
                        notes = notes.filter(note => 
                            note.tags && note.tags.includes(this.activeTagFilter)
                        );
                    }
                    
                    return notes;
                },
                
                filteredKnowledgeNotes() {
                    if (!this.selectedCategoryId) return [];
                    
                    let filtered = this.categoryNotes;
                    
                    // æœç´¢ç­›é€‰
                    if (this.knowledgeSearch.trim()) {
                        const searchTerm = this.knowledgeSearch.toLowerCase().trim();
                        
                        filtered = filtered.filter(note => {
                            switch (this.searchScope) {
                                case 'title':
                                    return note.title.toLowerCase().includes(searchTerm);
                                case 'content':
                                    return note.content.toLowerCase().includes(searchTerm);
                                case 'tags':
                                    return note.tags && note.tags.some(tag => 
                                        tag.toLowerCase().includes(searchTerm)
                                    );
                                default: // 'all'
                                    return note.title.toLowerCase().includes(searchTerm) || 
                                           note.content.toLowerCase().includes(searchTerm) ||
                                           (note.tags && note.tags.some(tag => 
                                               tag.toLowerCase().includes(searchTerm)
                                           ));
                            }
                        });
                        
                        // æ—¶é—´èŒƒå›´ç­›é€‰
                        if (this.searchTimeRange !== 'all') {
                            const now = new Date();
                            let startDate;
                            
                            switch (this.searchTimeRange) {
                                case 'today':
                                    startDate = new Date(now.setHours(0, 0, 0, 0));
                                    break;
                                case 'week':
                                    startDate = new Date(now.setDate(now.getDate() - 7));
                                    break;
                                case 'month':
                                    startDate = new Date(now.setMonth(now.getMonth() - 1));
                                    break;
                                case 'year':
                                    startDate = new Date(now.setFullYear(now.getFullYear() - 1));
                                    break;
                            }
                            
                            filtered = filtered.filter(note => {
                                const noteDate = new Date(note.updatedAt || note.createdAt);
                                return noteDate >= startDate;
                            });
                        }
                        
                        // æ’åº
                        switch (this.searchSort) {
                            case 'newest':
                                filtered.sort((a, b) => 
                                    new Date(b.updatedAt || b.createdAt) - new Date(a.updatedAt || a.createdAt)
                                );
                                break;
                            case 'oldest':
                                filtered.sort((a, b) => 
                                    new Date(a.updatedAt || a.createdAt) - new Date(b.updatedAt || b.createdAt)
                                );
                                break;
                            // relevance æ’åºéœ€è¦æ›´å¤æ‚çš„ç®—æ³•ï¼Œè¿™é‡Œç®€å•å¤„ç†
                            case 'relevance':
                                filtered.sort((a, b) => {
                                    const aTitleMatch = a.title.toLowerCase().includes(this.knowledgeSearch.toLowerCase());
                                    const bTitleMatch = b.title.toLowerCase().includes(this.knowledgeSearch.toLowerCase());
                                    
                                    if (aTitleMatch && !bTitleMatch) return -1;
                                    if (!aTitleMatch && bTitleMatch) return 1;
                                    
                                    return new Date(b.updatedAt || b.createdAt) - new Date(a.updatedAt || a.createdAt);
                                });
                                break;
                        }
                    } else {
                        // åº”ç”¨æ™®é€šæ’åº
                        this.applyComputedSort(filtered);
                    }
                    
                    return filtered;
                },
                
                paginatedNotes() {
                    const startIndex = (this.currentPage - 1) * this.pageSize;
                    return this.filteredKnowledgeNotes.slice(0, startIndex + this.pageSize);
                },
                
                totalPages() {
                    return Math.ceil(this.filteredKnowledgeNotes.length / this.pageSize);
                },
                
                totalNotesCount() {
                    return this.knowledgeNotes.length;
                },
                
                uniqueTagsCount() {
                    const allTags = new Set();
                    this.knowledgeNotes.forEach(note => {
                        if (note.tags) {
                            note.tags.forEach(tag => allTags.add(tag));
                        }
                    });
                    return allTags.size;
                },
                
                categoryTags() {
                    if (!this.selectedCategoryId) return [];
                    const tags = new Set();
                    this.categoryNotes.forEach(note => {
                        if (note.tags) {
                            note.tags.forEach(tag => tags.add(tag));
                        }
                    });
                    return Array.from(tags).sort();
                },
                
                selectedCategory() {
                    if (!this.selectedCategoryId) return null;
                    return this.knowledgeCategories.find(cat => cat.id === this.selectedCategoryId);
                }
            },
            watch: {
                selectedCategoryId() {
                    this.resetFilters();
                    this.currentPage = 1;
                },
                
                knowledgeSearch() {
                    this.currentPage = 1;
                },
                
                activeTagFilter() {
                    this.currentPage = 1;
                },
                
                currentSort() {
                    this.currentPage = 1;
                }
            },
            methods: {
                // åŸæœ‰çš„æ‰€æœ‰æ–¹æ³•
                // è¿™é‡Œåº”è¯¥æœ‰æ‰€æœ‰åŸæœ‰çš„æ–¹æ³•
                
                // æ–°å¢æ–¹æ³•
                toggleBatchMode() {
                    this.batchMode = !this.batchMode;
                    if (!this.batchMode) {
                        this.selectedNotes = [];
                        this.selectAll = false;
                    }
                },
                
                cancelBatchMode() {
                    this.batchMode = false;
                    this.selectedNotes = [];
                    this.selectAll = false;
                },
                
                toggleNoteSelection(noteId) {
                    const index = this.selectedNotes.indexOf(noteId);
                    if (index === -1) {
                        this.selectedNotes.push(noteId);
                    } else {
                        this.selectedNotes.splice(index, 1);
                    }
                    this.updateSelectAllState();
                },
                
                toggleSelectAll() {
                    if (this.selectAll) {
                        this.selectedNotes = this.filteredKnowledgeNotes.map(note => note.id);
                    } else {
                        this.selectedNotes = [];
                    }
                },
                
                updateSelectAllState() {
                    this.selectAll = this.selectedNotes.length === this.filteredKnowledgeNotes.length && 
                                     this.filteredKnowledgeNotes.length > 0;
                },
                
                async deleteSelectedNotes() {
                    if (this.selectedNotes.length === 0) return;
                    
                    if (!confirm(`ç¡®å®šåˆ é™¤é€‰ä¸­çš„ ${this.selectedNotes.length} ç¯‡ç¬”è®°å—ï¼Ÿ`)) {
                        return;
                    }
                    
                    try {
                        // åˆ é™¤é€‰ä¸­çš„ç¬”è®°
                        this.knowledgeNotes = this.knowledgeNotes.filter(
                            note => !this.selectedNotes.includes(note.id)
                        );
                        
                        // ä¿å­˜æ•°æ®
                        await this.saveKnowledgeData();
                        
                        // é‡ç½®æ‰¹é‡æ¨¡å¼
                        this.cancelBatchMode();
                        
                        this.showMessage(`å·²åˆ é™¤ ${this.selectedNotes.length} ç¯‡ç¬”è®°`, 'success');
                    } catch (error) {
                        console.error('æ‰¹é‡åˆ é™¤ç¬”è®°å¤±è´¥:', error);
                        this.showMessage('æ‰¹é‡åˆ é™¤å¤±è´¥', 'error');
                    }
                },
                
                openExportPanel() {
                    this.showExportPanel = true;
                    this.showImportPanel = false;
                },
                
                openImportPanel() {
                    this.showImportPanel = true;
                    this.showExportPanel = false;
                },
                
                closeExportImportPanel() {
                    this.showExportPanel = false;
                    this.showImportPanel = false;
                    this.importFileContent = null;
                },
                
                exportData() {
                    if (!this.exportIncludeCategories && !this.exportIncludeNotes) {
                        this.showMessage('è¯·é€‰æ‹©è¦å¯¼å‡ºçš„å†…å®¹', 'error');
                        return;
                    }
                    
                    const exportData = {
                        meta: {
                            exportDate: new Date().toISOString(),
                            format: this.exportFormat,
                            version: '1.0',
                            userEmail: this.userEmail
                        }
                    };
                    
                    if (this.exportIncludeCategories) {
                        if (this.exportOnlyCurrentCategory && this.selectedCategoryId) {
                            exportData.categories = this.knowledgeCategories.filter(
                                cat => cat.id === this.selectedCategoryId
                            );
                        } else {
                            exportData.categories = this.knowledgeCategories;
                        }
                    }
                    
                    if (this.exportIncludeNotes) {
                        if (this.exportOnlyCurrentCategory && this.selectedCategoryId) {
                            exportData.notes = this.knowledgeNotes.filter(
                                note => note.categoryId === this.selectedCategoryId
                            );
                        } else {
                            exportData.notes = this.knowledgeNotes;
                        }
                    }
                    
                    let content, filename, mimeType;
                    
                    switch (this.exportFormat) {
                        case 'json':
                            content = JSON.stringify(exportData, null, 2);
                            filename = `knowledge_base_${new Date().toISOString().split('T')[0]}.json`;
                            mimeType = 'application/json';
                            break;
                            
                        case 'markdown':
                            content = this.convertToMarkdown(exportData);
                            filename = `knowledge_base_${new Date().toISOString().split('T')[0]}.md`;
                            mimeType = 'text/markdown';
                            break;
                            
                        case 'html':
                            content = this.convertToHTML(exportData);
                            filename = `knowledge_base_${new Date().toISOString().split('T')[0]}.html`;
                            mimeType = 'text/html';
                            break;
                    }
                    
                    this.downloadFile(content, filename, mimeType);
                    this.showMessage('æ•°æ®å¯¼å‡ºæˆåŠŸ', 'success');
                    this.closeExportImportPanel();
                },
                
                downloadFile(content, filename, mimeType) {
                    const blob = new Blob([content], { type: mimeType });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                },
                
                convertToMarkdown(data) {
                    let markdown = `# çŸ¥è¯†åº“å¯¼å‡º\n\n`;
                    markdown += `å¯¼å‡ºæ—¶é—´: ${new Date(data.meta.exportDate).toLocaleString()}\n`;
                    markdown += `ç”¨æˆ·: ${data.meta.userEmail}\n\n`;
                    
                    if (data.categories && data.categories.length > 0) {
                        markdown += `## åˆ†ç±» (${data.categories.length}ä¸ª)\n\n`;
                        data.categories.forEach(category => {
                            markdown += `### ${category.icon} ${category.name}\n`;
                            if (category.description) {
                                markdown += `${category.description}\n`;
                            }
                            markdown += `\n`;
                        });
                    }
                    
                    if (data.notes && data.notes.length > 0) {
                        markdown += `## ç¬”è®° (${data.notes.length}ç¯‡)\n\n`;
                        
                        // æŒ‰åˆ†ç±»åˆ†ç»„ç¬”è®°
                        const notesByCategory = {};
                        data.notes.forEach(note => {
                            const categoryId = note.categoryId;
                            if (!notesByCategory[categoryId]) {
                                notesByCategory[categoryId] = [];
                            }
                            notesByCategory[categoryId].push(note);
                        });
                        
                        // ä¸ºæ¯ä¸ªåˆ†ç±»è¾“å‡ºç¬”è®°
                        Object.keys(notesByCategory).forEach(categoryId => {
                            const category = data.categories?.find(c => c.id == categoryId);
                            const categoryName = category ? `${category.icon} ${category.name}` : `åˆ†ç±»ID: ${categoryId}`;
                            
                            markdown += `### ${categoryName}\n\n`;
                            
                            notesByCategory[categoryId].forEach(note => {
                                markdown += `#### ${note.title}\n`;
                                markdown += `åˆ›å»ºæ—¶é—´: ${new Date(note.createdAt).toLocaleString()}\n`;
                                if (note.tags && note.tags.length > 0) {
                                    markdown += `æ ‡ç­¾: ${note.tags.join(', ')}\n`;
                                }
                                markdown += `\n${note.content}\n\n---\n\n`;
                            });
                        });
                    }
                    
                    return markdown;
                },
                
                convertToHTML(data) {
                    let html = `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çŸ¥è¯†åº“å¯¼å‡º</title>
    <style>
        body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; max-width: 800px; margin: 0 auto; padding: 20px; }
        h1 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
        h2 { color: #34495e; margin-top: 30px; }
        h3 { color: #16a085; }
        .category { background: #f8f9fa; border-left: 4px solid #3498db; padding: 15px; margin: 20px 0; }
        .note { background: white; border: 1px solid #ddd; padding: 15px; margin: 15px 0; border-radius: 5px; }
        .note-title { color: #2c3e50; margin-top: 0; }
        .meta { color: #7f8c8d; font-size: 0.9em; margin-bottom: 10px; }
        .tags { margin-top: 10px; }
        .tag { display: inline-block; background: #e8f4fc; color: #3498db; padding: 3px 8px; border-radius: 3px; margin-right: 5px; font-size: 0.8em; }
        .content { margin-top: 15px; }
    </style>
</head>
<body>
    <h1>ğŸ“š çŸ¥è¯†åº“å¯¼å‡º</h1>
                    `;
                    
                    html += `<div class="meta">å¯¼å‡ºæ—¶é—´: ${new Date(data.meta.exportDate).toLocaleString()}</div>`;
                    html += `<div class="meta">ç”¨æˆ·: ${data.meta.userEmail}</div>`;
                    
                    if (data.categories && data.categories.length > 0) {
                        html += `<h2>åˆ†ç±» (${data.categories.length}ä¸ª)</h2>`;
                        data.categories.forEach(category => {
                            html += `<div class="category">
                                <h3>${category.icon} ${category.name}</h3>
                                ${category.description ? `<p>${category.description}</p>` : ''}
                            </div>`;
                        });
                    }
                    
                    if (data.notes && data.notes.length > 0) {
                        html += `<h2>ç¬”è®° (${data.notes.length}ç¯‡)</h2>`;
                        
                        // æŒ‰åˆ†ç±»åˆ†ç»„ç¬”è®°
                        const notesByCategory = {};
                        data.notes.forEach(note => {
                            const categoryId = note.categoryId;
                            if (!notesByCategory[categoryId]) {
                                notesByCategory[categoryId] = [];
                            }
                            notesByCategory[categoryId].push(note);
                        });
                        
                        // ä¸ºæ¯ä¸ªåˆ†ç±»è¾“å‡ºç¬”è®°
                        Object.keys(notesByCategory).forEach(categoryId => {
                            const category = data.categories?.find(c => c.id == categoryId);
                            const categoryName = category ? `${category.icon} ${category.name}` : `åˆ†ç±»ID: ${categoryId}`;
                            
                            html += `<h3>${categoryName}</h3>`;
                            
                            notesByCategory[categoryId].forEach(note => {
                                html += `<div class="note">
                                    <h4 class="note-title">${note.title}</h4>
                                    <div class="meta">
                                        åˆ›å»ºæ—¶é—´: ${new Date(note.createdAt).toLocaleString()}
                                        ${note.updatedAt !== note.createdAt ? 
                                            ` | æ›´æ–°æ—¶é—´: ${new Date(note.updatedAt).toLocaleString()}` : ''}
                                    </div>
                                    ${note.tags && note.tags.length > 0 ? 
                                        `<div class="tags">æ ‡ç­¾: ${note.tags.map(tag => 
                                            `<span class="tag">${tag}</span>`).join(' ')}</div>` : ''}
                                    <div class="content">${this.renderMarkdown(note.content)}</div>
                                </div>`;
                            });
                        });
                    }
                    
                    html += `
    <footer style="margin-top: 50px; padding-top: 20px; border-top: 1px solid #ddd; color: #7f8c8d; text-align: center;">
        ä½¿ç”¨æˆé•¿æ‰‹è´¦çŸ¥è¯†åº“å¯¼å‡º â€¢ ${new Date().getFullYear()}
    </footer>
</body>
</html>`;
                    
                    return html;
                },
                
                handleFileImport(event) {
                    const file = event.target.files[0];
                    if (!file) return;
                    
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const content = JSON.parse(e.target.result);
                            this.importFileContent = content;
                            this.showMessage('æ–‡ä»¶è¯»å–æˆåŠŸ', 'success');
                        } catch (error) {
                            this.showMessage('æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼Œè¯·é€‰æ‹©æ­£ç¡®çš„JSONæ–‡ä»¶', 'error');
                            this.importFileContent = null;
                        }
                    };
                    reader.readAsText(file);
                },
                
                async importData() {
                    if (!this.importFileContent) {
                        this.showMessage('è¯·å…ˆé€‰æ‹©è¦å¯¼å…¥çš„æ–‡ä»¶', 'error');
                        return;
                    }
                    
                    try {
                        // å¤‡ä»½å½“å‰æ•°æ®
                        if (this.importBackupFirst) {
                            const backupData = {
                                categories: [...this.knowledgeCategories],
                                notes: [...this.knowledgeNotes],
                                backupDate: new Date().toISOString()
                            };
                            localStorage.setItem(
                                `knowledge_backup_${new Date().toISOString()}`,
                                JSON.stringify(backupData)
                            );
                        }
                        
                        // å¯¼å…¥æ•°æ®
                        if (this.importMerge) {
                            // åˆå¹¶æ•°æ®
                            const existingCategoryIds = new Set(this.knowledgeCategories.map(c => c.id));
                            const existingNoteIds = new Set(this.knowledgeNotes.map(n => n.id));
                            
                            // åˆå¹¶åˆ†ç±»
                            if (this.importFileContent.categories) {
                                this.importFileContent.categories.forEach(category => {
                                    if (!existingCategoryIds.has(category.id)) {
                                        this.knowledgeCategories.push(category);
                                    }
                                });
                            }
                            
                            // åˆå¹¶ç¬”è®°
                            if (this.importFileContent.notes) {
                                this.importFileContent.notes.forEach(note => {
                                    if (!existingNoteIds.has(note.id)) {
                                        this.knowledgeNotes.push(note);
                                    }
                                });
                            }
                            
                            this.showMessage('æ•°æ®åˆå¹¶æˆåŠŸ', 'success');
                        } else {
                            // æ›¿æ¢æ•°æ®
                            this.knowledgeCategories = this.importFileContent.categories || [];
                            this.knowledgeNotes = this.importFileContent.notes || [];
                            this.showMessage('æ•°æ®æ›¿æ¢æˆåŠŸ', 'success');
                        }
                        
                        // ä¿å­˜æ•°æ®
                        await this.saveKnowledgeData();
                        
                        // é‡ç½®å¯¼å…¥
                        this.closeExportImportPanel();
                        document.getElementById('import-file').value = '';
                        
                    } catch (error) {
                        console.error('å¯¼å…¥æ•°æ®å¤±è´¥:', error);
                        this.showMessage('å¯¼å…¥æ•°æ®å¤±è´¥', 'error');
                    }
                },
                
                applyAdvancedSearch() {
                    this.currentPage = 1;
                },
                
                setTagFilter(tag) {
                    this.activeTagFilter = tag;
                },
                
                resetFilters() {
                    this.knowledgeSearch = '';
                    this.showAdvancedSearch = false;
                    this.searchScope = 'all';
                    this.searchTimeRange = 'all';
                    this.searchSort = 'relevance';
                    this.activeTagFilter = 'all';
                    this.currentPage = 1;
                },
                
                applySort() {
                    this.currentPage = 1;
                },
                
                applyComputedSort(notes) {
                    switch (this.currentSort) {
                        case 'newest':
                            notes.sort((a, b) => 
                                new Date(b.updatedAt || b.createdAt) - new Date(a.updatedAt || a.createdAt)
                            );
                            break;
                        case 'oldest':
                            notes.sort((a, b) => 
                                new Date(a.updatedAt || a.createdAt) - new Date(b.updatedAt || b.createdAt)
                            );
                            break;
                        case 'title_asc':
                            notes.sort((a, b) => a.title.localeCompare(b.title));
                            break;
                        case 'title_desc':
                            notes.sort((a, b) => b.title.localeCompare(a.title));
                            break;
                    }
                    return notes;
                },
                
                prevPage() {
                    if (this.currentPage > 1) {
                        this.currentPage--;
                    }
                },
                
                nextPage() {
                    if (this.currentPage < this.totalPages) {
                        this.currentPage++;
                    }
                },
                
                loadMore() {
                    if (this.currentPage < this.totalPages) {
                        this.loadingMore = true;
                        setTimeout(() => {
                            this.currentPage++;
                            this.loadingMore = false;
                        }, 300);
                    }
                },
                
                highlightText(text) {
                    if (!this.knowledgeSearch.trim() || !text) {
                        return this.escapeHtml(text || '');
                    }
                    
                    const searchTerm = this.knowledgeSearch.toLowerCase();
                    const escapedText = this.escapeHtml(text);
                    
                    // ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼é«˜äº®åŒ¹é…çš„æ–‡æœ¬
                    const regex = new RegExp(`(${this.escapeRegExp(searchTerm)})`, 'gi');
                    return escapedText.replace(regex, '<span class="search-highlight">$1</span>');
                },
                
                escapeHtml(text) {
                    const div = document.createElement('div');
                    div.textContent = text;
                    return div.innerHTML;
                },
                
                escapeRegExp(string) {
                    return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                },
                
                getCategoryNoteCount(categoryId) {
                    return this.knowledgeNotes.filter(note => note.categoryId === categoryId).length;
                },
                
                toggleAutoSave() {
                    if (this.autoSave) {
                        this.startAutoSave();
                    } else {
                        this.stopAutoSave();
                    }
                },
                
                startAutoSave() {
                    this.stopAutoSave(); // å…ˆåœæ­¢ç°æœ‰çš„å®šæ—¶å™¨
                    this.autoSaveInterval = setInterval(() => {
                        this.saveKnowledgeData();
                    }, 30000); // æ¯30ç§’è‡ªåŠ¨ä¿å­˜ä¸€æ¬¡
                },
                
                stopAutoSave() {
                    if (this.autoSaveInterval) {
                        clearInterval(this.autoSaveInterval);
                        this.autoSaveInterval = null;
                    }
                },
                
                focusSearch() {
                    if (this.showKnowledgeBase && this.$refs.searchInput) {
                        this.$refs.searchInput.focus();
                    }
                },
                
                setupKeyboardShortcuts() {
                    document.addEventListener('keydown', (e) => {
                        if (!this.showKnowledgeBase || !this.shortcutsEnabled) return;
                        
                        // Ctrl+N: æ–°å»ºç¬”è®°
                        if (e.ctrlKey && e.key === 'n') {
                            e.preventDefault();
                            this.openKnowledgeEditor(null);
                        }
                        
                        // Ctrl+F: èšç„¦æœç´¢æ¡†
                        if (e.ctrlKey && e.key === 'f') {
                            e.preventDefault();
                            this.focusSearch();
                        }
                        
                        // Ctrl+S: ä¿å­˜
                        if (e.ctrlKey && e.key === 's' && this.showKnowledgeEditor) {
                            e.preventDefault();
                            this.saveKnowledgeNote();
                        }
                        
                        // Esc: å…³é—­
                        if (e.key === 'Escape') {
                            if (this.showKnowledgeEditor) {
                                this.closeKnowledgeEditor();
                            } else if (this.showCategoryEditor) {
                                this.closeCategoryEditor();
                            } else if (this.showNoteView) {
                                this.closeNoteView();
                            } else if (this.showExportPanel || this.showImportPanel) {
                                this.closeExportImportPanel();
                            }
                        }
                    });
                },
                
                formatNotePreview(content) {
                    // åŸæœ‰çš„é¢„è§ˆæ ¼å¼åŒ–æ–¹æ³•
                    // è¿™é‡Œåº”è¯¥æœ‰åŸæœ‰çš„formatNotePreviewæ–¹æ³•å®ç°
                    return content || '';
                },
                
                async saveKnowledgeData() {
                    // åŸæœ‰çš„ä¿å­˜æ•°æ®æ–¹æ³•
                    // è¿™é‡Œåº”è¯¥æœ‰åŸæœ‰çš„saveKnowledgeDataæ–¹æ³•å®ç°
                    console.log('ä¿å­˜çŸ¥è¯†åº“æ•°æ®');
                }
            },
            
            async mounted() {
                // åŸæœ‰çš„mountedä»£ç 
                // è¿™é‡Œåº”è¯¥æœ‰åŸæœ‰çš„mountedæ–¹æ³•å®ç°
                
                // è®¾ç½®é”®ç›˜å¿«æ·é”®
                this.setupKeyboardShortcuts();
                
                // å¯åŠ¨è‡ªåŠ¨ä¿å­˜
                if (this.autoSave) {
                    this.startAutoSave();
                }
            },
            
            beforeUnmount() {
                // æ¸…ç†è‡ªåŠ¨ä¿å­˜å®šæ—¶å™¨
                this.stopAutoSave();
            }
        }).mount('#app');
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆé•¿æ‰‹è´¦ - ç¨³å®šä¿®å¤ç‰ˆ</title>
    <!-- æ ¸å¿ƒåº“ï¼šä½¿ç”¨å¯é çš„ CDN -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* ========== å…¨å±€æ ·å¼ (æš–è‰²æ‰‹è´¦é£) ========== */
        :root {
            --bg-color: #fef9f3;
            --text-color: #5a4a42;
            --accent-pink: #ff9a8b;
            --accent-green: #a3de83;
            --card-border: 2.5px solid #5a4a42;
            --card-shadow: 6px 6px 0px #d4b8a7;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Noto Sans SC', sans-serif;
            background: var(--bg-color);
            min-height: 100vh;
            color: var(--text-color);
            padding: 20px;
        }

        .container { max-width: 1400px; margin: 0 auto; }

        /* å¤´éƒ¨ */
        .header {
            text-align: center; margin-bottom: 30px; padding: 30px;
            background: #fffaf0; border-radius: 24px;
            box-shadow: 8px 8px 0px #e0c9b8; border: 3px solid #5a4a42;
            display: flex; flex-direction: column; align-items: center; position: relative;
        }
        .header h1 { font-size: 2.2em; font-weight: 700; text-shadow: 3px 3px 0px #ffd6cc; margin-bottom: 10px; }

        /* æœç´¢æ¡† */
        .search-bar { position: absolute; right: 20px; top: 20px; }
        .search-input {
            padding: 8px 12px; border-radius: 20px; border: 2px solid #e0c9b8; 
            outline: none; background: rgba(255,255,255,0.8); transition: width 0.3s; width: 150px;
        }
        .search-input:focus { width: 220px; border-color: #ff9a8b; }

        /* å¸ƒå±€ */
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 30px; margin-bottom: 40px; }
        
        /* é€šç”¨å¡ç‰‡ */
        .card {
            background: #fffefc; border-radius: 20px; padding: 30px;
            box-shadow: var(--card-shadow); border: var(--card-border);
            transition: transform 0.3s; position: relative; display: flex; flex-direction: column;
        }
        .card:hover { transform: translateY(-3px); }
        .card h2 {
            margin-bottom: 20px; padding-bottom: 15px; border-bottom: 3px dotted #ff9a8b;
            font-size: 1.4em; font-weight: 700; display: flex; justify-content: space-between; align-items: center;
        }

        /* æŒ‰é’® */
        .btn {
            background: linear-gradient(90deg, #ff9a8b, #ff6b6b); border: none; padding: 12px 30px;
            border-radius: 50px; color: white; cursor: pointer; font-size: 16px; font-weight: 700;
            box-shadow: 4px 4px 0px #d45d5d; transition: all 0.2s; width: 100%;
        }
        .btn:hover:not(:disabled) { transform: translateY(-2px); }
        .btn-sm {
            padding: 6px 15px; font-size: 0.9em; border-radius: 20px;
            background: linear-gradient(90deg, #4ecdc4, #a3de83);
            box-shadow: 3px 3px 0px #2ba69b; border: none; color: white; font-weight: bold; cursor: pointer;
        }
        .btn-danger { background: #ff6b6b; box-shadow: 3px 3px 0px #c0392b; }
        .collapse-btn {
            background: #fffaf5; border: 2px solid #ff9a8b; color: #ff6b6b;
            padding: 4px 12px; border-radius: 12px; font-size: 0.8em; font-weight: bold; cursor: pointer;
        }

        /* è¾“å…¥æ¡† */
        .note-input, .note-textarea {
            width: 100%; padding: 12px; border: 2px solid #e0c9b8; border-radius: 12px;
            font-size: 15px; margin-bottom: 15px; background: #fffaf9; font-family: inherit;
        }
        .note-input:focus, .note-textarea:focus { outline: none; border-color: #ff9a8b; box-shadow: 2px 2px 0px #ffd6cc; }

        /* ç‰¹æ®Šæ¿å—æ ·å¼ */
        .quest-list { margin-top: 15px; background: #fffaf5; padding: 10px; border-radius: 12px; border: 1px solid #e0c9b8; }
        .quest-item {
            display: flex; align-items: center; padding: 10px; margin-bottom: 8px; 
            background: white; border-radius: 8px; border: 1px solid #eee; cursor: pointer; transition: all 0.2s;
        }
        .quest-item:hover { transform: translateX(5px); border-color: #a3de83; }
        .quest-item.done { background: #e8f5e9; opacity: 0.7; text-decoration: line-through; border-color: #a3de83; }

        .shop-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; margin-top: 15px; }
        .shop-item {
            text-align: center; padding: 10px; border: 2px solid #e0c9b8; border-radius: 10px; 
            cursor: pointer; background: white; transition: all 0.2s;
        }
        .shop-item:hover { background: #fff0eb; border-color: #ff9a8b; }

        .goal-item {
            background: #fffaf5; border: 2px solid #e0c9b8; border-radius: 15px; padding: 20px;
            margin-bottom: 15px; transition: all 0.3s;
        }
        .goal-progress-bg { height: 16px; background: #eee; border-radius: 8px; overflow: hidden; border: 1px solid #ddd; margin: 10px 0; }
        .goal-progress-fill { height: 100%; background: linear-gradient(90deg, #4ecdc4, #a3de83); transition: width 0.5s; }
        
        .tag-badge { 
            display: inline-block; background: #9fa8da; color: white; 
            padding: 2px 8px; border-radius: 10px; font-size: 0.8em; margin-right: 5px; 
        }

        .login-box { max-width: 400px; margin: 100px auto; text-align: center; }
        .status-message { padding: 10px; border-radius: 10px; margin-top: 15px; font-weight: bold; text-align: center;}
        .status-error { background: #ffe5e5; color: #d32f2f; border: 2px solid #ffcdd2; }
        .status-success { background: #e8f5e9; color: #2e7d32; border: 2px solid #c8e6c9; }

        @media (max-width: 768px) {
            .grid { grid-template-columns: 1fr; }
            .search-bar { position: static; margin-bottom: 10px; text-align: center; }
            .search-input { width: 100%; }
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- ç™»å½• -->
        <div v-if="!isLoggedIn" class="login-box">
            <div class="card">
                <h1 style="font-size: 3em; margin-bottom: 10px;">â˜¯ï¸</h1>
                <h2 style="justify-content: center;">æˆé•¿æ‰‹è´¦</h2>
                <input type="email" v-model="email" placeholder="é‚®ç®±" class="note-input">
                <input type="password" v-model="password" placeholder="å¯†ç " class="note-input">
                <button class="btn" @click="login" :disabled="loading">{{ loading ? 'éªŒè¯ä¸­...' : 'è¿›å…¥æˆ‘çš„ä¸–ç•Œ' }}</button>
                <div v-if="message" :class="['status-message', messageType === 'success' ? 'status-success' : 'status-error']">{{ message }}</div>
            </div>
        </div>

        <!-- ä¸»ç•Œé¢ -->
        <div v-else class="container">
            <div class="header">
                <div class="search-bar">
                    <input v-model="searchQuery" placeholder="ğŸ” æœç´¢å…¨ç«™å†…å®¹..." class="search-input">
                </div>
                <h1>ğŸ‘‹ {{ userEmail.split('@')[0] }} çš„ä¿®èº«ç©ºé—´</h1>
                <div>
                    <button class="btn-sm" @click="syncData" :disabled="syncing">{{ syncing ? 'â˜ï¸ åŒæ­¥ä¸­...' : 'ğŸ”„ åŒæ­¥æ•°æ®' }}</button>
                    <button class="btn-sm btn-danger" @click="logout" style="margin-left: 10px;">é€€å‡º</button>
                </div>
                <div v-if="message" :class="['status-message', messageType === 'success' ? 'status-success' : 'status-error']" style="margin-top: 10px;">{{ message }}</div>
            </div>
            
            <!-- æœç´¢ç»“æœæ  -->
            <div v-if="searchQuery" class="card" style="margin-bottom: 30px; border-color: #ff9a8b;">
                <h2>ğŸ” æœç´¢ç»“æœ <button class="btn-sm" @click="searchQuery=''">å…³é—­</button></h2>
                <div v-if="searchResults.length === 0" style="padding: 20px; color: #999;">æœªæ‰¾åˆ°ç›¸å…³å†…å®¹</div>
                <div v-else style="max-height: 300px; overflow-y: auto;">
                    <div v-for="item in searchResults" :key="item.id" style="padding: 10px; border-bottom: 1px dashed #e0c9b8; cursor: pointer;" @click="viewDetail(item)">
                        <strong>{{ item.typeLabel }}</strong> {{ item.title || item.code || 'æ— æ ‡é¢˜' }}
                        <div style="font-size: 0.8em; color: #777; overflow: hidden; white-space: nowrap; text-overflow: ellipsis;">{{ item.preview }}</div>
                    </div>
                </div>
            </div>

            <div class="grid">
                <!-- æ¨¡å—1ï¼šçŠ¶æ€ & æ¯æ—¥å§”æ‰˜ -->
                <div class="card">
                    <h2>ğŸ“Š è§’è‰²çŠ¶æ€</h2>
                    <div v-if="playerData">
                        <div style="font-size: 3em; font-weight: 800; text-align: center; color: #ff6b6b;">Lv.{{ playerData.level }}</div>
                        <div style="height: 20px; background: #ffe8d6; border-radius: 12px; overflow: hidden; border: 2px solid #5a4a42; margin: 10px 0;">
                            <div style="height: 100%; background: linear-gradient(90deg, #4ecdc4, #a3de83); transition: width 0.5s;" :style="{width: xpPercentage + '%'}"></div>
                        </div>
                        <div style="text-align: center; font-weight: bold; color: #7a6a62;">{{ playerData.xp }} / {{ playerData.nextLevelXp }} XP</div>
                    </div>

                    <div style="margin-top: 20px; border-top: 2px dashed #e0c9b8; padding-top: 10px;">
                        <h3 style="font-size: 1.1em; color: #5a4a42;">â˜€ï¸ æ¯æ—¥å§”æ‰˜ <span style="font-size: 0.7em; color: #999;">(0ç‚¹é‡ç½®)</span></h3>
                        <div class="quest-list" v-if="playerData.dailyQuests">
                            <div v-for="q in playerData.dailyQuests" :key="q.id" class="quest-item" :class="{done: q.done}" @click="toggleQuest(q)">
                                <span style="margin-right: 10px;">{{ q.done ? 'âœ…' : 'â¬œ' }}</span>
                                <span style="flex: 1;">{{ q.text }}</span>
                                <span style="font-size: 0.8em; font-weight: bold; color: #ff9a8b;">+{{ q.xp }} XP</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æ¨¡å—2ï¼šç›®æ ‡ & èµ„äº§æ›²çº¿ -->
                <div class="card">
                    <h2>ğŸ¯ ç›®æ ‡ & è´¢å¯Œ</h2>
                    
                    <!-- èµ„äº§æ›²çº¿å›¾è¡¨ -->
                    <div style="height: 180px; margin-bottom: 20px;">
                        <canvas id="assetChart"></canvas>
                    </div>

                    <div style="background: #fffaf5; padding: 15px; border-radius: 12px; border: 1px dashed #e0c9b8; margin-bottom: 15px;">
                        <div style="display: flex; gap: 5px;">
                            <input v-model="newGoal.title" placeholder="æ–°ç›®æ ‡..." class="note-input" style="margin: 0; flex: 2;">
                            <input v-model.number="newGoal.target" placeholder="ç›®æ ‡å€¼" type="number" class="note-input" style="margin: 0; flex: 1;">
                            <button class="btn-sm" @click="addGoal">â•</button>
                        </div>
                    </div>

                    <div style="max-height: 250px; overflow-y: auto;" v-if="playerData.goals">
                        <div v-for="(goal, index) in playerData.goals" :key="index" class="goal-item" style="padding: 15px; margin-bottom: 10px;">
                            <div style="display: flex; justify-content: space-between; font-weight: bold; font-size: 0.9em;">
                                <span>{{ goal.title }}</span>
                                <span>{{ calculateProgress(goal) }}%</span>
                            </div>
                            <div class="goal-progress-bg" style="height: 10px; margin: 8px 0;">
                                <div class="goal-progress-fill" :style="{width: Math.min(100, calculateProgress(goal)) + '%'}"></div>
                            </div>
                            <div style="display: flex; gap: 5px; align-items: center;">
                                <input type="number" v-model.number="goal.current" @change="saveAll" style="width: 70px; padding: 4px; border: 1px solid #ccc; border-radius: 4px;">
                                <span style="font-size: 0.8em; color: #999;">/ {{ goal.target }}</span>
                                <button class="btn-sm btn-danger" @click="deleteGoal(index)" style="margin-left: auto; padding: 4px 10px;">âœ•</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æ¨¡å—3ï¼šå¤ç›˜ç¬”è®° -->
                <div class="card" style="grid-column: 1 / -1;">
                    <h2>ğŸ”„ å¤ç›˜ç¬”è®° <button class="collapse-btn" @click="showReviewForm = !showReviewForm">{{ showReviewForm ? 'å–æ¶ˆ' : 'â• æ–°å»º' }}</button></h2>
                    
                    <div v-if="showReviewForm" style="background: #fffaf5; padding: 20px; border: 2px dashed #ff9a8b; border-radius: 15px; margin-bottom: 20px;">
                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <button v-for="t in ['daily','stock','weekly']" :key="t" class="btn-sm" 
                                :style="{background: activeReviewTab===t?'#ff9a8b':'#ddd'}" @click="activeReviewTab=t">
                                {{ t==='stock'?'ğŸ“ˆ è‚¡ç¥¨':(t==='daily'?'ğŸ“ æ—¥å¸¸':'ğŸ“… å‘¨ç»“') }}
                            </button>
                        </div>

                        <!-- è‚¡ç¥¨ä¸“ç”¨ -->
                        <div v-if="activeReviewTab === 'stock'" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 10px;">
                            <input v-model="newStockData.code" placeholder="ä»£ç /åç§°" class="note-input" style="margin:0;">
                            <select v-model="newStockData.action" class="note-input" style="margin:0;">
                                <option value="buy">ğŸ”µ ä¹°å…¥</option>
                                <option value="sell">ğŸ”´ å–å‡º</option>
                                <option value="hold">âšª æŒä»“</option>
                            </select>
                            <input v-model="newStockData.price" placeholder="ä»·æ ¼" class="note-input" style="margin:0;">
                            <input v-model="newStockData.profit" placeholder="ç›ˆäº" class="note-input" style="margin:0;">
                            <input v-model.number="newStockData.totalAssets" placeholder="ğŸ“Œ è¾“å…¥æ€»èµ„äº§æ›´æ–°æ›²çº¿" class="note-input" style="margin:0; border-color: #a3de83;">
                        </div>

                        <input v-if="activeReviewTab !== 'stock'" v-model="newNote.title" placeholder="æ ‡é¢˜..." class="note-input">
                        <input v-model="newNote.tags" placeholder="æ ‡ç­¾ (å¦‚: å¿ƒæ€, ç”²æœ¨, å†¥æƒ³)..." class="note-input">
                        <textarea v-model="newNote.content" class="note-textarea" placeholder="å†…å®¹..." style="height: 100px;"></textarea>
                        <button class="btn" @click="saveNote">ğŸ’¾ ä¿å­˜</button>
                    </div>

                    <div v-for="note in filteredNotes" :key="note.id" style="background: #f9f9f9; padding: 20px; border-radius: 15px; margin-bottom: 15px; border-left: 5px solid #e0c9b8; position: relative;">
                        <div style="position: absolute; top: 15px; right: 15px;">
                            <button class="btn-sm btn-danger" @click="deleteNote(note.id)">âœ•</button>
                        </div>
                        <div style="font-size: 0.85em; color: #999; margin-bottom: 5px;">{{ formatDate(note.createdAt) }}</div>
                        
                        <div v-if="note.tags" style="margin-bottom: 8px;">
                            <span v-for="tag in note.tags.split(/[,ï¼Œ]/)" :key="tag" class="tag-badge">{{ tag }}</span>
                        </div>

                        <div v-if="note.type === 'stock'" style="font-weight: bold; margin-bottom: 5px;">
                            <span :style="{color: note.stockData?.action === 'buy' ? 'red' : 'green'}">
                                {{ note.stockData?.action === 'buy' ? 'ä¹°å…¥' : (note.stockData?.action === 'sell' ? 'å–å‡º' : 'æŒä»“') }}
                            </span>
                            {{ note.stockData?.code }}
                            <span v-if="note.stockData?.profit" style="margin-left: 10px;">{{ note.stockData.profit }}</span>
                        </div>

                        <h3 v-if="note.title">{{ note.title }}</h3>
                        <p style="white-space: pre-wrap; line-height: 1.6; color: #5a4a42;">{{ note.content }}</p>
                    </div>
                </div>

                <!-- æ¨¡å—4ï¼šç§¯åˆ†å•†åº— -->
                <div class="card">
                    <h2>ğŸ¦ ç§¯åˆ†å•†åº— <span style="font-size: 0.6em; color: #7a6a62;">(XPä½™é¢: {{ playerData.xp }})</span></h2>
                    <div class="shop-grid" v-if="playerData.shopItems">
                        <div v-for="item in playerData.shopItems" :key="item.id" class="shop-item" @click="buyItem(item)">
                            <div style="font-size: 2em;">{{ item.icon }}</div>
                            <div style="font-weight: bold; font-size: 0.9em;">{{ item.name }}</div>
                            <div style="color: #ff9a8b; font-weight: bold;">ğŸ’ {{ item.cost }}</div>
                        </div>
                    </div>
                    <div style="margin-top: 15px; display: flex; gap: 5px;">
                        <input v-model="newShopItem.name" placeholder="è‡ªå®šä¹‰å¥–åŠ±" class="note-input" style="margin:0; font-size: 0.8em;">
                        <input v-model.number="newShopItem.cost" placeholder="XP" type="number" class="note-input" style="margin:0; width: 60px; font-size: 0.8em;">
                        <button class="btn-sm" @click="addShopItem">â•</button>
                    </div>
                </div>

                <!-- æ¨¡å—5ï¼šæ˜“å­¦å‘½ä¾‹ -->
                <div class="card">
                    <h2>â˜¯ï¸ æ˜“å­¦å‘½ä¾‹</h2>
                    <button class="btn-sm" @click="showCaseForm = !showCaseForm" style="margin-bottom: 15px;">+ æ–°è®°å½•</button>
                    <div v-if="showCaseForm" style="background: #fffaf5; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                        <input v-model="newCase.title" placeholder="æ ‡é¢˜" class="note-input">
                        <input type="file" @change="handleImageUpload" class="note-input" accept="image/*">
                        <textarea v-model="newCase.content" placeholder="æ–­è¯­..." class="note-textarea"></textarea>
                        <button class="btn" @click="saveCase">ä¿å­˜</button>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px;">
                        <div v-for="c in cases" :key="c.id" style="cursor: pointer;" @click="viewDetail({...c, typeLabel: 'æ˜“å­¦'})">
                            <img :src="c.image || 'https://via.placeholder.com/150'" style="width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 10px; border: 1px solid #ddd;">
                            <div style="font-size: 0.8em; text-align: center; margin-top: 5px;">{{ c.title }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- è¯¦æƒ…å¼¹çª— -->
        <div v-if="viewingItem" style="position: fixed; inset: 0; background: rgba(90, 74, 66, 0.6); backdrop-filter: blur(2px); z-index: 999; display: flex; justify-content: center; align-items: center;" @click.self="viewingItem = null">
            <div class="card" style="width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                    <h2>è¯¦æƒ…</h2> <span @click="viewingItem = null" style="cursor: pointer; font-size: 1.5em;">&times;</span>
                </div>
                <img v-if="viewingItem.image" :src="viewingItem.image" style="width: 100%; border-radius: 10px; margin-bottom: 15px;">
                <h3>{{ viewingItem.title || viewingItem.code }}</h3>
                <p style="white-space: pre-wrap; line-height: 1.6;">{{ viewingItem.content || viewingItem.notes }}</p>
            </div>
        </div>

    </div>

    <script>
        const SUPABASE_URL = 'https://zqmgigcnruvvdcholbuj.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpxbWdpZ2NucnV2dmRjaG9sYnVqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4NjgzNjEsImV4cCI6MjA4MTQ0NDM2MX0.IHzDp7o5M9QM8IBWy2ri5gS9h9nm0zk3AaPTNveDqXI';
        const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        const { createApp } = Vue;

        const app = createApp({
            data() {
                return {
                    isLoggedIn: false, userId: null, userEmail: '', email: '', password: '',
                    loading: false, syncing: false, message: '', messageType: '',
                    
                    activeReviewTab: 'stock', showReviewForm: false, showCaseForm: false, viewingItem: null,
                    searchQuery: '', chartInstance: null,

                    // é»˜è®¤æ•°æ®ç»“æ„ (é˜²æ­¢ç™½å±)
                    playerData: { 
                        level: 1, xp: 0, nextLevelXp: 100, 
                        goals: [], 
                        dailyQuests: [
                            { id: 1, text: 'ğŸ§˜â€â™‚ï¸ å†¥æƒ³/ç«™æ¡©', done: false, xp: 10 },
                            { id: 2, text: 'ğŸ“– é˜…è¯» 30åˆ†é’Ÿ', done: false, xp: 15 },
                            { id: 3, text: 'ğŸ“ˆ ç›˜åå¤ç›˜', done: false, xp: 20 }
                        ],
                        shopItems: [
                            { id: 1, name: 'å¥¶èŒ¶', cost: 50, icon: 'ğŸ¥¤' },
                            { id: 2, name: 'æ¸¸æˆ1h', cost: 100, icon: 'ğŸ®' }
                        ],
                        assetsHistory: [],
                        lastLoginDate: ''
                    },
                    notes: [], cases: [],
                    
                    newGoal: { title: '', target: null, current: 0 },
                    newNote: { title: '', content: '', tags: '' },
                    newStockData: { code: '', action: 'buy', price: '', profit: '', totalAssets: null },
                    newCase: { title: '', content: '', image: null },
                    newShopItem: { name: '', cost: 100, icon: 'ğŸ' }
                };
            },
            computed: {
                xpPercentage() { 
                    if (!this.playerData || !this.playerData.nextLevelXp) return 0;
                    return Math.min(100, (this.playerData.xp / this.playerData.nextLevelXp) * 100); 
                },
                filteredNotes() {
                    let res = this.notes || [];
                    if (this.activeReviewTab === 'daily') res = res.filter(n => !n.type || n.type === 'daily');
                    else res = res.filter(n => n.type === this.activeReviewTab);
                    return res.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));
                },
                searchResults() {
                    if (!this.searchQuery) return [];
                    const q = this.searchQuery.toLowerCase();
                    const mapItem = (item, type, preview) => ({ ...item, typeLabel: type, preview: preview });
                    
                    const n = this.notes.filter(x => (x.content+x.title+x.tags).toLowerCase().includes(q))
                                  .map(x => mapItem(x, x.type==='stock'?'è‚¡ç¥¨':'ç¬”è®°', x.content));
                    const c = this.cases.filter(x => (x.content+x.title).toLowerCase().includes(q))
                                  .map(x => mapItem(x, 'å‘½ä¾‹', x.content));
                    
                    return [...n, ...c];
                }
            },
            methods: {
                showMessage(txt, type='success') { this.message = txt; this.messageType = type; setTimeout(()=>this.message='', 3000); },
                formatDate(str) { return str ? new Date(str).toLocaleDateString() : ''; },
                calculateProgress(g) { if(!g || !g.target) return 0; return Math.round((g.current/g.target)*100); },
                
                async login() {
                    if (!this.email || !this.password) return this.showMessage('è¯·è¾“å…¥è´¦å·å¯†ç ', 'error');
                    this.loading = true;
                    const { data, error } = await sb.auth.signInWithPassword({ email: this.email, password: this.password });
                    this.loading = false;
                    if (error) return this.showMessage('ç™»å½•å¤±è´¥: ' + error.message, 'error');
                    this.isLoggedIn = true; this.userId = data.user.id; this.userEmail = data.user.email;
                    this.loadData();
                },
                async logout() { await sb.auth.signOut(); this.isLoggedIn = false; },

                async loadData() {
                    this.syncing = true;
                    try {
                        const [p, n, c] = await Promise.all([
                            sb.from('players').select('*').eq('user_id', this.userId).maybeSingle(), // Use maybeSingle to prevent crash on empty
                            sb.from('notes').select('*').eq('user_id', this.userId),
                            sb.from('cases').select('*').eq('user_id', this.userId)
                        ]);

                        if (p.data && p.data.data) {
                            // å®‰å…¨åˆå¹¶æ•°æ®ï¼Œé˜²æ­¢è¦†ç›–æ‰é»˜è®¤ç»“æ„
                            this.playerData = { ...this.playerData, ...p.data.data };
                        }
                        
                        // ç¡®ä¿å…³é”®æ•°ç»„å­˜åœ¨ï¼Œé˜²æ­¢ v-for æŠ¥é”™
                        const keys = ['goals', 'dailyQuests', 'shopItems', 'assetsHistory'];
                        keys.forEach(k => { if(!this.playerData[k]) this.playerData[k] = []; });

                        if (n.data) this.notes = n.data.map(i => i.data);
                        if (c.data) this.cases = c.data.map(i => i.data);

                        this.checkDailyReset();
                        this.initChart();
                    } catch (e) {
                        console.error("åŠ è½½é”™è¯¯:", e);
                        this.showMessage("æ•°æ®åŠ è½½å¼‚å¸¸ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°", "error");
                    }
                    this.syncing = false;
                },

                async saveAll() {
                    if (!this.userId) return;
                    const saveTable = async (table, list) => {
                        await sb.from(table).delete().eq('user_id', this.userId);
                        if(list && list.length) await sb.from(table).insert(list.map(d => ({ user_id: this.userId, data: d })));
                    };
                    
                    try {
                        await Promise.all([
                            sb.from('players').upsert({ user_id: this.userId, data: this.playerData }, { onConflict: 'user_id' }),
                            saveTable('notes', this.notes),
                            saveTable('cases', this.cases)
                        ]);
                    } catch (e) { console.error(e); }
                },
                async syncData() { this.syncing = true; await this.saveAll(); this.syncing = false; this.showMessage('åŒæ­¥å®Œæˆ'); },

                checkDailyReset() {
                    const today = new Date().toLocaleDateString();
                    if (this.playerData.lastLoginDate !== today) {
                        if(this.playerData.dailyQuests) this.playerData.dailyQuests.forEach(q => q.done = false);
                        this.playerData.lastLoginDate = today;
                        this.saveAll();
                    }
                },
                toggleQuest(q) {
                    q.done = !q.done;
                    if (q.done) { this.addXp(q.xp); } else { this.addXp(-q.xp); }
                    this.saveAll();
                },
                addXp(amount) {
                    this.playerData.xp += amount;
                    if (this.playerData.xp >= this.playerData.nextLevelXp) {
                        this.playerData.xp -= this.playerData.nextLevelXp;
                        this.playerData.level++;
                        this.showMessage('ğŸ‰ å‡çº§äº†ï¼');
                    }
                },

                // æ ¸å¿ƒä¿®å¤ï¼šå›¾è¡¨å»¶æ—¶åŠ è½½ï¼Œé˜²æ­¢ç™½å±
                initChart() {
                    setTimeout(() => {
                        const ctx = document.getElementById('assetChart');
                        if (!ctx || typeof Chart === 'undefined') return;
                        
                        if (this.chartInstance) this.chartInstance.destroy();

                        const history = this.playerData.assetsHistory || [];
                        const labels = history.map(h => h.date);
                        const data = history.map(h => h.value);

                        try {
                            this.chartInstance = new Chart(ctx, {
                                type: 'line',
                                data: {
                                    labels: labels,
                                    datasets: [{
                                        label: 'å‡€å€¼',
                                        data: data,
                                        borderColor: '#a3de83',
                                        backgroundColor: 'rgba(163, 222, 131, 0.2)',
                                        tension: 0.3, fill: true
                                    }]
                                },
                                options: { responsive: true, maintainAspectRatio: false }
                            });
                        } catch(e) { console.error("Chart Error", e); }
                    }, 500); // å»¶æ—¶500msç¡®ä¿DOMå·²ç»æ¸²æŸ“
                },
                updateChart(val) {
                    if(!val) return;
                    const today = new Date().toLocaleDateString();
                    if(!this.playerData.assetsHistory) this.playerData.assetsHistory = [];
                    this.playerData.assetsHistory.push({ date: today, value: val });
                    if(this.playerData.assetsHistory.length > 30) this.playerData.assetsHistory.shift();
                    this.initChart();
                },

                addGoal() { if(!this.newGoal.title)return; this.playerData.goals.push({...this.newGoal, current:0}); this.newGoal.title=''; this.saveAll(); },
                deleteGoal(i) { this.playerData.goals.splice(i,1); this.saveAll(); },
                
                addShopItem() { if(!this.newShopItem.name)return; this.playerData.shopItems.push({...this.newShopItem, id:Date.now()}); this.newShopItem={name:'',cost:100,icon:'ğŸ'}; this.saveAll(); },
                buyItem(item) {
                    if (this.playerData.xp >= item.cost) {
                        if(confirm('å…‘æ¢ ' + item.name + '?')) {
                            this.addXp(-item.cost);
                            this.notes.unshift({ id: Date.now(), type: 'daily', createdAt: new Date().toISOString(), title: 'ğŸ å…‘æ¢', content: item.name, tags: 'æ¶ˆè´¹' });
                            this.saveAll();
                        }
                    } else { this.showMessage('XPä¸è¶³', 'error'); }
                },

                saveNote() {
                    const note = { id: Date.now(), type: this.activeReviewTab, createdAt: new Date().toISOString(), ...this.newNote };
                    if (this.activeReviewTab === 'stock') {
                        note.stockData = { ...this.newStockData };
                        if (this.newStockData.totalAssets) this.updateChart(this.newStockData.totalAssets);
                        this.newStockData = { code:'', action:'buy', price:'', profit:'', totalAssets:null };
                    }
                    this.notes.unshift(note);
                    this.newNote = { title:'', content:'', tags:'' };
                    this.showReviewForm = false;
                    this.addXp(10); this.saveAll();
                },
                deleteNote(id) { if(confirm('åˆ é™¤?')) { this.notes = this.notes.filter(n=>n.id!==id); this.saveAll(); } },

                handleImageUpload(e) {
                    const file = e.target.files[0]; if(!file)return;
                    // å›¾ç‰‡é™åˆ¶ï¼š5MB
                    if(file.size > 5*1024*1024) return alert('å›¾ç‰‡ä¸èƒ½è¶…è¿‡5MB');
                    const reader = new FileReader();
                    reader.onload = (evt) => {
                        const img = new Image(); img.src = evt.target.result;
                        img.onload = () => {
                            const cvs = document.createElement('canvas'); const ctx = cvs.getContext('2d');
                            // å¼ºåˆ¶å‹ç¼©å®½åº¦åˆ° 800px
                            const scale = 800/img.width; 
                            cvs.width = img.width > 800 ? 800 : img.width; 
                            cvs.height = img.width > 800 ? img.height * scale : img.height;
                            ctx.drawImage(img,0,0,cvs.width,cvs.height);
                            // è´¨é‡å‹ç¼© 0.7
                            this.newCase.image = cvs.toDataURL('image/jpeg', 0.7);
                        }
                    };
                    reader.readAsDataURL(file);
                },
                saveCase() { if(!this.newCase.title)return; this.cases.unshift({id:Date.now(), type:'case', ...this.newCase}); this.newCase={title:'',content:'',image:null}; this.showCaseForm=false; this.addXp(20); this.saveAll(); },
                viewDetail(item) { this.viewingItem = item; }
            },
            mounted() {
                sb.auth.getSession().then(({ data: { session } }) => {
                    if (session) { this.isLoggedIn = true; this.userId = session.user.id; this.userEmail = session.user.email; this.loadData(); }
                });
            }
        });

        // å…¨å±€é”™è¯¯æ•æ‰ï¼Œé˜²æ­¢ç™½å±
        app.config.errorHandler = (err) => {
            console.error("Vue Crash:", err);
            alert("åº”ç”¨å‘ç”Ÿé”™è¯¯ï¼Œè¯·åˆ·æ–°é¡µé¢æˆ–æ£€æŸ¥æ§åˆ¶å°ã€‚");
        };

        app.mount('#app');
    </script>
</body>
</html>

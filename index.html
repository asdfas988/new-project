<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆé•¿æ‰‹è´¦</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* ========== å…¨å±€åŸºç¡€æ ·å¼ ========== */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Noto Sans SC', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #fef9f3;
            min-height: 100vh;
            color: #5a4a42;
            padding: 20px;
        }
        /* æ»šåŠ¨æ¡ç¾åŒ– */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #dccdc3; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #c0b0a3; }

        .container { max-width: 1400px; margin: 0 auto; }
        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px;
            background: #fffaf0;
            border-radius: 24px;
            box-shadow: 8px 8px 0px #e0c9b8;
            border: 3px solid #5a4a42;
            position: relative;
        }
        .header h1 {
            font-size: 2.5em;
            font-weight: 700;
            text-shadow: 3px 3px 0px #ffd6cc;
        }
        .grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }
        .card {
            background: #fffefc;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 6px 6px 0px #d4b8a7;
            border: 2.5px solid #5a4a42;
            transition: all 0.3s;
        }
        .card h2 {
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 3px dotted #ff9a8b;
            font-size: 1.4em;
            font-weight: 700;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* ========== æŒ‰é’®æ ·å¼ ========== */
        .btn {
            background: linear-gradient(90deg, #ff9a8b, #ff6b6b);
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            color: white;
            cursor: pointer;
            font-size: 16px;
            font-weight: 700;
            font-family: inherit;
            transition: all 0.3s;
            width: 100%;
            margin-top: 15px;
            box-shadow: 4px 4px 0px #d45d5d;
        }
        .btn:hover:not(:disabled) { transform: translateY(-2px); }
        .btn-sm {
            padding: 8px 20px;
            font-size: 0.9em;
            width: auto;
            border-radius: 25px;
            background: linear-gradient(90deg, #4ecdc4, #a3de83);
            box-shadow: 3px 3px 0px #2ba69b;
            border: none;
            color: white;
            font-weight: bold;
            cursor: pointer;
            margin: 0;
            font-family: inherit;
        }
        .collapse-btn {
            background: #fffaf5;
            border: 2px solid #ff9a8b;
            cursor: pointer;
            font-size: 0.85em;
            color: #ff6b6b;
            padding: 5px 12px;
            border-radius: 15px;
            font-family: inherit;
            font-weight: bold;
        }

        /* ========== è¾“å…¥æ¡†æ ·å¼ ========== */
        .note-input, .note-textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0c9b8;
            border-radius: 12px;
            font-size: 16px;
            font-family: inherit;
            margin-bottom: 15px;
            background: #fffaf9;
        }
        .note-textarea { min-height: 180px; resize: vertical; }
        .note-input:focus, .note-textarea:focus {
            outline: none;
            border-color: #ff9a8b;
            box-shadow: 2px 2px 0px #ffd6cc;
        }

        /* ========== çŠ¶æ€ä¸åŠ è½½ ========== */
        .status-message { padding: 15px 25px; border-radius: 12px; margin: 20px 0; font-weight: 700; border: 2px solid; }
        .status-success { background: rgba(163, 222, 131, 0.9); color: #2d5a27; border-color: #2ba69b; }
        .status-error { background: rgba(255, 154, 139, 0.9); color: #7a2c28; border-color: #d45d5d; }
        .loading-spinner { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(255, 154, 139, 0.3); border-radius: 50%; border-top-color: #ff6b6b; animation: spin 1s infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* ========== æ¸¸æˆåŒ–å…ƒç´  ========== */
        .level-display { font-size: 4.5em; font-weight: 800; text-align: center; margin: 25px 0; color: #ff6b6b; text-shadow: 3px 3px 0px #ffd6cc; }
        .xp-progress { height: 24px; background: #ffe8d6; border-radius: 12px; margin: 15px 0; overflow: hidden; border: 2px solid #5a4a42; }
        .xp-fill { height: 100%; background: linear-gradient(90deg, #4ecdc4, #a3de83); transition: width 0.5s ease; }
        .skill-item { padding: 18px; background: #fffaf5; border-radius: 15px; margin: 15px 0; border: 2px solid #e0c9b8; display: flex; justify-content: space-between; align-items: center; }
        .achievement-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 20px; margin-top: 25px; }
        .achievement-card { background: #fffefc; border-radius: 18px; padding: 20px; box-shadow: 4px 4px 0px #d4b8a7; border: 2px solid #5a4a42; }
        .achievement-card.locked { opacity: 0.6; filter: grayscale(0.4); }
        .achievement-icon { font-size: 2.5em; text-align: center; margin-bottom: 15px; }
        .achievement-progress { height: 10px; background: #ffe8d6; border-radius: 6px; margin: 15px 0; overflow: hidden; }
        .achievement-progress-fill { height: 100%; background: linear-gradient(90deg, #ff9a8b, #ff6b6b); transition: width 0.6s ease; }
        .achievement-icon-picker { display: grid; grid-template-columns: repeat(10, 1fr); gap: 10px; margin: 15px 0; }
        .achievement-icon-option { font-size: 2em; padding: 10px; border: 2px solid #e0c9b8; border-radius: 10px; cursor: pointer; text-align: center; transition: all 0.2s; background: white; }
        .achievement-icon-option.selected { border-color: #ff6b6b; background: #ffebe8; box-shadow: 3px 3px 0px #d4b8a7; }

        /* ========== ç¬”è®°æ ·å¼ ========== */
        .note-tabs { display: flex; gap: 12px; margin-bottom: 20px; border-bottom: 2px solid #e0c9b8; padding-bottom: 10px; }
        .note-tab { padding: 10px 20px; border: 2px solid #e0c9b8; background: #fffaf5; border-radius: 15px 15px 0 0; cursor: pointer; font-weight: 600; transition: all 0.3s; }
        .note-tab.active { background: linear-gradient(90deg, #ff9a8b, #ff6b6b); color: white; border-color: #ff6b6b; transform: translateY(2px); }
        .note-card { background: #fffaf5; padding: 20px; border-radius: 15px; margin-bottom: 15px; border: 2px solid #e0c9b8; }
        .note-tags { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px; }
        .note-tag { background: linear-gradient(90deg, #4ecdc4, #a3de83); color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.85em; font-weight: 600; }
        
        /* ç­›é€‰å™¨æ ·å¼ */
        .filter-container { background: #fffaf5; padding: 20px; border-radius: 15px; margin-bottom: 20px; border: 2px solid #e0c9b8; }
        .filter-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; user-select: none; }
        .collapsible-content { overflow: hidden; transition: max-height 0.3s ease; }
        .filter-active-indicator { width: 8px; height: 8px; background: #ff6b6b; border-radius: 50%; display: inline-block; animation: pulse 1.5s infinite; }
        .tags-filter { display: flex; flex-wrap: wrap; gap: 10px; }
        .tag-filter-btn { padding: 8px 16px; border: 2px solid #e0c9b8; background: white; border-radius: 20px; cursor: pointer; font-family: inherit; font-weight: 600; transition: all 0.3s; }
        .tag-filter-btn.active { background: linear-gradient(90deg, #4ecdc4, #a3de83); color: white; border-color: #2ba69b; }
        .sort-options { display: flex; gap: 10px; }
        .sort-btn { padding: 10px 20px; border: 2px solid #e0c9b8; background: white; border-radius: 15px; cursor: pointer; font-family: inherit; font-weight: 600; transition: all 0.3s; }
        .sort-btn.active { background: linear-gradient(90deg, #ff9a8b, #ff6b6b); color: white; border-color: #ff6b6b; }
        .no-notes-message { text-align: center; padding: 40px 20px; color: #c9b8a7; font-size: 1.1em; }

        /* ========== è¯»ä¹¦ç¬”è®°æ ·å¼ ========== */
        .book-tabs { display: flex; gap: 12px; margin-bottom: 20px; border-bottom: 2px solid #e0c9b8; padding-bottom: 10px; }
        .book-tab { padding: 10px 20px; border: 2px solid #e0c9b8; background: #fffaf5; border-radius: 15px 15px 0 0; cursor: pointer; font-weight: 600; transition: all 0.3s; }
        .book-tab.active { background: linear-gradient(90deg, #667eea, #764ba2); color: white; border-color: #5a4a42; transform: translateY(2px); }
        .book-form-group { margin-bottom: 20px; }
        .book-form-group label { display: block; margin-bottom: 8px; font-weight: 700; color: #5a4a42; font-family: inherit; }
        .book-rating { display: flex; gap: 10px; margin: 15px 0; justify-content: center; }
        .star-rating { font-size: 2em; cursor: pointer; transition: all 0.2s; color: #e0c9b8; }
        .star-rating:hover { transform: scale(1.2); }
        .star-rating.filled { color: #ffd700; text-shadow: 0 0 10px rgba(255, 215, 0, 0.5); }
        .book-tag-picker { display: flex; flex-wrap: wrap; gap: 10px; margin: 15px 0; }
        .book-tag-option { padding: 8px 16px; border: 2px solid #e0c9b8; background: white; border-radius: 20px; cursor: pointer; font-family: inherit; font-weight: 600; transition: all 0.3s; }
        .book-tag-option.selected { background: linear-gradient(90deg, #667eea, #764ba2); color: white; border-color: #5a4a42; }
        .book-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-top: 20px; }
        
        .book-card {
            background: #fffefc;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 4px 4px 0px #d4b8a7;
            border: 2px solid #e0c9b8;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            gap: 12px;
            cursor: pointer; /* è¡¨ç¤ºå¯ç‚¹å‡» */
        }
        .book-card:hover {
            transform: translateY(-5px);
            box-shadow: 6px 6px 0px #d4b8a7;
            border-color: #667eea;
        }
        .book-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; }
        .book-header h3 { font-weight: 700; font-size: 1.2em; color: #5a4a42; margin: 0; flex: 1; }
        .book-author { color: #7a6a62; font-size: 0.95em; font-style: italic; }
        .book-rating-display { font-size: 1.2em; color: #ffd700; margin: 5px 0; }
        .book-content { color: #5a4a42; font-size: 0.95em; line-height: 1.6; flex: 1; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
        .book-footer { display: flex; justify-content: space-between; align-items: center; padding-top: 10px; border-top: 1px dotted #e0c9b8; margin-top: auto; }
        .book-tags { display: flex; flex-wrap: wrap; gap: 6px; }
        .book-tag { background: linear-gradient(90deg, #667eea, #764ba2); color: white; padding: 3px 10px; border-radius: 10px; font-size: 0.8em; font-weight: 600; }
        .book-actions { display: flex; gap: 8px; z-index: 2; /* ç¡®ä¿æŒ‰é’®åœ¨å¡ç‰‡ç‚¹å‡»ä¹‹ä¸Š */ }
        .book-action-btn { background: #fffaf5; border: 1px solid #e0c9b8; border-radius: 8px; padding: 6px 10px; cursor: pointer; font-size: 0.9em; transition: all 0.2s; }
        .book-action-btn:hover { background: #ff9a8b; transform: scale(1.1); }
        .book-status { padding: 4px 12px; border-radius: 12px; font-size: 0.8em; font-weight: 600; margin-left: 10px; }
        .book-status.reading { background: #ff9a8b; color: white; }
        .book-status.finished { background: linear-gradient(90deg, #4ecdc4, #a3de83); color: white; }
        .book-status.planning { background: #e0c9b8; color: #5a4a42; }

        /* ========== è¯­é›€é£æ ¼çŸ¥è¯†åº“ (æ”¹è¿›ç‰ˆ) ========== */
        .kb-modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex; justify-content: center; align-items: center;
            z-index: 1000; backdrop-filter: blur(5px);
        }
        .kb-modal {
            background: #ffffff; /* æ›´å¹²å‡€çš„ç™½è‰²èƒŒæ™¯ */
            width: 95%; max-width: 1500px; height: 90vh;
            display: flex;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            border-radius: 8px; /* åœ†è§’æ›´å°ï¼Œæ›´å•†åŠ¡ */
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
        }

        /* KB å·¦ä¾§è¾¹æ  - å¯¼èˆª */
        .kb-sidebar {
            width: 260px;
            background: #fafafa; /* æµ…ç°èƒŒæ™¯ */
            border-right: 1px solid #e8e8e8;
            display: flex; flex-direction: column;
            flex-shrink: 0;
        }
        .kb-sidebar-header {
            padding: 16px 20px;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #f0f0f0;
        }
        .kb-sidebar-header h3 { font-size: 16px; font-weight: 600; color: #262626; margin: 0; }
        .kb-add-repo-btn {
            background: transparent; border: none; color: #595959; cursor: pointer;
            font-size: 18px; width: 24px; height: 24px; border-radius: 4px;
            display: flex; align-items: center; justify-content: center;
        }
        .kb-add-repo-btn:hover { background: #e6e6e6; color: #262626; }

        .kb-nav-list { flex: 1; overflow-y: auto; padding: 12px; }
        
        .kb-nav-item {
            display: flex; align-items: center; gap: 10px;
            padding: 8px 12px;
            border-radius: 6px;
            color: #595959;
            cursor: pointer;
            margin-bottom: 2px;
            transition: all 0.2s;
            font-size: 14px;
        }
        .kb-nav-item:hover { background: #e6f7ff; color: #262626; }
        .kb-nav-item.active { background: #e6f7ff; color: #1890ff; font-weight: 500; }
        .kb-nav-icon { font-size: 16px; width: 20px; text-align: center; }
        .kb-nav-text { flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .kb-nav-count { font-size: 12px; color: #bfbfbf; }

        /* KB ä¸»åŒºåŸŸ */
        .kb-main { flex: 1; display: flex; flex-direction: column; background: #fff; position: relative; }
        
        /* é¡¶éƒ¨å·¥å…·æ /é¢åŒ…å±‘ */
        .kb-toolbar {
            height: 56px; padding: 0 24px;
            border-bottom: 1px solid #f0f0f0;
            display: flex; align-items: center; justify-content: space-between;
            background: #fff;
        }
        .kb-breadcrumb { display: flex; align-items: center; color: #8c8c8c; font-size: 14px; }
        .kb-breadcrumb-item { display: flex; align-items: center; }
        .kb-breadcrumb-sep { margin: 0 8px; color: #bfbfbf; }
        .kb-breadcrumb-current { color: #262626; font-weight: 500; }
        .kb-breadcrumb-link { cursor: pointer; transition: color 0.2s; }
        .kb-breadcrumb-link:hover { color: #1890ff; }

        .kb-action-group { display: flex; gap: 12px; }
        .kb-btn-primary {
            background: #00b96b; /* è¯­é›€ç»¿ */
            color: white; border: none; padding: 6px 16px;
            border-radius: 4px; font-size: 14px; font-weight: 500;
            cursor: pointer; transition: background 0.2s;
            display: flex; align-items: center; gap: 6px;
        }
        .kb-btn-primary:hover { background: #00a65e; }
        .kb-search-bar {
            position: relative;
            width: 200px;
        }
        .kb-search-input-yuque {
            width: 100%; padding: 6px 12px 6px 30px;
            border: 1px solid #d9d9d9; border-radius: 4px;
            font-size: 14px; outline: none; transition: all 0.2s;
        }
        .kb-search-input-yuque:focus { border-color: #00b96b; box-shadow: 0 0 0 2px rgba(0, 185, 107, 0.1); }
        .kb-search-icon { position: absolute; left: 8px; top: 50%; transform: translateY(-50%); color: #bfbfbf; }

        /* å†…å®¹å±•ç¤ºåŒº (åˆ—è¡¨ or è¯¦æƒ…) */
        .kb-content-area { flex: 1; overflow-y: auto; display: flex; flex-direction: column; }
        
        /* åˆ—è¡¨è§†å›¾ */
        .kb-list-view { padding: 24px 40px; max-width: 1000px; margin: 0 auto; width: 100%; }
        .kb-list-header { margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid #f0f0f0; }
        .kb-list-title { font-size: 20px; font-weight: 600; color: #262626; display: flex; align-items: center; gap: 10px; }
        .kb-doc-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 16px 0; border-bottom: 1px solid #f0f0f0;
            cursor: pointer; transition: all 0.2s;
        }
        .kb-doc-item:hover { background: #fafafa; padding-left: 10px; padding-right: 10px; border-radius: 4px; }
        .kb-doc-icon { font-size: 18px; color: #8c8c8c; margin-right: 12px; }
        .kb-doc-info { flex: 1; }
        .kb-doc-title { font-size: 16px; color: #262626; margin-bottom: 4px; font-weight: 500; }
        .kb-doc-meta { font-size: 12px; color: #8c8c8c; }
        .kb-doc-actions { display: none; gap: 8px; }
        .kb-doc-item:hover .kb-doc-actions { display: flex; }
        .kb-icon-btn-sm {
            width: 28px; height: 28px; border-radius: 4px; border: 1px solid #d9d9d9;
            background: #fff; color: #595959; cursor: pointer; display: flex; align-items: center; justify-content: center;
        }
        .kb-icon-btn-sm:hover { color: #1890ff; border-color: #1890ff; }

        /* è¯¦æƒ…/é˜…è¯»è§†å›¾ */
        .kb-detail-view { padding: 40px 60px; max-width: 900px; margin: 0 auto; width: 100%; background: #fff; }
        .kb-detail-header { margin-bottom: 30px; border-bottom: 1px solid #f0f0f0; padding-bottom: 20px; }
        .kb-detail-title { font-size: 32px; font-weight: 700; color: #262626; margin-bottom: 16px; line-height: 1.4; }
        .kb-detail-meta-row { display: flex; gap: 20px; font-size: 13px; color: #8c8c8c; }
        .kb-detail-body { 
            font-size: 16px; line-height: 1.8; color: #262626; 
            white-space: pre-wrap; word-wrap: break-word; 
        }
        
        /* å¼¹çª—æ ·å¼å¤ç”¨ */
        .kb-form-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex; justify-content: center; align-items: center;
            z-index: 2000; backdrop-filter: blur(5px);
        }
        .kb-form-modal {
            background: #fff; border-radius: 8px; width: 90%; max-width: 600px;
            display: flex; flex-direction: column; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            max-height: 90vh;
        }
        .kb-form-header { padding: 16px 24px; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; }
        .kb-form-header h2 { font-size: 18px; font-weight: 600; color: #262626; margin: 0; }
        .kb-form-body { padding: 24px; overflow-y: auto; }
        .kb-form-footer { padding: 16px 24px; border-top: 1px solid #f0f0f0; display: flex; justify-content: flex-end; gap: 12px; background: #fafafa; border-radius: 0 0 8px 8px; }
        
        /* é€šç”¨è¡¨å•æ§ä»¶ */
        .yuque-input { width: 100%; padding: 8px 12px; border: 1px solid #d9d9d9; border-radius: 4px; font-size: 14px; outline: none; transition: all 0.2s; }
        .yuque-input:focus { border-color: #00b96b; box-shadow: 0 0 0 2px rgba(0, 185, 107, 0.1); }
        .yuque-textarea { width: 100%; min-height: 200px; padding: 12px; border: 1px solid #d9d9d9; border-radius: 4px; font-size: 14px; outline: none; resize: vertical; line-height: 1.6; }
        .yuque-textarea:focus { border-color: #00b96b; box-shadow: 0 0 0 2px rgba(0, 185, 107, 0.1); }
        .yuque-btn-secondary { background: #fff; border: 1px solid #d9d9d9; color: #595959; padding: 6px 16px; border-radius: 4px; cursor: pointer; transition: all 0.2s; }
        .yuque-btn-secondary:hover { color: #00b96b; border-color: #00b96b; }
        .yuque-icon-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(40px, 1fr)); gap: 8px; }
        .yuque-icon-btn { width: 40px; height: 40px; border: 1px solid #f0f0f0; border-radius: 4px; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; background: #fff; }
        .yuque-icon-btn:hover { background: #f5f5f5; }
        .yuque-icon-btn.active { border-color: #00b96b; background: #e6f7ff; }

        /* ç»Ÿä¸€å…³é—­æŒ‰é’® */
        .close-icon-btn { border: none; background: transparent; cursor: pointer; font-size: 20px; color: #bfbfbf; }
        .close-icon-btn:hover { color: #595959; }

        /* ä¹¦ç±è¯¦æƒ…å¼¹çª— (å¤ç”¨ä¸€äº› KB æ ·å¼) */
        .book-detail-modal {
            background: #fef9f3; border-radius: 20px; width: 90%; max-width: 800px;
            max-height: 90vh; display: flex; flex-direction: column;
            border: 3px solid #5a4a42; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
        }
        .book-detail-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; padding: 25px; display: flex; justify-content: space-between; align-items: flex-start;
        }
        .book-detail-content { padding: 30px; overflow-y: auto; background: #fffefc; flex: 1; }
        .book-detail-section { margin-bottom: 25px; }
        .book-detail-label { font-weight: 700; color: #5a4a42; margin-bottom: 10px; font-size: 1.1em; border-left: 4px solid #764ba2; padding-left: 10px; }
        .book-detail-text { line-height: 1.8; color: #5a4a42; font-size: 1.05em; white-space: pre-wrap; }

        @media (max-width: 768px) {
            .kb-modal { border-radius: 0; width: 100%; height: 100vh; }
            .kb-sidebar { width: 60px; }
            .kb-nav-text, .kb-sidebar-header h3, .kb-nav-count { display: none; }
            .kb-detail-view { padding: 20px; }
            .kb-list-view { padding: 20px; }
        }
    </style>
</head>
<body>
    <div id="app" class="container">
        <!-- ç™»å½•ç•Œé¢ -->
        <div v-if="!isLoggedIn">
            <div class="header">
                <h1>ğŸŒŸ ä¸ªäººæˆé•¿ç©ºé—´ ğŸŒŸ</h1>
                <p style="margin-top: 10px; font-size: 1.2em; color: #7a6a62;">è®°å½•æ¯ä¸€æ­¥æˆé•¿çš„è¶³è¿¹</p>
            </div>
            
            <div class="grid">
                <div class="card">
                    <h2>ğŸ” ç™»å½•/æ³¨å†Œ</h2>
                    <input type="email" v-model="email" placeholder="é‚®ç®±" class="note-input" @keyup.enter="login">
                    <input type="password" v-model="password" placeholder="å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰" class="note-input" @keyup.enter="login">
                    <button class="btn" @click="login" :disabled="loading">
                        <span v-if="!loading">ç™»å½•</span>
                        <span v-else class="loading-spinner"></span>
                    </button>
                    <button class="btn" @click="register" :disabled="loading" style="background: linear-gradient(90deg, #4ecdc4, #a3de83); box-shadow: 4px 4px 0px #2ba69b;">
                        <span v-if="!loading">æ³¨å†Œ</span>
                        <span v-else class="loading-spinner"></span>
                    </button>
                </div>
            </div>
            <div v-if="message" :class="['status-message', messageType === 'success' ? 'status-success' : 'status-error']">
                {{ message }}
            </div>
        </div>
        
        <!-- ä¸»ç•Œé¢ -->
        <div v-else>
            <div class="header">
                <h1>ğŸŒŸ ä¸ªäººæˆé•¿ç©ºé—´ ğŸŒŸ</h1>
                <p style="margin-top: 10px; font-size: 1.1em; color: #7a6a62;">
                    æ¬¢è¿å›æ¥ï¼Œ{{ userEmail }}ï¼
                    <button class="btn-sm" @click="syncData" :disabled="syncing" style="margin-left: 15px;">
                        <span v-if="!syncing">ğŸ”„ åŒæ­¥</span>
                        <span v-else class="loading-spinner"></span>
                    </button>
                    <button class="btn-sm" @click="saveAllData" :disabled="saving" style="margin-left: 10px; background: linear-gradient(90deg, #4ecdc4, #a3de83); box-shadow: 3px 3px 0px #2ba69b;">
                        <span v-if="!saving">ğŸ’¾ ä¿å­˜</span>
                        <span v-else class="loading-spinner"></span>
                    </button>
                    <button class="btn-sm" @click="logout" style="margin-left: 10px; background: linear-gradient(90deg, #ff9a8b, #ff6b6b); box-shadow: 3px 3px 0px #d45d5d;">é€€å‡º</button>
                </p>
            </div>
            
            <div v-if="message" :class="['status-message', messageType === 'success' ? 'status-success' : 'status-error']">
                {{ message }}
            </div>
            
            <div class="grid">
                <!-- ç­‰çº§çŠ¶æ€ (ä¿æŒä¸å˜) -->
                <div class="card">
                    <h2>
                        ğŸ“Š ç­‰çº§çŠ¶æ€
                        <button class="collapse-btn" @click="collapsed.status = !collapsed.status">
                            {{ collapsed.status ? 'å±•å¼€' : 'æ”¶èµ·' }}
                        </button>
                    </h2>
                    <div v-show="!collapsed.status">
                        <div class="level-display">Lv.{{ playerData.level }}</div>
                        <div class="xp-progress"><div class="xp-fill" :style="{width: xpPercentage + '%'}"></div></div>
                        <div style="text-align: center; margin-top: 15px; font-size: 1.1em;"><strong>{{ playerData.xp }}</strong> / {{ playerData.nextLevelXp }} XP</div>
                    </div>
                </div>
                
                <!-- æŠ€èƒ½è¿½è¸ª (ä¿æŒä¸å˜) -->
                <div class="card">
                    <h2>
                        âš¡ æŠ€èƒ½è¿½è¸ª
                        <button class="collapse-btn" @click="collapsed.skills = !collapsed.skills">
                            {{ collapsed.skills ? 'å±•å¼€' : 'æ”¶èµ·' }}
                        </button>
                    </h2>
                    <div v-show="!collapsed.skills">
                        <div v-for="skill in skills" :key="skill.id" class="skill-item">
                            <div>
                                <div style="font-weight: 700; font-size: 1.1em; margin-bottom: 8px;">
                                    {{ skill.icon }} {{ skill.name }} <span style="color: #a0a0a0; font-size: 0.85em;">Lv.{{ skill.level }}</span>
                                </div>
                                <div class="xp-progress" style="height: 8px; margin: 10px 0;"><div class="xp-fill" :style="{width: (skill.xp / skill.maxXp * 100) + '%'}"></div></div>
                            </div>
                            <div>
                                <button class="btn-sm" @click="practiceSkill(skill.id)">ç»ƒä¹ </button>
                                <button class="btn-sm" @click="deleteSkill(skill.id)" style="background: linear-gradient(90deg, #ff9a8b, #ff6b6b); margin-top: 8px;">åˆ é™¤</button>
                            </div>
                        </div>
                        <button class="btn" @click="addNewSkill">â• æ·»åŠ æ–°æŠ€èƒ½</button>
                    </div>
                </div>

                <!-- æˆå°±ç³»ç»Ÿ (ç•¥) -->
                <div class="card">
                    <h2>ğŸ† æˆå°±ç³»ç»Ÿ <button class="collapse-btn" @click="collapsed.achievements = !collapsed.achievements">{{ collapsed.achievements ? 'å±•å¼€' : 'æ”¶èµ·' }}</button></h2>
                    <div v-show="!collapsed.achievements">
                        <div class="achievement-grid">
                            <div v-for="ach in achievements" :key="ach.id" class="achievement-card" :class="{locked: !ach.unlocked}">
                                <div class="achievement-icon">{{ ach.icon }}</div>
                                <h3 style="text-align: center; font-size: 1em;">{{ ach.name }}</h3>
                                <div style="text-align: center; font-size: 0.8em; color: #7a6a62;">{{ ach.current }} / {{ ach.requirement }}</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ç¬”è®°æœ¬ (ç•¥, ä¿æŒåŸºæœ¬åŠŸèƒ½) -->
                <div class="card">
                    <h2>ğŸ“ ç¬”è®°æœ¬ <button class="collapse-btn" @click="collapsed.notes = !collapsed.notes">{{ collapsed.notes ? 'å±•å¼€' : 'æ”¶èµ·' }}</button></h2>
                    <div v-show="!collapsed.notes">
                        <button class="btn" @click="activeNoteTab = activeNoteTab === 'new' ? 'all' : 'new'">{{ activeNoteTab === 'new' ? 'æŸ¥çœ‹ç¬”è®°åˆ—è¡¨' : 'âœ¨ æ–°å»ºç¬”è®°' }}</button>
                        <div v-if="activeNoteTab === 'new'" style="margin-top: 20px;">
                            <input type="text" v-model="newNote.title" placeholder="ç¬”è®°æ ‡é¢˜..." class="note-input">
                            <textarea v-model="newNote.content" placeholder="å†…å®¹..." class="note-textarea"></textarea>
                            <input type="text" v-model="newNote.tags" placeholder="æ ‡ç­¾..." class="note-input">
                            <button class="btn" @click="saveNote">ä¿å­˜</button>
                        </div>
                        <div v-else class="note-list">
                            <div v-for="note in notes" :key="note.id" class="note-card">
                                <h3>{{ note.title }}</h3>
                                <p style="margin: 10px 0;">{{ note.content }}</p>
                                <button class="btn-sm" @click="deleteNote(note.id)" style="background: #ff6b6b;">åˆ é™¤</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- è¯»ä¹¦ç¬”è®°æ¿å— (æ”¹è¿›ï¼šç‚¹å‡»å¡ç‰‡æŸ¥çœ‹è¯¦æƒ…) -->
                <div class="card">
                    <h2>
                        ğŸ“š è¯»ä¹¦ç¬”è®°
                        <button class="collapse-btn" @click="collapsed.books = !collapsed.books">
                            {{ collapsed.books ? 'å±•å¼€' : 'æ”¶èµ·' }}
                        </button>
                    </h2>
                    <div v-show="!collapsed.books">
                        <div class="book-tabs">
                            <div class="book-tab" :class="{active: activeBookTab === 'all'}" @click="activeBookTab = 'all'">æ‰€æœ‰ä¹¦ç± ({{ books.length }})</div>
                            <div class="book-tab" :class="{active: activeBookTab === 'new'}" @click="activeBookTab = 'new'">âœ¨ æ·»åŠ æ–°ä¹¦</div>
                        </div>
                        
                        <!-- æ–°å¢ä¹¦ç±è¡¨å• -->
                        <div v-if="activeBookTab === 'new'">
                            <div class="book-form-group"><label>ä¹¦å</label><input type="text" v-model="newBook.title" class="note-input"></div>
                            <div class="book-form-group"><label>ä½œè€…</label><input type="text" v-model="newBook.author" class="note-input"></div>
                            <div class="book-form-group">
                                <label>çŠ¶æ€</label>
                                <select v-model="newBook.status" class="note-input">
                                    <option value="planning">è®¡åˆ’é˜…è¯»</option>
                                    <option value="reading">æ­£åœ¨é˜…è¯»</option>
                                    <option value="finished">å·²è¯»å®Œ</option>
                                </select>
                            </div>
                            <div class="book-form-group">
                                <label>è¯„åˆ†</label>
                                <div class="book-rating">
                                    <span v-for="star in 5" :key="star" class="star-rating" :class="{filled: star <= newBook.rating}" @click="newBook.rating = star">â˜…</span>
                                </div>
                            </div>
                            <div class="book-form-group"><label>è¯»ä¹¦ç¬”è®°</label><textarea v-model="newBook.notes" class="note-textarea"></textarea></div>
                            <div class="book-form-group"><label>æ„Ÿæ‚Ÿ</label><textarea v-model="newBook.insights" class="note-textarea"></textarea></div>
                            <div class="book-form-group"><label>æ—¥æœŸ</label><input type="date" v-model="newBook.startDate" class="note-input"></div>
                            <button class="btn" @click="saveBook">ä¿å­˜è¯»ä¹¦ç¬”è®°</button>
                        </div>
                        
                        <!-- ä¹¦ç±åˆ—è¡¨ -->
                        <div v-if="activeBookTab === 'all'" class="book-grid">
                            <div v-for="book in books" :key="book.id" class="book-card" @click="openBookDetail(book)">
                                <div class="book-header">
                                    <div>
                                        <h3>{{ book.title }}</h3>
                                        <div class="book-author">ä½œè€…ï¼š{{ book.author }}</div>
                                    </div>
                                    <span class="book-status" :class="book.status">
                                        {{ book.status === 'planning' ? 'è®¡åˆ’ä¸­' : book.status === 'reading' ? 'é˜…è¯»ä¸­' : 'å·²è¯»å®Œ' }}
                                    </span>
                                </div>
                                <div class="book-rating-display">
                                    <span v-for="star in 5" :key="star">{{ star <= book.rating ? 'â˜…' : 'â˜†' }}</span>
                                </div>
                                <div class="book-content" v-if="book.notes">
                                    <strong>ç¬”è®°é¢„è§ˆï¼š</strong>{{ book.notes }}
                                </div>
                                <div class="book-footer">
                                    <div class="book-tags"><span v-for="tag in book.tags" :key="tag" class="book-tag">{{ tag }}</span></div>
                                    <div class="book-actions">
                                        <button class="book-action-btn" @click.stop="editBook(book.id)">âœï¸</button>
                                        <button class="book-action-btn" @click.stop="deleteBook(book.id)">ğŸ—‘ï¸</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- çŸ¥è¯†åº“å…¥å£ -->
                <div class="card">
                    <h2>ğŸ“š çŸ¥è¯†åº“</h2>
                    <p style="margin: 15px 0; color: #7a6a62;">æ•´ç†ç¬”è®°ï¼Œæ„å»ºä½ çš„çŸ¥è¯†ä½“ç³»ï¼ˆè¯­é›€é£æ ¼ï¼‰</p>
                    <button class="btn" @click="openKnowledgeBase" style="background: linear-gradient(90deg, #667eea, #764ba2); box-shadow: 4px 4px 0px #5a4a42;">
                        ğŸ“š è¿›å…¥çŸ¥è¯†åº“
                    </button>
                </div>
            </div>
        </div>

        <!-- ä¹¦ç±è¯¦æƒ…å¼¹çª— -->
        <div v-if="isLoggedIn && viewingBook" class="kb-form-overlay" @click.self="closeBookDetail">
            <div class="book-detail-modal">
                <div class="book-detail-header">
                    <div style="flex: 1;">
                        <h2 style="font-size: 1.8em; margin-bottom: 5px;">{{ viewingBook.title }}</h2>
                        <div style="opacity: 0.9;">{{ viewingBook.author }}</div>
                    </div>
                    <button @click="closeBookDetail" style="background:none; border:none; color:white; font-size: 24px; cursor:pointer;">âœ•</button>
                </div>
                <div class="book-detail-content">
                    <div class="book-detail-section" style="display:flex; justify-content:space-between; border-bottom:1px dotted #ccc; padding-bottom:15px;">
                        <div>
                            <span class="book-status" :class="viewingBook.status">{{ viewingBook.status === 'planning' ? 'è®¡åˆ’ä¸­' : viewingBook.status === 'reading' ? 'é˜…è¯»ä¸­' : 'å·²è¯»å®Œ' }}</span>
                            <span style="color:#ffd700; font-size:1.2em; margin-left:15px;">
                                <span v-for="star in 5" :key="star">{{ star <= viewingBook.rating ? 'â˜…' : 'â˜†' }}</span>
                            </span>
                        </div>
                        <div style="font-size:0.9em; color:#888;">
                            <div v-if="viewingBook.startDate">å¼€å§‹: {{ formatDateShort(viewingBook.startDate) }}</div>
                            <div v-if="viewingBook.finishDate">å®Œæˆ: {{ formatDateShort(viewingBook.finishDate) }}</div>
                        </div>
                    </div>

                    <div class="book-detail-section" v-if="viewingBook.tags && viewingBook.tags.length">
                        <div class="book-tags">
                            <span v-for="tag in viewingBook.tags" :key="tag" class="book-tag">{{ tag }}</span>
                        </div>
                    </div>

                    <div class="book-detail-section" v-if="viewingBook.notes">
                        <div class="book-detail-label">è¯»ä¹¦ç¬”è®°</div>
                        <div class="book-detail-text">{{ viewingBook.notes }}</div>
                    </div>

                    <div class="book-detail-section" v-if="viewingBook.insights">
                        <div class="book-detail-label">æ„Ÿæ‚Ÿä¸æ”¶è·</div>
                        <div class="book-detail-text">{{ viewingBook.insights }}</div>
                    </div>
                </div>
                <div class="kb-form-footer">
                    <button class="btn-sm" @click="editBook(viewingBook.id); closeBookDetail();">ç¼–è¾‘</button>
                    <button class="btn-sm" style="background: #e0c9b8;" @click="closeBookDetail">å…³é—­</button>
                </div>
            </div>
        </div>

        <!-- è¯­é›€é£æ ¼çŸ¥è¯†åº“å¼¹çª— -->
        <div v-if="isLoggedIn && showKnowledgeBase" class="kb-modal-overlay" @click.self="closeKnowledgeBase">
            <div class="kb-modal">
                <!-- å·¦ä¾§ï¼šçŸ¥è¯†åº“å¯¼èˆª -->
                <div class="kb-sidebar">
                    <div class="kb-sidebar-header">
                        <h3>æˆ‘çš„çŸ¥è¯†åº“</h3>
                        <button class="kb-add-repo-btn" @click="showCategoryForm = true" title="æ–°å»ºçŸ¥è¯†åº“">+</button>
                    </div>
                    <div class="kb-nav-list">
                        <!-- å¸¸ç”¨å…¥å£ -->
                        <div class="kb-nav-item" :class="{active: selectedCategory === 'recent'}" @click="selectCategory('recent')">
                            <span class="kb-nav-icon">ğŸ•’</span>
                            <span class="kb-nav-text">æœ€è¿‘ç¼–è¾‘</span>
                        </div>
                        <div class="kb-nav-item" :class="{active: selectedCategory === 'all'}" @click="selectCategory('all')">
                            <span class="kb-nav-icon">ğŸ“‘</span>
                            <span class="kb-nav-text">æ‰€æœ‰æ–‡æ¡£</span>
                        </div>
                        
                        <!-- åˆ†å‰²çº¿ -->
                        <div style="height: 1px; background: #f0f0f0; margin: 8px 12px;"></div>
                        
                        <!-- çŸ¥è¯†åº“åˆ—è¡¨ -->
                        <div v-for="category in kbCategories" :key="category.id" 
                             class="kb-nav-item" 
                             :class="{active: selectedCategory && selectedCategory.id === category.id}"
                             @click="selectCategory(category)">
                            <span class="kb-nav-icon">{{ category.icon }}</span>
                            <span class="kb-nav-text">{{ category.name }}</span>
                            <span class="kb-nav-count">{{ getCategoryNotesCount(category.id) }}</span>
                        </div>
                        
                        <div class="kb-nav-item" :class="{active: selectedCategory === 'uncategorized'}" @click="selectCategory('uncategorized')">
                            <span class="kb-nav-icon">ğŸ“‚</span>
                            <span class="kb-nav-text">æœªåˆ†ç±»</span>
                            <span class="kb-nav-count">{{ getUncategorizedCount() }}</span>
                        </div>
                    </div>
                </div>

                <!-- å³ä¾§ï¼šä¸»åŒºåŸŸ -->
                <div class="kb-main">
                    <!-- é¡¶éƒ¨å·¥å…·æ  -->
                    <div class="kb-toolbar">
                        <div class="kb-breadcrumb">
                            <span class="kb-breadcrumb-link" @click="closeKnowledgeBase">é¦–é¡µ</span>
                            <span class="kb-breadcrumb-sep">/</span>
                            <span v-if="viewingNote" class="kb-breadcrumb-link" @click="viewingNote = null">
                                {{ getCategoryNameStr() }}
                            </span>
                            <span v-else class="kb-breadcrumb-current">{{ getCategoryNameStr() }}</span>
                            <span v-if="viewingNote" class="kb-breadcrumb-sep">/</span>
                            <span v-if="viewingNote" class="kb-breadcrumb-current">æ–‡æ¡£è¯¦æƒ…</span>
                        </div>
                        
                        <div class="kb-action-group">
                            <div class="kb-search-bar" v-if="!viewingNote">
                                <span class="kb-search-icon">ğŸ”</span>
                                <input type="text" v-model="kbSearchQuery" placeholder="æœç´¢..." class="kb-search-input-yuque">
                            </div>
                            <button class="kb-btn-primary" @click="showNoteEditor = true; editingNoteId = null;">
                                <span>+</span> æ–°å»ºæ–‡æ¡£
                            </button>
                            <button class="close-icon-btn" @click="closeKnowledgeBase">âœ•</button>
                        </div>
                    </div>

                    <!-- è§†å›¾å†…å®¹ï¼šé˜…è¯»æ¨¡å¼ OR åˆ—è¡¨æ¨¡å¼ -->
                    <div class="kb-content-area">
                        <!-- é˜…è¯»æ¨¡å¼ -->
                        <div v-if="viewingNote" class="kb-detail-view">
                            <div class="kb-detail-header">
                                <h1 class="kb-detail-title">{{ viewingNote.title }}</h1>
                                <div class="kb-detail-meta-row">
                                    <span>ğŸ“… {{ formatDate(viewingNote.updatedAt || viewingNote.createdAt) }}</span>
                                    <span>ğŸ“‚ {{ getCategoryName(viewingNote.categoryId) }}</span>
                                    <div style="flex:1"></div>
                                    <button class="yuque-btn-secondary" @click="editKbNote(viewingNote)">ç¼–è¾‘</button>
                                    <button class="yuque-btn-secondary" style="color:#ff4d4f; border-color:#ff4d4f;" @click="deleteKbNote(viewingNote.id); viewingNote = null;">åˆ é™¤</button>
                                </div>
                            </div>
                            <div class="kb-detail-body">{{ viewingNote.content }}</div>
                        </div>

                        <!-- åˆ—è¡¨æ¨¡å¼ -->
                        <div v-else class="kb-list-view">
                            <div class="kb-list-header">
                                <h2 class="kb-list-title">
                                    {{ getCategoryIconStr() }} {{ getCategoryNameStr() }}
                                    <button v-if="selectedCategory && selectedCategory.id" 
                                            class="yuque-btn-secondary" style="font-size:12px; margin-left:10px;"
                                            @click="editCategory(selectedCategory)">è®¾ç½®</button>
                                </h2>
                            </div>
                            
                            <div v-if="filteredKbNotes.length === 0" style="text-align: center; color: #bfbfbf; padding: 40px;">
                                ç©ºç©ºå¦‚ä¹Ÿï¼Œå¼€å§‹åˆ›å»ºç¬¬ä¸€ç¯‡æ–‡æ¡£å§
                            </div>

                            <div v-for="note in filteredKbNotes" :key="note.id" class="kb-doc-item" @click="viewingNote = note">
                                <div class="kb-doc-icon">ğŸ“„</div>
                                <div class="kb-doc-info">
                                    <div class="kb-doc-title">{{ note.title }}</div>
                                    <div class="kb-doc-meta">
                                        {{ formatDateShort(note.updatedAt || note.createdAt) }} Â· 
                                        {{ note.content.substring(0, 30).replace(/\n/g, ' ') }}...
                                    </div>
                                </div>
                                <div class="kb-doc-actions">
                                    <button class="kb-icon-btn-sm" @click.stop="editKbNote(note)" title="ç¼–è¾‘">âœï¸</button>
                                    <button class="kb-icon-btn-sm" @click.stop="deleteKbNote(note.id)" title="åˆ é™¤">ğŸ—‘ï¸</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- KB: æ–°å»º/ç¼–è¾‘åˆ†ç±»å¼¹çª— -->
        <div v-if="isLoggedIn && showCategoryForm" class="kb-form-overlay" @click.self="closeCategoryForm">
            <div class="kb-form-modal">
                <div class="kb-form-header">
                    <h2>{{ editingCategoryId ? 'çŸ¥è¯†åº“è®¾ç½®' : 'æ–°å»ºçŸ¥è¯†åº“' }}</h2>
                    <button class="close-icon-btn" @click="closeCategoryForm">âœ•</button>
                </div>
                <div class="kb-form-body">
                    <div style="margin-bottom: 20px;">
                        <label style="display:block; margin-bottom:8px; font-weight:600;">åç§°</label>
                        <input type="text" v-model="categoryForm.name" placeholder="ä¾‹å¦‚ï¼šäº§å“æ–‡æ¡£ã€ä¸ªäººæ—¥è®°..." class="yuque-input">
                    </div>
                    <div>
                        <label style="display:block; margin-bottom:8px; font-weight:600;">å›¾æ ‡</label>
                        <div class="yuque-icon-grid">
                            <button v-for="icon in categoryIcons" :key="icon" 
                                    class="yuque-icon-btn" :class="{ active: categoryForm.icon === icon }"
                                    @click="categoryForm.icon = icon">{{ icon }}</button>
                        </div>
                    </div>
                </div>
                <div class="kb-form-footer">
                    <button v-if="editingCategoryId" class="yuque-btn-secondary" style="color:#ff4d4f; border-color:#ff4d4f; margin-right:auto;" @click="deleteCategory(editingCategoryId)">åˆ é™¤æ­¤åº“</button>
                    <button class="yuque-btn-secondary" @click="closeCategoryForm">å–æ¶ˆ</button>
                    <button class="kb-btn-primary" @click="saveCategoryForm">ç¡®å®š</button>
                </div>
            </div>
        </div>

        <!-- KB: æ–°å»º/ç¼–è¾‘æ–‡æ¡£å¼¹çª— -->
        <div v-if="isLoggedIn && showNoteEditor" class="kb-form-overlay" @click.self="closeNoteEditor">
            <div class="kb-form-modal" style="max-width: 800px;">
                <div class="kb-form-header">
                    <h2>{{ editingNoteId ? 'ç¼–è¾‘æ–‡æ¡£' : 'æ–°å»ºæ–‡æ¡£' }}</h2>
                    <button class="close-icon-btn" @click="closeNoteEditor">âœ•</button>
                </div>
                <div class="kb-form-body">
                    <div style="margin-bottom: 16px;">
                        <input type="text" v-model="noteForm.title" placeholder="è¾“å…¥æ–‡æ¡£æ ‡é¢˜" class="yuque-input" style="font-size: 18px; font-weight: 600; padding: 10px;">
                    </div>
                    <div style="margin-bottom: 16px;">
                        <select v-model="noteForm.categoryId" class="yuque-input">
                            <option :value="null">é€‰æ‹©å½’å±çŸ¥è¯†åº“ (æœªåˆ†ç±»)</option>
                            <option v-for="category in kbCategories" :key="category.id" :value="category.id">
                                {{ category.icon }} {{ category.name }}
                            </option>
                        </select>
                    </div>
                    <div>
                        <textarea v-model="noteForm.content" placeholder="è¾“å…¥æ­£æ–‡..." class="yuque-textarea" style="height: 400px;"></textarea>
                    </div>
                </div>
                <div class="kb-form-footer">
                    <button class="yuque-btn-secondary" @click="closeNoteEditor">å–æ¶ˆ</button>
                    <button class="kb-btn-primary" @click="saveNoteForm">å‘å¸ƒ</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        const SUPABASE_URL = 'https://zqmgigcnruvvdcholbuj.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpxbWdpZ2NucnV2dmRjaG9sYnVqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4NjgzNjEsImV4cCI6MjA4MTQ0NDM2MX0.IHzDp7o5M9QM8IBWy2ri5gS9h9nm0zk3AaPTNveDqXI';
        const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    // Auth & Loading
                    isLoggedIn: false, userId: null, userEmail: '', email: '', password: '',
                    loading: false, syncing: false, saving: false, dataLoaded: false,
                    message: '', messageType: 'success',
                    
                    // UI State
                    collapsed: { status: false, skills: false, achievements: false, notes: false, books: false },
                    
                    // Data Models
                    playerData: { level: 1, xp: 0, nextLevelXp: 100 },
                    skills: [],
                    achievements: [
                        { id: 1, name: 'åˆå­¦è€…', icon: 'ğŸŒ±', description: 'åˆ›å»ºç¬¬ä¸€ä¸ªæŠ€èƒ½', requirement: 1, current: 0, unlocked: false, reward: 50 },
                        { id: 2, name: 'å¤šé¢æ‰‹', icon: 'ğŸ”§', description: 'æ‹¥æœ‰5ä¸ªæŠ€èƒ½', requirement: 5, current: 0, unlocked: false, reward: 150 },
                    ],
                    
                    // Notebook
                    notes: [], activeNoteTab: 'all', newNote: { title: '', content: '', tags: '' },
                    
                    // Books
                    books: [], activeBookTab: 'all', editingBookId: null, viewingBook: null, // æ–°å¢ viewingBook
                    newBook: { title: '', author: '', status: 'planning', rating: 0, notes: '', insights: '', tags: [], startDate: '', finishDate: '' },
                    
                    // Knowledge Base (Yuque Style)
                    showKnowledgeBase: false, kbCategories: [], kbNotes: [], 
                    selectedCategory: 'recent', // é»˜è®¤ä¸º 'recent'
                    kbSearchQuery: '', viewingNote: null,
                    showCategoryForm: false, editingCategoryId: null, categoryForm: { name: '', icon: 'ğŸ“˜' },
                    showNoteEditor: false, editingNoteId: null, noteForm: { title: '', content: '', categoryId: null },
                    categoryIcons: ['ğŸ“˜', 'ğŸ“•', 'ğŸ“—', 'ğŸ“™', 'ğŸ““', 'ğŸ“', 'ğŸ“‚', 'ğŸ—‚ï¸', 'ğŸ§ ', 'ğŸ’¡', 'ğŸš€', 'ğŸ¨', 'ğŸ’¼'],
                };
            },
            computed: {
                xpPercentage() { return Math.min(100, (this.playerData.xp / this.playerData.nextLevelXp) * 100); },
                filteredKbNotes() {
                    let filtered = [...this.kbNotes];
                    
                    // åˆ†ç±»ç­›é€‰
                    if (this.selectedCategory === 'recent') {
                        // æœ€è¿‘ç¼–è¾‘: æŒ‰æ›´æ–°æ—¶é—´æ’åºå–å‰20
                        filtered.sort((a, b) => new Date(b.updatedAt || b.createdAt) - new Date(a.updatedAt || a.createdAt));
                    } else if (this.selectedCategory === 'all') {
                        // å…¨éƒ¨
                    } else if (this.selectedCategory === 'uncategorized') {
                        filtered = filtered.filter(n => !n.categoryId);
                    } else if (this.selectedCategory && this.selectedCategory.id) {
                        filtered = filtered.filter(n => n.categoryId === this.selectedCategory.id);
                    }
                    
                    // æœç´¢ç­›é€‰
                    if (this.kbSearchQuery.trim()) {
                        const q = this.kbSearchQuery.toLowerCase();
                        filtered = filtered.filter(n => n.title.toLowerCase().includes(q) || n.content.toLowerCase().includes(q));
                    }
                    
                    // é»˜è®¤æŒ‰æ—¶é—´å€’åº
                    return filtered.sort((a, b) => new Date(b.updatedAt || b.createdAt) - new Date(a.updatedAt || a.createdAt));
                }
            },
            methods: {
                // é€šç”¨é€»è¾‘
                showMessage(text, type = 'success') { this.message = text; this.messageType = type; setTimeout(() => this.message = '', 3000); },
                formatDate(str) { if(!str) return ''; return new Date(str).toLocaleString('zh-CN'); },
                formatDateShort(str) { if(!str) return ''; return new Date(str).toLocaleDateString('zh-CN'); },
                
                // é‰´æƒ
                async login() {
                    if (!this.email || !this.password) return this.showMessage('è¯·è¾“å…¥é‚®ç®±å¯†ç ', 'error');
                    this.loading = true;
                    const { data, error } = await sb.auth.signInWithPassword({ email: this.email, password: this.password });
                    this.loading = false;
                    if (error) return this.showMessage(error.message, 'error');
                    this.isLoggedIn = true; this.userId = data.user.id; this.userEmail = data.user.email;
                    this.loadAllData();
                },
                async register() {
                     if (!this.email || !this.password) return this.showMessage('è¯·è¾“å…¥é‚®ç®±å¯†ç ', 'error');
                     this.loading = true;
                     const { error } = await sb.auth.signUp({ email: this.email, password: this.password });
                     this.loading = false;
                     if (error) return this.showMessage(error.message, 'error');
                     this.showMessage('æ³¨å†ŒæˆåŠŸï¼Œè¯·ç™»å½•', 'success');
                },
                async logout() { await sb.auth.signOut(); this.isLoggedIn = false; window.location.reload(); },

                // æ•°æ®åŠ è½½ä¸ä¿å­˜ (ç®€åŒ–ç‰ˆï¼Œæ ¸å¿ƒé€»è¾‘åŒä¸Š)
                async loadAllData() {
                    this.syncing = true;
                    // å¹¶è¡ŒåŠ è½½æ‰€æœ‰è¡¨
                    const p1 = sb.from('players').select('*').eq('user_id', this.userId).single();
                    const p2 = sb.from('skills').select('*').eq('user_id', this.userId);
                    const p3 = sb.from('achievements').select('*').eq('user_id', this.userId);
                    const p4 = sb.from('notes').select('*').eq('user_id', this.userId);
                    const p5 = sb.from('books').select('*').eq('user_id', this.userId);
                    const p6 = sb.from('kb_categories').select('*').eq('user_id', this.userId);
                    const p7 = sb.from('kb_notes').select('*').eq('user_id', this.userId);
                    
                    const [r1, r2, r3, r4, r5, r6, r7] = await Promise.all([p1, p2, p3, p4, p5, p6, p7]);
                    
                    if(r1.data) this.playerData = r1.data.data;
                    if(r2.data) this.skills = r2.data.map(i => i.data);
                    // ç®€å•å¤„ç†ï¼Œå®é™…åº”åˆå¹¶
                    if(r3.data && r3.data.length) this.achievements = r3.data.map(i => i.data);
                    if(r4.data) this.notes = r4.data.map(i => i.data);
                    if(r5.data) this.books = r5.data.map(i => i.data);
                    if(r6.data) this.kbCategories = r6.data.map(i => i.data);
                    if(r7.data) this.kbNotes = r7.data.map(i => i.data);
                    
                    this.syncing = false; this.dataLoaded = true;
                },
                async saveAllData() {
                    if(!this.userId) return;
                    this.saving = true;
                    // å…ˆæ¸…ç©ºæ—§æ•°æ® (ç®€å•ç²—æš´çš„å…¨é‡åŒæ­¥ç­–ç•¥)
                    await Promise.all([
                        sb.from('skills').delete().eq('user_id', this.userId),
                        sb.from('achievements').delete().eq('user_id', this.userId),
                        sb.from('notes').delete().eq('user_id', this.userId),
                        sb.from('books').delete().eq('user_id', this.userId),
                        sb.from('kb_categories').delete().eq('user_id', this.userId),
                        sb.from('kb_notes').delete().eq('user_id', this.userId),
                    ]);
                    
                    const payload = (list) => list.map(item => ({ user_id: this.userId, data: item }));
                    
                    await sb.from('players').upsert({ user_id: this.userId, data: this.playerData });
                    if(this.skills.length) await sb.from('skills').insert(payload(this.skills));
                    if(this.achievements.length) await sb.from('achievements').insert(payload(this.achievements));
                    if(this.notes.length) await sb.from('notes').insert(payload(this.notes));
                    if(this.books.length) await sb.from('books').insert(payload(this.books));
                    if(this.kbCategories.length) await sb.from('kb_categories').insert(payload(this.kbCategories));
                    if(this.kbNotes.length) await sb.from('kb_notes').insert(payload(this.kbNotes));
                    
                    this.saving = false; this.showMessage('ä¿å­˜æˆåŠŸ');
                },

                // æŠ€èƒ½ç›¸å…³
                addXp(amount) {
                    this.playerData.xp += amount;
                    if(this.playerData.xp >= this.playerData.nextLevelXp) {
                        this.playerData.xp -= this.playerData.nextLevelXp;
                        this.playerData.level++;
                        this.playerData.nextLevelXp = Math.floor(this.playerData.nextLevelXp * 1.5);
                        this.showMessage(`å‡çº§äº†ï¼Lv.${this.playerData.level}`);
                    }
                },
                addNewSkill() {
                    const name = prompt('æŠ€èƒ½åç§°'); if(!name) return;
                    this.skills.push({ id: Date.now(), name, icon: 'âœ¨', level: 1, xp: 0, maxXp: 50 });
                    this.addXp(10);
                },
                practiceSkill(id) {
                    const s = this.skills.find(x => x.id === id);
                    if(s) {
                        s.xp += 10; 
                        if(s.xp >= s.maxXp) { s.xp = 0; s.level++; s.maxXp = Math.floor(s.maxXp * 1.3); }
                        this.addXp(5);
                    }
                },
                deleteSkill(id) { this.skills = this.skills.filter(x => x.id !== id); },

                // ç¬”è®°
                saveNote() {
                    this.notes.unshift({ id: Date.now(), ...this.newNote, createdAt: new Date().toISOString() });
                    this.newNote = { title: '', content: '', tags: '' };
                },
                deleteNote(id) { this.notes = this.notes.filter(x => x.id !== id); },

                // è¯»ä¹¦ç¬”è®°
                openBookDetail(book) { this.viewingBook = book; },
                closeBookDetail() { this.viewingBook = null; },
                saveBook() {
                    const book = {
                        id: this.editingBookId || Date.now(),
                        ...this.newBook,
                        createdAt: new Date().toISOString()
                    };
                    if(this.editingBookId) {
                        const idx = this.books.findIndex(b => b.id === this.editingBookId);
                        this.books[idx] = book;
                    } else {
                        this.books.unshift(book);
                        this.addXp(20);
                    }
                    this.saveAllData();
                    this.activeBookTab = 'all'; this.newBook = { title: '', author: '', status: 'planning', rating: 0, notes: '', insights: '', tags: [] }; this.editingBookId = null;
                },
                editBook(id) {
                    const b = this.books.find(x => x.id === id);
                    this.newBook = { ...b };
                    this.editingBookId = id;
                    this.activeBookTab = 'new';
                },
                deleteBook(id) { if(confirm('åˆ é™¤?')) this.books = this.books.filter(x => x.id !== id); this.saveAllData(); },

                // çŸ¥è¯†åº“ (Yuque Logic)
                openKnowledgeBase() { this.showKnowledgeBase = true; this.selectedCategory = 'recent'; this.viewingNote = null; },
                closeKnowledgeBase() { this.showKnowledgeBase = false; },
                
                selectCategory(cat) { 
                    this.selectedCategory = cat; 
                    this.viewingNote = null; // åˆ‡æ¢åˆ†ç±»æ—¶å›åˆ°åˆ—è¡¨æ¨¡å¼
                },
                
                getCategoryNameStr() {
                    if (this.selectedCategory === 'recent') return 'æœ€è¿‘ç¼–è¾‘';
                    if (this.selectedCategory === 'all') return 'æ‰€æœ‰æ–‡æ¡£';
                    if (this.selectedCategory === 'uncategorized') return 'æœªåˆ†ç±»';
                    return this.selectedCategory.name;
                },
                getCategoryIconStr() {
                    if (this.selectedCategory === 'recent') return 'ğŸ•’';
                    if (this.selectedCategory === 'all') return 'ğŸ“‘';
                    if (this.selectedCategory === 'uncategorized') return 'ğŸ“‚';
                    return this.selectedCategory.icon;
                },
                getCategoryName(id) {
                    const c = this.kbCategories.find(x => x.id === id);
                    return c ? c.name : 'æœªåˆ†ç±»';
                },
                getCategoryNotesCount(id) { return this.kbNotes.filter(n => n.categoryId === id).length; },
                getUncategorizedCount() { return this.kbNotes.filter(n => !n.categoryId).length; },

                // KB åˆ†ç±»ç®¡ç†
                saveCategoryForm() {
                    if(!this.categoryForm.name) return;
                    if(this.editingCategoryId) {
                        const c = this.kbCategories.find(x => x.id === this.editingCategoryId);
                        c.name = this.categoryForm.name; c.icon = this.categoryForm.icon;
                    } else {
                        this.kbCategories.push({ id: Date.now(), ...this.categoryForm });
                    }
                    this.saveAllData(); this.closeCategoryForm();
                },
                editCategory(c) { this.categoryForm = {name: c.name, icon: c.icon}; this.editingCategoryId = c.id; this.showCategoryForm = true; },
                deleteCategory(id) {
                    if(!confirm('åˆ é™¤æ­¤çŸ¥è¯†åº“ï¼Ÿæ–‡æ¡£å°†å˜ä¸ºæœªåˆ†ç±»ã€‚')) return;
                    this.kbCategories = this.kbCategories.filter(c => c.id !== id);
                    this.kbNotes.forEach(n => { if(n.categoryId === id) n.categoryId = null; });
                    this.selectedCategory = 'all';
                    this.saveAllData(); this.closeCategoryForm();
                },
                closeCategoryForm() { this.showCategoryForm = false; this.editingCategoryId = null; this.categoryForm = {name:'', icon:'ğŸ“˜'}; },

                // KB æ–‡æ¡£ç®¡ç†
                editKbNote(note) {
                    this.noteForm = { title: note.title, content: note.content, categoryId: note.categoryId };
                    this.editingNoteId = note.id;
                    this.showNoteEditor = true;
                },
                saveNoteForm() {
                    if(!this.noteForm.title) return this.showMessage('è¯·è¾“å…¥æ ‡é¢˜', 'error');
                    const now = new Date().toISOString();
                    if(this.editingNoteId) {
                        const n = this.kbNotes.find(x => x.id === this.editingNoteId);
                        Object.assign(n, this.noteForm, { updatedAt: now });
                        // å¦‚æœæ­£åœ¨æŸ¥çœ‹è¯¥æ–‡æ¡£ï¼ŒåŒæ­¥æ›´æ–°è§†å›¾
                        if(this.viewingNote && this.viewingNote.id === n.id) {
                            this.viewingNote = n;
                        }
                    } else {
                        const newNote = { id: Date.now(), ...this.noteForm, createdAt: now, updatedAt: now };
                        this.kbNotes.unshift(newNote);
                        // æ–°å»ºåç›´æ¥è¿›å…¥æŸ¥çœ‹æ¨¡å¼
                        this.viewingNote = newNote;
                        // å¦‚æœæœ‰åˆ†ç±»ï¼Œåˆ‡æ¢åˆ°è¯¥åˆ†ç±»è§†å›¾
                        if (newNote.categoryId) {
                            this.selectedCategory = this.kbCategories.find(c => c.id === newNote.categoryId) || 'all';
                        }
                        this.addXp(5);
                    }
                    this.saveAllData();
                    this.closeNoteEditor();
                },
                closeNoteEditor() { this.showNoteEditor = false; this.editingNoteId = null; this.noteForm = {title:'', content:'', categoryId: null}; },
                deleteKbNote(id) {
                    if(!confirm('åˆ é™¤æ–‡æ¡£?')) return;
                    this.kbNotes = this.kbNotes.filter(x => x.id !== id);
                    this.saveAllData();
                }
            },
            mounted() {
                // Check Session
                sb.auth.getSession().then(({ data: { session } }) => {
                    if(session) { this.isLoggedIn = true; this.userId = session.user.id; this.userEmail = session.user.email; this.loadAllData(); }
                });
            }
        }).mount('#app');
    </script>
</body>
</html>

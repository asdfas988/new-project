<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆé•¿æ‰‹è´¦ - ä¸ªäººç‹¬äº«ç‰ˆ</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* ========== å…¨å±€é…ç½® ========== */
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%); /* æ›´æ²‰ç¨³çš„ç´«è“æ¸å˜ */
            --accent-color: #5a4a42;
            --bg-color: #f7f9fc;
            --card-bg: #ffffff;
            --border-color: #e2e8f0;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Noto Sans SC', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-color);
            min-height: 100vh;
            color: var(--accent-color);
            padding: 20px;
        }

        /* ç™»å½•é¡µä¸“ç”¨æ ·å¼ */
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            text-align: center;
        }
        .login-logo { font-size: 3em; margin-bottom: 20px; }
        
        /* å¸ƒå±€ä¸å®¹å™¨ */
        .container { max-width: 1400px; margin: 0 auto; }
        .grid { display: grid; grid-template-columns: 1fr; gap: 30px; margin-bottom: 40px; }
        .card {
            background: var(--card-bg); border-radius: 16px; padding: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05); border: 1px solid var(--border-color);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px rgba(0,0,0,0.1); }
        .card h2 {
            margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px dashed var(--border-color);
            font-size: 1.3em; font-weight: 700; color: #2d3748;
            display: flex; justify-content: space-between; align-items: center;
        }

        /* æŒ‰é’®ä¸è¾“å…¥æ¡† */
        .btn {
            background: var(--primary-gradient); border: none; padding: 12px 24px;
            border-radius: 8px; color: white; cursor: pointer; font-size: 15px; font-weight: 600;
            width: 100%; transition: opacity 0.2s; box-shadow: 0 4px 6px rgba(118, 75, 162, 0.3);
        }
        .btn:hover { opacity: 0.9; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        
        .btn-sm {
            padding: 6px 14px; font-size: 0.85em; border-radius: 6px;
            background: #edf2f7; color: #4a5568; border: 1px solid #cbd5e0;
            cursor: pointer; font-weight: 600;
        }
        .btn-sm:hover { background: #e2e8f0; }
        .btn-danger { background: #fff5f5; color: #c53030; border-color: #fc8181; }
        
        .note-input, .note-textarea {
            width: 100%; padding: 12px; border: 1px solid #cbd5e0; border-radius: 8px;
            font-size: 14px; margin-bottom: 15px; transition: border 0.2s;
            font-family: inherit; background: #f8fafc;
        }
        .note-input:focus, .note-textarea:focus { outline: none; border-color: #667eea; background: white; }
        
        /* çŠ¶æ€æç¤º */
        .status-message { 
            padding: 12px; border-radius: 8px; margin: 15px 0; font-size: 0.9em; 
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .status-success { background: #f0fff4; color: #276749; border: 1px solid #c6f6d5; }
        .status-error { background: #fff5f5; color: #c53030; border: 1px solid #feb2b2; }

        /* å¤ç›˜ç³»ç»Ÿ */
        .review-tabs { display: flex; gap: 8px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 5px; }
        .review-tab {
            padding: 6px 16px; border-radius: 20px; font-size: 0.9em; font-weight: 600;
            cursor: pointer; background: #edf2f7; color: #718096; transition: all 0.2s;
            white-space: nowrap;
        }
        .review-tab.active { background: #667eea; color: white; }
        
        /* åˆ—è¡¨é¡¹ */
        .item-card { 
            background: #fff; border: 1px solid #e2e8f0; border-radius: 10px; padding: 15px; 
            margin-bottom: 15px; transition: all 0.2s; 
        }
        .item-card:hover { border-color: #667eea; }
        .tag-pill { display: inline-block; padding: 2px 8px; border-radius: 4px; background: #edf2f7; color: #4a5568; font-size: 0.75em; margin-right: 5px; }

        /* çŸ¥è¯†åº“å¼¹çª— (è¯­é›€é£æ ¼) */
        .kb-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.3); backdrop-filter: blur(2px); z-index: 1000; display: flex; justify-content: center; align-items: center; }
        .kb-window { width: 95%; max-width: 1400px; height: 90vh; background: white; border-radius: 12px; display: flex; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); overflow: hidden; }
        .kb-sidebar { width: 240px; background: #f8fafc; border-right: 1px solid #e2e8f0; display: flex; flex-direction: column; }
        .kb-main { flex: 1; display: flex; flex-direction: column; background: white; }
        .kb-toolbar { height: 60px; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; padding: 0 20px; justify-content: space-between; }
        .kb-content { flex: 1; padding: 40px; overflow-y: auto; }
        
        .kb-nav-item { padding: 10px 20px; font-size: 0.9em; color: #4a5568; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .kb-nav-item:hover { background: #edf2f7; }
        .kb-nav-item.active { background: #ebf4ff; color: #4299e1; border-right: 3px solid #4299e1; }

        /* ä»ªè¡¨ç›˜ */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-box { background: white; padding: 20px; border-radius: 12px; text-align: center; border: 1px solid #e2e8f0; }
        .stat-num { font-size: 2em; font-weight: 700; color: #667eea; }
        .stat-label { font-size: 0.9em; color: #718096; }

        @media (max-width: 768px) {
            .grid { grid-template-columns: 1fr; }
            .kb-window { width: 100%; height: 100vh; border-radius: 0; }
            .kb-sidebar { width: 60px; }
            .kb-nav-item span:not(.icon) { display: none; }
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- ç™»å½•ç•Œé¢ -->
        <div v-if="!isLoggedIn" class="login-container">
            <div class="login-logo">ğŸš€</div>
            <h2 style="margin-bottom: 10px; color: #2d3748;">æˆé•¿æ‰‹è´¦</h2>
            <p style="color: #718096; margin-bottom: 30px; font-size: 0.9em;">ä¸ªäººç‹¬äº« Â· çŸ¥è¯†ç®¡ç† Â· å¤ç›˜ç³»ç»Ÿ</p>
            
            <input type="email" v-model="email" placeholder="è¾“å…¥æ‚¨çš„ Supabase é‚®ç®±" class="note-input" @keyup.enter="login">
            <input type="password" v-model="password" placeholder="è¾“å…¥å¯†ç " class="note-input" @keyup.enter="login">
            
            <button class="btn" @click="login" :disabled="loading">
                {{ loading ? 'éªŒè¯ä¸­...' : 'è¿›å…¥ç³»ç»Ÿ' }}
            </button>
            
            <div v-if="message" :class="['status-message', messageType === 'success' ? 'status-success' : 'status-error']">
                {{ message }}
            </div>

            <div style="margin-top: 20px; font-size: 0.8em; color: #a0aec0; line-height: 1.5;">
                <p>âš ï¸ æç¤ºï¼šæ˜¾ç¤º Invalid login credentialsï¼Ÿ</p>
                <p>è¯·ç¡®ä¿æ‚¨å·²åœ¨ Supabase åå° Authentication æ ç›®ä¸­<br>æ‰‹åŠ¨åˆ›å»ºäº†è¯¥ç”¨æˆ·ã€‚</p>
            </div>
        </div>

        <!-- ä¸»ç•Œé¢ -->
        <div v-else class="container" style="padding: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <div>
                    <h1 style="font-size: 1.5em; color: #2d3748;">ğŸ‘‹ ä½ å¥½ï¼Œ{{ userEmail.split('@')[0] }}</h1>
                    <p style="color: #718096; font-size: 0.9em;">ä»Šå¤©ä¹Ÿè¦ä¿æŒè¿›æ­¥</p>
                </div>
                <div>
                    <button class="btn-sm" @click="syncData" :disabled="syncing">
                        {{ syncing ? 'â˜ï¸ åŒæ­¥ä¸­...' : 'ğŸ”„ åŒæ­¥æ•°æ®' }}
                    </button>
                    <button class="btn-sm btn-danger" @click="logout" style="margin-left: 10px;">é€€å‡º</button>
                </div>
            </div>

            <div v-if="message" :class="['status-message', messageType === 'success' ? 'status-success' : 'status-error']">
                {{ message }}
            </div>

            <!-- æ•°æ®æ¦‚è§ˆ -->
            <div class="stats-grid">
                <div class="stat-box">
                    <div class="stat-num">{{ playerData.level }}</div>
                    <div class="stat-label">å½“å‰ç­‰çº§</div>
                </div>
                <div class="stat-box">
                    <div class="stat-num">{{ notes.length }}</div>
                    <div class="stat-label">å¤ç›˜è®°å½•</div>
                </div>
                <div class="stat-box">
                    <div class="stat-num">{{ books.filter(b=>b.status==='finished').length }}</div>
                    <div class="stat-label">å·²è¯»ä¹¦ç±</div>
                </div>
                <div class="stat-box">
                    <div class="stat-num">{{ kbDocs.length }}</div>
                    <div class="stat-label">çŸ¥è¯†æ–‡æ¡£</div>
                </div>
            </div>

            <div class="grid">
                <!-- æ¨¡å—ä¸€ï¼šå¤ç›˜ç³»ç»Ÿ -->
                <div class="card">
                    <h2>
                        ğŸ”„ å¤ç›˜ç³»ç»Ÿ
                        <div style="font-size: 0.8em; font-weight: normal; color: #718096;">
                            {{ filteredNotes.length }} æ¡è®°å½•
                        </div>
                    </h2>
                    
                    <div class="review-tabs">
                        <div class="review-tab" :class="{active: activeReviewTab === 'daily'}" @click="activeReviewTab = 'daily'">ğŸ“ æ—¥å¸¸</div>
                        <div class="review-tab" :class="{active: activeReviewTab === 'weekly'}" @click="activeReviewTab = 'weekly'">ğŸ“… å‘¨å¤ç›˜</div>
                        <div class="review-tab" :class="{active: activeReviewTab === 'yearly'}" @click="activeReviewTab = 'yearly'">ğŸ† å¹´æ€»ç»“</div>
                    </div>

                    <!-- è¾“å…¥åŒº -->
                    <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <input v-model="newNote.title" placeholder="æ ‡é¢˜..." class="note-input" style="background: white;">
                        <textarea v-model="newNote.content" placeholder="å†™ä¸‹ä½ çš„æ€è€ƒ..." class="note-textarea" style="background: white; height: 100px;"></textarea>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="font-size: 0.85em; color: #718096;">
                                <span v-if="activeReviewTab === 'weekly'" style="cursor: pointer; color: #667eea;" @click="applyTemplate('weekly')">ğŸ“„ æ’å…¥å‘¨å¤ç›˜æ¨¡æ¿</span>
                                <span v-if="activeReviewTab === 'yearly'" style="cursor: pointer; color: #667eea; margin-left: 10px;" @click="applyTemplate('yearly')">ğŸ“„ æ’å…¥å¹´ç»ˆæ¨¡æ¿</span>
                            </div>
                            <button class="btn-sm" style="background: #667eea; color: white; border: none;" @click="saveNote">å‘å¸ƒ</button>
                        </div>
                    </div>

                    <!-- ç­›é€‰ -->
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <input v-model="noteFilters.search" placeholder="ğŸ” æœç´¢..." class="note-input" style="margin-bottom: 0;">
                        <select v-model="noteFilters.sortBy" class="note-input" style="width: 120px; margin-bottom: 0;">
                            <option value="newest">æœ€æ–°</option>
                            <option value="oldest">æœ€æ—©</option>
                        </select>
                    </div>

                    <!-- åˆ—è¡¨ -->
                    <div v-for="note in filteredNotes" :key="note.id" class="item-card">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <strong style="color: #2d3748;">{{ note.title }}</strong>
                            <small style="color: #a0aec0;">{{ formatDateShort(note.createdAt) }}</small>
                        </div>
                        <p style="color: #4a5568; font-size: 0.95em; line-height: 1.6; white-space: pre-wrap;">{{ note.content }}</p>
                        <div style="margin-top: 10px; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <span v-for="tag in note.tags" :key="tag" class="tag-pill">#{{ tag }}</span>
                            </div>
                            <button class="btn-sm btn-danger" @click="deleteNote(note.id)">åˆ é™¤</button>
                        </div>
                    </div>
                </div>

                <!-- æ¨¡å—äºŒï¼šè¯»ä¹¦ç¬”è®° -->
                <div class="card">
                    <h2>ğŸ“š è¯»ä¹¦ç¬”è®°</h2>
                    
                    <button class="btn-sm" style="width: 100%; margin-bottom: 15px; border-style: dashed;" @click="showBookForm = !showBookForm">
                        {{ showBookForm ? 'æ”¶èµ·è¡¨å•' : '+ æ·»åŠ æ–°ä¹¦' }}
                    </button>

                    <div v-if="showBookForm" style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <input v-model="newBook.title" placeholder="ä¹¦å" class="note-input">
                            <input v-model="newBook.author" placeholder="ä½œè€…" class="note-input">
                        </div>
                        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                            <select v-model="newBook.status" class="note-input" style="margin-bottom: 0;">
                                <option value="planning">ğŸ“… è®¡åˆ’</option>
                                <option value="reading">ğŸ“– åœ¨è¯»</option>
                                <option value="finished">âœ… å·²è¯»</option>
                            </select>
                            <select v-model="newBook.rating" class="note-input" style="margin-bottom: 0;">
                                <option :value="0">è¯„åˆ†</option>
                                <option :value="5">â­â­â­â­â­</option>
                                <option :value="4">â­â­â­â­</option>
                                <option :value="3">â­â­â­</option>
                            </select>
                        </div>
                        <textarea v-model="newBook.notes" placeholder="ç¬”è®°..." class="note-textarea" style="height: 80px;"></textarea>
                        <button class="btn-sm" style="background: #667eea; color: white; border: none; width: 100%;" @click="saveBook">ä¿å­˜ä¹¦ç±</button>
                    </div>

                    <!-- ä¹¦ç±ç­›é€‰ -->
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                         <select v-model="bookFilters.status" class="note-input" style="margin-bottom: 0;">
                            <option value="all">å…¨éƒ¨çŠ¶æ€</option>
                            <option value="reading">åœ¨è¯»</option>
                            <option value="finished">å·²è¯»</option>
                        </select>
                        <input v-model="bookFilters.search" placeholder="ğŸ” æœä¹¦å..." class="note-input" style="margin-bottom: 0;">
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px;">
                        <div v-for="book in filteredBooks" :key="book.id" class="item-card" @click="viewBookDetail(book)" style="cursor: pointer; height: 100%;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                <span class="tag-pill" :style="{background: book.status==='reading'?'#fefcbf':'#edf2f7'}">
                                    {{ book.status === 'planning' ? 'è®¡åˆ’' : book.status === 'reading' ? 'åœ¨è¯»' : 'å·²è¯»' }}
                                </span>
                                <span style="color: #ecc94b;">{{ 'â˜…'.repeat(book.rating) }}</span>
                            </div>
                            <h3 style="font-size: 1.1em; margin: 10px 0 5px 0;">{{ book.title }}</h3>
                            <p style="font-size: 0.9em; color: #718096; margin-bottom: 10px;">{{ book.author }}</p>
                            <p v-if="book.notes" style="font-size: 0.85em; color: #a0aec0; line-height: 1.4; height: 40px; overflow: hidden;">{{ book.notes }}</p>
                        </div>
                    </div>
                </div>

                <!-- æ¨¡å—ä¸‰ï¼šçŸ¥è¯†åº“ -->
                <div class="card">
                    <h2>ğŸ§  çŸ¥è¯†åº“</h2>
                    <p style="color: #718096; font-size: 0.9em; margin-bottom: 15px;">
                        è¯­é›€é£æ ¼æ–‡æ¡£ç®¡ç†ï¼Œç›®å‰å·²æœ‰ {{ kbDocs.length }} ç¯‡æ–‡æ¡£ã€‚
                    </p>
                    <button class="btn" @click="showKnowledgeBase = true">ğŸ“‚ è¿›å…¥çŸ¥è¯†åº“å·¥ä½œå°</button>
                </div>
            </div>
        </div>

        <!-- çŸ¥è¯†åº“å¼¹çª— -->
        <div v-if="showKnowledgeBase" class="kb-overlay" @click.self="showKnowledgeBase = false">
            <div class="kb-window">
                <div class="kb-sidebar">
                    <div style="padding: 20px; font-weight: bold; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between;">
                        <span>çŸ¥è¯†åº“</span>
                        <span style="cursor: pointer; color: #667eea;" @click="addCategory">+</span>
                    </div>
                    <div style="flex: 1; overflow-y: auto; padding: 10px 0;">
                        <div class="kb-nav-item" :class="{active: kbCurrentCategory === 'all'}" @click="kbCurrentCategory = 'all'">
                            <span>ğŸ“‚ å…¨éƒ¨æ–‡æ¡£</span>
                        </div>
                        <div v-for="cat in kbCategories" :key="cat.id" 
                             class="kb-nav-item" 
                             :class="{active: kbCurrentCategory && kbCurrentCategory.id === cat.id}"
                             @click="kbCurrentCategory = cat">
                            <span>ğŸ“ {{ cat.name }}</span>
                            <small style="color: #cbd5e0;">{{ kbDocs.filter(d=>d.categoryId===cat.id).length }}</small>
                        </div>
                    </div>
                </div>
                <div class="kb-main">
                    <div class="kb-toolbar">
                        <span style="color: #718096;">
                            {{ kbCurrentCategory === 'all' ? 'å…¨éƒ¨æ–‡æ¡£' : kbCurrentCategory.name }}
                        </span>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn-sm" style="background: #667eea; color: white; border: none;" @click="openKbEditor()">+ æ–°å»ºæ–‡æ¡£</button>
                            <button class="btn-sm" @click="showKnowledgeBase = false">å…³é—­</button>
                        </div>
                    </div>
                    
                    <div class="kb-content">
                        <!-- ç¼–è¾‘æ¨¡å¼ -->
                        <div v-if="kbEditorMode" style="height: 100%; display: flex; flex-direction: column;">
                            <input v-model="kbEditorData.title" placeholder="æ— æ ‡é¢˜æ–‡æ¡£" style="font-size: 2em; border: none; outline: none; font-weight: bold; margin-bottom: 20px;">
                            <select v-model="kbEditorData.categoryId" style="border: none; outline: none; margin-bottom: 20px; color: #718096;">
                                <option :value="null">é€‰æ‹©åˆ†ç±»...</option>
                                <option v-for="cat in kbCategories" :key="cat.id" :value="cat.id">{{ cat.name }}</option>
                            </select>
                            <textarea v-model="kbEditorData.content" placeholder="å¼€å§‹å†™ä½œ..." style="flex: 1; border: none; outline: none; resize: none; font-size: 1.1em; line-height: 1.8;"></textarea>
                            <div style="text-align: right; margin-top: 10px;">
                                <button class="btn-sm" @click="saveKbDoc" style="background: #667eea; color: white; border: none;">ä¿å­˜å‘å¸ƒ</button>
                                <button class="btn-sm" @click="kbEditorMode = false" style="margin-left: 10px;">å–æ¶ˆ</button>
                            </div>
                        </div>

                        <!-- åˆ—è¡¨æ¨¡å¼ -->
                        <div v-else>
                            <div v-if="filteredKbDocs.length === 0" style="text-align: center; color: #cbd5e0; margin-top: 50px;">
                                æš‚æ— æ–‡æ¡£
                            </div>
                            <div v-for="doc in filteredKbDocs" :key="doc.id" class="item-card" @click="editKbDoc(doc)" style="cursor: pointer;">
                                <div style="display: flex; justify-content: space-between;">
                                    <strong style="font-size: 1.1em;">ğŸ“„ {{ doc.title }}</strong>
                                    <span style="font-size: 0.8em; color: #a0aec0;">{{ formatDateShort(doc.updatedAt) }}</span>
                                </div>
                                <p style="color: #718096; font-size: 0.9em; margin-top: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                    {{ doc.content }}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- è¯¦æƒ…å¼¹çª— (é€šç”¨) -->
        <div v-if="viewingItem" class="kb-overlay" @click.self="viewingItem = null">
            <div class="card" style="width: 90%; max-width: 600px; max-height: 80vh; display: flex; flex-direction: column;">
                <div style="display: flex; justify-content: space-between; border-bottom: 1px solid #e2e8f0; padding-bottom: 15px; margin-bottom: 15px;">
                    <h2>{{ viewingItem.title }}</h2>
                    <span style="cursor: pointer;" @click="viewingItem = null">âœ•</span>
                </div>
                <div style="overflow-y: auto; flex: 1; line-height: 1.8; white-space: pre-wrap;">
                    <div v-if="viewingItem.type === 'book'" style="background: #f7fafc; padding: 10px; border-radius: 8px; margin-bottom: 15px; font-size: 0.9em;">
                        ä½œè€…ï¼š{{ viewingItem.author }} | çŠ¶æ€ï¼š{{ viewingItem.status }} | è¯„åˆ†ï¼š{{ viewingItem.rating }}
                    </div>
                    {{ viewingItem.content || viewingItem.notes }}
                    <div v-if="viewingItem.insights" style="margin-top: 15px; border-top: 1px dashed #e2e8f0; padding-top: 10px;">
                        <strong>ğŸ’¡ æ„Ÿæ‚Ÿï¼š</strong>
                        {{ viewingItem.insights }}
                    </div>
                </div>
                <div style="margin-top: 20px; text-align: right;">
                    <button class="btn-sm btn-danger" @click="deleteItem(viewingItem)">åˆ é™¤</button>
                    <button class="btn-sm" @click="viewingItem = null" style="margin-left: 10px;">å…³é—­</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        const SUPABASE_URL = 'https://zqmgigcnruvvdcholbuj.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpxbWdpZ2NucnV2dmRjaG9sYnVqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4NjgzNjEsImV4cCI6MjA4MTQ0NDM2MX0.IHzDp7o5M9QM8IBWy2ri5gS9h9nm0zk3AaPTNveDqXI';
        const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    isLoggedIn: false, userId: null, userEmail: '', email: '', password: '',
                    loading: false, syncing: false, message: '', messageType: '',
                    
                    playerData: { level: 1, xp: 0, nextLevelXp: 100 },
                    
                    // å¤ç›˜
                    notes: [], activeReviewTab: 'daily', newNote: { title: '', content: '', tags: '' },
                    noteFilters: { search: '', sortBy: 'newest' },
                    
                    // ä¹¦ç±
                    books: [], showBookForm: false, 
                    newBook: { title: '', author: '', status: 'planning', rating: 0, notes: '', tags: '' },
                    bookFilters: { status: 'all', search: '' },
                    
                    // çŸ¥è¯†åº“
                    showKnowledgeBase: false, kbCategories: [], kbDocs: [],
                    kbCurrentCategory: 'all', kbEditorMode: false,
                    kbEditorData: { id: null, title: '', content: '', categoryId: null },
                    
                    viewingItem: null
                };
            },
            computed: {
                filteredNotes() {
                    let res = this.notes.filter(n => {
                        if (n.type && n.type !== this.activeReviewTab) return false;
                        if (!n.type && this.activeReviewTab !== 'daily') return false; // å…¼å®¹æ—§æ•°æ®
                        return true;
                    });
                    if (this.noteFilters.search) {
                        res = res.filter(n => n.title.includes(this.noteFilters.search) || n.content.includes(this.noteFilters.search));
                    }
                    return res.sort((a,b) => this.noteFilters.sortBy === 'newest' ? new Date(b.createdAt)-new Date(a.createdAt) : new Date(a.createdAt)-new Date(b.createdAt));
                },
                filteredBooks() {
                    let res = this.books;
                    if (this.bookFilters.status !== 'all') res = res.filter(b => b.status === this.bookFilters.status);
                    if (this.bookFilters.search) res = res.filter(b => b.title.includes(this.bookFilters.search));
                    return res;
                },
                filteredKbDocs() {
                    let res = this.kbDocs;
                    if (this.kbCurrentCategory !== 'all') res = res.filter(d => d.categoryId === this.kbCurrentCategory.id);
                    return res.sort((a,b) => new Date(b.updatedAt) - new Date(a.updatedAt));
                }
            },
            methods: {
                showMessage(txt, type='success') { this.message = txt; this.messageType = type; setTimeout(()=>this.message='', 4000); },
                formatDateShort(str) { return new Date(str).toLocaleDateString(); },
                
                async login() {
                    if (!this.email || !this.password) return this.showMessage('è¯·è¾“å…¥é‚®ç®±å’Œå¯†ç ', 'error');
                    this.loading = true;
                    // çº¯ç²¹çš„ç™»å½•é€»è¾‘
                    const { data, error } = await sb.auth.signInWithPassword({ email: this.email, password: this.password });
                    this.loading = false;
                    
                    if (error) {
                        console.error(error);
                        return this.showMessage(error.message === 'Invalid login credentials' ? 'ç™»å½•å¤±è´¥ï¼šè¯·ç¡®ä¿åœ¨Supabase Authenticationä¸­åˆ›å»ºäº†ç”¨æˆ·' : error.message, 'error');
                    }
                    
                    this.isLoggedIn = true;
                    this.userId = data.user.id;
                    this.userEmail = data.user.email;
                    this.loadData();
                },
                async logout() {
                    await sb.auth.signOut();
                    this.isLoggedIn = false;
                    this.userId = null;
                },
                
                async loadData() {
                    this.syncing = true;
                    const [p, n, b, kc, kd] = await Promise.all([
                        sb.from('players').select('*').eq('user_id', this.userId).single(),
                        sb.from('notes').select('*').eq('user_id', this.userId),
                        sb.from('books').select('*').eq('user_id', this.userId),
                        sb.from('kb_categories').select('*').eq('user_id', this.userId),
                        sb.from('kb_notes').select('*').eq('user_id', this.userId)
                    ]);
                    if(p.data) this.playerData = p.data.data;
                    if(n.data) this.notes = n.data.map(i => i.data);
                    if(b.data) this.books = b.data.map(i => i.data);
                    if(kc.data) this.kbCategories = kc.data.map(i => i.data);
                    if(kd.data) this.kbDocs = kd.data.map(i => i.data);
                    this.syncing = false;
                },
                
                async saveAll() {
                    // ç®€åŒ–çš„å…¨é‡åŒæ­¥
                    const wrap = (list) => list.map(d => ({ user_id: this.userId, data: d }));
                    await Promise.all([
                        sb.from('notes').delete().eq('user_id', this.userId),
                        sb.from('books').delete().eq('user_id', this.userId),
                        sb.from('kb_categories').delete().eq('user_id', this.userId),
                        sb.from('kb_notes').delete().eq('user_id', this.userId)
                    ]);
                    await sb.from('players').upsert({ user_id: this.userId, data: this.playerData });
                    if(this.notes.length) await sb.from('notes').insert(wrap(this.notes));
                    if(this.books.length) await sb.from('books').insert(wrap(this.books));
                    if(this.kbCategories.length) await sb.from('kb_categories').insert(wrap(this.kbCategories));
                    if(this.kbDocs.length) await sb.from('kb_notes').insert(wrap(this.kbDocs));
                },
                
                async syncData() { await this.saveAll(); this.loadData(); },
                
                // åŠŸèƒ½é€»è¾‘
                applyTemplate(type) {
                    if (type === 'weekly') this.newNote.content = "## æœ¬å‘¨å®Œæˆ\n- \n\n## KPTå¤ç›˜\n- Keep: \n- Problem: \n- Try: ";
                    if (type === 'yearly') this.newNote.content = "## å¹´åº¦å…³é”®è¯\n\n## æˆå°±\n\n## é—æ†¾\n\n## æ˜å¹´è§„åˆ’";
                },
                saveNote() {
                    if(!this.newNote.title) return;
                    this.notes.unshift({
                        id: Date.now(), title: this.newNote.title, content: this.newNote.content,
                        type: this.activeReviewTab, createdAt: new Date().toISOString(), tags: []
                    });
                    this.newNote = { title: '', content: '' };
                    this.playerData.xp += 10;
                    this.saveAll();
                },
                deleteNote(id) {
                    if(confirm('åˆ é™¤?')) { this.notes = this.notes.filter(n => n.id !== id); this.saveAll(); }
                },
                saveBook() {
                    if(!this.newBook.title) return;
                    this.books.unshift({ id: Date.now(), ...this.newBook, createdAt: new Date().toISOString() });
                    this.newBook = { title: '', author: '', status: 'planning', rating: 0, notes: '' };
                    this.showBookForm = false;
                    this.playerData.xp += 15;
                    this.saveAll();
                },
                viewBookDetail(book) { this.viewingItem = { ...book, type: 'book', content: book.notes }; },
                
                // çŸ¥è¯†åº“
                addCategory() {
                    const name = prompt('åˆ†ç±»åç§°');
                    if(name) { this.kbCategories.push({ id: Date.now(), name }); this.saveAll(); }
                },
                openKbEditor() { 
                    this.kbEditorData = { id: null, title: '', content: '', categoryId: this.kbCurrentCategory.id || null };
                    this.kbEditorMode = true; 
                },
                editKbDoc(doc) {
                    this.kbEditorData = { ...doc };
                    this.kbEditorMode = true;
                },
                saveKbDoc() {
                    if(!this.kbEditorData.title) return;
                    const now = new Date().toISOString();
                    if(this.kbEditorData.id) {
                        const idx = this.kbDocs.findIndex(d => d.id === this.kbEditorData.id);
                        this.kbDocs[idx] = { ...this.kbEditorData, updatedAt: now };
                    } else {
                        this.kbDocs.unshift({ id: Date.now(), ...this.kbEditorData, createdAt: now, updatedAt: now });
                        this.playerData.xp += 20;
                    }
                    this.kbEditorMode = false;
                    this.saveAll();
                },
                deleteItem(item) {
                    if(!confirm('ç¡®è®¤åˆ é™¤ï¼Ÿ')) return;
                    if(item.type === 'book') this.books = this.books.filter(b => b.id !== item.id);
                    else this.kbDocs = this.kbDocs.filter(d => d.id !== item.id); // ç®€å•å¤„ç†ï¼Œå®é™…åº”åŒºåˆ†ç±»å‹
                    this.viewingItem = null;
                    this.saveAll();
                }
            },
            mounted() {
                sb.auth.getSession().then(({ data: { session } }) => {
                    if(session) { this.isLoggedIn = true; this.userId = session.user.id; this.userEmail = session.user.email; this.loadData(); }
                });
            }
        }).mount('#app');
    </script>
</body>
</html>

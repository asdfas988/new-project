<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆé•¿æ‰‹è´¦ - å®Œæ•´ç‰ˆ</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* ========== å…¨å±€æ ·å¼ (æš–è‰²æ‰‹è´¦é£) ========== */
        :root {
            --bg-color: #fef9f3;
            --text-color: #5a4a42;
            --accent-pink: #ff9a8b;
            --accent-green: #a3de83;
            --card-border: 2.5px solid #5a4a42;
            --card-shadow: 6px 6px 0px #d4b8a7;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Noto Sans SC', sans-serif;
            background: var(--bg-color);
            min-height: 100vh;
            color: var(--text-color);
            padding: 20px;
        }

        .container { max-width: 1400px; margin: 0 auto; }

        /* å¤´éƒ¨ */
        .header {
            text-align: center; margin-bottom: 30px; padding: 30px;
            background: #fffaf0; border-radius: 24px;
            box-shadow: 8px 8px 0px #e0c9b8; border: 3px solid #5a4a42;
            display: flex; flex-direction: column; align-items: center;
        }
        .header h1 { font-size: 2.2em; font-weight: 700; text-shadow: 3px 3px 0px #ffd6cc; margin-bottom: 10px; }

        /* å¸ƒå±€ */
        .grid { display: grid; grid-template-columns: 1fr; gap: 30px; margin-bottom: 40px; }
        
        /* é€šç”¨å¡ç‰‡ */
        .card {
            background: #fffefc; border-radius: 20px; padding: 30px;
            box-shadow: var(--card-shadow); border: var(--card-border);
            transition: transform 0.3s; position: relative;
        }
        .card:hover { transform: translateY(-3px); }
        .card h2 {
            margin-bottom: 20px; padding-bottom: 15px; border-bottom: 3px dotted #ff9a8b;
            font-size: 1.4em; font-weight: 700; display: flex; justify-content: space-between; align-items: center;
        }

        /* æŒ‰é’® */
        .btn {
            background: linear-gradient(90deg, #ff9a8b, #ff6b6b); border: none; padding: 12px 30px;
            border-radius: 50px; color: white; cursor: pointer; font-size: 16px; font-weight: 700;
            box-shadow: 4px 4px 0px #d45d5d; transition: all 0.2s; width: 100%;
        }
        .btn:hover:not(:disabled) { transform: translateY(-2px); }
        .btn-sm {
            padding: 6px 15px; font-size: 0.9em; border-radius: 20px;
            background: linear-gradient(90deg, #4ecdc4, #a3de83);
            box-shadow: 3px 3px 0px #2ba69b; border: none; color: white; font-weight: bold; cursor: pointer;
        }
        .btn-danger { background: #ff6b6b; box-shadow: 3px 3px 0px #c0392b; }
        .collapse-btn {
            background: #fffaf5; border: 2px solid #ff9a8b; color: #ff6b6b;
            padding: 4px 12px; border-radius: 12px; font-size: 0.8em; font-weight: bold; cursor: pointer;
        }

        /* è¾“å…¥æ¡† */
        .note-input, .note-textarea {
            width: 100%; padding: 12px; border: 2px solid #e0c9b8; border-radius: 12px;
            font-size: 15px; margin-bottom: 15px; background: #fffaf9; font-family: inherit;
        }
        .note-input:focus, .note-textarea:focus { outline: none; border-color: #ff9a8b; box-shadow: 2px 2px 0px #ffd6cc; }

        /* ========== ç›®æ ‡ç®¡ç† (OKR) ========== */
        .goal-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; }
        .goal-item {
            background: #fffaf5; border: 2px solid #e0c9b8; border-radius: 15px; padding: 15px;
        }
        .goal-progress-bg { height: 10px; background: #eee; border-radius: 5px; margin: 10px 0; overflow: hidden; }
        .goal-progress-fill { height: 100%; background: linear-gradient(90deg, #ff9a8b, #ff6b6b); transition: width 0.3s; }

        /* ========== æ¸¸æˆåŒ–æ ¸å¿ƒ ========== */
        .level-display { font-size: 3.5em; font-weight: 800; text-align: center; color: #ff6b6b; text-shadow: 3px 3px 0px #ffd6cc; margin: 10px 0; }
        .xp-progress { height: 20px; background: #ffe8d6; border-radius: 10px; overflow: hidden; border: 2px solid #5a4a42; margin: 10px 0; }
        .xp-fill { height: 100%; background: linear-gradient(90deg, #4ecdc4, #a3de83); transition: width 0.5s ease; }
        
        .skill-item {
            padding: 15px; background: #fffaf5; border-radius: 15px; margin: 10px 0;
            border: 2px solid #e0c9b8; display: flex; justify-content: space-between; align-items: center;
        }
        .achievement-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-top: 20px; }
        .achievement-card {
            background: #fffefc; border-radius: 15px; padding: 15px; text-align: center;
            box-shadow: 3px 3px 0px #d4b8a7; border: 2px solid #5a4a42;
        }
        .achievement-card.locked { opacity: 0.6; filter: grayscale(0.8); }

        /* ========== å¤ç›˜ç³»ç»Ÿ (å«è‚¡ç¥¨) ========== */
        .review-tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #e0c9b8; padding-bottom: 10px; overflow-x: auto; }
        .review-tab {
            padding: 8px 20px; border: 2px solid #e0c9b8; background: #fffaf5; border-radius: 15px 15px 0 0;
            cursor: pointer; font-weight: 600; transition: all 0.2s; white-space: nowrap;
        }
        .review-tab.active { background: #ff9a8b; color: white; border-color: #ff9a8b; transform: translateY(2px); }
        .review-tab.special { background: #a3de83; border-color: #88c967; color: #2d5a27; }

        .note-card { background: #fffaf5; padding: 15px; border-radius: 15px; margin-bottom: 15px; border: 2px solid #e0c9b8; position: relative; }
        .note-type-badge { position: absolute; top: 15px; right: 15px; font-size: 0.8em; color: #ff6b6b; font-weight: bold; border: 1px solid #ff6b6b; padding: 2px 6px; border-radius: 6px; }

        .stock-tag { display: inline-block; padding: 2px 6px; font-size: 0.8em; border-radius: 4px; color: white; margin-right: 5px; }
        .bg-red { background: #e53935; } /* æ¶¨/å–å‡º */
        .bg-green { background: #43a047; } /* è·Œ/ä¹°å…¥ */

        /* ========== æ˜“å­¦å‘½ä¾‹ (æ–°) ========== */
        .case-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .case-card {
            background: #fff; border-radius: 16px; padding: 20px; box-shadow: 4px 4px 0px #d4b8a7; border: 2px solid #e0c9b8;
            cursor: pointer; transition: all 0.2s;
        }
        .case-img-preview { width: 100%; height: 150px; object-fit: cover; border-radius: 10px; margin-bottom: 10px; border: 1px solid #ddd; }
        .image-upload-area {
            border: 2px dashed #e0c9b8; padding: 20px; text-align: center; border-radius: 10px; margin-bottom: 15px; cursor: pointer; background: #fffaf9;
        }

        /* ========== çŸ¥è¯†åº“ & è¯»ä¹¦ ========== */
        .book-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .book-card {
            background: #fff; border-radius: 16px; padding: 20px; box-shadow: 4px 4px 0px #d4b8a7; border: 2px solid #e0c9b8;
            cursor: pointer; transition: all 0.2s;
        }

        .kb-overlay { position: fixed; inset: 0; background: rgba(90, 74, 66, 0.6); backdrop-filter: blur(3px); z-index: 999; display: flex; justify-content: center; align-items: center; }
        .kb-window { width: 95%; max-width: 1400px; height: 90vh; background: #fef9f3; border-radius: 20px; border: 4px solid #5a4a42; display: flex; overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.3); }
        .kb-sidebar { width: 250px; background: #fffaf0; border-right: 2px solid #e0c9b8; display: flex; flex-direction: column; }
        .kb-main { flex: 1; display: flex; flex-direction: column; background: #fffefc; }
        .kb-nav-item { padding: 12px 20px; cursor: pointer; color: #5a4a42; font-weight: 500; display: flex; justify-content: space-between; }
        .kb-nav-item.active { background: #ffe8d6; border-right: 4px solid #ff9a8b; }
        .kb-content { flex: 1; padding: 40px; overflow-y: auto; }
        .kb-toolbar { padding: 15px 30px; border-bottom: 2px dashed #e0c9b8; display: flex; justify-content: space-between; align-items: center; background: #fffaf5; }

        /* ç™»å½• */
        .login-box { max-width: 400px; margin: 100px auto; text-align: center; }
        .status-message { padding: 10px; border-radius: 10px; margin-top: 15px; font-weight: bold; }
        .status-error { background: #ffe5e5; color: #d32f2f; border: 2px solid #ffcdd2; }
        .status-success { background: #e8f5e9; color: #2e7d32; border: 2px solid #c8e6c9; }

        @media (max-width: 768px) {
            .kb-window { width: 100%; height: 100vh; border-radius: 0; }
            .kb-sidebar { width: 60px; }
            .kb-nav-item span:not(.count) { display: none; }
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- ç™»å½• -->
        <div v-if="!isLoggedIn" class="login-box">
            <div class="card">
                <h1 style="font-size: 3em; margin-bottom: 10px;">â˜¯ï¸</h1>
                <h2 style="justify-content: center;">æˆé•¿æ‰‹è´¦</h2>
                <p style="margin-bottom: 20px; color: #7a6a62;">è®°å½• Â· äº¤æ˜“ Â· æ˜“å­¦ Â· è¿›åŒ–</p>
                <input type="email" v-model="email" placeholder="é‚®ç®±" class="note-input">
                <input type="password" v-model="password" placeholder="å¯†ç " class="note-input">
                <button class="btn" @click="login" :disabled="loading">{{ loading ? 'éªŒè¯ä¸­...' : 'è¿›å…¥æˆ‘çš„ä¸–ç•Œ' }}</button>
                <div v-if="message" :class="['status-message', messageType === 'success' ? 'status-success' : 'status-error']">{{ message }}</div>
                <p style="margin-top: 15px; font-size: 0.8em; color: #999;">âš ï¸ è¯·ç¡®ä¿åœ¨ Supabase åå°å·²åˆ›å»ºè¯¥ç”¨æˆ·</p>
            </div>
        </div>

        <!-- ä¸»ç•Œé¢ -->
        <div v-else class="container">
            <div class="header">
                <h1>ğŸ‘‹ {{ userEmail.split('@')[0] }} çš„ä¿®èº«ç©ºé—´</h1>
                <div>
                    <button class="btn-sm" @click="syncData" :disabled="syncing">{{ syncing ? 'â˜ï¸ åŒæ­¥ä¸­' : 'ğŸ”„ åŒæ­¥æ•°æ®' }}</button>
                    <button class="btn-sm btn-danger" @click="logout" style="margin-left: 10px;">é€€å‡º</button>
                </div>
                <div v-if="message" :class="['status-message', messageType === 'success' ? 'status-success' : 'status-error']" style="margin-top: 10px;">{{ message }}</div>
            </div>

            <div class="grid">
                <!-- æ¨¡å—ï¼šçŠ¶æ€ä¸ç›®æ ‡ -->
                <div class="card">
                    <h2>ğŸ¯ ç›®æ ‡ä¸çŠ¶æ€ <button class="collapse-btn" @click="collapsed.stats = !collapsed.stats">{{ collapsed.stats ? 'å±•å¼€' : 'æ”¶èµ·' }}</button></h2>
                    <div v-show="!collapsed.stats">
                        <div style="display: flex; flex-wrap: wrap; gap: 30px;">
                            <!-- ç­‰çº§ -->
                            <div style="flex: 1; min-width: 250px; text-align: center;">
                                <div class="level-display">Lv.{{ playerData.level }}</div>
                                <div class="xp-progress"><div class="xp-fill" :style="{width: xpPercentage + '%'}"></div></div>
                                <div style="font-weight: bold; color: #7a6a62;">{{ playerData.xp }} / {{ playerData.nextLevelXp }} XP</div>
                            </div>
                            <!-- ç›®æ ‡ç®¡ç† (OKR) -->
                            <div style="flex: 2; min-width: 300px;">
                                <h3 style="margin-bottom: 15px;">ğŸš© é˜¶æ®µç›®æ ‡</h3>
                                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                                    <input v-model="newGoal.title" placeholder="è®¾å®šä¸€ä¸ªFlag..." class="note-input" style="margin-bottom: 0;">
                                    <button class="btn-sm" @click="addGoal" style="width: 80px;">æ·»åŠ </button>
                                </div>
                                <div class="goal-list">
                                    <div v-for="(goal, index) in playerData.goals || []" :key="index" class="goal-item">
                                        <div style="display: flex; justify-content: space-between; font-weight: bold;">
                                            <span>{{ goal.title }}</span><span>{{ goal.progress }}%</span>
                                        </div>
                                        <div class="goal-progress-bg"><div class="goal-progress-fill" :style="{width: goal.progress + '%'}"></div></div>
                                        <div style="text-align: right; margin-top: 5px;">
                                            <input type="range" v-model="goal.progress" min="0" max="100" style="width: 60%; margin-right: 10px;">
                                            <button class="btn-sm btn-danger" @click="deleteGoal(index)">åˆ </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æ¨¡å—ï¼šå¤ç›˜ç³»ç»Ÿ (å«è‚¡ç¥¨å¤ç›˜) -->
                <div class="card">
                    <h2>ğŸ”„ å¤ç›˜ç¬”è®° <button class="collapse-btn" @click="collapsed.reviews = !collapsed.reviews">{{ collapsed.reviews ? 'å±•å¼€' : 'æ”¶èµ·' }}</button></h2>
                    <div v-show="!collapsed.reviews">
                        <div class="review-tabs">
                            <div class="review-tab" :class="{active: activeReviewTab === 'daily'}" @click="activeReviewTab = 'daily'">ğŸ“ æ—¥å¸¸</div>
                            <div class="review-tab" :class="{active: activeReviewTab === 'weekly'}" @click="activeReviewTab = 'weekly'">ğŸ“… å‘¨å¤ç›˜</div>
                            <div class="review-tab" :class="{active: activeReviewTab === 'stock'}" @click="activeReviewTab = 'stock'">ğŸ“ˆ è‚¡ç¥¨å¤ç›˜</div>
                            <div class="review-tab" :class="{active: activeReviewTab === 'yearly'}" @click="activeReviewTab = 'yearly'">ğŸ† å¹´æ€»ç»“</div>
                            <div class="review-tab special" @click="showReviewForm = !showReviewForm">{{ showReviewForm ? 'âœ–ï¸ å–æ¶ˆ' : 'â• æ–°å»º' }}</div>
                        </div>

                        <!-- è¡¨å• -->
                        <div v-if="showReviewForm" style="background: #fffaf5; padding: 20px; border: 2px dashed #ff9a8b; border-radius: 15px; margin-bottom: 20px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <strong>è®°å½• {{ getReviewTypeName(activeReviewTab) }}</strong>
                                <button v-if="activeReviewTab !== 'stock'" class="btn-sm" style="background: #e0c9b8; border: none;" @click="applyTemplate(activeReviewTab)">ğŸ“„ æ’å…¥æ¨¡æ¿</button>
                            </div>

                            <!-- è‚¡ç¥¨ä¸“ç”¨å­—æ®µ -->
                            <div v-if="activeReviewTab === 'stock'" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                                <input v-model="newStockData.code" placeholder="ä»£ç /åç§°" class="note-input" style="margin: 0;">
                                <select v-model="newStockData.action" class="note-input" style="margin: 0;">
                                    <option value="buy">ğŸ”µ ä¹°å…¥</option>
                                    <option value="sell">ğŸ”´ å–å‡º</option>
                                    <option value="hold">âšª æŒä»“</option>
                                </select>
                                <input v-model="newStockData.price" placeholder="ä»·æ ¼" class="note-input" style="margin: 0;">
                                <input v-model="newStockData.profit" placeholder="ç›ˆäºé¢ (å¯é€‰)" class="note-input" style="margin: 0;">
                            </div>

                            <input v-if="activeReviewTab !== 'stock'" v-model="newNote.title" placeholder="æ ‡é¢˜..." class="note-input">
                            <textarea v-model="newNote.content" :placeholder="activeReviewTab === 'stock' ? 'äº¤æ˜“é€»è¾‘ä¸åæ€...' : 'å†…å®¹...'" class="note-textarea" style="height: 150px;"></textarea>
                            <button class="btn" @click="saveNote">ğŸ’¾ ä¿å­˜</button>
                        </div>

                        <!-- åˆ—è¡¨ -->
                        <div v-for="note in filteredNotes" :key="note.id" class="note-card">
                            <div class="note-type-badge">{{ getReviewTypeName(note.type || 'daily') }}</div>
                            <div style="font-size: 0.85em; color: #999; margin-bottom: 5px;">{{ formatDate(note.createdAt) }}</div>
                            
                            <!-- è‚¡ç¥¨å±•ç¤ºé€»è¾‘ -->
                            <div v-if="note.type === 'stock'" style="margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px dashed #e0c9b8;">
                                <span class="stock-tag" :class="note.stockData?.action === 'buy' ? 'bg-red' : (note.stockData?.action === 'sell' ? 'bg-green' : 'bg-gray')" style="background: #555;">
                                    {{ note.stockData?.action === 'buy' ? 'ä¹°å…¥' : (note.stockData?.action === 'sell' ? 'å–å‡º' : 'æŒä»“') }}
                                </span>
                                <strong>{{ note.stockData?.code }}</strong>
                                <span v-if="note.stockData?.price" style="margin-left: 10px; color: #7a6a62;">@ {{ note.stockData?.price }}</span>
                                <span v-if="note.stockData?.profit" style="float: right; font-weight: bold;" :style="{color: parseFloat(note.stockData.profit) > 0 ? '#e53935' : '#43a047'}">
                                    {{ parseFloat(note.stockData.profit) > 0 ? '+' : '' }}{{ note.stockData.profit }}
                                </span>
                            </div>

                            <h3 v-if="note.title" style="margin-bottom: 10px;">{{ note.title }}</h3>
                            <p style="white-space: pre-wrap; line-height: 1.6; color: #5a4a42;">{{ note.content }}</p>
                            <div style="margin-top: 10px; text-align: right;">
                                <button class="btn-sm btn-danger" @click="deleteNote(note.id)">åˆ é™¤</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æ¨¡å—ï¼šæ˜“å­¦å‘½ä¾‹ (æ–°å¢) -->
                <div class="card">
                    <h2>â˜¯ï¸ æ˜“å­¦å‘½ä¾‹ <button class="collapse-btn" @click="collapsed.cases = !collapsed.cases">{{ collapsed.cases ? 'å±•å¼€' : 'æ”¶èµ·' }}</button></h2>
                    <div v-show="!collapsed.cases">
                        <button class="btn" style="margin-bottom: 20px; background: linear-gradient(90deg, #5a4a42, #7a6a62);" @click="showCaseForm = !showCaseForm">{{ showCaseForm ? 'æ”¶èµ·' : 'âœ¨ è®°å½•æ–°å‘½ä¾‹' }}</button>
                        
                        <!-- å‘½ä¾‹è¡¨å• -->
                        <div v-if="showCaseForm" style="background: #fffaf5; padding: 20px; border: 2px dashed #5a4a42; border-radius: 15px; margin-bottom: 20px;">
                            <input v-model="newCase.title" placeholder="å‘½ä¸»ç§°å‘¼ / å…«å­—æ¦‚è¦ (å¦‚: ä¹¾é€  ç”²å­å¹´...)" class="note-input">
                            
                            <!-- å›¾ç‰‡ä¸Šä¼  -->
                            <div class="image-upload-area" @click="$refs.fileInput.click()">
                                <input type="file" ref="fileInput" @change="handleImageUpload" style="display: none;" accept="image/*">
                                <div v-if="newCase.image" style="position: relative;">
                                    <img :src="newCase.image" style="max-height: 200px; max-width: 100%; border-radius: 10px;">
                                    <div style="font-size: 0.8em; color: #ff6b6b;">ç‚¹å‡»æ›´æ¢å›¾ç‰‡</div>
                                </div>
                                <div v-else>
                                    <div style="font-size: 2em;">ğŸ“·</div>
                                    <div>ç‚¹å‡»ä¸Šä¼ æ’ç›˜å›¾ç‰‡</div>
                                    <div style="font-size: 0.8em; color: #999;">(å›¾ç‰‡å°†è‡ªåŠ¨å¤„ç†ï¼Œæ— éœ€å›¾åºŠ)</div>
                                </div>
                            </div>

                            <textarea v-model="newCase.content" placeholder="æ–­è¯­ã€åé¦ˆä¸å¤ç›˜..." class="note-textarea" style="height: 150px;"></textarea>
                            <button class="btn" @click="saveCase">ğŸ’¾ ä¿å­˜å‘½ä¾‹</button>
                        </div>

                        <!-- å‘½ä¾‹åˆ—è¡¨ -->
                        <div class="case-grid">
                            <div v-for="c in cases" :key="c.id" class="case-card" @click="viewingItem = { ...c, type: 'case' }">
                                <img v-if="c.image" :src="c.image" class="case-img-preview">
                                <div v-else style="height: 150px; background: #eee; border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-bottom: 10px; color: #999;">æ— å›¾ç‰‡</div>
                                <h3>{{ c.title }}</h3>
                                <p style="font-size: 0.9em; color: #7a6a62; overflow: hidden; white-space: nowrap; text-overflow: ellipsis;">{{ c.content }}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æ¨¡å—ï¼šæŠ€èƒ½ & æˆå°± -->
                <div class="card">
                    <h2>âš¡ æŠ€èƒ½ä¸æˆå°± <button class="collapse-btn" @click="collapsed.skills = !collapsed.skills">{{ collapsed.skills ? 'å±•å¼€' : 'æ”¶èµ·' }}</button></h2>
                    <div v-show="!collapsed.skills">
                        <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                            <div style="flex: 1; min-width: 250px;">
                                <h3 style="margin-bottom: 10px;">æˆ‘çš„æŠ€èƒ½æ ‘</h3>
                                <div v-for="skill in skills" :key="skill.id" class="skill-item">
                                    <div>{{ skill.icon }} {{ skill.name }} <small>Lv.{{ skill.level }}</small></div>
                                    <div class="xp-progress" style="width: 100px; height: 8px; margin: 0;"><div class="xp-fill" :style="{width: (skill.xp / skill.maxXp * 100) + '%'}"></div></div>
                                    <button class="btn-sm" @click="practiceSkill(skill.id)">ç»ƒ</button>
                                </div>
                                <button class="btn-sm" style="width: 100%; margin-top: 10px;" @click="addNewSkill">+ æ–°æŠ€èƒ½</button>
                            </div>
                            <div style="flex: 1; min-width: 250px;">
                                <h3 style="margin-bottom: 10px;">æœ€è¿‘æˆå°±</h3>
                                <div class="achievement-grid" style="margin-top: 0;">
                                    <div v-for="ach in achievements.slice(0, 4)" :key="ach.id" class="achievement-card" :class="{locked: !ach.unlocked}">
                                        <div style="font-size: 1.5em;">{{ ach.icon }}</div>
                                        <div style="font-size: 0.9em; font-weight: bold;">{{ ach.name }}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æ¨¡å—ï¼šçŸ¥è¯†åº“ & è¯»ä¹¦ -->
                <div class="card">
                    <h2>ğŸ§  çŸ¥è¯†åº“ & è¯»ä¹¦</h2>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn" @click="showKnowledgeBase = true" style="background: linear-gradient(90deg, #667eea, #764ba2);">ğŸ“‚ æ‰“å¼€çŸ¥è¯†åº“</button>
                        <button class="btn" style="background: linear-gradient(90deg, #4ecdc4, #a3de83);" @click="collapsed.books = false; document.querySelector('.book-card')?.scrollIntoView()">ğŸ“š æŸ¥çœ‹ä¹¦æ¶</button>
                    </div>
                    
                    <!-- è¯»ä¹¦å±•ç¤º (ç®€åŒ–) -->
                    <div v-show="!collapsed.books" style="margin-top: 20px;">
                         <button class="btn-sm" style="margin-bottom: 15px;" @click="showBookForm = !showBookForm">âœ¨ æ·»åŠ æ–°ä¹¦</button>
                         <div v-if="showBookForm" style="background: #fffaf5; padding: 15px; border: 2px dashed #a3de83; border-radius: 10px; margin-bottom: 15px;">
                            <input v-model="newBook.title" placeholder="ä¹¦å" class="note-input">
                            <input v-model="newBook.author" placeholder="ä½œè€…" class="note-input">
                            <select v-model="newBook.status" class="note-input"><option value="planning">ğŸ“… è®¡åˆ’</option><option value="reading">ğŸ“– åœ¨è¯»</option><option value="finished">âœ… å·²è¯»</option></select>
                            <textarea v-model="newBook.notes" placeholder="ç¬”è®°..." class="note-textarea" style="height: 80px;"></textarea>
                            <button class="btn" @click="saveBook">ä¿å­˜</button>
                         </div>
                         <div class="book-grid">
                            <div v-for="book in books" :key="book.id" class="book-card" @click="viewingItem = { ...book, type: 'book' }">
                                <h4 style="margin: 0;">{{ book.title }}</h4>
                                <small style="color: #999;">{{ book.author }}</small>
                                <div style="color: #ffcc00;">{{ 'â˜…'.repeat(book.rating) }}</div>
                            </div>
                         </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- çŸ¥è¯†åº“å¼¹çª— -->
        <div v-if="showKnowledgeBase" class="kb-overlay" @click.self="showKnowledgeBase = false">
            <div class="kb-window">
                <div class="kb-sidebar">
                    <div style="padding: 20px; font-weight: bold; border-bottom: 2px dashed #e0c9b8; display: flex; justify-content: space-between;">
                        <span>ğŸ“š çŸ¥è¯†åº“</span>
                        <span @click="addKbCategory" style="cursor: pointer; color: #ff6b6b;">+</span>
                    </div>
                    <div style="flex: 1; overflow-y: auto; padding: 10px 0;">
                        <div class="kb-nav-item" :class="{active: kbCurrentCategory === 'all'}" @click="kbCurrentCategory = 'all'"><span>ğŸ“‚ å…¨éƒ¨</span></div>
                        <div v-for="cat in kbCategories" :key="cat.id" class="kb-nav-item" :class="{active: kbCurrentCategory && kbCurrentCategory.id === cat.id}" @click="kbCurrentCategory = cat">
                            <span>ğŸ“ {{ cat.name }}</span><span class="count" style="color:#999">{{ kbDocs.filter(d=>d.categoryId===cat.id).length }}</span>
                        </div>
                    </div>
                </div>
                <div class="kb-main">
                    <div class="kb-toolbar">
                        <span>{{ kbCurrentCategory === 'all' ? 'å…¨éƒ¨æ–‡æ¡£' : kbCurrentCategory.name }}</span>
                        <div><button class="btn-sm" @click="openKbEditor()">+ æ–°å»º</button><button class="btn-sm" style="background:#e0c9b8; margin-left:10px;" @click="showKnowledgeBase = false">âœ•</button></div>
                    </div>
                    <div class="kb-content">
                        <div v-if="kbEditorMode" style="height: 100%; display: flex; flex-direction: column;">
                            <input v-model="kbEditorData.title" placeholder="æ ‡é¢˜" style="font-size: 1.5em; font-weight: bold; border: none; background: transparent; outline: none; margin-bottom: 10px;">
                            <select v-model="kbEditorData.categoryId" style="margin-bottom: 10px; padding: 5px;"><option :value="null">æ— åˆ†ç±»</option><option v-for="cat in kbCategories" :key="cat.id" :value="cat.id">{{ cat.name }}</option></select>
                            <textarea v-model="kbEditorData.content" placeholder="å†™ä½œ..." style="flex: 1; border: none; outline: none; resize: none; background: transparent; font-size: 1.1em; line-height: 1.6;"></textarea>
                            <div style="text-align: right;"><button class="btn-sm" @click="saveKbDoc">ä¿å­˜</button><button class="btn-sm" style="margin-left: 10px; background:#ccc;" @click="kbEditorMode = false">å–æ¶ˆ</button></div>
                        </div>
                        <div v-else>
                            <div v-for="doc in filteredKbDocs" :key="doc.id" style="padding: 15px; border-bottom: 1px dashed #e0c9b8; cursor: pointer;" @click="editKbDoc(doc)">
                                <div style="font-weight: bold;">ğŸ“„ {{ doc.title }}</div>
                                <div style="font-size: 0.9em; color: #999;">{{ formatDateShort(doc.updatedAt) }}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- é€šç”¨è¯¦æƒ…å¼¹çª— (å«å‘½ä¾‹å›¾ç‰‡) -->
        <div v-if="viewingItem" class="kb-overlay" @click.self="viewingItem = null">
            <div class="card" style="width: 90%; max-width: 700px; max-height: 85vh; display: flex; flex-direction: column;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 15px; border-bottom: 2px solid #eee;">
                    <h2>{{ viewingItem.title }}</h2><span @click="viewingItem = null" style="cursor: pointer;">âœ•</span>
                </div>
                <div style="overflow-y: auto; flex: 1; white-space: pre-wrap; line-height: 1.6;">
                    <!-- å¦‚æœæ˜¯å‘½ä¾‹ï¼Œæ˜¾ç¤ºå›¾ç‰‡ -->
                    <img v-if="viewingItem.type === 'case' && viewingItem.image" :src="viewingItem.image" style="width: 100%; border-radius: 10px; margin-bottom: 15px;">
                    
                    {{ viewingItem.content || viewingItem.notes }}
                    
                    <div v-if="viewingItem.insights" style="margin-top: 20px; padding: 10px; background: #f9f9f9; border-radius: 8px;"><strong>ğŸ’¡ æ„Ÿæ‚Ÿï¼š</strong>{{ viewingItem.insights }}</div>
                </div>
                <div style="text-align: right; margin-top: 20px;">
                    <button class="btn-sm btn-danger" @click="deleteItem(viewingItem)">åˆ é™¤</button>
                    <button class="btn-sm" style="margin-left: 10px; background: #e0c9b8;" @click="viewingItem = null">å…³é—­</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://zqmgigcnruvvdcholbuj.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpxbWdpZ2NucnV2dmRjaG9sYnVqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4NjgzNjEsImV4cCI6MjA4MTQ0NDM2MX0.IHzDp7o5M9QM8IBWy2ri5gS9h9nm0zk3AaPTNveDqXI';
        const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    isLoggedIn: false, userId: null, userEmail: '', email: '', password: '',
                    loading: false, syncing: false, message: '', messageType: '',
                    
                    // UIçŠ¶æ€
                    collapsed: { stats: false, reviews: false, books: true, skills: false, cases: false },
                    playerData: { level: 1, xp: 0, nextLevelXp: 100, goals: [] },
                    
                    // ç›®æ ‡
                    newGoal: { title: '', progress: 0 },
                    
                    // æŠ€èƒ½ä¸æˆå°±
                    skills: [], achievements: [
                        { id: 1, name: 'åˆæ¬¡äº¤æ˜“', icon: 'ğŸ’°', description: 'è®°å½•è‚¡ç¥¨äº¤æ˜“', requirement: 1, current: 0, unlocked: false },
                        { id: 2, name: 'é“å£ç›´æ–­', icon: 'â˜¯ï¸', description: 'è®°å½•3ä¸ªå‘½ä¾‹', requirement: 3, current: 0, unlocked: false }
                    ],
                    
                    // å¤ç›˜ (å«è‚¡ç¥¨)
                    notes: [], activeReviewTab: 'daily', showReviewForm: false,
                    newNote: { title: '', content: '', tags: '' },
                    newStockData: { code: '', action: 'buy', price: '', profit: '', logic: '', mistake: '' },
                    
                    // å‘½ä¾‹ (æ–°å¢)
                    cases: [], showCaseForm: false, 
                    newCase: { title: '', content: '', image: null },

                    // ä¹¦ç±
                    books: [], showBookForm: false, viewingItem: null,
                    newBook: { title: '', author: '', status: 'reading', rating: 0, notes: '', insights: '' },
                    
                    // çŸ¥è¯†åº“
                    showKnowledgeBase: false, kbCategories: [], kbDocs: [],
                    kbCurrentCategory: 'all', kbEditorMode: false,
                    kbEditorData: { id: null, title: '', content: '', categoryId: null }
                };
            },
            computed: {
                xpPercentage() { return Math.min(100, (this.playerData.xp / this.playerData.nextLevelXp) * 100); },
                filteredNotes() {
                    let res = this.notes.filter(n => {
                        if (n.type && n.type !== this.activeReviewTab) return false;
                        if (!n.type && this.activeReviewTab !== 'daily' && this.activeReviewTab !== 'stock') return false; 
                        return true;
                    });
                    return res.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));
                },
                filteredKbDocs() {
                    let res = this.kbDocs;
                    if (this.kbCurrentCategory !== 'all') res = res.filter(d => d.categoryId === this.kbCurrentCategory.id);
                    return res.sort((a,b) => new Date(b.updatedAt) - new Date(a.updatedAt));
                }
            },
            methods: {
                showMessage(txt, type='success') { this.message = txt; this.messageType = type; setTimeout(()=>this.message='', 4000); },
                formatDate(str) { return new Date(str).toLocaleString('zh-CN'); },
                formatDateShort(str) { return new Date(str).toLocaleDateString(); },
                getReviewTypeName(t) { const map={stock:'è‚¡ç¥¨',daily:'æ—¥å¸¸',weekly:'å‘¨å¤ç›˜',yearly:'å¹´ç»ˆ'}; return map[t]||'è®°å½•'; },
                
                // Auth & Data
                async login() {
                    if (!this.email || !this.password) return this.showMessage('è¯·è¾“å…¥è´¦å·å¯†ç ', 'error');
                    this.loading = true;
                    const { data, error } = await sb.auth.signInWithPassword({ email: this.email, password: this.password });
                    this.loading = false;
                    if (error) return this.showMessage('ç™»å½•å¤±è´¥: ' + error.message, 'error');
                    this.isLoggedIn = true; this.userId = data.user.id; this.userEmail = data.user.email;
                    this.loadData();
                },
                async logout() { await sb.auth.signOut(); this.isLoggedIn = false; },

                async loadData() {
                    this.syncing = true;
                    // åŠ è½½æ‰€æœ‰è¡¨ï¼ŒåŒ…æ‹¬æ–°è¡¨ cases
                    const [p, s, a, n, b, kc, kd, cs] = await Promise.all([
                        sb.from('players').select('*').eq('user_id', this.userId).single(),
                        sb.from('skills').select('*').eq('user_id', this.userId),
                        sb.from('achievements').select('*').eq('user_id', this.userId),
                        sb.from('notes').select('*').eq('user_id', this.userId),
                        sb.from('books').select('*').eq('user_id', this.userId),
                        sb.from('kb_categories').select('*').eq('user_id', this.userId),
                        sb.from('kb_notes').select('*').eq('user_id', this.userId),
                        sb.from('cases').select('*').eq('user_id', this.userId) // æ–°è¡¨
                    ]);
                    if(p.data) this.playerData = p.data.data;
                    if(s.data) this.skills = s.data.map(i => i.data);
                    if(a.data) this.achievements = a.data.map(i => i.data); // ç®€åŒ–
                    if(n.data) this.notes = n.data.map(i => i.data);
                    if(b.data) this.books = b.data.map(i => i.data);
                    if(kc.data) this.kbCategories = kc.data.map(i => i.data);
                    if(kd.data) this.kbDocs = kd.data.map(i => i.data);
                    if(cs.data) this.cases = cs.data.map(i => i.data);
                    this.syncing = false;
                },
                async saveAll() {
                    const wrap = (list) => list.map(d => ({ user_id: this.userId, data: d }));
                    // åˆ é™¤æ—§æ•°æ® (ç®€åŒ–ç­–ç•¥)
                    await Promise.all([
                        sb.from('skills').delete().eq('user_id', this.userId),
                        sb.from('notes').delete().eq('user_id', this.userId),
                        sb.from('books').delete().eq('user_id', this.userId),
                        sb.from('kb_categories').delete().eq('user_id', this.userId),
                        sb.from('kb_notes').delete().eq('user_id', this.userId),
                        sb.from('cases').delete().eq('user_id', this.userId)
                    ]);
                    await sb.from('players').upsert({ user_id: this.userId, data: this.playerData });
                    if(this.skills.length) await sb.from('skills').insert(wrap(this.skills));
                    if(this.notes.length) await sb.from('notes').insert(wrap(this.notes));
                    if(this.books.length) await sb.from('books').insert(wrap(this.books));
                    if(this.kbCategories.length) await sb.from('kb_categories').insert(wrap(this.kbCategories));
                    if(this.kbDocs.length) await sb.from('kb_notes').insert(wrap(this.kbDocs));
                    if(this.cases.length) await sb.from('cases').insert(wrap(this.cases));
                },
                async syncData() { await this.saveAll(); this.showMessage('åŒæ­¥æˆåŠŸï¼'); },

                // OKR
                addGoal() { if(!this.newGoal.title) return; if(!this.playerData.goals) this.playerData.goals=[]; this.playerData.goals.push({title:this.newGoal.title, progress:0}); this.newGoal.title=''; this.saveAll(); },
                deleteGoal(i) { this.playerData.goals.splice(i,1); this.saveAll(); },

                // XP
                addXp(amount) { this.playerData.xp+=amount; if(this.playerData.xp>=this.playerData.nextLevelXp) { this.playerData.xp-=this.playerData.nextLevelXp; this.playerData.level++; this.showMessage('å‡çº§äº†!'); } },
                addNewSkill() { const n=prompt('æŠ€èƒ½å'); if(n) { this.skills.push({id:Date.now(), name:n, icon:'âœ¨', level:1, xp:0, maxXp:50}); this.addXp(10); this.saveAll(); } },
                practiceSkill(id) { const s=this.skills.find(x=>x.id===id); if(s){ s.xp+=10; if(s.xp>=s.maxXp){ s.xp=0; s.level++; s.maxXp=Math.floor(s.maxXp*1.5); } this.addXp(5); this.saveAll(); } },
                
                // å¤ç›˜
                applyTemplate(t) { if(t==='weekly') this.newNote.content="## KPTå¤ç›˜\nKeep:\nProblem:\nTry:"; if(t==='yearly') this.newNote.content="## å¹´åº¦å…³é”®è¯\n"; },
                saveNote() {
                    if(this.activeReviewTab === 'stock') {
                        if(!this.newStockData.code) return;
                        // å°†äº¤æ˜“é€»è¾‘å’Œåæ€ç»„åˆè¿› contentï¼Œæˆ–è€…å­˜å…¥ stockData
                        const content = `é€»è¾‘: ${this.newStockData.logic}\nåæ€: ${this.newStockData.mistake}`;
                        this.notes.unshift({ id: Date.now(), type: 'stock', createdAt: new Date().toISOString(), content: content, stockData: {...this.newStockData} });
                        this.newStockData = { code:'', action:'buy', price:'', profit:'', logic:'', mistake:'' };
                    } else {
                        if(!this.newNote.title) return;
                        this.notes.unshift({ id: Date.now(), type: this.activeReviewTab, createdAt: new Date().toISOString(), ...this.newNote });
                        this.newNote = { title:'', content:'' };
                    }
                    this.showReviewForm = false; this.addXp(15); this.saveAll();
                },
                deleteNote(id) { if(confirm('åˆ é™¤?')) { this.notes=this.notes.filter(n=>n.id!==id); this.saveAll(); } },

                // æ˜“å­¦å‘½ä¾‹ (å›¾ç‰‡å¤„ç†)
                handleImageUpload(e) {
                    const file = e.target.files[0];
                    if(!file) return;
                    const reader = new FileReader();
                    reader.onload = (evt) => {
                        this.newCase.image = evt.target.result; // Base64 string
                    };
                    reader.readAsDataURL(file);
                },
                saveCase() {
                    if(!this.newCase.title) return this.showMessage('è¯·å¡«å†™æ ‡é¢˜', 'error');
                    this.cases.unshift({ id: Date.now(), type: 'case', createdAt: new Date().toISOString(), ...this.newCase });
                    this.newCase = { title: '', content: '', image: null };
                    this.showCaseForm = false;
                    this.addXp(30); this.saveAll();
                },

                // çŸ¥è¯†åº“ & ä¹¦
                saveBook() { if(!this.newBook.title)return; this.books.unshift({id:Date.now(), ...this.newBook}); this.showBookForm=false; this.saveAll(); },
                addKbCategory() { const n=prompt('åˆ†ç±»å'); if(n) this.kbCategories.push({id:Date.now(), name:n}); this.saveAll(); },
                openKbEditor() { this.kbEditorData={id:null, title:'', content:'', categoryId:null}; this.kbEditorMode=true; },
                editKbDoc(d) { this.kbEditorData={...d}; this.kbEditorMode=true; },
                saveKbDoc() { 
                    const now = new Date().toISOString();
                    if(this.kbEditorData.id) { const i=this.kbDocs.findIndex(d=>d.id===this.kbEditorData.id); this.kbDocs[i]={...this.kbEditorData, updatedAt:now}; }
                    else { this.kbDocs.unshift({id:Date.now(), ...this.kbEditorData, createdAt:now, updatedAt:now}); }
                    this.kbEditorMode=false; this.saveAll();
                },
                deleteItem(item) { 
                    if(!confirm('åˆ é™¤?')) return; 
                    if(item.type==='book') this.books=this.books.filter(b=>b.id!==item.id);
                    else if(item.type==='case') this.cases=this.cases.filter(c=>c.id!==item.id);
                    this.viewingItem=null; this.saveAll(); 
                }
            },
            mounted() {
                sb.auth.getSession().then(({ data: { session } }) => {
                    if(session) { this.isLoggedIn = true; this.userId = session.user.id; this.userEmail = session.user.email; this.loadData(); }
                });
            }
        }).mount('#app');
    </script>
</body>
</html>
